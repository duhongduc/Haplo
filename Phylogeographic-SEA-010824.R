############################################################################################    
# R codes for phylogeographic distribution of mtDNA haplogroups in Southeast Asia

#	A workflow with RStudio: phylogenetic analyses and visualizations using mtDNA sequences
#		
#	Duc Du
#	August 2023

# Device configration
# R version 4.2.1 (2022-06-23)
# Platform: x86_64-pc-linux-gnu (64-bit)
# Running under: Ubuntu 18.04.6 LTS
###########################################################################

rm(list = ls(all.names = TRUE))

# Install and load packages

InstallPackages = FALSE

if (InstallPackages) {
  if (!requireNamespace("BiocManager", quietly=TRUE)) 
    install.packages("BiocManager")
  BiocManager::install("msa")
  BiocManager::install("ggtreeExtra")
  
  install.packages("adegenet")
  install.packages("ape")
  install.packages("ggtree")
  install.packages("ggplot2")
  install.packages("ips")
  install.packages("bios2mds")
  install.packages("haplotypes")
  install.packages("pegas")
  install.packages("phytools")
  install.packages("stats")
  install.packages("treeio")
}

# install.packages("strap", dependencies=TRUE)
# install.packages("phytools", dependencies=TRUE)
# remotes::install_github("fmichonneau/phyloch")
# install.packages("admixr")
# devtools::install_github("uqrmaie1/admixtools")
# devtools::install_github("uqrmaie1/admixtools", dependencies = TRUE, force = TRUE)
# install.packages("Rcpp")
# install.packages("tidyverse")
# install.packages("igraph")
# install.packages("plotly")
# install.packages("coalescentMCMC")

library(adegenet)
library(ape)
library(BiocManager)
# BiocManager::install("ggtree")
library(ggtree)
library(ggplot2)
library(sf)
library(scatterpie)
library(ggpmisc)
library(stats)
library(ips)
# BiocManager::install("msa")
library(msa)
library(stringi)
library(stringr)
library(strap)
library(coalescentMCMC)
library(ggtree)
library(treeio)

# Load multiple DNA sequences
# fname = "countries.fasta"
fname2 = "Iso_RSRS_RCRS_countriesAlign.fasta"
# file <- Biostrings::readDNAStringSet(fname)#for reading multiple DNA sequences from msa package
file2 <- Biostrings::readDNAStringSet(fname2)#for reading multiple DNA sequences from msa package
cb<-file2
nbin<-as.DNAbin(cb) #read aligned data from cb above

an<-as.alignment(nbin)  #converting DNAbin to alignment format
nm<-as.matrix(an)       #converting alignment to matrix
nbinmat<-as.matrix(labels(nbin)) #extraction of the sample names
nbin
class(nbin)
# dnbin<-dist.dna(nbin, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
# tree<-nj(dnbin)
# 
# library(ggtree)
# ggt<-ggtree::ggtree(tree, cex = 0.8, aes(color=branch.length))+
#   scale_color_continuous(high='lightskyblue1',low='coral4')+
#   geom_tiplab(align=TRUE, size=2)+
#   geom_treescale(y = - 5, color = "coral4", fontsize = 4)
# 
# library(treeio)
# zoom(tree, grep("Vietnam", tree$tip.label, value = TRUE))
# 
# groupInfo <- split(tree$tip.label, gsub("_\\w+", "", tree$tip.label))
# tree <- groupOTU(tree, groupInfo)
# options(ignore.negative.edge=TRUE)
# p <- ggtree(tree, aes(color=group)) + geom_tiplab() + xlim(NA, 23)
# zoom(tree, grep("Vietnam", tree$tip.label), xmax_adjust=2)
# 
# tre<-ladderize(tree)
# ggtree(tre, cex = 0.8, aes(color=branch.length))+
#   scale_color_continuous(high='lightskyblue1',low='coral4')+
#   geom_tiplab(align=TRUE, size=2)+
#   geom_treescale(y = - 5, color = "coral4", fontsize = 4)+
#   geom_highlight(node = 20, fill="purple", alpha=0.2)

# njmsaplot<-msaplot(ggt, nbin, offset = 0.009, width=1, height = 0.5, color = c(rep("coral4", 1), rep("rosybrown", 1), rep("sienna1", 1), rep("lightgoldenrod1", 1), rep("darkseagreen2", 1), rep("lightskyblue1", 1)))
# njmsaplot
# 
# dev.new()
# njmsaplot
# 
# pdf("njmsaplot-sea.pdf", width = 11, height = 9)#save as pdf file
# njmsaplot
# dev.off()

# Phylogenetic tree

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

# tree2 <- ape::read.tree("Treefull_root.newick")

tree <- phytools::read.newick("Treefull.newick")
tree$tip.label <- gsub("'", "", tree$tip.label)
tree$tip.label <- gsub("_", "", tree$tip.label)
tree$tip.label <- gsub("-", "", tree$tip.label)
tree$tip.label <- gsub(" ", "", tree$tip.label)
tree$tip.label <- gsub(",", "", tree$tip.label)
tree$tip.label <- trimws(gsub("\\s+", " ", tree$tip.label))

options(max.print=1000000)

# ggt<-ggtree::ggtree(tree, cex = 0.8, aes(color=branch.length))+
#   scale_color_continuous(high='lightskyblue1',low='coral4')+
#   geom_tiplab(align=TRUE, size=2)+
#   geom_treescale(y = - 5, color = "coral4", fontsize = 4)
# ggt

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

pal<-rgb(0,1,0)
show_col(pal)
show_col(hue_pal()(9))
show_col(hue_pal()(16), borders = NA)

show_col(viridis_pal()(16))
show_col(viridis_pal()(16), labels = FALSE)
show_col(viridis_pal()(141))
viridis_pal()(141)

show_col(c("#0099ff", "#163566", "#336699", "#339900", "#660000", "#66ccff", "#9900ff", "#990f80", "#996666", "#99ff99", "#cc0000", "#cc66ff", "#cccc33", "#fa0f0c", "#ff6633", "#ff9999", "#ffcc33", "#ffcc99", "#ffff00"))

# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
dat$name <- gsub("\\+", "", dat$name)
dat$name <- gsub("\\'", "", dat$name)
dat$name <- gsub("\\(", "", dat$name)
dat$name <- gsub("\\)", "", dat$name)
dat$name <- gsub("\\_", "", dat$name)
dat$name <- gsub("\\-", "", dat$name)
dat$name <- gsub(" ", "", dat$name)
dat$name <- gsub("\\*", "", dat$name)
dat$name <- gsub("\\@", "", dat$name)
dat$name <- gsub("\\!", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
dat2 <- dat %>% filter(!name %in% tree$tip.label)
table(tree$tip.label %in% dat$name)
table(dat$name %in% tree$tip.label)
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`))))))))))))))))))) %>%
  droplevels()

library(gtsummary)
library(writexl)

gt_table <- dat %>% select(Country, `Language family`, Ethnicity, haplo) %>% 
  tbl_summary(by=Country, statistic = list(all_categorical() ~ "{n} ({p}%)",
                                           all_continuous() ~ "{median} ({p25}, {p75})"),
              missing = "no", 
              percent = "column") %>% 
  add_n() %>% 
  add_overall() %>% modify_footnote(all_stat_cols() ~ NA) %>% 
  modify_header(update = list(all_stat_cols() ~ "**{level}**<br>n = {n}", stat_0 ~ "**Total**<br>N = {N}")) %>% 
  bold_labels()

# Export to Excel ----

# convert to tibble, then write to xlsx
gt_table %>%
  gtsummary::as_tibble() %>% 
  writexl::write_xlsx(., "example_gtsummary4_new.xlsx")

a <- dat %>% select(`Language family`, Ethnicity) %>%
  tbl_summary(by=`Language family`) %>%
  add_n() %>%
  gtsummary::as_tibble() %>% 
  writexl::write_xlsx(., "lf_ethnic1_new.xlsx")


# # Or use `as_hux_xlsx()`
# gt_table %>% 
#   as_hux_xlsx("example_gtsummary2.xlsx")

# df <- df_Candidaauris_data
# tr <- tree_Candidaauris
# library(writexl)
# write_xlsx(dat, "SEA_megadata.xlsx")
# 
# dat <- read_excel("SEA_megadata.xlsx")
countries <- c("Brunei", "Cambodia", "Indonesia", "Laos", "Malaysia", "Myanmar", "Philippines", "rCRS", "RSRS", "Singapore", "Thailand", "Timor-Leste", "Vietnam")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

# For the haplogroup layer
dat3 <- dat %>% dplyr::select(c("name", "haplogroup2")) %>%
  melt(id="name", variable.name="haplo", value.name="haplogroup")

# For the clade group
dat4 <- dat %>% dplyr::select(c("name", "Language family"))
dat4 <- aggregate(.~`Language family`, dat4, FUN=paste, collapse=",")
clades <- lapply(dat4$name, function(x){unlist(strsplit(x,split=","))})
names(clades) <- dat4$`Language family`

# ggt<-ggtree::ggtree(tree, cex = 0.8, aes(color=branch.length))+
#   geom_tiplab(align=TRUE, size=2)+
#   geom_treescale(y = - 5, color = "coral4", fontsize = 4)
# ggt
# 
# tree <- groupOTU(tree, clades, "Clade")
# Clade <- NULL
# p <- ggtree(tr=tree, layout="fan", open.angle=15, size=0.2, aes(colour=Clade)) +
#   scale_colour_manual(
#     name="Language",
#     values=c("black", "#fa0f0c", "#FF61CC", "#ED68ED", "#F8766D", "#ABA300", "#C77CFF", "#8494FF", "#E68613", "#0099ff", "#660000", "#163566", "#336699", "#339900", "#66ccff", "lightgrey"),
#     labels=c("RSRS", "Austroasiatic", "Austroasiatic, Austronesian", "Austroasiatic, Austronesian + (xSino-Tibetan)", "Austroasiatic, Austronesian, Sino-Tibetan", "Austroasiatic, Tai-Kadai +", "Austronesian", "Austronesian + (xAustroasiatic)", "rCRS", "Hmong-Mien +", "Mayan", "Sino-Tibetan", "Sino-Tibetan +", "Tai-Kadai", "Trans-New Guinea +", "Unknown"),
#     guide=guide_legend(keywidth=1.5,
#                        keyheight=1.25,
#                        order=1,
#                        override.aes=list(linetype=1, size=6,alpha=1))) +
#   theme(legend.position="right",
#         legend.background=element_rect(fill=NA),
#         legend.title=element_text(size=20),
#         legend.text=element_text(size=15),
#         legend.key.size = unit(40, "cm"),
#         legend.spacing.y = unit(2, "cm")) + 
#   new_scale_colour()
# 
# p1 <- p %<+% dat1 +
#   geom_tippoint(aes(colour=Country), alpha=0) +
#   geom_tiplab(aes(colour=Country),
#               align=TRUE,
#               linetype=3,
#               size=1,
#               linesize=0.2,
#               show.legend=FALSE) +
#   scale_colour_manual(
#     name="Country",
#     values=Countrycolors, 
#     guide=guide_legend(keywidth=1.5,
#                        keyheight=1.25,
#                        order=2,
#                        override.aes=list(size=5,alpha=1))) +
#   theme(legend.position="right",
#         legend.background=element_rect(fill=NA),
#         legend.title=element_text(size=20),
#         legend.text=element_text(size=15),
#         legend.key.size = unit(30, "cm"),
#         legend.spacing.y = unit(2, "cm")) + 
#   new_scale_colour()
# 
# p3 <- p1 +
#   geom_fruit(data=dat3,
#              geom=geom_star,
#              mapping=aes(x=haplogroup, y=name, fill=haplogroup, starshape=haplo),
#              size=3,
#              starstroke=0,
#              pwidth=0.1,
#              inherit.aes = FALSE,
#              grid.params=list(linetype=3, size=0.2)) +
#   scale_fill_discrete(
#     name="Haplogroup",
#     guide=guide_legend(keywidth=1.5, 
#                        keyheight=1.25, 
#                        order=3,
#                        override.aes=list(size=5)),
#     na.translate=FALSE) +
#   scale_starshape_discrete(guide="none") +
#   theme(legend.background=element_rect(fill=NA),
#         legend.title=element_text(size=20), 
#         legend.text=element_text(size=15),
#         legend.key.size = unit(30, "cm"),
#         legend.spacing.y = unit(2, "cm"))
# p3
# ggsave(filename = file.path("figures", "Treefull.png"), width = 30, height = 20)

filename <- "TREEFULL.NEXUS"
tree2 <- ape::read.nexus(filename)
tree2$tip.label <- gsub("'", "", tree2$tip.label)
tree2$tip.label <- gsub("_", "", tree2$tip.label)
tree2$tip.label <- gsub("-", "", tree2$tip.label)
tree2$tip.label <- gsub(" ", "", tree2$tip.label)
tree2$tip.label <- gsub(",", "", tree2$tip.label)
tree2$tip.label <- trimws(gsub("\\s+", " ", tree2$tip.label))

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Austroasiatic", "Austroasiatic, Austronesian", "Austroasiatic, Tai-Kaidai, Hmong-Mien", "Austronesian", "Austronesian, Sino-Tibetan", "Austronesian, Trans–New Guinea", "Hmong-Mien", "Mayan", "rCRS", "RSRS", "Sino-Tibetan", "Tai-Kadai", "Trans–New Guinea", "Unknown")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Abaknon", "Achang", "Aeta (Agta)", "Aini", "Alorese, Alor Malay, Alor-Pantar", "Ambonese", "Ancient Thai", "Arakanese (or Rakhine)", "Bali Aga, Balinese", "Bamar (or Burman)", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Batek", "Besemah", "Bidayuh", "Black Tai", "Blang", "Bru (Brao)", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Central Thai", "Cham", "Chin", "Chinese", "CoLao", "Cuyunin (or Cuyonon)", "Dai", "Dao", "Dawei", "Dayak", "Deang", "Ede", "English", "Filipino (or Tagalog)", "Giarai", "H’tin", "Han", "HaNhi", "Hmong", "Hui", "Ibaloi", "Ifugao", "Indonesian", "Isan (or Lao)", "IuMien", "Ivatan", "Jahai, Semang", "Jarai", "Javanese", "Jehai", "Jingpo", "Kadazan-Dusun", "Kalueng", "Kankanaey (or Igorot)", "Karen", "Kensiu", "Khamu", "Khmer", "Khmer Loeu", "Khon Mueang", "Khuen", "Kinh", "Kinh, Cham, Ede, Giarai", "Kinh, Muong, Khmer", "Kinh, Tay, Thai, Muong, Hmong", "Kintaq", "Kreung", "LaChi", "Lahu", "Lao", "Lawa", "Lisu", "LoLo", "Lun", "Makassarese", "Malay", "Malay, Achehnese", "Mamanwa", "Manabo", "Mang", "Maniq", "Maranao", "Mel Khaonh", "Minahasa", "Minangkabau", "Mlabri", "Moken", "Mon", "Naga", "Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Nung", "Nyahkur", "Nyaw", "Orang Asli", "Paluang", "Papuan", "PaThen", "Phnong", "Phuan", "PhuLa", "Phutai", "rCRS", "RSRS", "Sasak", "Seak", "Seletar", "Semelai", "Semende", "Shan", "SiLa", "Soa", "Southern Thai_AN", "Southern Thai_TK", "Stieng", "Suay", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Tai Lue", "Tai Yuan", "Taiwan", "Tay", "Tay Nung", "Temuan", "Tengger", "Tetum, Mambai, Makasae", "Thai", "The Kalanguya (or Ikalahan)", "Tompoun", "Toraja", "Unknown", "UrakLawoi")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("A", "B", "C", "D", "E", "F", "G", "H", "I", "K", "L", "M", "N", "P", "Q", "R", "U", "W", "Y", "Z")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

# Final tree

p <- ggtree(tree2, layout='circular')

p <- p %<+% metadata

p1 <- p +
  geom_tippoint(aes(color=Country),
                size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical")

p4 <- p1 +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=`Language family`),
    width=0.005,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Language",
    values=Languagecolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=1,
                       override.aes=list(size=10,alpha=1))
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"), 
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical")

p6 <- p +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=Ethnicity),
    width=0.005,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Ethnicity",
    values=Ethniccolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=2.5, 
                       ncol = 3,
                       override.aes=list(size=10,alpha=1),
                       title.position="top")
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=36, face="bold"), 
        legend.text=element_text(size=22),
        legend.key.size = unit(10, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "horizontal",
        legend.direction = "horizontal",
        legend.position = "right", 
        legend.box.spacing = unit(-30, "pt"))

p7 <- p4 +
  new_scale_fill() +
  geom_fruit(geom=geom_star,
             mapping=aes(fill=haplogroup1),
             size=18,
             starstroke=0,
             pwidth=0.2,
             inherit.aes = FALSE,
             grid.params=list(linetype=3, size=0.2)) +
  scale_fill_manual(
    name="Haplogroup",
    values = Haplocolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=3,
                       nrow = 4, byrow = TRUE,
                       override.aes=list(size=10)),
    na.translate=FALSE) +
  scale_starshape_discrete(guide="none") +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=40, face="bold"), 
        legend.text=element_text(size=30),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "left", 
        legend.box.spacing = unit(-50, "pt")) + 
  new_scale_colour()
p7

library(cowplot)   # get_legend() & plot_grid() functions
library(patchwork) # blank plot: plot_spacer()

# Get legends

leg6 <- get_legend(p6)

# create a blank plot for legend alignment 
blank_p <- plot_spacer() + theme_void()

# Make a title

title <- ggdraw() + draw_label("Southeast Asia", fontface='bold') +
  theme(plot.title = element_text(size = 100))

# Put everything together

final_p <- plot_grid(p7, leg6, nrow = 1, align = "h", axis = "r", rel_widths = c(1.8,1)) +
  theme(plot.background = element_rect(fill = "white", colour = NA)) +
  ggtitle("Southeast Asia") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "plot")

ggsave(filename = file.path("figures", "Treefull_final_new.png"), width = 49, height = 33)

## Vietnam

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

tree <- phytools::read.newick("Vietnam.newick")
tree$tip.label <- gsub("'", "", tree$tip.label)
tree$tip.label <- gsub("_", "", tree$tip.label)
tree$tip.label <- gsub("-", "", tree$tip.label)
tree$tip.label <- gsub(" ", "", tree$tip.label)
tree$tip.label <- gsub(",", "", tree$tip.label)
tree$tip.label <- trimws(gsub("\\s+", " ", tree$tip.label))

options(max.print=1000000)

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
dat$name <- gsub("\\+", "", dat$name)
dat$name <- gsub("\\'", "", dat$name)
dat$name <- gsub("\\(", "", dat$name)
dat$name <- gsub("\\)", "", dat$name)
dat$name <- gsub("\\_", "", dat$name)
dat$name <- gsub("\\-", "", dat$name)
dat$name <- gsub(" ", "", dat$name)
dat$name <- gsub("\\*", "", dat$name)
dat$name <- gsub("\\@", "", dat$name)
dat$name <- gsub("\\!", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat2 <- dat %>% filter(!name %in% tree$tip.label)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
table(tree$tip.label %in% dat$name)
table(dat$name %in% tree$tip.label)
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`))))))))))))))))))) %>%
  droplevels() %>%
  filter(Country=="Vietnam")

countries <- c("Vietnam")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

filename <- "Vietnam.NEXUS"
tree2 <- ape::read.nexus(filename)
tree2$tip.label <- gsub("'", "", tree2$tip.label)
tree2$tip.label <- gsub("_", "", tree2$tip.label)
tree2$tip.label <- gsub("-", "", tree2$tip.label)
tree2$tip.label <- gsub(" ", "", tree2$tip.label)
tree2$tip.label <- gsub(",", "", tree2$tip.label)
tree2$tip.label <- trimws(gsub("\\s+", " ", tree2$tip.label))

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Austroasiatic", "Austroasiatic, Austronesian", "Austroasiatic, Tai-Kaidai, Hmong-Mien", "Austronesian", "Hmong-Mien", "Sino-Tibetan", "Tai-Kadai")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Cham", "CoLao", "Dao", "Ede", "Giarai", "HaNhi", "Hmong", "Hui", "Kinh", "Kinh, Cham, Ede, Giarai", "Kinh, Muong, Khmer", "Kinh, Tay, Thai, Muong, Hmong", "LaChi", "Lahu", "LoLo", "Mang", "Nung", "PaThen", "PhuLa", "SiLa", "Stieng", "Tay", "Tay Nung", "Thai")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("A", "B", "C", "D", "F", "G", "M", "N", "R", "Z")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(tree2, layout='circular')

p <- p %<+% metadata

p1 <- p +
  geom_tippoint(aes(color=Country),
                size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p4 <-p1 +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=`Language family`),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Language",
    values=Languagecolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=1,
                       override.aes=list(size=10,alpha=1))
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"), 
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p6 <- p4 +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=Ethnicity),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Ethnicity",
    values=Ethniccolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       ncol = 1,
                       order = 4,
                       override.aes=list(size=1,alpha=1),
                       title.position="top")
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=36, face="bold"), 
        legend.text=element_text(size=22),
        legend.key.size = unit(10, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p7 <- p6 +
  new_scale_fill() +
  geom_fruit(geom=geom_star,
             mapping=aes(fill=haplogroup1),
             size=30,
             starstroke=0,
             pwidth=0.2,
             inherit.aes = FALSE,
             grid.params=list(linetype=3, size=0.2)) +
  scale_fill_manual(
    name="Haplogroup",
    values = Haplocolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       order=3,
                       nrow = 2, byrow = TRUE,
                       override.aes=list(size=10)),
    na.translate=FALSE) +
  scale_starshape_discrete(guide="none") +
  ggtitle("Vietnam") + 
  theme(plot.title = element_text(size = 100, face = "bold")) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=40, face="bold"), 
        legend.text=element_text(size=30),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "right") + 
  new_scale_colour()
p7

ggsave(filename = file.path("figures", "Tree_Vietnam_new.png"), width = 49, height = 33)

## Thailand

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

tree <- phytools::read.newick("Thailand.newick")
tree$tip.label <- gsub("'", "", tree$tip.label)
tree$tip.label <- gsub("_", "", tree$tip.label)
tree$tip.label <- gsub("-", "", tree$tip.label)
tree$tip.label <- gsub(" ", "", tree$tip.label)
tree$tip.label <- gsub(",", "", tree$tip.label)
tree$tip.label <- trimws(gsub("\\s+", " ", tree$tip.label))

options(max.print=1000000)

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
dat$name <- gsub("\\+", "", dat$name)
dat$name <- gsub("\\'", "", dat$name)
dat$name <- gsub("\\(", "", dat$name)
dat$name <- gsub("\\)", "", dat$name)
dat$name <- gsub("\\_", "", dat$name)
dat$name <- gsub("\\-", "", dat$name)
dat$name <- gsub(" ", "", dat$name)
dat$name <- gsub("\\*", "", dat$name)
dat$name <- gsub("\\@", "", dat$name)
dat$name <- gsub("\\!", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat2 <- dat %>% filter(!name %in% tree$tip.label)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
table(tree$tip.label %in% dat$name)
table(dat$name %in% tree$tip.label)
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`))))))))))))))))))) %>%
  droplevels() %>%
  filter(Country=="Thailand")

countries <- c("Thailand")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

filename <- "Thailand.NEXUS"
tree2 <- ape::read.nexus(filename)
tree2$tip.label <- gsub("'", "", tree2$tip.label)
tree2$tip.label <- gsub("_", "", tree2$tip.label)
tree2$tip.label <- gsub("-", "", tree2$tip.label)
tree2$tip.label <- gsub(" ", "", tree2$tip.label)
tree2$tip.label <- gsub(",", "", tree2$tip.label)
tree2$tip.label <- trimws(gsub("\\s+", " ", tree2$tip.label))

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Austroasiatic", "Austronesian", "Austronesian, Sino-Tibetan", "Hmong-Mien", "Sino-Tibetan", "Tai-Kadai")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Ancient Thai", "Black Tai", "Blang", "Bru (Brao)", "Central Thai", "H’tin", "Hmong", "Isan (or Lao)", "IuMien", "Kalueng", "Karen", "Khamu", "Khmer", "Khon Mueang", "Khuen", "Lahu", "Lawa", "Lisu", "Maniq", "Mlabri", "Moken", "Mon", "Nyahkur", "Nyaw", "Paluang", "Phuan", "Phutai", "Seak", "Shan", "Soa", "Southern Thai_AN", "Southern Thai_TK", "Suay", "Tai Lue", "Tai Yuan", "Taiwan", "Thai", "UrakLawoi")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("A", "B", "C", "D", "E", "F", "G", "H", "I", "K", "M", "N", "Q", "R", "U", "W", "Y", "Z")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(tree2, layout='circular')

p <- p %<+% metadata

p1 <- p +
  geom_tippoint(aes(color=Country),
                size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p4 <-p1 +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=`Language family`),
    width=0.002,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Language",
    values=Languagecolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=1,
                       override.aes=list(size=10,alpha=1))
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"), 
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p6 <- p4 +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=Ethnicity),
    width=0.002,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Ethnicity",
    values=Ethniccolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       ncol = 1,
                       order = 4,
                       override.aes=list(size=1,alpha=1),
                       title.position="top")
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=36, face="bold"), 
        legend.text=element_text(size=22),
        legend.key.size = unit(10, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p7 <- p6 +
  new_scale_fill() +
  geom_fruit(geom=geom_star,
             mapping=aes(fill=haplogroup1),
             size=30,
             starstroke=0,
             pwidth=0.2,
             inherit.aes = FALSE,
             grid.params=list(linetype=3, size=0.2)) +
  scale_fill_manual(
    name="Haplogroup",
    values = Haplocolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       order=3,
                       nrow = 2, byrow = TRUE,
                       override.aes=list(size=10)),
    na.translate=FALSE) +
  scale_starshape_discrete(guide="none") +
  ggtitle("Thailand") + 
  theme(plot.title = element_text(size = 100, face = "bold")) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=40, face="bold"), 
        legend.text=element_text(size=30),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(1, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "right") + 
  new_scale_colour()
p7

ggsave(filename = file.path("figures", "Tree_Thailand_new.png"), width = 49, height = 33)

## Indonesia

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

tree <- phytools::read.newick("Indonesia.newick")
tree$tip.label <- gsub("'", "", tree$tip.label)
tree$tip.label <- gsub("_", "", tree$tip.label)
tree$tip.label <- gsub("-", "", tree$tip.label)
tree$tip.label <- gsub(" ", "", tree$tip.label)
tree$tip.label <- gsub(",", "", tree$tip.label)
tree$tip.label <- trimws(gsub("\\s+", " ", tree$tip.label))

options(max.print=1000000)

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
dat$name <- gsub("\\+", "", dat$name)
dat$name <- gsub("\\'", "", dat$name)
dat$name <- gsub("\\(", "", dat$name)
dat$name <- gsub("\\)", "", dat$name)
dat$name <- gsub("\\_", "", dat$name)
dat$name <- gsub("\\-", "", dat$name)
dat$name <- gsub(" ", "", dat$name)
dat$name <- gsub("\\*", "", dat$name)
dat$name <- gsub("\\@", "", dat$name)
dat$name <- gsub("\\!", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat <- dat %>%
  mutate(name=ifelse(name=="Indonesia.FTDNAIN86021.MW366904.M74b1a", "Indonesia.FTDNA",
                     ifelse(name=="Indonesia.FTDNAN103101.KF631317.B5a1a", "Indonesia.FTDNA2",
                            ifelse(name=="Indonesia.individualA.JN048455.N10", "Indonesia.individual",
                                   ifelse(name=="Indonesia.individualA.JN048456.N10", "Indonesia.individual2",
                                          ifelse(name=="Indonesia.individualA.JN048457.N10", "Indonesia.individual3",
                                                 ifelse(name=="Indonesia.individualA.JN048458.N10", "Indonesia.individual4",
                                                        ifelse(name=="Indonesia.individualA.JN048459.N10", "Indonesia.individual5",
                                                               ifelse(name=="Indonesia.individualA.JN048460.N10", "Indonesia.individual6",
                                                                      ifelse(name=="Indonesia.individualB.JN048461.H2a2a1d", "Indonesia.individual7",
                                                                             ifelse(name=="Indonesia.individualB.JN048462.H2a2a1d", "Indonesia.individual8",
                                                                                    ifelse(name=="Indonesia.individualB.JN048463.H2a2a1d", "Indonesia.individual9",
                                                                                           name))))))))))))

dat2 <- dat %>% filter(!name %in% tree$tip.label)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
table(tree$tip.label %in% dat$name)
table(dat$name %in% tree$tip.label)
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`))))))))))))))))))) %>%
  droplevels() %>%
  filter(Country=="Indonesia")

countries <- c("Indonesia")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

filename <- "Indonesia.NEXUS"
tree2 <- ape::read.nexus(filename)
tree2$tip.label <- gsub("'", "", tree2$tip.label)
tree2$tip.label <- gsub("_", "", tree2$tip.label)
tree2$tip.label <- gsub("-", "", tree2$tip.label)
tree2$tip.label <- gsub(" ", "", tree2$tip.label)
tree2$tip.label <- gsub(",", "", tree2$tip.label)
tree2$tip.label <- trimws(gsub("\\s+", " ", tree2$tip.label))

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Austronesian", "Austronesian, Trans–New Guinea", "Sino-Tibetan", "Trans–New Guinea", "Unknown")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Aini", "Alorese, Alor Malay, Alor-Pantar", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bugis", "Dayak", "Indonesian", "Javanese", "Makassarese", "Minahasa", "Minangkabau", "Papuan", "Sasak", "Semende", "Sumatrans", "Sumbanese", "Sundanese", "Tengger", "Toraja", "Unknown")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("B", "D", "E", "F", "H", "M", "N", "P", "Q", "R", "Y")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(tree2, layout='circular')

p <- p %<+% metadata

p1 <- p +
  geom_tippoint(aes(color=Country),
                size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p4 <-p1 +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=`Language family`),
    width=0.0004,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Language",
    values=Languagecolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=1,
                       override.aes=list(size=10,alpha=1))
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"), 
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p6 <- p4 +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=Ethnicity),
    width=0.0004,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Ethnicity",
    values=Ethniccolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       ncol = 1,
                       order = 4,
                       override.aes=list(size=1,alpha=1),
                       title.position="top")
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=36, face="bold"), 
        legend.text=element_text(size=22),
        legend.key.size = unit(10, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p7 <- p6 +
  new_scale_fill() +
  geom_fruit(geom=geom_star,
             mapping=aes(fill=haplogroup1),
             size=30,
             starstroke=0,
             pwidth=0.2,
             inherit.aes = FALSE,
             grid.params=list(linetype=3, size=0.2)) +
  scale_fill_manual(
    name="Haplogroup",
    values = Haplocolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       order=3,
                       nrow = 2, byrow = TRUE,
                       override.aes=list(size=10)),
    na.translate=FALSE) +
  scale_starshape_discrete(guide="none") +
  ggtitle("Indonesia") + 
  theme(plot.title = element_text(size = 100, face = "bold")) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=40, face="bold"), 
        legend.text=element_text(size=30),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "right") + 
  new_scale_colour()
p7

ggsave(filename = file.path("figures", "Tree_Indonesia_new.png"), width = 49, height = 33)

## Philippines

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

tree <- phytools::read.newick("Philippines.newick")
tree$tip.label <- gsub("'", "", tree$tip.label)
tree$tip.label <- gsub("_", "", tree$tip.label)
tree$tip.label <- gsub("-", "", tree$tip.label)
tree$tip.label <- gsub(" ", "", tree$tip.label)
tree$tip.label <- gsub(",", "", tree$tip.label)
tree$tip.label <- trimws(gsub("\\s+", " ", tree$tip.label))

options(max.print=1000000)

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
dat$name <- gsub("\\+", "", dat$name)
dat$name <- gsub("\\'", "", dat$name)
dat$name <- gsub("\\(", "", dat$name)
dat$name <- gsub("\\)", "", dat$name)
dat$name <- gsub("\\_", "", dat$name)
dat$name <- gsub("\\-", "", dat$name)
dat$name <- gsub(" ", "", dat$name)
dat$name <- gsub("\\*", "", dat$name)
dat$name <- gsub("\\@", "", dat$name)
dat$name <- gsub("\\!", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat <- dat %>%
  mutate(name=ifelse(name=="Philippines.FTDNA233764.JX390633.M7b3a", "Philippines.FTDNA",
                     ifelse(name=="Philippines.FTDNA254214.KF006361.E1a1a1", "Philippines.FTDNA2",
                            ifelse(name=="Philippines.FTDNAB638234.MT832322.P9a", "Philippines.FTDNA3",
                                   ifelse(name=="Philippines.FTDNAIN49404.MK590045.B5b1c", "Philippines.FTDNA4",
                                          ifelse(name=="Philippines.FTDNAIN59697.MN053904.E2a", "Philippines.FTDNA5",
                                                 name))))))

dat2 <- dat %>% filter(!name %in% tree$tip.label)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
table(tree$tip.label %in% dat$name)
table(dat$name %in% tree$tip.label)
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`))))))))))))))))))) %>%
  droplevels() %>%
  filter(Country=="Philippines")

countries <- c("Philippines")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

filename <- "Philippines.NEXUS"
tree2 <- ape::read.nexus(filename)
tree2$tip.label <- gsub("'", "", tree2$tip.label)
tree2$tip.label <- gsub("_", "", tree2$tip.label)
tree2$tip.label <- gsub("-", "", tree2$tip.label)
tree2$tip.label <- gsub(" ", "", tree2$tip.label)
tree2$tip.label <- gsub(",", "", tree2$tip.label)
tree2$tip.label <- trimws(gsub("\\s+", " ", tree2$tip.label))

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Austronesian", "Mayan")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Abaknon", "Aeta (Agta)", "Batak", "Bugkalot (or Ilongot)", "Cebuano - Filipino", "Cuyunin (or Cuyonon)", "Filipino (or Tagalog)", "Ibaloi", "Ifugao", "Ivatan", "Kankanaey (or Igorot)", "Mamanwa", "Manabo", "Maranao", "Surigaonon", "Tagbanua", "The Kalanguya (or Ikalahan)")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("B", "D", "E", "F", "H", "M", "N", "P", "Q", "R", "Y", "Z")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(tree2, layout='circular')

p <- p %<+% metadata

p1 <- p +
  geom_tippoint(aes(color=Country),
                size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p4 <-p1 +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=`Language family`),
    width=0.0004,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Language",
    values=Languagecolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=1,
                       override.aes=list(size=10,alpha=1))
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"), 
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p6 <- p4 +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=Ethnicity),
    width=0.0004,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Ethnicity",
    values=Ethniccolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       ncol = 1,
                       order = 4,
                       override.aes=list(size=1,alpha=1),
                       title.position="top")
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=36, face="bold"), 
        legend.text=element_text(size=22),
        legend.key.size = unit(10, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p7 <- p6 +
  new_scale_fill() +
  geom_fruit(geom=geom_star,
             mapping=aes(fill=haplogroup1),
             size=30,
             starstroke=0,
             pwidth=0.2,
             inherit.aes = FALSE,
             grid.params=list(linetype=3, size=0.2)) +
  scale_fill_manual(
    name="Haplogroup",
    values = Haplocolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       order=3,
                       nrow = 2, byrow = TRUE,
                       override.aes=list(size=10)),
    na.translate=FALSE) +
  scale_starshape_discrete(guide="none") +
  ggtitle("Philippines") + 
  theme(plot.title = element_text(size = 100, face = "bold")) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=40, face="bold"), 
        legend.text=element_text(size=30),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "right") + 
  new_scale_colour()
p7

ggsave(filename = file.path("figures", "Tree_Philippines_new.png"), width = 49, height = 33)

## Cambodia

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

tree <- phytools::read.newick("Cambodia.newick")
tree$tip.label <- gsub("'", "", tree$tip.label)
tree$tip.label <- gsub("_", "", tree$tip.label)
tree$tip.label <- gsub("-", "", tree$tip.label)
tree$tip.label <- gsub(" ", "", tree$tip.label)
tree$tip.label <- gsub(",", "", tree$tip.label)
tree$tip.label <- trimws(gsub("\\s+", " ", tree$tip.label))

options(max.print=1000000)

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
dat$name <- gsub("\\+", "", dat$name)
dat$name <- gsub("\\'", "", dat$name)
dat$name <- gsub("\\(", "", dat$name)
dat$name <- gsub("\\)", "", dat$name)
dat$name <- gsub("\\_", "", dat$name)
dat$name <- gsub("\\-", "", dat$name)
dat$name <- gsub(" ", "", dat$name)
dat$name <- gsub("\\*", "", dat$name)
dat$name <- gsub("\\@", "", dat$name)
dat$name <- gsub("\\!", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat2 <- dat %>% filter(!name %in% tree$tip.label)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
table(tree$tip.label %in% dat$name)
table(dat$name %in% tree$tip.label)
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`))))))))))))))))))) %>%
  droplevels() %>%
  filter(Country=="Cambodia")

countries <- c("Cambodia")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

filename <- "Cambodia.NEXUS"
tree2 <- ape::read.nexus(filename)
tree2$tip.label <- gsub("'", "", tree2$tip.label)
tree2$tip.label <- gsub("_", "", tree2$tip.label)
tree2$tip.label <- gsub("-", "", tree2$tip.label)
tree2$tip.label <- gsub(" ", "", tree2$tip.label)
tree2$tip.label <- gsub(",", "", tree2$tip.label)
tree2$tip.label <- trimws(gsub("\\s+", " ", tree2$tip.label))

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Austroasiatic", "Austroasiatic, Austronesian", "Austronesian", "Tai-Kadai", "Unknown")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Bru (Brao)", "Cham", "Jarai", "Khmer", "Khmer Loeu", "Kreung", "Lao", "Lun", "Mel Khaonh", "Phnong", "Stieng", "Tompoun", "Unknown")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("B", "C", "D", "F", "M", "N", "R", "U", "W", "Z")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(tree2, layout='circular')

p <- p %<+% metadata

p1 <- p +
  geom_tippoint(aes(color=Country),
                size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p4 <-p1 +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=`Language family`),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Language",
    values=Languagecolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=1,
                       override.aes=list(size=10,alpha=1))
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"), 
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p6 <- p4 +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=Ethnicity),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Ethnicity",
    values=Ethniccolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       ncol = 1,
                       order = 4,
                       override.aes=list(size=1,alpha=1),
                       title.position="top")
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=36, face="bold"), 
        legend.text=element_text(size=22),
        legend.key.size = unit(10, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p7 <- p6 +
  new_scale_fill() +
  geom_fruit(geom=geom_star,
             mapping=aes(fill=haplogroup1),
             size=30,
             starstroke=0,
             pwidth=0.2,
             inherit.aes = FALSE,
             grid.params=list(linetype=3, size=0.2)) +
  scale_fill_manual(
    name="Haplogroup",
    values = Haplocolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       order=3,
                       nrow = 2, byrow = TRUE,
                       override.aes=list(size=10)),
    na.translate=FALSE) +
  scale_starshape_discrete(guide="none") +
  ggtitle("Cambodia") + 
  theme(plot.title = element_text(size = 100, face = "bold")) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=40, face="bold"), 
        legend.text=element_text(size=30),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "right") + 
  new_scale_colour()
p7

ggsave(filename = file.path("figures", "Tree_Cambodia_new.png"), width = 49, height = 33)

## Myanmar

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

tree <- phytools::read.newick("Myanmar.newick")
tree$tip.label <- gsub("'", "", tree$tip.label)
tree$tip.label <- gsub("_", "", tree$tip.label)
tree$tip.label <- gsub("-", "", tree$tip.label)
tree$tip.label <- gsub(" ", "", tree$tip.label)
tree$tip.label <- gsub(",", "", tree$tip.label)
tree$tip.label <- trimws(gsub("\\s+", " ", tree$tip.label))

options(max.print=1000000)

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
dat$name <- gsub("\\+", "", dat$name)
dat$name <- gsub("\\'", "", dat$name)
dat$name <- gsub("\\(", "", dat$name)
dat$name <- gsub("\\)", "", dat$name)
dat$name <- gsub("\\_", "", dat$name)
dat$name <- gsub("\\-", "", dat$name)
dat$name <- gsub(" ", "", dat$name)
dat$name <- gsub("\\*", "", dat$name)
dat$name <- gsub("\\@", "", dat$name)
dat$name <- gsub("\\!", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat <- dat %>%
  mutate(name=ifelse(name=="Myanmar.FTDNA347650.MH571405.C7a2", "Myanmar.FTDNA",
                     name))
dat2 <- dat %>% filter(!name %in% tree$tip.label)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
table(tree$tip.label %in% dat$name)
table(dat$name %in% tree$tip.label)
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`))))))))))))))))))) %>%
  droplevels() %>%
  filter(Country=="Myanmar")

countries <- c("Myanmar")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

filename <- "Myanmar.NEXUS"
tree2 <- ape::read.nexus(filename)
tree2$tip.label <- gsub("'", "", tree2$tip.label)
tree2$tip.label <- gsub("_", "", tree2$tip.label)
tree2$tip.label <- gsub("-", "", tree2$tip.label)
tree2$tip.label <- gsub(" ", "", tree2$tip.label)
tree2$tip.label <- gsub(",", "", tree2$tip.label)
tree2$tip.label <- trimws(gsub("\\s+", " ", tree2$tip.label))

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Austroasiatic", "Sino-Tibetan", "Tai-Kadai", "Unknown")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Achang", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Dai", "Dawei", "Deang", "English", "Han", "Jingpo", "Karen", "Lisu", "Mon", "Naga", "Shan", "Unknown")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("B", "C", "D", "G", "H", "M", "N", "R", "U")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(tree2, layout='circular')

p <- p %<+% metadata

p1 <- p +
  geom_tippoint(aes(color=Country),
                size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p4 <-p1 +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=`Language family`),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Language",
    values=Languagecolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=1,
                       override.aes=list(size=10,alpha=1))
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"), 
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p6 <- p4 +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=Ethnicity),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Ethnicity",
    values=Ethniccolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       ncol = 1,
                       order = 4,
                       override.aes=list(size=1,alpha=1),
                       title.position="top")
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=36, face="bold"), 
        legend.text=element_text(size=22),
        legend.key.size = unit(10, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p7 <- p6 +
  new_scale_fill() +
  geom_fruit(geom=geom_star,
             mapping=aes(fill=haplogroup1),
             size=30,
             starstroke=0,
             pwidth=0.2,
             inherit.aes = FALSE,
             grid.params=list(linetype=3, size=0.2)) +
  scale_fill_manual(
    name="Haplogroup",
    values = Haplocolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       order=3,
                       nrow = 2, byrow = TRUE,
                       override.aes=list(size=10)),
    na.translate=FALSE) +
  scale_starshape_discrete(guide="none") +
  ggtitle("Myanmar") + 
  theme(plot.title = element_text(size = 100, face = "bold")) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=40, face="bold"), 
        legend.text=element_text(size=30),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "right") + 
  new_scale_colour()
p7

ggsave(filename = file.path("figures", "Tree_Myanmar_new.png"), width = 49, height = 33)

## Malaysia

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

tree <- phytools::read.newick("Malaysia.newick")
tree$tip.label <- gsub("'", "", tree$tip.label)
tree$tip.label <- gsub("_", "", tree$tip.label)
tree$tip.label <- gsub("-", "", tree$tip.label)
tree$tip.label <- gsub(" ", "", tree$tip.label)
tree$tip.label <- gsub(",", "", tree$tip.label)
tree$tip.label <- trimws(gsub("\\s+", " ", tree$tip.label))

options(max.print=1000000)

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
dat$name <- gsub("\\+", "", dat$name)
dat$name <- gsub("\\'", "", dat$name)
dat$name <- gsub("\\(", "", dat$name)
dat$name <- gsub("\\)", "", dat$name)
dat$name <- gsub("\\_", "", dat$name)
dat$name <- gsub("\\-", "", dat$name)
dat$name <- gsub(" ", "", dat$name)
dat$name <- gsub("\\*", "", dat$name)
dat$name <- gsub("\\@", "", dat$name)
dat$name <- gsub("\\!", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat <- dat %>%
  mutate(name=ifelse(name=="Malaysia.FTDNAB670911.ON792208.M3c1a", "Malaysia.FTDNA",
                     name))
dat2 <- dat %>% filter(!name %in% tree$tip.label)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
table(tree$tip.label %in% dat$name)
table(dat$name %in% tree$tip.label)
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`))))))))))))))))))) %>%
  droplevels() %>%
  filter(Country=="Malaysia")

countries <- c("Malaysia")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

filename <- "Malaysia.NEXUS"
tree2 <- ape::read.nexus(filename)
tree2$tip.label <- gsub("'", "", tree2$tip.label)
tree2$tip.label <- gsub("_", "", tree2$tip.label)
tree2$tip.label <- gsub("-", "", tree2$tip.label)
tree2$tip.label <- gsub(" ", "", tree2$tip.label)
tree2$tip.label <- gsub(",", "", tree2$tip.label)
tree2$tip.label <- trimws(gsub("\\s+", " ", tree2$tip.label))

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Austroasiatic", "Austroasiatic, Austronesian", "Austronesian", "Austronesian, Sino-Tibetan")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Banjar", "Batek", "Bidayuh", "Bugis", "Bumiputera", "Jahai, Semang", "Javanese", "Jehai", "Kadazan-Dusun", "Kensiu", "Kintaq", "Malay", "Malay, Achehnese", "Minangkabau", "Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Orang Asli", "Seletar", "Semelai", "Temuan")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("B", "E", "F", "G", "M", "N", "R", "Y")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(tree2, layout='circular')

p <- p %<+% metadata

p1 <- p +
  geom_tippoint(aes(color=Country),
                size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p4 <-p1 +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=`Language family`),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Language",
    values=Languagecolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=1,
                       override.aes=list(size=10,alpha=1))
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"), 
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p6 <- p4 +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=Ethnicity),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Ethnicity",
    values=Ethniccolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       ncol = 1,
                       order = 4,
                       override.aes=list(size=1,alpha=1),
                       title.position="top")
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=36, face="bold"), 
        legend.text=element_text(size=22),
        legend.key.size = unit(10, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p7 <- p6 +
  new_scale_fill() +
  geom_fruit(geom=geom_star,
             mapping=aes(fill=haplogroup1),
             size=30,
             starstroke=0,
             pwidth=0.2,
             inherit.aes = FALSE,
             grid.params=list(linetype=3, size=0.2)) +
  scale_fill_manual(
    name="Haplogroup",
    values = Haplocolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       order=3,
                       nrow = 2, byrow = TRUE,
                       override.aes=list(size=10)),
    na.translate=FALSE) +
  scale_starshape_discrete(guide="none") +
  ggtitle("Malaysia") + 
  theme(plot.title = element_text(size = 100, face = "bold")) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=40, face="bold"), 
        legend.text=element_text(size=30),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "right") + 
  new_scale_colour()
p7

ggsave(filename = file.path("figures", "Tree_Malaysia_new.png"), width = 49, height = 33)

## Brunei

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

tree <- phytools::read.newick("Brunei.newick")
tree$tip.label <- gsub("'", "", tree$tip.label)
tree$tip.label <- gsub("_", "", tree$tip.label)
tree$tip.label <- gsub("-", "", tree$tip.label)
tree$tip.label <- gsub(" ", "", tree$tip.label)
tree$tip.label <- gsub(",", "", tree$tip.label)
tree$tip.label <- trimws(gsub("\\s+", " ", tree$tip.label))

options(max.print=1000000)

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
dat$name <- gsub("\\+", "", dat$name)
dat$name <- gsub("\\'", "", dat$name)
dat$name <- gsub("\\(", "", dat$name)
dat$name <- gsub("\\)", "", dat$name)
dat$name <- gsub("\\_", "", dat$name)
dat$name <- gsub("\\-", "", dat$name)
dat$name <- gsub(" ", "", dat$name)
dat$name <- gsub("\\*", "", dat$name)
dat$name <- gsub("\\@", "", dat$name)
dat$name <- gsub("\\!", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat2 <- dat %>% filter(!name %in% tree$tip.label)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
table(tree$tip.label %in% dat$name)
table(dat$name %in% tree$tip.label)
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`))))))))))))))))))) %>%
  droplevels() %>%
  filter(Country=="Brunei")

countries <- c("Brunei")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

filename <- "Brunei.NEXUS"
tree2 <- ape::read.nexus(filename)
tree2$tip.label <- gsub("'", "", tree2$tip.label)
tree2$tip.label <- gsub("_", "", tree2$tip.label)
tree2$tip.label <- gsub("-", "", tree2$tip.label)
tree2$tip.label <- gsub(" ", "", tree2$tip.label)
tree2$tip.label <- gsub(",", "", tree2$tip.label)
tree2$tip.label <- trimws(gsub("\\s+", " ", tree2$tip.label))

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Austronesian")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Bruneian Malay")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("B", "F", "M", "Y")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(tree2, layout='circular')

p <- p %<+% metadata

p1 <- p +
  geom_tippoint(aes(color=Country),
                size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p4 <-p1 +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=`Language family`),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Language",
    values=Languagecolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=1,
                       override.aes=list(size=10,alpha=1))
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"), 
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p6 <- p4 +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=Ethnicity),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Ethnicity",
    values=Ethniccolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       ncol = 1,
                       order = 4,
                       override.aes=list(size=1,alpha=1),
                       title.position="top")
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=36, face="bold"), 
        legend.text=element_text(size=22),
        legend.key.size = unit(10, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p7 <- p6 +
  new_scale_fill() +
  geom_fruit(geom=geom_star,
             mapping=aes(fill=haplogroup1),
             size=30,
             starstroke=0,
             pwidth=0.2,
             inherit.aes = FALSE,
             grid.params=list(linetype=3, size=0.2)) +
  scale_fill_manual(
    name="Haplogroup",
    values = Haplocolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       order=3,
                       nrow = 2, byrow = TRUE,
                       override.aes=list(size=10)),
    na.translate=FALSE) +
  scale_starshape_discrete(guide="none") +
  ggtitle("Brunei") + 
  theme(plot.title = element_text(size = 100, face = "bold")) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=40, face="bold"), 
        legend.text=element_text(size=30),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "right") + 
  new_scale_colour()
p7

ggsave(filename = file.path("figures", "Tree_Brunei_new.png"), width = 49, height = 33)

## Laos

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

tree <- phytools::read.newick("Laos.newick")
tree$tip.label <- gsub("'", "", tree$tip.label)
tree$tip.label <- gsub("_", "", tree$tip.label)
tree$tip.label <- gsub("-", "", tree$tip.label)
tree$tip.label <- gsub(" ", "", tree$tip.label)
tree$tip.label <- gsub(",", "", tree$tip.label)
tree$tip.label <- trimws(gsub("\\s+", " ", tree$tip.label))

options(max.print=1000000)

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
dat$name <- gsub("\\+", "", dat$name)
dat$name <- gsub("\\'", "", dat$name)
dat$name <- gsub("\\(", "", dat$name)
dat$name <- gsub("\\)", "", dat$name)
dat$name <- gsub("\\_", "", dat$name)
dat$name <- gsub("\\-", "", dat$name)
dat$name <- gsub(" ", "", dat$name)
dat$name <- gsub("\\*", "", dat$name)
dat$name <- gsub("\\@", "", dat$name)
dat$name <- gsub("\\!", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat2 <- dat %>% filter(!name %in% tree$tip.label)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
table(tree$tip.label %in% dat$name)
table(dat$name %in% tree$tip.label)
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`))))))))))))))))))) %>%
  droplevels() %>%
  filter(Country=="Laos")

countries <- c("Laos")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

filename <- "Laos.NEXUS"
tree2 <- ape::read.nexus(filename)
tree2$tip.label <- gsub("'", "", tree2$tip.label)
tree2$tip.label <- gsub("_", "", tree2$tip.label)
tree2$tip.label <- gsub("-", "", tree2$tip.label)
tree2$tip.label <- gsub(" ", "", tree2$tip.label)
tree2$tip.label <- gsub(",", "", tree2$tip.label)
tree2$tip.label <- trimws(gsub("\\s+", " ", tree2$tip.label))

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Hmong-Mien", "Tai-Kadai")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Hmong", "Lao")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("B", "C", "D", "F", "M", "N", "R")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(tree2, layout='circular')

p <- p %<+% metadata

p1 <- p +
  geom_tippoint(aes(color=Country),
                size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p4 <-p1 +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=`Language family`),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Language",
    values=Languagecolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=1,
                       override.aes=list(size=10,alpha=1))
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"), 
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p6 <- p4 +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=Ethnicity),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Ethnicity",
    values=Ethniccolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       ncol = 1,
                       order = 4,
                       override.aes=list(size=1,alpha=1),
                       title.position="top")
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=36, face="bold"), 
        legend.text=element_text(size=22),
        legend.key.size = unit(10, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p7 <- p6 +
  new_scale_fill() +
  geom_fruit(geom=geom_star,
             mapping=aes(fill=haplogroup1),
             size=30,
             starstroke=0,
             pwidth=0.2,
             inherit.aes = FALSE,
             grid.params=list(linetype=3, size=0.2)) +
  scale_fill_manual(
    name="Haplogroup",
    values = Haplocolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       order=3,
                       nrow = 2, byrow = TRUE,
                       override.aes=list(size=10)),
    na.translate=FALSE) +
  scale_starshape_discrete(guide="none") +
  ggtitle("Laos") + 
  theme(plot.title = element_text(size = 100, face = "bold")) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=40, face="bold"), 
        legend.text=element_text(size=30),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "right") + 
  new_scale_colour()
p7

ggsave(filename = file.path("figures", "Tree_Laos_new.png"), width = 49, height = 33)

## Timor-Leste

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

tree <- phytools::read.newick("Timor-Leste.newick")
tree$tip.label <- gsub("'", "", tree$tip.label)
tree$tip.label <- gsub("_", "", tree$tip.label)
tree$tip.label <- gsub("-", "", tree$tip.label)
tree$tip.label <- gsub(" ", "", tree$tip.label)
tree$tip.label <- gsub(",", "", tree$tip.label)
tree$tip.label <- trimws(gsub("\\s+", " ", tree$tip.label))

options(max.print=1000000)

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
dat$name <- gsub("\\+", "", dat$name)
dat$name <- gsub("\\'", "", dat$name)
dat$name <- gsub("\\(", "", dat$name)
dat$name <- gsub("\\)", "", dat$name)
dat$name <- gsub("\\_", "", dat$name)
dat$name <- gsub("\\-", "", dat$name)
dat$name <- gsub(" ", "", dat$name)
dat$name <- gsub("\\*", "", dat$name)
dat$name <- gsub("\\@", "", dat$name)
dat$name <- gsub("\\!", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat2 <- dat %>% filter(!name %in% tree$tip.label)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
table(tree$tip.label %in% dat$name)
table(dat$name %in% tree$tip.label)
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`))))))))))))))))))) %>%
  droplevels() %>%
  filter(Country=="Timor-Leste")

countries <- c("Timor-Leste")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

filename <- "Timor-Leste.NEXUS"
tree2 <- ape::read.nexus(filename)
tree2$tip.label <- gsub("'", "", tree2$tip.label)
tree2$tip.label <- gsub("_", "", tree2$tip.label)
tree2$tip.label <- gsub("-", "", tree2$tip.label)
tree2$tip.label <- gsub(" ", "", tree2$tip.label)
tree2$tip.label <- gsub(",", "", tree2$tip.label)
tree2$tip.label <- trimws(gsub("\\s+", " ", tree2$tip.label))

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Austronesian, Trans–New Guinea")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Tetum, Mambai, Makasae")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("D", "M", "P", "Q", "R")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(tree2, layout='circular')

p <- p %<+% metadata

p1 <- p +
  geom_tippoint(aes(color=Country),
                size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p4 <-p1 +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=`Language family`),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Language",
    values=Languagecolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=1,
                       override.aes=list(size=10,alpha=1))
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"), 
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p6 <- p4 +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=Ethnicity),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Ethnicity",
    values=Ethniccolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       ncol = 1,
                       order = 4,
                       override.aes=list(size=1,alpha=1),
                       title.position="top")
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=36, face="bold"), 
        legend.text=element_text(size=22),
        legend.key.size = unit(10, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p7 <- p6 +
  new_scale_fill() +
  geom_fruit(geom=geom_star,
             mapping=aes(fill=haplogroup1),
             size=30,
             starstroke=0,
             pwidth=0.2,
             inherit.aes = FALSE,
             grid.params=list(linetype=3, size=0.2)) +
  scale_fill_manual(
    name="Haplogroup",
    values = Haplocolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       order=3,
                       nrow = 2, byrow = TRUE,
                       override.aes=list(size=10)),
    na.translate=FALSE) +
  scale_starshape_discrete(guide="none") +
  ggtitle("Timor-Leste") + 
  theme(plot.title = element_text(size = 100, face = "bold")) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=40, face="bold"), 
        legend.text=element_text(size=30),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "right") + 
  new_scale_colour()
p7

ggsave(filename = file.path("figures", "Tree_Timor-Leste_new.png"), width = 49, height = 33)

## F tree full

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

options(max.print=1000000)

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

dat <- read_excel("IsolateExplanation.xlsx")
dat$name <- gsub("\\'", "_", dat$name)
dat$name <- gsub("\\@", "_", dat$name)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",`Language family`)))))))))))))),
         `Language family`=ifelse(`Language family`=="Austronesian, Austroasiatic" | `Language family`=="Austroasiatic, Austronesian", "Austroasiatic, Austronesian, Sino-Tibetan",
                                  ifelse(`Language family`=="Austronesian, Spanish" | `Language family`=="Austronesian, Trans-New Guinea" | `Language family`=="Papuan, Austronesian, English", "Austronesian",
                                         ifelse(`Language family`=="Hmong-Mien" | `Language family`=="Hmong-Mien, Mongolic", "Hmong-Mien +",
                                                ifelse(`Language family`=="Indo-European, Sino-Tibetan" | `Language family`=="Sino-Tibetan, Austroasiatic, Tai-Kadai" | `Language family`=="Sino-Tibetan, Tai-Kada" | `Language family`=="Tai-Kadai, Sino-Tibetan", "Sino-Tibetan +",
                                                       ifelse(`Language family`=="Trans-New Guinea" | `Language family`=="Trans–New Guinea (Alor-Pantar, Papuan)", "Trans-New Guinea +",
                                                              ifelse(`Language family`=="Austronesian, Austroasiatic, Indo-European", "Austroasiatic, Austronesian + (xSino-Tibetan)",
                                                                     ifelse(`Language family`=="Austroasiatic, Tai-Kadai" | `Language family`=="Austroasiatic, Tai-Kadai, Hmong-Mien, Sino-Tibetan" | `Language family`=="Tai-Kadai, Hmong-Mien, Austroasiatic", "Austroasiatic, Tai-Kadai +",
                                                                            ifelse(`Language family`=="Sino-Tibetan", "Sino-Tibetan +", `Language family`))))))))) %>%
  droplevels() %>%
  filter(haplogroup1=="F")

countries <- c("Brunei", "Cambodia", "Indonesia", "Laos", "Malaysia", "Philippines", "Thailand", "Vietnam")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

show_col("#39B600")

show_col(hue_pal(h = c(90, 180))(9))

file <- ("beast/FClean2.mcc.tre")
tree2 <- read.beast(file)
tree2@phylo$tip.label <- trimws(gsub("\\s+", " ", tree2@phylo$tip.label))

dat2 <- dat %>% filter(name %in% tree2@phylo$tip.label)

table(tree2@phylo$tip.label %in% dat$name)
table(dat$name %in% tree2@phylo$tip.label)

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian, Sino-Tibetan", "#cccc33",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kadai +", "#ffcc99",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="rCRS", "white",
                                                                  ifelse(`Language family`=="Hmong-Mien +", "#0099ff",
                                                                         ifelse(`Language family`=="Mayan", "#660000",
                                                                                ifelse(`Language family`=="Sino-Tibetan +", "#336699",
                                                                                       ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                              ifelse(`Language family`=="Trans-New Guinea +", "#66ccff",
                                                                                                     ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                            Language_color)))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Alor", "Ambelau, Ambonese", "Ambonese", "Balantak, Bali Aga, Balinese", "Bali Aga, Balinese", "Banjar", "Banjar, Bantenese, Banyumasan", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Bicolano", "Bidayuh", "Bruneian Malay", "Bugis", "Bugis, Malay", "Bugkalot (or Ilongot)", "Cebuano", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Filipino", "Filipino (or Tagalog)", "Ibaloi", "Ifugao", "Igorot", "Indonesian", "Ivatan", "Jarai", "Javanese", "Javanese, Malay", "Javanese, Palembang, Batak, Minangkabau, Komering", "Kadazan-Dusun", "Kankanaey", "Makassarese", "Malay", "Malay, Achehnese", "Malay, Banjar Malay", "Maranao", "Melanau", "Minahasa", "Minangkabau", "Moken", "Palembangese", "Papuan", "Seletar (or Orang Seletar)", "Semende", "SiLa", "Sumbanese", "Sundanese", "Surigaonon", "Tagalog", "Temuan", "Tetum", "The Kalanguya (or Ikalahan)", "Timorese", "Toraja", "UrakLawoi", "Zambal"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chinese", "Dai", "Deang", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "LaHu", "Naga"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Akar", "Akar Jambat", "Bru (Brao)", "Ede", "Giarai", "Jehai (or Jahai)", "Khmer", "Khuen", "Kinh", "Kintaq", "Kreung", "Mang", "Mon", "PaThen", "Phnong", "PhuLa", "Semelai", "Stieng", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Batek", "Jahai, Semang", "Kensiu", "Khmer, Cham, Chinese-Cambodian, Vietnamese", "Lisu", "LoLo", "Orang Asli"), "#cccc33",
                                                            ifelse(Ethnicity %in% c("Bunak", "Fataluku", "Kemak", "Makasae", "Makassai", "Mambai"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("CoLao", "Isan (or Lao)", "LaChi", "Lao", "Lao Islan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Nung", "Phutai", "Shan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "white",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan"), "#ffcc99",
                                                                                               ifelse(Ethnicity %in% c("Mam"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("Unknown"), "lightgrey", Ethnicity)))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Austroasiatic", "Austroasiatic, Austronesian, Sino-Tibetan", "Austroasiatic, Tai-Kadai +", "Austronesian", "Hmong-Mien +", "Sino-Tibetan +", "Tai-Kadai", "Unknown")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Abaknon", "Akar Jambat", "Alor", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Bidayuh", "Bruneian Malay", "Bugkalot (or Ilongot)", "CoLao", "Dao", "Dayak", "Ede", "Filipino", "Filipino (or Tagalog)", "Giarai", "HaNhi", "Hmong", "Ibaloi", "Ifugao", "Indonesian", "Isan (or Lao)", "IuMien", "Ivatan", "Jehai (or Jahai)", "Kadazan-Dusun", "Kankanaey", "Karen", "Khmer, Cham, Chinese-Cambodian, Vietnamese", "Khuen", "Kinh", "Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung", "LaChi", "Lahu", "LaHu", "Lao Islan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lisu", "LoLo", "Mang", "Maranao", "Moken", "Mon", "Nung", "PaThen", "PhuLa", "Phutai", "Semelai", "Semende", "Shan", "SiLa", "Surigaonon", "Tagalog", "Tay", "Tay Nung", "Thai", "The Kalanguya (or Ikalahan)", "Tompoun", "Unknown", "UrakLawoi")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("F")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(tree2@phylo, layout='circular')

p <- p %<+% metadata

p1 <- p +
  geom_tippoint(aes(color=Country),
                size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"))

p4 <-p1 +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=`Language family`),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Language",
    values=Languagecolors,
    guide=guide_legend(keywidth=3, 
                       keyheight=3, 
                       order=1,
                       override.aes=list(size=10,alpha=1))
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"), 
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p6 <- p4 +
  new_scale_fill() +
  geom_fruit(
    geom=geom_tile,
    mapping=aes(fill=Ethnicity),
    width=0.0003,
    offset=0.03
  ) +
  scale_fill_manual(
    name="Ethnicity",
    values=Ethniccolors,
    guide=guide_legend(keywidth=2, 
                       keyheight=3, 
                       ncol = 1,
                       order = 4,
                       override.aes=list(size=1,alpha=1),
                       title.position="top")
  ) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=36, face="bold"), 
        legend.text=element_text(size=22),
        legend.key.size = unit(10, "cm"),
        legend.spacing.y = unit(2, "cm")) + 
  new_scale_colour()

p7 <- p6 +
  geom_fruit(geom=geom_star,
             mapping=aes(fill=haplogroup1),
             size=30,
             starstroke=0,
             pwidth=0.2,
             inherit.aes = FALSE,
             grid.params=list(linetype=3, size=0.2)) +
  scale_fill_manual(
    name="Haplogroup",
    values = Haplocolors,
    guide=guide_legend(keywidth=1, 
                       keyheight=1, 
                       order=3,
                       nrow = 2, byrow = TRUE,
                       override.aes=list(size=10)),
    na.translate=FALSE) +
  scale_starshape_discrete(guide="none") +
  ggtitle("Haplogroup F") + 
  theme(plot.title = element_text(size = 100, face = "bold")) +
  theme(legend.background=element_rect(fill=NA),
        legend.title=element_text(size=40, face="bold"), 
        legend.text=element_text(size=30),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(1, "cm"),
        legend.box = "vertical",
        legend.direction = "vertical",
        legend.position = "right")
p7

ggsave(filename = file.path("figures", "Ftree_full.png"), width = 49, height = 33)

# BEAST

library(devtools)
# devtools::install_github("laduplessis/bdskytools")
library(bdskytools)
fname <- "beast/NClean.log.txt"
lf <- readLogfile(fname, burnin =0.1)
Re_sky <- getSkylineSubset(lf, "skyline.popSize1")
Re_hpd <- getMatrixHPD(Re_sky)
delta_hpd <- getHPD(lf$becomeUninfectiousRate)

plotSkyline (1:10, Re_hpd, type='step', ylab="Ne")

library(treeio)
library(ggtree)
library(tidytree)
help(offspring.treedata)

show_col(c("#0099ff", "#163566", "#336699", "#339900", "#660000", "#66ccff", "#9900ff", "#990f80", "#996666", "#99ff99", "#cc0000", "#cc66ff", "#cccc33", "#fa0f0c", "#ff6633", "#ff9999", "#ffcc33", "#ffcc99", "#ffff00"))

show_col(hue_pal()(10), borders = NA)

# F

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

show_col("#39B600")

show_col(hue_pal(h = c(90, 180))(9))

file <- ("beast/FClean2.mcc.tre")
beast <- read.beast(file)
beast@phylo$tip.label <- gsub("\\+", "", beast@phylo$tip.label)
beast@phylo$tip.label <- gsub("\\'", "", beast@phylo$tip.label)
beast@phylo$tip.label <- gsub("\\(", "", beast@phylo$tip.label)
beast@phylo$tip.label <- gsub("\\)", "", beast@phylo$tip.label)
beast@phylo$tip.label <- gsub("\\_", "", beast@phylo$tip.label)
beast@phylo$tip.label <- gsub(" ", "", beast@phylo$tip.label)
beast@phylo$tip.label <- gsub("\\*", "", beast@phylo$tip.label)
beast@phylo$tip.label <- gsub("\\@", "", beast@phylo$tip.label)
beast@phylo$tip.label <- gsub("\\!", "", beast@phylo$tip.label)
beast@phylo$tip.label <- gsub("\\,", "", beast@phylo$tip.label)
beast@phylo$tip.label <- gsub("\\,", "", beast@phylo$tip.label)
beast@phylo$tip.label <- trimws(gsub("\\s+", " ", beast@phylo$tip.label))

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)
library(scales)

dat <- read_excel("IsolateExplanation.xlsx")
dat$name <- gsub("\\+", "", dat$name)
dat$name <- gsub("\\'", "", dat$name)
dat$name <- gsub("\\(", "", dat$name)
dat$name <- gsub("\\)", "", dat$name)
dat$name <- gsub("\\_", "", dat$name)
dat$name <- gsub(" ", "", dat$name)
dat$name <- gsub("\\*", "", dat$name)
dat$name <- gsub("\\@", "", dat$name)
dat$name <- gsub("\\!", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat$name <- gsub("\\,", "", dat$name)
dat2 <- dat %>% filter(name %in% beast@phylo$tip.label)
dat$name <- trimws(gsub("\\s+", " ", dat$name))
table(beast@phylo$tip.label %in% dat$name)
table(dat$name %in% beast@phylo$tip.label)
dat <- as.data.frame(dat)

dat <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",`Language family`)))))))))))))),
         `Language family`=ifelse(`Language family`=="Austronesian, Austroasiatic" | `Language family`=="Austroasiatic, Austronesian", "Austroasiatic, Austronesian, Sino-Tibetan",
                                  ifelse(`Language family`=="Austronesian, Spanish" | `Language family`=="Austronesian, Trans-New Guinea" | `Language family`=="Papuan, Austronesian, English", "Austronesian",
                                         ifelse(`Language family`=="Hmong-Mien" | `Language family`=="Hmong-Mien, Mongolic", "Hmong-Mien +",
                                                ifelse(`Language family`=="Indo-European, Sino-Tibetan" | `Language family`=="Sino-Tibetan, Austroasiatic, Tai-Kadai" | `Language family`=="Sino-Tibetan, Tai-Kada" | `Language family`=="Tai-Kadai, Sino-Tibetan", "Sino-Tibetan +",
                                                       ifelse(`Language family`=="Trans-New Guinea" | `Language family`=="Trans–New Guinea (Alor-Pantar, Papuan)", "Trans-New Guinea +",
                                                              ifelse(`Language family`=="Austronesian, Austroasiatic, Indo-European", "Austroasiatic, Austronesian + (xSino-Tibetan)",
                                                                     ifelse(`Language family`=="Austroasiatic, Tai-Kadai" | `Language family`=="Austroasiatic, Tai-Kadai, Hmong-Mien, Sino-Tibetan" | `Language family`=="Tai-Kadai, Hmong-Mien, Austroasiatic", "Austroasiatic, Tai-Kadai +",
                                                                            ifelse(`Language family`=="Sino-Tibetan", "Sino-Tibetan +", `Language family`))))))))) %>%
  droplevels() %>%
  filter(haplogroup1=="F")

countries <- c("Brunei", "Cambodia", "Indonesia", "Laos", "Malaysia", "Philippines", "Thailand", "Vietnam")

# For the tip points
dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
dat1$Country <- factor(dat1$Country, levels=countries)
Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]

# For the haplogroup layer
dat3 <- dat %>% dplyr::select(c("name", "haplogroup2")) %>%
  melt(id="name", variable.name="haplo", value.name="haplogroup")

# For the clade group
dat4 <- dat %>% dplyr::select(c("name", "Language family"))
dat4 <- aggregate(.~`Language family`, dat4, FUN=paste, collapse=",")
clades <- lapply(dat4$name, function(x){unlist(strsplit(x,split=","))})
names(clades) <- dat4$`Language family`

info <- dat
cols <- Countrycolors

metadata <- dat %>%
  mutate(Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian, Sino-Tibetan", "#cccc33",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kadai +", "#ffcc99",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="rCRS", "white",
                                                                  ifelse(`Language family`=="Hmong-Mien +", "#0099ff",
                                                                         ifelse(`Language family`=="Mayan", "#660000",
                                                                                ifelse(`Language family`=="Sino-Tibetan +", "#336699",
                                                                                       ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                              ifelse(`Language family`=="Trans-New Guinea +", "#66ccff",
                                                                                                     ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                            Language_color)))))))))))),
         Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
                                 ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Alor", "Ambelau, Ambonese", "Ambonese", "Balantak, Bali Aga, Balinese", "Bali Aga, Balinese", "Banjar", "Banjar, Bantenese, Banyumasan", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Bicolano", "Bidayuh", "Bruneian Malay", "Bugis", "Bugis, Malay", "Bugkalot (or Ilongot)", "Cebuano", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Filipino", "Filipino (or Tagalog)", "Ibaloi", "Ifugao", "Igorot", "Indonesian", "Ivatan", "Jarai", "Javanese", "Javanese, Malay", "Javanese, Palembang, Batak, Minangkabau, Komering", "Kadazan-Dusun", "Kankanaey", "Makassarese", "Malay", "Malay, Achehnese", "Malay, Banjar Malay", "Maranao", "Melanau", "Minahasa", "Minangkabau", "Moken", "Palembangese", "Papuan", "Seletar (or Orang Seletar)", "Semende", "SiLa", "Sumbanese", "Sundanese", "Surigaonon", "Tagalog", "Temuan", "Tetum", "The Kalanguya (or Ikalahan)", "Timorese", "Toraja", "UrakLawoi", "Zambal"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chinese", "Dai", "Deang", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "LaHu", "Naga"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Akar", "Akar Jambat", "Bru (Brao)", "Ede", "Giarai", "Jehai (or Jahai)", "Khmer", "Khuen", "Kinh", "Kintaq", "Kreung", "Mang", "Mon", "PaThen", "Phnong", "PhuLa", "Semelai", "Stieng", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Batek", "Jahai, Semang", "Kensiu", "Khmer, Cham, Chinese-Cambodian, Vietnamese", "Lisu", "LoLo", "Orang Asli"), "#cccc33",
                                                            ifelse(Ethnicity %in% c("Bunak", "Fataluku", "Kemak", "Makasae", "Makassai", "Mambai"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("CoLao", "Isan (or Lao)", "LaChi", "Lao", "Lao Islan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Nung", "Phutai", "Shan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "white",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan"), "#ffcc99",
                                                                                               ifelse(Ethnicity %in% c("Mam"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("Unknown"), "lightgrey", Ethnicity)))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

metadata <- metadata %>%
  left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
  dplyr::select(c("name", "Country", "Country_color",
                  "Language family", "Language_color", "haplogroup1", "haplogroup2", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
  droplevels()

languages <- c("Austroasiatic", "Austroasiatic, Austronesian, Sino-Tibetan", "Austroasiatic, Tai-Kadai +", "Austronesian", "Hmong-Mien +", "Mayan", "rCRS", "RSRS", "Sino-Tibetan +", "Tai-Kadai", "Trans-New Guinea +", "Unknown")
Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]

ethnics <- c("Abaknon", "Achang", "Aini", "Akar", "Akar Jambat", "Alor", "Ambelau, Ambonese", "Ambonese", "Arakanese (or Rakhine)", "Balantak, Bali Aga, Balinese", "Bali Aga, Balinese", "Bamar (or Burman)", "Banjar", "Banjar, Bantenese, Banyumasan", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Batek", "Bicolano", "Bidayuh", "Bru (Brao)", "Bruneian Malay", "Bugis", "Bugis, Malay", "Bugkalot (or Ilongot)", "Bunak", "Cebuano", "Cebuano - Filipino", "Cham", "Chinese", "CoLao", "Cuyunin (or Cuyonon)", "Dai", "Dao", "Dayak", "Deang", "Ede", "Fataluku", "Filipino", "Filipino (or Tagalog)", "Giarai", "HaNhi", "Hmong", "Hui", "Ibaloi", "Ifugao", "Igorot", "Indonesian", "Isan (or Lao)", "IuMien", "Ivatan", "Jahai, Semang", "Jarai", "Javanese", "Javanese, Malay", "Javanese, Palembang, Batak, Minangkabau, Komering", "Jehai (or Jahai)", "Jingpo", "Kadazan-Dusun", "Kankanaey", "Karen", "Kemak", "Kensiu", "Khmer", "Khmer, Cham, Chinese-Cambodian, Vietnamese", "Khuen", "Kinh", "Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung", "Kintaq", "Kreung", "LaChi", "Lahu", "LaHu", "Lao", "Lao Islan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lisu", "LoLo", "Makasae", "Makassai", "Makassarese", "Malay", "Malay, Achehnese", "Malay, Banjar Malay", "Mam", "Mambai", "Mang", "Maranao", "Melanau", "Minahasa", "Minangkabau", "Moken", "Mon", "Naga", "Nung", "Orang Asli", "Palembangese", "Papuan", "PaThen", "Phnong", "PhuLa", "Phutai", "rCRS", "RSRS", "Seletar (or Orang Seletar)", "Semelai", "Semende", "Shan", "SiLa", "Stieng", "Sumbanese", "Sundanese", "Surigaonon", "Tagalog", "Tay", "Tay Nung", "Temuan", "Tetum", "Thai", "The Kalanguya (or Ikalahan)", "Timorese", "Tompoun", "Toraja", "Unknown", "UrakLawoi", "Zambal")
Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]

haplos <- c("A", "B", "C", "D", "E", "F", "G", "H", "I", "K", "L", "M", "N", "P", "Q", "R", "U", "W", "Y", "Z")
Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(beast, size=1.25, mrsd = "0-01-01") + 
  theme_tree2() + 
  scale_x_continuous(breaks=c(-60000,0), minor_breaks=seq(-60000,0,10000)) +
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#9DA700', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height), 0), 
                 subset=as.numeric(posterior) > 0.99 & height > 10000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5)

p <- p %<+% metadata

p

# p1 <- p %<+% meta2.ed + new_scale_color() + geom_tippoint(aes(color=Region), size=2.5, alpha=1, shape=20) + 
#   scale_colour_manual(name=levels(factor(meta2.ed$Region)), values = c("#97b3d0ff", "#002147", "#f0e1b9ff", "#bf87b3", "#ed254eff"))

p1 <- p %<+% metadata + 
  new_scale_color() +
  geom_tippoint(aes(color=Country), size=5) + 
  scale_color_manual(values=cols, 
                     guide=guide_legend(keywidth=2,
                                        keyheight=3,
                                        order=2,
                                        override.aes=list(size=15,alpha=1))) + 
  theme(legend.position="right",
        legend.background=element_rect(fill=NA),
        legend.title=element_text(size=30, face="bold"),
        legend.text=element_text(size=24),
        legend.key.size = unit(30, "cm"),
        legend.spacing.y = unit(2, "cm"))



## find nodes that represent F clades
tre1 <- beast@phylo
library(caper)
trenodelist <- clade.members.list(tre1, tip.labels = TRUE, include.nodes = FALSE)
F1 <- metadata[which(metadata$haplogroup2 == "F1"), "name"]
F2 <- metadata[which(metadata$haplogroup2 == "F2"), "name"]
F3 <- metadata[which(metadata$haplogroup2 == "F3"), "name"]
F4 <- metadata[which(metadata$haplogroup2 == "F4"), "name"]

findnode <- function(tree, tips) {
  require(caper)
  trenodelist <- clade.members.list(tree, tip.labels = TRUE, include.nodes = FALSE)
  kk <- c()
  for (i in 1:length(trenodelist)) {
    kk[i] <- all(all(trenodelist[[i]] %in% tips) & (length(trenodelist[[i]]) == length(tips)))
  }
  val <- names(trenodelist)[which(kk)]
  return(val)
}

ann_node <- c(findnode(tre1, F1),
              findnode(tre1, F2), 
              findnode(tre1, F3),
              findnode(tre1, F4))
dt <- data.frame(node=as.numeric(ann_node), name=c("F1", "F2", "F3", "F4"))

p1 <- p + new_scale_color() + geom_hilight(data=dt, mapping=aes(node=node, fill=name), alpha=0.5, type="rect")

#####################

# F

library(ggtree)
library(ggtreeExtra)
library(ggnewscale)
library(reshape2)
library(tidytree)
library(ggstar)
library(TDbook)
library(phytools)
library(ape)

show_col("#39B600")

show_col(hue_pal(h = c(90, 180))(9))

file <- ("beast/FClean2.mcc.tre")
beast <- read.beast(file)

# beast@phylo$tip.label <- gsub("\\+", "", beast@phylo$tip.label)
# beast@phylo$tip.label <- gsub("\\'", "", beast@phylo$tip.label)
# beast@phylo$tip.label <- gsub("\\(", "", beast@phylo$tip.label)
# beast@phylo$tip.label <- gsub("\\)", "", beast@phylo$tip.label)
# beast@phylo$tip.label <- gsub("\\_", "", beast@phylo$tip.label)
# beast@phylo$tip.label <- gsub(" ", "", beast@phylo$tip.label)
# beast@phylo$tip.label <- gsub("\\*", "", beast@phylo$tip.label)
# beast@phylo$tip.label <- gsub("\\@", "", beast@phylo$tip.label)
# beast@phylo$tip.label <- gsub("\\!", "", beast@phylo$tip.label)
# beast@phylo$tip.label <- gsub("\\,", "", beast@phylo$tip.label)
# beast@phylo$tip.label <- gsub("\\,", "", beast@phylo$tip.label)
# beast@phylo$tip.label <- trimws(gsub("\\s+", " ", beast@phylo$tip.label))
# 
# library(tidyr)
# library(dplyr)
# library(data.table)
# library(readxl)
# library(scales)
# 
# dat <- read_excel("IsolateExplanation.xlsx")
# dat$name <- gsub("\\+", "", dat$name)
# dat$name <- gsub("\\'", "", dat$name)
# dat$name <- gsub("\\(", "", dat$name)
# dat$name <- gsub("\\)", "", dat$name)
# dat$name <- gsub("\\_", "", dat$name)
# dat$name <- gsub(" ", "", dat$name)
# dat$name <- gsub("\\*", "", dat$name)
# dat$name <- gsub("\\@", "", dat$name)
# dat$name <- gsub("\\!", "", dat$name)
# dat$name <- gsub("\\,", "", dat$name)
# dat$name <- gsub("\\,", "", dat$name)
# dat2 <- dat %>% filter(name %in% beast@phylo$tip.label)
# dat$name <- trimws(gsub("\\s+", " ", dat$name))
# table(beast@phylo$tip.label %in% dat$name)
# table(dat$name %in% beast@phylo$tip.label)
# dat <- as.data.frame(dat)
# 
# dat <- dat %>%
#   mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
#                             ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
#          Country_color=NA,
#          Country_color=ifelse(Country=="Brunei", "#ff6633",
#                               ifelse(Country=="Cambodia", "#ffff00",
#                                      ifelse(Country=="Indonesia", "#9900ff",
#                                             ifelse(Country=="Laos", "#0099ff",
#                                                    ifelse(Country=="Malaysia", "#990f80",
#                                                           ifelse(Country=="Myanmar", "#99ff99",
#                                                                  ifelse(Country=="Philippines", "#cc66ff",
#                                                                         ifelse(Country=="Singapore", "#ff9999",
#                                                                                ifelse(Country=="Thailand", "#339900",
#                                                                                       ifelse(Country=="Timor-Leste", "#66ccff",
#                                                                                              ifelse(Country=="Vietnam", "#fa0f0c",
#                                                                                                     ifelse(Country=="RSRS", "black",
#                                                                                                            ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
#          `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
#                                   ifelse(Ethnicity=="Hmong", "Hmong-Mien",
#                                          ifelse(Ethnicity=="Shan", "Tai-Kadai",
#                                                 ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
#                                                        ifelse(Ethnicity=="Temuan", "Austronesian",
#                                                               ifelse(Ethnicity=="Maranao", "Austronesian",
#                                                                      ifelse(Ethnicity=="Semelai", "Austroasiatic",
#                                                                             ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
#                                                                                    ifelse(Ethnicity=="Jarai", "Austronesian",
#                                                                                           ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
#                                                                                                  ifelse(Ethnicity=="Alor", "Austronesian",
#                                                                                                         ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
#                                                                                                                ifelse(Ethnicity=="Timorese", "Austronesian",
#                                                                                                                       ifelse(Ethnicity=="Mang", "Austroasiatic",`Language family`)))))))))))))),
#          `Language family`=ifelse(`Language family`=="Austronesian, Austroasiatic" | `Language family`=="Austroasiatic, Austronesian", "Austroasiatic, Austronesian, Sino-Tibetan",
#                                   ifelse(`Language family`=="Austronesian, Spanish" | `Language family`=="Austronesian, Trans-New Guinea" | `Language family`=="Papuan, Austronesian, English", "Austronesian",
#                                          ifelse(`Language family`=="Hmong-Mien" | `Language family`=="Hmong-Mien, Mongolic", "Hmong-Mien +",
#                                                 ifelse(`Language family`=="Indo-European, Sino-Tibetan" | `Language family`=="Sino-Tibetan, Austroasiatic, Tai-Kadai" | `Language family`=="Sino-Tibetan, Tai-Kada" | `Language family`=="Tai-Kadai, Sino-Tibetan", "Sino-Tibetan +",
#                                                        ifelse(`Language family`=="Trans-New Guinea" | `Language family`=="Trans–New Guinea (Alor-Pantar, Papuan)", "Trans-New Guinea +",
#                                                               ifelse(`Language family`=="Austronesian, Austroasiatic, Indo-European", "Austroasiatic, Austronesian + (xSino-Tibetan)",
#                                                                      ifelse(`Language family`=="Austroasiatic, Tai-Kadai" | `Language family`=="Austroasiatic, Tai-Kadai, Hmong-Mien, Sino-Tibetan" | `Language family`=="Tai-Kadai, Hmong-Mien, Austroasiatic", "Austroasiatic, Tai-Kadai +",
#                                                                             ifelse(`Language family`=="Sino-Tibetan", "Sino-Tibetan +", `Language family`))))))))) %>%
#   droplevels()
# 
# countries <- c("Brunei", "Cambodia", "Indonesia", "Laos", "Malaysia", "Myanmar", "Philippines", "rCRS", "RSRS", "Singapore", "Thailand", "Timor-Leste", "Vietnam")
# 
# # For the tip points
# dat1 <- dat %>% dplyr::select(c("name", "Country", "Country_color", "haplogroup2"))
# dat1$Country <- factor(dat1$Country, levels=countries)
# Countrycolors <- dat1[match(countries,dat$Country),"Country_color"]
# 
# # For the haplogroup layer
# dat3 <- dat %>% dplyr::select(c("name", "haplogroup2")) %>%
#   melt(id="name", variable.name="haplo", value.name="haplogroup")
# 
# # For the clade group
# dat4 <- dat %>% dplyr::select(c("name", "Language family"))
# dat4 <- aggregate(.~`Language family`, dat4, FUN=paste, collapse=",")
# clades <- lapply(dat4$name, function(x){unlist(strsplit(x,split=","))})
# names(clades) <- dat4$`Language family`
# 
# info <- dat
# cols <- Countrycolors
# 
# metadata <- dat %>%
#   mutate(Language_color=NA,
#          Language_color=ifelse(`Language family`=="RSRS", "black",
#                                ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
#                                       ifelse(`Language family`=="Austroasiatic, Austronesian, Sino-Tibetan", "#cccc33",
#                                              ifelse(`Language family`=="Austroasiatic, Tai-Kadai +", "#ffcc99",
#                                                     ifelse(`Language family`=="Austronesian", "#9900ff",
#                                                            ifelse(`Language family`=="rCRS", "white",
#                                                                   ifelse(`Language family`=="Hmong-Mien +", "#0099ff",
#                                                                          ifelse(`Language family`=="Mayan", "#660000",
#                                                                                 ifelse(`Language family`=="Sino-Tibetan +", "#336699",
#                                                                                        ifelse(`Language family`=="Tai-Kadai", "#339900",
#                                                                                               ifelse(`Language family`=="Trans-New Guinea +", "#66ccff",
#                                                                                                      ifelse(`Language family`=="Unknown", "lightgrey",
#                                                                                                             Language_color)))))))))))),
#          Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
#                           ifelse(Ethnicity=="Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan",
#                                  ifelse(Ethnicity=="Yao", "Dao", Ethnicity))),
#          Ethnicity_color=NA,
#          Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Alor", "Ambelau, Ambonese", "Ambonese", "Balantak, Bali Aga, Balinese", "Bali Aga, Balinese", "Banjar", "Banjar, Bantenese, Banyumasan", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Bicolano", "Bidayuh", "Bruneian Malay", "Bugis", "Bugis, Malay", "Bugkalot (or Ilongot)", "Cebuano", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Filipino", "Filipino (or Tagalog)", "Ibaloi", "Ifugao", "Igorot", "Indonesian", "Ivatan", "Jarai", "Javanese", "Javanese, Malay", "Javanese, Palembang, Batak, Minangkabau, Komering", "Kadazan-Dusun", "Kankanaey", "Makassarese", "Malay", "Malay, Achehnese", "Malay, Banjar Malay", "Maranao", "Melanau", "Minahasa", "Minangkabau", "Moken", "Palembangese", "Papuan", "Seletar (or Orang Seletar)", "Semende", "SiLa", "Sumbanese", "Sundanese", "Surigaonon", "Tagalog", "Temuan", "Tetum", "The Kalanguya (or Ikalahan)", "Timorese", "Toraja", "UrakLawoi", "Zambal"), "#9900ff",
#                                 ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chinese", "Dai", "Deang", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "LaHu", "Naga"), "#336699",
#                                        ifelse(Ethnicity=="RSRS", "black",
#                                               ifelse(Ethnicity %in% c("Akar", "Akar Jambat", "Bru (Brao)", "Ede", "Giarai", "Jehai (or Jahai)", "Khmer", "Khuen", "Kinh", "Kintaq", "Kreung", "Mang", "Mon", "PaThen", "Phnong", "PhuLa", "Semelai", "Stieng", "Tompoun"), "#fa0f0c",
#                                                      ifelse(Ethnicity %in% c("Batek", "Jahai, Semang", "Kensiu", "Khmer, Cham, Chinese-Cambodian, Vietnamese", "Lisu", "LoLo", "Orang Asli"), "#cccc33",
#                                                             ifelse(Ethnicity %in% c("Bunak", "Fataluku", "Kemak", "Makasae", "Makassai", "Mambai"), "#66ccff",
#                                                                    ifelse(Ethnicity %in% c("CoLao", "Isan (or Lao)", "LaChi", "Lao", "Lao Islan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Nung", "Phutai", "Shan", "Tay", "Tay Nung", "Thai"), "#339900",
#                                                                           ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien"), "#0099ff",
#                                                                                  ifelse(Ethnicity %in% c("rCRS"), "white",
#                                                                                         ifelse(Ethnicity %in% c("Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan"), "#ffcc99",
#                                                                                                ifelse(Ethnicity %in% c("Mam"), "#660000",
#                                                                                                       ifelse(Ethnicity %in% c("Unknown"), "lightgrey", Ethnicity)))))))))))),
#          Haplogroup1_color=NA,
#          Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
#                                   ifelse(haplogroup1=="B", "#EA8331",
#                                          ifelse(haplogroup1=="C", "#D89000",
#                                                 ifelse(haplogroup1=="D", "#C09B00",
#                                                        ifelse(haplogroup1=="E", "#A3A500",
#                                                               ifelse(haplogroup1=="F", "#39B600",
#                                                                      ifelse(haplogroup1=="G", "#7CAE00",
#                                                                             ifelse(haplogroup1=="H", "yellow",
#                                                                                    ifelse(haplogroup1=="I", "#00BF7D",
#                                                                                           ifelse(haplogroup1=="K", "#00C1A3",
#                                                                                                  ifelse(haplogroup1=="L", "black",
#                                                                                                         ifelse(haplogroup1=="M", "#00BAE0",
#                                                                                                                ifelse(haplogroup1=="N", "#00B0F6",
#                                                                                                                       ifelse(haplogroup1=="P", "#35A2FF",
#                                                                                                                              ifelse(haplogroup1=="Q", "#9590FF",
#                                                                                                                                     ifelse(haplogroup1=="R", "#C77CFF",
#                                                                                                                                            ifelse(haplogroup1=="U", "#E76BF3",
#                                                                                                                                                   ifelse(haplogroup1=="W", "#FA62DB",
#                                                                                                                                                          ifelse(haplogroup1=="Y", "#FF62BC",
#                                                                                                                                                                 ifelse(haplogroup1=="Z", "#FF6A98",
#                                                                                                                                                                        Haplogroup1_color))))))))))))))))))))) %>%
#   droplevels()
# 
# metadata <- metadata %>%
#   left_join(dat1 %>% dplyr::select(name, Country_color)) %>% 
#   dplyr::select(c("name", "Country", "Country_color",
#                   "Language family", "Language_color", "haplogroup1", "haplogroup2", "Ethnicity", "Ethnicity_color", "Haplogroup1_color")) %>%
#   droplevels()
# 
# languages <- c("Austroasiatic", "Austroasiatic, Austronesian, Sino-Tibetan", "Austroasiatic, Tai-Kadai +", "Austronesian", "Hmong-Mien +", "Sino-Tibetan +", "Tai-Kadai", "Unknown")
# Languagecolors <- metadata[match(languages, metadata$`Language family`),"Language_color"]
# 
# ethnics <- c("Abaknon", "Akar Jambat", "Alor", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Bruneian Malay", "Bugkalot (or Ilongot)", "CoLao", "Dao", "Ede", "Filipino", "Filipino (or Tagalog)", "Giarai", "HaNhi", "Hmong", "Ibaloi", "Ifugao", "Indonesian", "Isan (or Lao)", "IuMien", "Ivatan", "Jehai (or Jahai)", "Kadazan-Dusun", "Kankanaey", "Karen", "Khmer, Cham, Chinese-Cambodian, Vietnamese", "Khuen", "Kinh", "Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung", "LaChi", "Lahu", "LaHu", "Lao Islan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Lisu", "LoLo", "Mang", "Maranao", "Moken", "Mon", "Nung", "PaThen", "PhuLa", "Phutai", "Semelai", "Semende", "Shan", "SiLa", "Surigaonon", "Tagalog", "Tay", "Tay Nung", "Thai", "The Kalanguya (or Ikalahan)", "Tompoun", "Unknown", "UrakLawoi")
# Ethniccolors <- metadata[match(ethnics, metadata$Ethnicity), "Ethnicity_color"]
# 
# haplos <- c("F")
# Haplocolors <- metadata[match(haplos, metadata$haplogroup1), "Haplogroup1_color"]

p <- ggtree(beast, size=1.25) + 
  theme_tree2() + 
  # scale_x_continuous(breaks=c(-60000,0), minor_breaks=seq(-60000,0,10000)) +
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#9DA700', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height), 0), 
                 subset=as.numeric(posterior) > 0.99 & height > 10000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5)

p1 <- p + 
  geom_strip('Thailand.CT457.MG272694.F3b', 'Vietnam.PaThen524.MH449356.F3a1', color='#85AD00',
             label="F3", offset = 0, offset.text=25, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) + 
  geom_strip('Vietnam.PaThen523.MH449355.F2a', 'Thailand.UT408.KX457584.F2e', color='#00BD5D', 
             label="F2", offset = 0, offset.text=25, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) + 
  geom_strip('Thailand.A2YU234.KX456507.F4b', 'Thailand.CT715.MG272762.F4a2', color='#00C1A9', 
             label="F4", offset = 0, offset.text=25, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) + 
  geom_strip('Thailand.BR_567.MN006847.F1', 'Cambodia.1_F1a1(Tor49).AY963572.F1a1a1', color='#35B600', 
             label="F1", offset = 0, offset.text=25, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup F") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

ggsave(filename = file.path("figures", "F_beast.png"), width = 33, height = 49)

# p1 <- p1 %<+% metadata
# 
# p2 <- p1 +
#   geom_tippoint(aes(color=Country),
#                 size=5) + 
#   scale_color_manual(values=cols, 
#                      guide=guide_legend(keywidth=2,
#                                         keyheight=3,
#                                         order=2,
#                                         override.aes=list(size=15,alpha=1))) + 
#   theme(legend.position="right",
#         legend.background=element_rect(fill=NA),
#         legend.title=element_text(size=30, face="bold"),
#         legend.text=element_text(size=24),
#         legend.key.size = unit(30, "cm"),
#         legend.spacing.y = unit(2, "cm"),
#         legend.box = "vertical",
#         legend.direction = "vertical") + 
#   new_scale_colour()
# 
# p4 <- p2 +
#   geom_fruit(
#     geom=geom_tile,
#     mapping=aes(fill=`Language family`),
#     width=0.5,
#     offset=0.3
#   ) +
#   scale_fill_manual(
#     name="Language",
#     values=Languagecolors,
#     guide=guide_legend(keywidth=3, 
#                        keyheight=3, 
#                        order=1,
#                        override.aes=list(size=10,alpha=1))
#   ) +
#   theme(legend.background=element_rect(fill=NA),
#         legend.title=element_text(size=30, face="bold"), 
#         legend.text=element_text(size=24),
#         legend.key.size = unit(30, "cm"),
#         legend.spacing.y = unit(2, "cm"),
#         legend.box = "vertical",
#         legend.direction = "vertical") + 
#   new_scale_colour()
# 
# ggsave(filename = file.path("figures", "F_beast_new.png"), width = 33, height = 49)

### F1a1a1

F1a1a1 <- tree_subset(beast, "Cambodia.1_F1a1(Tor49).AY963572.F1a1a1", levels_back = 13)

p <- ggtree(F1a1a1, size=1.25) + 
  geom_tiplab(align=F, linetype='dashed', linesize=.3, size=8) + 
  geom_range("height_0.95_HPD", color='#35B600', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height), 0), 
                 subset=as.numeric(posterior) > 0.8 & height > 2000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) +
  theme_tree2() + 
  xlim(0, 20000)

p1 <- p + 
  ggtitle("Haplogroup F1a1a1") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "F1a1a1_beast.png"), width = 33, height = 49)


# M

show_col("#00B0F6")

show_col(hue_pal(h = c(180, 270))(30))

file <- ("beast/MClean2.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#00B9E2', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Thailand.CT353.MG272662.M7b1a1a', 'Philippines.PH277.KU131352.M7a1a6', color='#00B1F5',
             label="M7", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.MON247.KX457137.M74b1', 'Vietnam.Thai254.MH449484.M74', color='#00AFF8',
             label="M74", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Cambodia.Kravet01_M12b.KC505075.M12b1a2a', 'Myanmar.MMR258.JX289125.M12a2*', color='#00ADFB',
             label="M12", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Malaysia.JHF043.AP012376.M21a', 'Indonesia.BJM093.MK128883.M21a', color='#00AAFE',
             label="M21", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.LW529.KX457032.M71+151', 'Indonesia.Le.HM436819.M71a2', color='#00A8FF',
             label="M71", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Cambodia.C100_Seim_Riep_M17c1a1a.KT587449.M17c1a1a', 'Thailand.BST135.OQ731963.M17', color='#00A5FF',
             label="M17", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.BRU137.KX456752.M20*', 'Laos.VIE143.KX457615.M20', color='#2DA2FF',
             label="M20", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Indonesia.Smd10.HM596681.M51a1a*1', 'Thailand.MST306.OQ731981.M51b*', color='#4A9FFF',
             label="M51", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Cambodia.Khmer02_M24.KC505094.M24a', 'Thailand.A2YU315.KX456515.M24b', color='#5E9CFF',
             label="M24", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Vietnam.Giarai734.MH449549.M73b', 'Indonesia.NU134.MN849530.M73a', color='#6E99FF',
             label="M73", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.PPA122.KX457270.M9a4a1', 'Vietnam.Cham10.HM346881.M9b', color='#7D96FF',
             label="M9", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Cambodia.Tompoun73_M68a.KC887482.M68a1a', 'Thailand.SO113.KX457409.M68a', color='#8993FF',
             label="M68", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Myanmar.MMR007.JX289092.M13c*', 'Vietnam.VNM396.KY686211.M13_46_61', color='#9490FF',
             label="M13", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Cambodia.C151_Kampong_Thom_M76.KT587500.M76*', 'Cambodia.Khmer01_M76a.KC505113.M76a', color='#9F8CFF',
             label="M76", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Myanmar.MMR302.JX289130.M91a', 'Thailand.PT141.KX457304.M91b', color='#00B3F2',
             label="M91", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.Thai271(M3).GU810074.M3c2', 'Cambodia.Lao44_M3d1.KC887469.M3d1a*', color='#00B5EE',
             label="M3", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.Moken209(M*).GU810018.M50a1', 'Myanmar.Burman618.KP346020.M50', color='#00B6EA',
             label="M50", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Laos.VIE131.KX457610.M72a', 'Myanmar.Burman376.KP345996.M72', color='#00B8E6',
             label="M72", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Cambodia.C275_Banteay_Meanchey_M1_20_51.KT587623.M1_20_51', 'Myanmar.JingpoSC1.KP346055.M1_20_51', color='#00B9E2',
             label="M1", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.TU121.MG273048.M61*', 'Thailand.SPP125.KX457445.M61', color='#00BADE',
             label="M61", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Philippines.AeZ1790_Aeta_Zambales.KC993961.M52a1b1', 'Philippines.Agl4396_Agta_Iriga.KC993968.M52a1b1', color='#00BCD9',
             label="M52", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Indonesia.Bes18.HM596653.M69', 'Cambodia.C246_Svay_Rieng_M69a.KT587594.M69a', color='#00BDD4',
             label="M69", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Cambodia.Lao013_Seim_Riep_M46.KT587362.M46', 'Myanmar.Burman631.KP346023.M46a', color='#00BECF',
             label="M46", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.MON321.KX457150.M49e1*', 'Myanmar.Burman249.KP345991.M49', color='#00BECA',
             label="M49", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.MLB121.KX457077.M5a', 'Vietnam.Thai262.MH449488.M5', color='#00BFC5',
             label="M5", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Myanmar.MMR054.JX289101.M10a1', 'Vietnam.CoLao578.MH448959.M10', color='#00BFC0',
             label="M10", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.TU443.MG273133.M8a2a1*', 'Thailand.A3YU123.KX456620.M8a2a1', color='#00C0BA',
             label="M8", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Indonesia.Smd5.HM596712.M26', 'Thailand.BST105.OQ731948.M26', color='#00C0B5',
             label="M26", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Myanmar.JingpoAS1.KP346052.M55', 'Myanmar.LisuDI1.KP346057.M55', color='#00C0AF',
             label="M55", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Myanmar.LP533.KP346063.M54', 'Thailand.Thai329(M*).GU810077.M54', color='#00C1A9',
             label="M54", offset = 0, offset.text=0, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup M") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "M_beast2.png"), width = 33, height = 49)

### M7b1a1

M7b1a1 <- tree_subset(beast, "Thailand.CT353.MG272662.M7b1a1a", levels_back = 15)

p <- ggtree(M7b1a1, size=1.25) + 
  geom_tiplab(align=F, linetype='dashed', linesize=.3, size=8) + 
  geom_range("height_0.95_HPD", color='#00B1F5', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) > 0.8 & height_median > 2000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) +
  theme_tree2() + 
  xlim(0, 20000)

p1 <- p + 
  ggtitle("Haplogroup M7b1a1") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "M7b1a1_beast.png"), width = 33, height = 49)

# B

show_col("#EA8331")

show_col(hue_pal(h = c(30, 90))(30))

file <- ("beast/BClean4.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#EA8331', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Philippines.Kla3638_Kalangoya.KC994109.B4a1a', 'Vietnam.LoLo481.MH449240.B4c', color='#ED813E',
             label="B4", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Vietnam.Nung696.MH449323.B6a', 'Thailand.A4YU111.KX456637.B6a1', color='#CB9600',
             label="B6", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.KAL131.KX456768.B5a1a', 'Vietnam.Kinh22.MH449119.B5b2.204', color='#9DA700',
             label="B5", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup B") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "B_beast.png"), width = 33, height = 49)

# N

show_col("#00B0F6")

show_col(hue_pal(h = c(180, 270))(30))

file <- ("beast/NClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#00B0F6', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Malaysia.TMF061.AP012421.N9a6a', 'Vietnam.VN-302.DQ834255.N9a6', color='#00C1A9',
             label="N9", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Malaysia.TMM010.AP012423.N21a', 'Myanmar.Burman614.KP346019.N21+195', color='#00C0BA',
             label="N21", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Philippines.CUY2.JF739542.N22', 'Cambodia.C178_Kampong_Thom_N22.KT587527.N22', color='#00BECA',
             label="N22", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.UT427.KX457594.N8*', 'Myanmar.MMR168.JX289118.N8', color='#00BCD9',
             label="N8", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Cambodia.Brao25_N7.KC887472.N7a2', 'Cambodia.C254_Kampong_Cham_N7b.KT587602.N7b', color='#00B8E6',
             label="N7", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.LW608.KX457046.N10a', 'Thailand.A2YU613.KX456589.N10b', color='#00B3F2',
             label="N10", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup N") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "N_beast.png"), width = 33, height = 49)


# P

show_col("#35A2FF")

show_col(hue_pal(h = c(180, 270))(30))

file <- ("beast/PClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#35A2FF', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Indonesia.PB119.MN849692.P1d1', 'Indonesia.PB76.MN849727.P1', color='#2DA2FF',
             label="P1", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Indonesia.PNG87.MN849861.P2', 'Indonesia.NU71.MN849579.P', color='#4A9FFF',
             label="P2", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Indonesia.NV16.MN849600.P3b', 'Indonesia.PNG80.MN849856.P3b', color='#5E9CFF',
             label="P3", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Philippines.PH285.GQ119036.P10', 'Philippines.Bug3272_Bugkalot.KC993997.P10', color='#6E99FF',
             label="P10", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Philippines.AeB4069_Aeta_Bataan.KC993935.P9a*', 'Philippines.AeB4080_Aeta_Bataan.KC993942.P9*', color='#7D96FF',
             label="P9", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Indonesia.NZ96.MN849681.P4a1', 'Indonesia.MJ3.MN849505.P4a', color='#8993FF',
             label="P4", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup P") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "P_beast.png"), width = 33, height = 49)

# Q

show_col("#9590FF")

show_col(hue_pal(h = c(180, 270))(30))

file <- ("beast/QClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#9590FF', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Indonesia.NZ180.MN849637.Q1a1', 'Indonesia.PNG81.MN849857.Q1', color='#8993FF',
             label="Q1", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Indonesia.NJ26.MN849513.Q3a1', 'Indonesia.PM18.MN849752.Q3b', color='#9490FF',
             label="Q3", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Indonesia.PM86.MN849783.Q2a', 'Indonesia.PNG54.MN849847.Q2a4', color='#9F8CFF',
             label="Q2", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup Q") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "Q_beast.png"), width = 33, height = 49)

# A

show_col("#F8766D")

show_col(hue_pal(h = c(0, 90))(30))

file <- ("beast/AClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#F8766D', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Vietnam.PaThen507.MH449339.A14', 'Thailand.CT251.MG272631.A14', color='#FF6C91',
             label="A14", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.LS119.MT419145.A13*', 'Thailand.A1YU113.KX456443.A13', color='#FE6E8A',
             label="A13", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Vietnam.Mang290.MH449268.A+152+16362+200', 'Thailand.A4YU105.KX456634.A+152', color='#FD7083',
             label="A+152", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.LW624.KX457056.A17', 'Thailand.RM115.KX457344.A17', color='#FB727B',
             label="A17", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.CT605.MG272728.A5b1', 'Vietnam.Tay72.MH449471.A5b1', color='#F97474',
             label="A5", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup A") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "A_beast.png"), width = 33, height = 49)

# C

show_col("#D89000")

show_col(hue_pal(h = c(0, 90))(30))

file <- ("beast/CClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#D89000', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Vietnam.HMong218.MH449049.C5d', 'Vietnam.HMong228.MH449059.C5d', color='#DD8D00',
             label="C5", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.PL113.KX457186.C4a1b', 'Vietnam.HaNhi320.MH449073.C4a2b', color='#D98F00',
             label="C4", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.CT351.MG272661.C7*', 'Thailand.HM134.MT418991.C7a', color='#D69100',
             label="C7", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup C") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "C_beast.png"), width = 33, height = 49)

# D

show_col("#C09B00")

show_col(hue_pal(h = c(0, 90))(30))

file <- ("beast/DClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#C09B00', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Philippines.Igorot17.KU752562.D5b1c1a', 'Laos.VIE111.KX457600.D5b3', color='#CE9500',
             label="D5", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Timor-Leste.ET126.KJ676774.D6a', 'Philippines.PH348.GQ119040.D6c1', color='#C69900',
             label="D6", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Vietnam.Thai136.MH449477.D4g2a1', 'Vietnam.LaChi550.MH449169.D4', color='#C19B00',
             label="D4", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup D") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "D_beast.png"), width = 33, height = 49)

# E

show_col("#A3A500")

show_col(hue_pal(h = c(0, 90))(30))

file <- ("beast/EClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#A3A500', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Thailand.Thai223(E2b1).GU810070.E2b', 'Philippines.Sur22.GU733820.E2a', color='#AEA200',
             label="E2", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Indonesia.BJM024.MK128866.E1a2+(16261)', 'Philippines.Man104.GU733761.E1a1a1', color='#A3A500',
             label="E1", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup E") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "E_beast.png"), width = 33, height = 49)

# G

show_col("#7CAE00")

show_col(hue_pal(h = c(90, 120))(30))

file <- ("beast/GClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#7CAE00', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Malaysia.SL16.AP012400.G1c', 'Thailand.Y208.MT419323.G1a1', color='#7DAE00',
             label="G1", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.BST129.OQ731960.G', 'Vietnam.Dao623.MH448984.G', color='#7CAE00',
             label="G", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.Y218.MT419329.G2a+152', 'Myanmar.MMR018.JX289093.G2b1a1', color='#7AAE00',
             label="G2", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup G") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "G_beast.png"), width = 33, height = 49)

# R

show_col("#C77CFF")

show_col(hue_pal(h = c(270, 300))(40))

file <- ("beast/RClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#C77CFF', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Indonesia.BJM121.MK128858.R22', 'Thailand.LAO505.KX456900.R22*', color='#C17FFF',
             label="R22", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Vietnam.Cham57.GQ301864.R23', 'Cambodia.C105_Seim_Riep_R23.KT587454.R23', color='#C37EFF',
             label="R23", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.UrakLawoi109(R*).GU810037.R6+16129*', 'Thailand.MLB107.KX457070.R6a2', color='#C67DFF',
             label="R6", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.LW148.KX457017.R2+13500', 'Thailand.TK115.MG272924.R2+13500', color='#C87CFF',
             label="R2+13500", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Philippines.Mam4.GU733726.R24', 'Philippines.Aba5044_Abaknon.KC993925.R24a', color='#CA7AFF',
             label="R24", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.TL151.MG272964.R+16189', 'Thailand.HMP107.MT419089.R+16189', color='#CD79FF',
             label="R+16189", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.KHM223.KX456813.R11b1', 'Thailand.TL167.MG272968.R11_B6', color='#CF78FF',
             label="R11", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Malaysia.JHM068.AP012392.R21', 'Thailand.CT213.MG272612.R21', color='#C87CFF',
             label="R21", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.A1YU119.KX456446.R9c1a', 'Thailand.SPP108.KX457433.R9b1a3', color='#C77CFF',
             label="R9", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup R") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "R_beast.png"), width = 33, height = 49)

# U

show_col("#E76BF3")

show_col(hue_pal(h = c(270, 300))(30))

file <- ("beast/UClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#E76BF3', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Thailand.CT517.MG272704.U1a1c1a', 'Thailand.CT257.MG272634.U1a1c1d', color='#E06FF8',
             label="U1", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.CT617.MG272734.U2a1b', 'Myanmar.WA8.KY686212.U2', color='#E36EF6',
             label="U2", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup U") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "U_beast.png"), width = 33, height = 49)

# W

show_col("#FA62DB")

show_col(hue_pal(h = c(300, 360))(30))

file <- ("beast/WClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#FA62DB', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Cambodia.C266_Banteay_Meanchey_W3b.KT587614.W3b', 'Thailand.MO113.KX457099.W3a1b', color='#FA62DB',
             label="W3", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup W") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "W_beast.png"), width = 33, height = 49)

# Y

show_col("#FF62BC")

show_col(hue_pal(h = c(300, 360))(30))

file <- ("beast/YClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#FF62BC', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Thailand.Y178.MT419312.Y1', 'Thailand.Y178.MT419312.Y1', color='#FF62BF',
             label="Y1", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Philippines.Mara3676_Maranao.KC994149.Y2a', 'Indonesia.IN302.GQ119013.Y2a1', color='#FF66A7',
             label="Y2", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup Y") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "Y_beast.png"), width = 33, height = 49)

# Z

show_col("#FF6A98")

show_col(hue_pal(h = c(300, 360))(30))

file <- ("beast/ZClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='#FF6A98', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  geom_strip('Thailand.LS112.MT419138.Z3', 'Thailand.LW527.KX457031.Z3a', color='#FF67A3',
             label="Z3", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Philippines.PH247.GQ119035.Z4', 'Thailand.SPP115.KX457438.Z4', color='#FF6A9A',
             label="Z4", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  geom_strip('Thailand.LAO443.KX456893.Z3', 'Cambodia.C037_Seim_Riep_Z3c.KT587386.Z3c', color='#FF6C91',
             label="Z3", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
             angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup Z") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "Z_beast.png"), width = 33, height = 49)

# H

show_col("yellow")

show_col(hue_pal(h = c(0, 90))(30))

file <- ("beast/HClean.mcc.tre")
beast <- read.beast(file)

p <- ggtree(beast, size=1.25) + 
  # geom_tiplab(align=TRUE, linetype='dashed', linesize=.3) + 
  geom_range("height_0.95_HPD", color='yellow', size=4, alpha=0.6) + 
  geom_text2(aes(label=round(as.numeric(height_median), 0), 
                 subset=as.numeric(posterior) == 1 & height_median > 20000, 
                 x=branch), size=12, color='red', vjust=-0.5, hjust=-0.5) 

p1 <- p + 
  # geom_strip('Thailand.LS112.MT419138.Z3', 'Thailand.LW527.KX457031.Z3a', color='#FF67A3',
  #            label="Z3", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
  #            angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  # geom_strip('Philippines.PH247.GQ119035.Z4', 'Thailand.SPP115.KX457438.Z4', color='#FF6A9A',
  #            label="Z4", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
  #            angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  # geom_strip('Thailand.LAO443.KX456893.Z3', 'Cambodia.C037_Seim_Riep_Z3c.KT587386.Z3c', color='#FF6C91',
  #            label="Z3", offset = 0, offset.text=0.1, align = TRUE, barsize = 2, extend = 0, fontsize = 15,
  #            angle = 0, geom = "text", hjust = 0, fill = NA, family = "sans", parse = FALSE) +
  ggtitle("Haplogroup Z") + 
  theme(plot.title = element_text(size = 100, face = "bold", hjust = 0),
        plot.title.position = "panel")

p1

ggsave(filename = file.path("figures", "H_beast.png"), width = 33, height = 49)

# Bayesian estimates (BE) of coalescence time of the major SEA haplogroups

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)

be <- read_excel("SEA_BE_Results.xlsx")
be <- be %>% mutate(haplo=Haplogroup)

dat <- read_excel("IsolateExplanation.xlsx")

hap <- dat %>%
  mutate_all(funs(gsub("\\(", "", .))) %>% 
  mutate_all(funs(gsub("\\)", "", .))) %>%
  mutate_all(funs(gsub("\\@", "", .))) %>%
  mutate_all(funs(gsub("\\!", "", .))) %>%
  mutate(haplogroup2 = str_extract(haplo, "^([A-Z])\\d+"),
         haplogroup3 = str_extract(haplo, "^([A-Z])\\d+\\w"),
         haplogroup4 = str_extract(haplo, "^([A-Z])\\d+\\w\\d"),
         haplogroup5 = str_extract(haplo, "^([A-Z])\\d+\\w\\d\\w"),
         haplogroup6 = str_extract(haplo, "^([A-Z])\\d+\\w\\d\\w\\d"),
         haplogroup7 = str_extract(haplo, "^([A-Z])\\d+\\w\\d\\w\\d\\w"),
         haplogroup8 = str_extract(haplo, "^([A-Z])\\d+\\w"),
         haplogroup9 = str_extract(haplo, "^([A-Z])\\d+\\w\\d\\+\\@\\d+"),
         haplogroup9 = ifelse(haplogroup9=="F1b1+@152", "F1b1+152", haplogroup9),
         haplogroup10 = str_extract(haplo, "^([A-Z])\\d+\\w\\d\\w\\d\\+\\!\\d+"),
         haplogroup10 = ifelse(haplogroup10=="D5a2a1+!16172", "D5a2a1+16172", haplogroup10)) %>%
  dplyr::select(haplo, haplogroup1, haplogroup2, haplogroup3, haplogroup4, haplogroup5, haplogroup6, haplogroup7, haplogroup8, haplogroup9, haplogroup10) %>%
  setDT()

hapf <- hap %>% dplyr::filter(!haplo %in% c(hap$haplogroup1, hap$haplogroup2, hap$haplogroup3, hap$haplogroup4, hap$haplogroup5, hap$haplogroup6, hap$haplogroup7, hap$haplogroup8, hap$haplogroup9, hap$haplogroup10)) %>% setDT()
hapf <- hapf[, .N, by = .(haplo)] %>% arrange(desc(N))

extra <- c("B4a1", "B4b1a2b", "B4c1", "B5a1c1", "D4e1", "D5a2", "D5a2a1+16172", "F1b1+152", "F1c1a", "F3b1a", "M7b1", "M7c1", "M9a4", "M9a4a", "M9a1b", "M12a1", "M12b1", "M35b", "M51a1", "M51b", "M51b1", "R9b1a", "R9b1a2", "U1a1c1")
hapex <- hap %>% filter(haplo %in% extra) %>% setDT()

hapex <- datex[, .N, by = .(haplo)] %>% arrange(desc(N))

hap1 <- hap[, .N, by = .(haplogroup1)] %>% arrange(desc(N)) %>% setnames(c("haplo", "N"))
hap2 <- hap[, .N, by = .(haplogroup2)] %>% arrange(desc(N)) %>% setnames(c("haplo", "N")) %>% filter(!haplo %in% hap1$haplo)
hap3 <- hap[, .N, by = .(haplogroup3)] %>% arrange(desc(N)) %>% setnames(c("haplo", "N")) %>% filter(!haplo %in% c(hap1$haplo, hap2$haplo))
hap4 <- hap[, .N, by = .(haplogroup4)] %>% arrange(desc(N)) %>% setnames(c("haplo", "N")) %>% filter(!haplo %in% c(hap1$haplo, hap2$haplo, hap3$haplo))
hap5 <- hap[, .N, by = .(haplogroup5)] %>% arrange(desc(N)) %>% setnames(c("haplo", "N")) %>% filter(!haplo %in% c(hap1$haplo, hap2$haplo, hap3$haplo, hap4$haplo))
hap6 <- hap[, .N, by = .(haplogroup6)] %>% arrange(desc(N)) %>% setnames(c("haplo", "N")) %>% filter(!haplo %in% c(hap1$haplo, hap2$haplo, hap3$haplo, hap4$haplo, hap5$haplo))
hap7 <- hap[, .N, by = .(haplogroup7)] %>% arrange(desc(N)) %>% setnames(c("haplo", "N")) %>% filter(!haplo %in% c(hap1$haplo, hap2$haplo, hap3$haplo, hap4$haplo, hap5$haplo, hap6$haplo))
hap8 <- hap[, .N, by = .(haplogroup8)] %>% arrange(desc(N)) %>% setnames(c("haplo", "N")) %>% filter(!haplo %in% c(hap1$haplo, hap2$haplo, hap3$haplo, hap4$haplo, hap5$haplo, hap6$haplo, hap7$haplo))
hap9 <- hap[, .N, by = .(haplogroup9)] %>% arrange(desc(N)) %>% setnames(c("haplo", "N")) %>% filter(!haplo %in% c(hap1$haplo, hap2$haplo, hap3$haplo, hap4$haplo, hap5$haplo, hap6$haplo, hap7$haplo, hap8$haplo))
hap10 <- hap[, .N, by = .(haplogroup10)] %>% arrange(desc(N)) %>% setnames(c("haplo", "N")) %>% filter(!haplo %in% c(hap1$haplo, hap2$haplo, hap3$haplo, hap4$haplo, hap5$haplo, hap6$haplo, hap7$haplo, hap8$haplo, hap9$haplo))

hap_all <- rbind(hapf, hapex, hap1, hap2, hap3, hap4, hap5, hap6, hap7, hap8, hap9, hap10)
hap_all <- unique(hap_all, by = c('haplo','N'))

table(be$haplo %in% hap_all$haplo)
be$haplo[which(!be$haplo %in% hap_all$haplo)]

be_hap <- merge(be, hap_all, by="haplo")
be_hap <- unique(be_hap, by = c('haplo','N')) %>% setDT()
be_hap <- be_hap[, -c(1,3)]
be_hap <- be_hap[, c(1,6,2,3,4,5)]

## Rename
setnames(x = be_hap,
         old = c("Haplogroup", "N", "BE coalescent time", "Lower", "Upper", "Posterior"),
         new = c("Haplogroup", "Sample size", "BE coalescent time", "Lower", "Upper", "Posterior"))

library(writexl)
write_xlsx(be_hap, "SEA_BE_results_updated.xlsx")

# Create dataset of sequences and subclades

library(tidyr)
library(dplyr)
library(data.table)
library(readxl)

dat <- read_excel("IsolateExplanation.xlsx")
dat <- as.data.frame(dat)
names <- dat$names

library(janitor)
dat2 <- dat %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan",
                          ifelse(Ethnicity=="Yao", "Dao", Ethnicity))) %>%
  dplyr::select(name, Country, `Language family`, Ethnicity, haplo, haplogroup1, haplogroup2, haplogroup3) %>% setDT()
hap_rank <- dat2[, .N, by = .(haplogroup1)] %>% arrange(desc(N))
hap2_rank <- dat2[, .N, by = .(haplogroup2)] %>% arrange(desc(N))
hap3_rank <- dat2[, .N, by = .(haplogroup3)] %>% arrange(desc(N))

hap <- dat2[, .N, by = .(haplogroup1)] %>% arrange(desc(N)) %>% mutate(percent=(N*100)/sum(N)) %>% ungroup()
hap2 <- dat2[, .N, by = .(haplogroup2)] %>% arrange(desc(N)) %>% mutate(percent=(N*100)/sum(N)) %>% ungroup()
hap3 <- dat2[, .N, by = .(haplogroup3)] %>% arrange(desc(N)) %>% mutate(percent=(N*100)/sum(N)) %>% ungroup()

library(pegas)
library(ape)

### Calculate nucleotide diversity, haplotype diversity, MPD and write out all subclades

dat_hap <- NULL
for (i in hap_rank$haplogroup1) {
  cat(i, "\n")
  df_i <- dat2 %>% dplyr::filter(haplogroup1==i)
  n_i <- nrow(df_i)
  nbin_i <- nbin[labels(nbin) %in% df_i$name]
  h_i <- pegas::haplotype(nbin_i)
  n_hi <- length(as.list(h_i))
  fas_i <- file2[labels(nbin) %in% df_i$name]
  writeXStringSet(fas_i, paste0("data/haplo/", i, "Aligned.fasta"))
  # dnbin_i <- dist.dna(nbin_i, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
  x_i <- as.matrix.DNAbin(nbin_i)  #converting DNAbin to matrix
  dist.gene_i <- dist.gene(x_i, method = "pairwise", variance = TRUE, pairwise.deletion = FALSE)
  mpd_i <- mean(dist.gene_i)
  hap.div_i <- hap.div(nbin_i, variance = TRUE)
  nuc.div_i <- nuc.div(nbin_i, variance = TRUE, pairwise.deletion = FALSE) # hap.div = 1 all haplotypes are unique
  dati <- data.frame(df_i$haplogroup1, n_i, n_hi, hap.div_i[1], hap.div_i[2], nuc.div_i[1], nuc.div_i[2], mpd_i) %>% slice(1)
  ## combine
  dat_hap <- rbindlist(l = list(dat_hap, dati)) %>% unique() %>% setDT()
}

## Rename
setnames(x = dat_hap,
         old = c("df_i.haplogroup1", "n_i", "n_hi", "hap.div_i.1.", "hap.div_i.2.", "nuc.div_i.1.", "nuc.div_i.2.", "mpd_i"),
         new = c("Haplogroup", "Sample size", "Number of haplotypes", "Haplotype diversity (H)", "H variance", "Nucleotide diveristy (pi)", "pi SE", "MPD"))

dat_hap2 <- NULL
for (i in hap2_rank$haplogroup2) {
  cat(i, "\n")
  df_i <- dat2 %>% dplyr::filter(haplogroup2==i)
  n_i <- nrow(df_i)
  nbin_i <- nbin[labels(nbin) %in% df_i$name]
  h_i <- pegas::haplotype(nbin_i)
  n_hi <- length(as.list(h_i))
  fas_i <- file2[labels(nbin) %in% df_i$name]
  writeXStringSet(fas_i, paste0("data/haplo/", i, "Aligned.fasta"))
  # dnbin_i <- dist.dna(nbin_i, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
  x_i <- as.matrix.DNAbin(nbin_i)  #converting DNAbin to matrix
  dist.gene_i <- dist.gene(x_i, method = "pairwise", variance = TRUE, pairwise.deletion = FALSE)
  mpd_i <- mean(dist.gene_i)
  hap.div_i <- hap.div(nbin_i, variance = TRUE)
  nuc.div_i <- nuc.div(nbin_i, variance = TRUE, pairwise.deletion = FALSE) # hap.div = 1 all haplotypes are unique
  dati <- data.frame(df_i$haplogroup2, n_i, n_hi, hap.div_i[1], hap.div_i[2], nuc.div_i[1], nuc.div_i[2], mpd_i) %>% slice(1)
  ## combine
  dat_hap2 <- rbindlist(l = list(dat_hap2, dati)) %>% unique() %>% setDT()
}

## Rename
setnames(x = dat_hap2,
         old = c("df_i.haplogroup2", "n_i", "n_hi", "hap.div_i.1.", "hap.div_i.2.", "nuc.div_i.1.", "nuc.div_i.2.", "mpd_i"),
         new = c("Haplogroup", "Sample size", "Number of haplotypes", "Haplotype diversity (H)", "H variance", "Nucleotide diveristy (pi)", "pi SE", "MPD"))

dat_hap3 <- NULL
for (i in hap3_rank$haplogroup3) {
  cat(i, "\n")
  df_i <- dat2 %>% dplyr::filter(haplogroup3==i)
  n_i <- nrow(df_i)
  nbin_i <- nbin[labels(nbin) %in% df_i$name]
  h_i <- pegas::haplotype(nbin_i)
  n_hi <- length(as.list(h_i))
  fas_i <- file2[labels(nbin) %in% df_i$name]
  writeXStringSet(fas_i, paste0("data/haplo/", i, "Aligned.fasta"))
  # dnbin_i <- dist.dna(nbin_i, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
  x_i <- as.matrix.DNAbin(nbin_i)  #converting DNAbin to matrix
  dist.gene_i <- dist.gene(x_i, method = "pairwise", variance = TRUE, pairwise.deletion = FALSE)
  mpd_i <- mean(dist.gene_i)
  hap.div_i <- hap.div(nbin_i, variance = TRUE)
  nuc.div_i <- nuc.div(nbin_i, variance = TRUE, pairwise.deletion = FALSE) # hap.div = 1 all haplotypes are unique
  dati <- data.frame(df_i$haplogroup3, n_i, n_hi, hap.div_i[1], hap.div_i[2], nuc.div_i[1], nuc.div_i[2], mpd_i) %>% slice(1)
  ## combine
  dat_hap3 <- rbindlist(l = list(dat_hap3, dati)) %>% unique() %>% setDT()
}

## Rename
setnames(x = dat_hap3,
         old = c("df_i.haplogroup3", "n_i", "n_hi", "hap.div_i.1.", "hap.div_i.2.", "nuc.div_i.1.", "nuc.div_i.2.", "mpd_i"),
         new = c("Haplogroup", "Sample size", "Number of haplotypes", "Haplotype diversity (H)", "H variance", "Nucleotide diveristy (pi)", "pi SE", "MPD"))

## Combine
dat_hap <- rbindlist(l = list(dat_hap, dat_hap2, dat_hap3)) %>% unique() %>% setDT()

## Rename
setnames(x = dat_hap,
         old = c("df_i.haplogroup1", "n_i", "n_hi", "hap.div_i.1.", "hap.div_i.2.", "nuc.div_i.1.", "nuc.div_i.2.", "mpd_i"),
         new = c("Haplogroup", "Sample size", "Number of haplotypes", "Haplotype diversity (H)", "H variance", "Nucleotide diveristy (pi)", "pi SE", "MPD"))

library(writexl)
write_xlsx(dat_hap, "SEA_haplogroups_updated.xlsx")

################ SUBCLADES #######################

# Write separate subclade sequences

# Haplogroup F (Clean)

F_dat <- read.csv("subclade/F_Clean.csv")
F_clean <- file2[F_dat$name]
writeXStringSet(F_clean, "data/F_Clean.fasta")

# Haplogroup M (Clean)

M_dat <- read.csv("subclade/M_Clean.csv")
M_clean <- file2[M_dat$name]
writeXStringSet(M_clean, "data/M_Clean.fasta")

# Haplogroup B (Clean)

B_dat <- read.csv("subclade/B_Clean.csv")
B_clean <- file2[B_dat$name]
writeXStringSet(B_clean, "data/B_Clean.fasta")

# Haplogroup N (Clean)

N_dat <- read.csv("subclade/N_Clean.csv")
N_clean <- file2[N_dat$name]
writeXStringSet(N_clean, "data/N_Clean.fasta")

# Haplogroup P (Clean)

P_dat <- read.csv("subclade/P_Clean.csv")
P_clean <- file2[P_dat$name]
writeXStringSet(P_clean, "data/P_Clean.fasta")

# Haplogroup G
hap_G <- dat %>% filter(haplogroup1 == "G")
nbin_G <- nbin[labels(nbin) %in% hap_G$name]
G <- file2[hap_G$name]
writeXStringSet(G, "data/GAligned.fasta")

# Haplogroup M
hap_M <- dat %>% filter(haplogroup1 == "M")
nbin_M <- nbin[labels(nbin) %in% hap_M$name]
M <- file2[hap_M$name]
writeXStringSet(M, "data/MAligned.fasta")

# Haplogroup N
hap_N <- dat %>% filter(haplogroup1 == "N")
nbin_N <- nbin[labels(nbin) %in% hap_N$name]
N <- file2[hap_N$name]
writeXStringSet(N, "data/NAligned.fasta")

# Haplogroup P
hap_P <- dat %>% filter(haplogroup1 == "P")
nbin_P <- nbin[labels(nbin) %in% hap_P$name]
P <- file2[hap_P$name]
writeXStringSet(P, "data/PAligned.fasta")

# Haplogroup R
hap_R <- dat %>% filter(haplogroup1 == "R")
nbin_R <- nbin[labels(nbin) %in% hap_R$name]
R <- file2[hap_R$name]
writeXStringSet(R, "data/RAligned.fasta")

# Haplogroup F1
hap_F1 <- dat %>% filter(haplogroup2 == "F1")
nbin_F1 <- nbin[labels(nbin) %in% hap_F1$name]

F1 <- file2[hap_F1$name]
writeXStringSet(F1, "data/F1Aligned.fasta")

# Haplogroup F1(xF1a)

hap_F1xF1a <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="F1", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup2 == "F1" & haplogroup4 != "F1a")
nbin_F1xF1a <- nbin[labels(nbin) %in% hap_F1xF1a$name]

F1xF1a <- file2[hap_F1xF1a$name]
writeXStringSet(F1xF1a, "data/F1xF1aAligned.fasta")

# # Haplogroup F1a
# hap_F1a <- dat %>% 
#   mutate(haplogroup4 = ifelse(haplogroup3=="F1", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
#   filter(haplogroup4 == "F1a")
# nbin_F1a <- nbin[labels(nbin) %in% hap_F1a$name]
# 
# F1a <- file[hap_F1a$name]
# writeXStringSet(F1a, "data/F1a.fasta")
# 
# # cat(file="data/F1a.fasta", paste(paste0(">",names(nbin_F1a)),
# #                                  sapply(nbin_F1a, paste, collapse=""), sep="\n"), sep="\n")
# 

# Haplogroup F2
hap_F2 <- dat %>% filter(haplogroup2 == "F2")
nbin_F2 <- nbin[labels(nbin) %in% hap_F2$name]

F2 <- file2[hap_F2$name]
writeXStringSet(F2, "data/F2Aligned.fasta")

# Haplogroup F3
hap_F3 <- dat %>% filter(haplogroup2 == "F3")
nbin_F3 <- nbin[labels(nbin) %in% hap_F3$name]

F3 <- file2[hap_F3$name]
writeXStringSet(F3, "data/F3Aligned.fasta")

# Haplogroup B5
hap_B5 <- dat %>% filter(haplogroup2 == "B5")
nbin_B5 <- nbin[labels(nbin) %in% hap_B5$name]

B5 <- file2[hap_B5$name]
writeXStringSet(B5, "data/B5Aligned.fasta")

# # Haplogroup B5a
# 
# hap_B5a <- dat %>% 
#   mutate(haplogroup4 = ifelse(haplogroup3=="B5", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
#   filter(haplogroup4 == "B5a")
# 
# B5a <- file[hap_B5a$name]
# writeXStringSet(B5a, "data/B5a.fasta")
# 

# Haplogroup M7
hap_M7 <- dat %>% filter(haplogroup2 == "M7")
nbin_M7 <- nbin[labels(nbin) %in% hap_M7$name]

M7 <- file2[hap_M7$name]
writeXStringSet(M7, "data/M7Aligned.fasta")

# # Haplogroup M7b
# hap_M7b <- dat %>% 
#   mutate(haplogroup4 = ifelse(haplogroup3=="M7", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
#   filter(haplogroup4 == "M7b")
# 
# M7b <- file[hap_M7b$name]
# writeXStringSet(M7b, "data/M7b.fasta")
# 
# hap_M7b1a1 <- dat %>%
#   mutate(haplogroup4 = ifelse(haplogroup2=="M7", str_extract(haplo, "^([A-Z])\\d+\\w\\d\\w\\d"), haplogroup3)) %>%
#   filter(haplogroup4 == "M7b1a1")
# 
# M7b1a1 <- file[hap_M7b1a1$name]
# writeXStringSet(M7b1a1, "data/M7b1a1.fasta")
# 

# Haplogroup B4
hap_B4 <- dat %>% filter(haplogroup2 == "B4")
nbin_B4 <- nbin[labels(nbin) %in% hap_B4$name]

B4 <- file2[hap_B4$name]
writeXStringSet(B4, "data/B4Aligned.fasta")

# # Haplogroup B4a
# 
# hap_B4a <- dat %>% 
#   mutate(haplogroup4 = ifelse(haplogroup3=="B4", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
#   filter(haplogroup4 == "B4a")
# 
# B4a <- file[hap_B4a$name]
# writeXStringSet(B4a, "data/B4a.fasta")
# 
# # Haplogroup M7c
# hap_M7c <- dat %>% 
#   mutate(haplogroup4 = ifelse(haplogroup3=="M7", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
#   filter(haplogroup4 == "M7c")
# 
# M7c <- file[hap_M7c$name]
# writeXStringSet(M7c, "data/M7c.fasta")
# 
# # Haplogroup B4c
# 
# hap_B4c <- dat %>% 
#   mutate(haplogroup4 = ifelse(haplogroup3=="B4", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
#   filter(haplogroup4 == "B4c")
# 
# B4c <- file[hap_B4c$name]
# writeXStringSet(B4c, "data/B4c.fasta")
# 
# # Haplogroup F1f
# hap_F1f <- dat %>% 
#   mutate(haplogroup4 = ifelse(haplogroup3=="F1", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
#   filter(haplogroup4 == "F1f")
# 
# F1f <- file[hap_F1f$name]
# writeXStringSet(F1f, "data/F1f.fasta")
# 

# Haplogroup N9
hap_N9 <- dat %>% filter(haplogroup2 == "N9")
nbin_N9 <- nbin[labels(nbin) %in% hap_N9$name]

N9 <- file2[hap_N9$name]
writeXStringSet(N9, "data/N9Aligned.fasta")

# # Haplogroup N9a
# hap_N9a <- dat %>% 
#   mutate(haplogroup4 = ifelse(haplogroup3=="N9", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
#   filter(haplogroup4 == "N9a")
# 
# N9a <- file[hap_N9a$name]
# writeXStringSet(N9a, "data/N9a.fasta")
# 

# Haplogroup R9
hap_R9 <- dat %>% filter(haplogroup2 == "R9")
nbin_R9 <- nbin[labels(nbin) %in% hap_R9$name]

R9 <- file2[hap_R9$name]
writeXStringSet(R9, "data/R9Aligned.fasta")

# # Haplogroup R9b
# hap_R9b <- dat %>% 
#   mutate(haplogroup4 = ifelse(haplogroup3=="R9", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
#   filter(haplogroup4 == "R9b")
# 
# R9b <- file[hap_R9b$name]
# writeXStringSet(R9b, "data/R9b.fasta")
# 

# # Haplogroup M74
# hap_M74 <- dat %>%filter(haplogroup3 == "M74")
# 
# M74 <- file[hap_M74$name]
# writeXStringSet(M74, "data/M74.fasta")
# 
# Haplogroup C7
hap_C7 <- dat %>% filter(haplogroup2 == "C7")
nbin_C7 <- nbin[labels(nbin) %in% hap_C7$name]

C7 <- file2[hap_C7$name]
writeXStringSet(C7, "data/C7Aligned.fasta")

# # Haplogroup C7a
# hap_C7a <- dat %>% 
#   mutate(haplogroup4 = ifelse(haplogroup3=="C7", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
#   filter(haplogroup4 == "C7a")
# 
# C7a <- file[hap_C7a$name]
# writeXStringSet(C7a, "data/C7a.fasta")

# Haplogroup D4
hap_D4 <- dat %>% filter(haplogroup2 == "D4")
nbin_D4 <- nbin[labels(nbin) %in% hap_D4$name]

D4 <- file2[hap_D4$name]
writeXStringSet(D4, "data/D4Aligned.fasta")

###########################################

names <- as.data.frame(nbinmat)
data <- separate(names, V1, into = c("country", "ethnic", "access_no", "haplo"), sep = "\\.")
data <- cbind(data, names) %>% dplyr::rename(name=V1)

dat <- data %>% mutate(
  haplogroup1 = substr(haplo, 1, 1),
  haplogroup2 = substr(haplo, 1, 2),
  haplogroup3 = str_extract(haplo, "^([A-Z])\\d+"),
  haplogroup3 = ifelse(is.na(haplogroup3), haplo, haplogroup3)
) %>% setDT()

library(writexl)
# dat_write <- data %>% mutate(
#   haplogroup1 = substr(haplo, 1, 1),
#   haplogroup2 = str_extract(haplo, "^([A-Z])\\d+"),
#   haplogroup2 = ifelse(is.na(haplogroup2), haplo, haplogroup2),
#   haplogroup3=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
#   haplogroup3=ifelse(is.na(haplogroup3), haplo, haplogroup3),
#   haplogroup3=case_when(haplogroup3 %in% c("134", "157", "161", "168", "171", "174", "241", "257", "259", "260", "262", "268", "279", "281", "295", "30", "304", 
#                                  "313", "315", "32", "351", "375", "381", "425", "433", "439", "483", "489", "496", "50", "501", "51", "53", "530", 
#                                  "563", "564", "567", "589", "607", "62", "73", "78", "90") ~ haplo,
#                         TRUE ~ haplogroup3),
#   ID=order(name)
#   ) %>% setDT()
# dat_write <- dat_write[, c(9,5,1,2,3,4,6,7,8)]
# write_xlsx(dat_write, "SEA_haplogroups.xlsx")

hap_country <- dat[, .N, by = .(haplo, country)]
hap1_country <- dat[, .N, by = .(haplogroup1, country)]

country_hap <- dat[, .N, by = .(country, haplo)]
country_hap <- country_hap %>%
  group_by(country) %>% arrange(haplo, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

country_hap1 <- dat[, .N, by = .(country, haplogroup1)]
country_hap1 <- country_hap1 %>%
  group_by(country) %>% arrange(haplogroup1, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

country_hap3 <- dat[, .N, by = .(country, haplogroup3)]
country_hap3 <- country_hap3 %>%
  group_by(country) %>% arrange(haplogroup3, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

ethnic <- read.csv("SEAFreq_by_label.csv")
ethnic <- ethnic %>%
  mutate(haplo=str_extract(Haplogroup, "^([A-Z])\\d+"),
         haplo=ifelse(is.na(haplo), Haplogroup, haplo))

library(reshape2)
ethnic_hap <- ethnic %>% select(-Haplogroup) %>%
  melt(., id.vars="haplo")

###################################################

# Haplogroup frequency

# Country

dat <- read_excel("CompleteFull.xlsx")
dat <- as.data.frame(dat)

### MacroM: haplogroup M, haplogroup C, haplogroup Z, haplogroup D, haplogroup E, haplogroup G, haplogroup Q.
### MacroR: haplogroup R, haplogroup B, haplogroup F, haplogroup H, haplogroup V, haplogroup J, haplogroup T, haplogroup U, haplogroup K.
### MacroNxR: haplogroup N, haplogroup O, haplogroup A, haplogroup S, haplogroup I, haplogroup W, haplogroup X, haplogroup Y.

dat <- dat %>%
  mutate(macrohap0="Macro-haplogroup L",
         macrohap0=ifelse(haplogroup1 %in% c("M", "C", "Z", "D", "E", "G", "Q"), "Macro-haplogroup M",
                          ifelse(haplogroup1 %in% c("R", "B", "F", "H", "V", "J", "T", "P", "U", "K", "N", "O", "A", "S", "I", "W", "X", "Y"), "Macro-haplogroup N", macrohap0)),
         macrohap1="Macro-haplogroup L",
         macrohap1=ifelse(haplogroup1 %in% c("M", "C", "Z", "D", "E", "G", "Q"), "Macro-haplogroup M",
                          ifelse(haplogroup1 %in% c("R", "B", "F", "H", "V", "J", "T", "P", "U", "K"), "Macro-haplogroup R",
                                 ifelse(haplogroup1 %in% c("N", "O", "A", "S", "I", "W", "X", "Y"), "Macro-haplogroup N (xR)", macrohap1))),
         haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`)))))))))))))))))),
         Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color)))))))))))))))))))))

country <- dat %>% filter(Country!=c("rCRS", "RSRS")) %>%
  dplyr::select(name, Country, Location, `Language family`, Ethnicity, haplo, haplogroup1, haplogroup2, haplogroup3, macrohap0, macrohap1, Country_color, Language_color, Ethnicity_color, Haplogroup1_color) %>% setDT()

library(scales)
library(data.table)

country_rank <- country[, .N, by = .(Country)] %>% arrange(desc(N))

country_macro0 <- country[, .N, by = .(Country, macrohap0)]
country_macro0 <- country_macro0 %>%
  group_by(Country) %>% arrange(macrohap0, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1)) %>% ungroup()

country_macro1 <- country[, .N, by = .(Country, macrohap1)]
country_macro1 <- country_macro1 %>%
  group_by(Country) %>% arrange(macrohap1, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1)) %>% ungroup()

country_hap1 <- country[, .N, by = .(Country, haplogroup1)]
country_hap1 <- country_hap1 %>%
  group_by(Country) %>% arrange(haplogroup1, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1)) %>% ungroup()

country_hap2 <- country[, .N, by = .(Country, haplogroup2)]
country_hap2 <- country_hap2 %>%
  group_by(Country) %>% arrange(haplogroup2, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1)) %>% ungroup()

country_hap3 <- country[, .N, by = .(Country, haplogroup3)]
country_hap3 <- country_hap3 %>%
  group_by(Country) %>% arrange(haplogroup3, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1)) %>% ungroup()

sea <- country

sea_macro0 <- sea[, .N, by = .(macrohap0)]
sea_macro0 <- sea_macro0 %>%
  arrange(macrohap0, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1))

sea_macro1 <- sea[, .N, by = .(macrohap1)]
sea_macro1 <- sea_macro1 %>%
  arrange(macrohap1, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1))

sea_hap1 <- sea[, .N, by = .(haplogroup1)]
sea_hap1 <- sea_hap1 %>%
  arrange(haplogroup1, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1))

sea_hap2 <- sea[, .N, by = .(haplogroup2)]
sea_hap2 <- sea_hap2 %>%
  arrange(haplogroup2, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1))

sea_hap3 <- sea[, .N, by = .(haplogroup3)]
sea_hap3 <- sea_hap3 %>%
  arrange(haplogroup3, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1))

## All countries

country_hap1$Haplocolors <- dat[match(country_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

Countrycolors <- unique(dat[match(country_hap1$Country, dat$Country), "Country_color"])
rev_Countrycolors <- rev(Countrycolors)

g1 <- country_hap1 %>% filter(!Country %in% c("rCRS", "RSRS")) %>%
  ggplot(aes(x=Country, y=percent, fill=haplogroup1)) +      
  # Add the stacked bar
  geom_bar(position = "stack", stat="identity", alpha=1, data = country_hap1 %>% filter(Country == "Brunei")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = country_hap1 %>% filter(Country == "Cambodia")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = country_hap1 %>% filter(Country == "Indonesia")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = country_hap1 %>% filter(Country == "Laos")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = country_hap1 %>% filter(Country == "Malaysia")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = country_hap1 %>% filter(Country == "Myanmar")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = country_hap1 %>% filter(Country == "Philippines")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = country_hap1 %>% filter(Country == "Singapore")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = country_hap1 %>% filter(Country == "Thailand")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = country_hap1 %>% filter(Country == "Timor-Leste")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = country_hap1 %>% filter(Country == "Vietnam")) +
  ggtitle("Country") +
  guides(fill=guide_legend("Haplocolors", nrow=2, byrow=TRUE)) +
  # scale_fill_manual(values = Haplocolors) +
  scale_x_discrete(name = "Country", limits = rev(unique(country_hap1$Country))) +
  scale_y_continuous(name = "Percent") +
  theme_bw() +
  theme(axis.text.y = element_text(colour = rev_Countrycolors, size=12),
        axis.title.y = element_text(colour = "black", size=12, face = "bold"),
        axis.title.x = element_text(colour = "black", size=10, face = "bold"),
        plot.title = element_text(hjust = 0.5, vjust = 1, face = "bold"),
        legend.position = "none", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm")) +
  coord_flip() +
  geom_label(aes(label = haplogroup1), 
             size = 4,
             label.size = NA,
             position = position_stack(vjust = .5),
             show.legend = FALSE)
g1

ggsave(filename = file.path("figures", "country_haplo1_new.png"), width = 15, height = 10)

## SEA

Haplocolors <- dat[match(sea_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

sea <- sea_hap1 %>%
  ggplot(aes(x = "", y = percent, fill = haplogroup1)) +
  geom_bar(stat="identity", width = 1, alpha=1) +
  guides(fill=guide_legend(nrow=1, byrow=TRUE)) +
  geom_label_repel(aes(label = paste(haplogroup1, " (", percent, "%", ")", sep = "")), 
                   size = 3.5,
                   position = position_stack(vjust = .3),
                   show.legend = FALSE) +
  coord_polar(theta = "y", start = 0) + theme_void() +
  ggtitle("Southeast Asia (n=4932)") +
  scale_fill_manual(values = Haplocolors) +
  theme(plot.title = element_text(hjust = 0.5, vjust = -2, face = "bold"),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm"))

## Brunei

brunei_hap1 <- country_hap1 %>% filter(Country=="Brunei")
Haplocolors <- dat[match(brunei_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

brunei <- brunei_hap1 %>%
  ggplot(aes(x = "", y = percent, fill = haplogroup1)) +
  geom_bar(stat="identity", width = 1, alpha=1) +
  guides(fill=guide_legend(nrow=1, byrow=TRUE)) +
  geom_label_repel(aes(label = paste(haplogroup1, " (", percent, "%", ")", sep = "")), 
                   size = 3.5,
                   position = position_stack(vjust = .3),
                   show.legend = FALSE) +
  coord_polar(theta = "y", start = 0) + theme_void() +
  ggtitle("Brunei (n=8)") +
  scale_fill_manual(values = Haplocolors) +
  theme(plot.title = element_text(hjust = 0.5, vjust = -2, face = "bold"),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm"))

## Cambodia

cambodia_hap1 <- country_hap1 %>% filter(Country=="Cambodia")
Haplocolors <- dat[match(cambodia_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

cambodia <- cambodia_hap1 %>%
  ggplot(aes(x = "", y = percent, fill = haplogroup1)) +
  geom_bar(stat="identity", width = 1, alpha=1) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  geom_label_repel(aes(label = paste(haplogroup1, " (", percent, "%", ")", sep = "")), 
                   size = 3.5,
                   position = position_stack(vjust = .3),
                   show.legend = FALSE) +
  coord_polar(theta = "y", start = 0) + theme_void() +
  ggtitle("Cambodia (n=398)") +
  scale_fill_manual(values = Haplocolors) +
  theme(plot.title = element_text(hjust = 0.5, vjust = -2, face = "bold"),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm"))

## Indonesia

indonesia_hap1 <- country_hap1 %>% filter(Country=="Indonesia")
Haplocolors <- dat[match(indonesia_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

indonesia <- indonesia_hap1 %>%
  ggplot(aes(x = "", y = percent, fill = haplogroup1)) +
  geom_bar(stat="identity", width = 1, alpha=1) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  geom_label_repel(aes(label = paste(haplogroup1, " (", percent, "%", ")", sep = "")), 
                   size = 3.5,
                   position = position_stack(vjust = .3),
                   show.legend = FALSE) +
  coord_polar(theta = "y", start = 0) + theme_void() +
  ggtitle("Indonesia (n=656)") +
  scale_fill_manual(values = Haplocolors) +
  theme(plot.title = element_text(hjust = 0.5, vjust = -2, face = "bold"),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm"))

## Laos

laos_hap1 <- country_hap1 %>% filter(Country=="Laos")
Haplocolors <- dat[match(laos_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

laos <- laos_hap1 %>%
  ggplot(aes(x = "", y = percent, fill = haplogroup1)) +
  geom_bar(stat="identity", width = 1, alpha=1) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  geom_label_repel(aes(label = paste(haplogroup1, " (", percent, "%", ")", sep = "")), 
                   size = 3.5,
                   position = position_stack(vjust = .3),
                   show.legend = FALSE) +
  coord_polar(theta = "y", start = 0) + theme_void() +
  ggtitle("Laos (n=59)") +
  scale_fill_manual(values = Haplocolors) +
  theme(plot.title = element_text(hjust = 0.5, vjust = -2, face = "bold"),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm"))

## Malaysia

malaysia_hap1 <- country_hap1 %>% filter(Country=="Malaysia")
Haplocolors <- dat[match(malaysia_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

malaysia <- malaysia_hap1 %>%
  ggplot(aes(x = "", y = percent, fill = haplogroup1)) +
  geom_bar(stat="identity", width = 1, alpha=1) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  geom_label_repel(aes(label = paste(haplogroup1, " (", percent, "%", ")", sep = "")), 
                   size = 3.5,
                   position = position_stack(vjust = .3),
                   show.legend = FALSE) +
  coord_polar(theta = "y", start = 0) + theme_void() +
  ggtitle("Malaysia (n=151)") +
  scale_fill_manual(values = Haplocolors) +
  theme(plot.title = element_text(hjust = 0.5, vjust = -2, face = "bold"),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm"))

## Myanmar

myanmar_hap1 <- country_hap1 %>% filter(Country=="Myanmar")
Haplocolors <- dat[match(myanmar_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

myanmar <- myanmar_hap1 %>%
  ggplot(aes(x = "", y = percent, fill = haplogroup1)) +
  geom_bar(stat="identity", width = 1, alpha=1) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  geom_label_repel(aes(label = paste(haplogroup1, " (", percent, "%", ")", sep = "")), 
                   size = 3.5,
                   position = position_stack(vjust = .4),
                   show.legend = FALSE) +
  coord_polar(theta = "y", start = 0) + theme_void() +
  ggtitle("Myanmar (n=151)") +
  scale_fill_manual(values = Haplocolors) +
  theme(plot.title = element_text(hjust = 0.5, vjust = -2, face = "bold"),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm"))

## Philippines

philippines_hap1 <- country_hap1 %>% filter(Country=="Philippines")
Haplocolors <- dat[match(philippines_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

philippines <- philippines_hap1 %>%
  ggplot(aes(x = "", y = percent, fill = haplogroup1)) +
  geom_bar(stat="identity", width = 1, alpha=1) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  geom_label_repel(aes(label = paste(haplogroup1, " (", percent, "%", ")", sep = "")), 
                   size = 3.5,
                   position = position_stack(vjust = .4),
                   show.legend = FALSE) +
  coord_polar(theta = "y", start = 0) + theme_void() +
  ggtitle("Philippines (n=446)") +
  scale_fill_manual(values = Haplocolors) +
  theme(plot.title = element_text(hjust = 0.5, vjust = -2, face = "bold"),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm"))

## Singapore

singapore_hap1 <- country_hap1 %>% filter(Country=="Singapore")
Haplocolors <- dat[match(singapore_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

singapore <- singapore_hap1 %>%
  ggplot(aes(x = "", y = percent, fill = haplogroup1)) +
  geom_bar(stat="identity", width = 1, alpha=1) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  geom_label_repel(aes(label = paste(haplogroup1, " (", percent, "%", ")", sep = "")), 
                   size = 3.5,
                   position = position_stack(vjust = .4),
                   show.legend = FALSE) +
  coord_polar(theta = "y", start = 0) + theme_void() +
  ggtitle("Singapore (n=1)") +
  scale_fill_manual(values = Haplocolors) +
  theme(plot.title = element_text(hjust = 0.5, vjust = -2, face = "bold"),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm"))

## Thailand

thailand_hap1 <- country_hap1 %>% filter(Country=="Thailand")
Haplocolors <- dat[match(thailand_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

thailand <- thailand_hap1 %>%
  ggplot(aes(x = "", y = percent, fill = haplogroup1)) +
  geom_bar(stat="identity", width = 1, alpha=1) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  geom_label_repel(aes(label = paste(haplogroup1, " (", percent, "%", ")", sep = "")), 
                   size = 3.5,
                   position = position_stack(vjust = .1),
                   show.legend = FALSE) +
  coord_polar(theta = "y", start = 0) + theme_void() +
  ggtitle("Thailand (n=2339)") +
  scale_fill_manual(values = Haplocolors) +
  theme(plot.title = element_text(hjust = 0.5, vjust = -2, face = "bold"),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm"))

## Timor-Leste

timor_hap1 <- country_hap1 %>% filter(Country=="Timor-Leste")
Haplocolors <- dat[match(timor_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

timor <- timor_hap1 %>%
  ggplot(aes(x = "", y = percent, fill = haplogroup1)) +
  geom_bar(stat="identity", width = 1, alpha=1) +
  guides(fill=guide_legend(nrow=1, byrow=TRUE)) +
  geom_label_repel(aes(label = paste(haplogroup1, " (", percent, "%", ")", sep = "")), 
                   size = 3.5,
                   position = position_stack(vjust = .4),
                   show.legend = FALSE) +
  coord_polar(theta = "y", start = 0) + theme_void() +
  ggtitle("Timor-Leste (n=17)") +
  scale_fill_manual(values = Haplocolors) +
  theme(plot.title = element_text(hjust = 0.5, vjust = -2, face = "bold"),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm"))

## Vietnam

vietnam_hap1 <- country_hap1 %>% filter(Country=="Vietnam")
Haplocolors <- dat[match(vietnam_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

vietnam <- vietnam_hap1 %>%
  ggplot(aes(x = "", y = percent, fill = haplogroup1)) +
  geom_bar(stat="identity", width = 1, alpha=1) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  geom_label_repel(aes(label = paste(haplogroup1, " (", percent, "%", ")", sep = "")), 
                   size = 3.5,
                   position = position_stack(vjust = .3),
                   show.legend = FALSE) +
  coord_polar(theta = "y", start = 0) + theme_void() +
  ggtitle("Vietnam (n=706)") +
  scale_fill_manual(values = Haplocolors) +
  theme(plot.title = element_text(hjust = 0.5, vjust = -2, face = "bold"),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm"))

library(ggpubr)
library(gridExtra)
library(grid)

ggarrange(sea, brunei, cambodia, indonesia, laos, malaysia, myanmar, philippines, singapore, thailand, timor, vietnam, 
          common.legend = T, 
          legend = "bottom", 
          font.label = list(size = 20, color = "black")) + 
  bgcolor("white") 

ggsave("figures/SEA_Haplo_Pie_new.png", width = 15, height = 10)

# Language family

lf <- read_excel("CompleteFull.xlsx")
lf <- as.data.frame(lf)

library(janitor)
lf2 <- lf %>% filter(!`Language family` %in% c("rCRS", "RSRS")) %>%
  mutate(macrohap0="Macro-haplogroup L",
         macrohap0=ifelse(haplogroup1 %in% c("M", "C", "Z", "D", "E", "G", "Q"), "Macro-haplogroup M",
                          ifelse(haplogroup1 %in% c("R", "B", "F", "H", "V", "J", "T", "P", "U", "K", "N", "O", "A", "S", "I", "W", "X", "Y"), "Macro-haplogroup N", macrohap0)),
         macrohap1="Macro-haplogroup L",
         macrohap1=ifelse(haplogroup1 %in% c("M", "C", "Z", "D", "E", "G", "Q"), "Macro-haplogroup M",
                          ifelse(haplogroup1 %in% c("R", "B", "F", "H", "V", "J", "T", "P", "U", "K"), "Macro-haplogroup R",
                                 ifelse(haplogroup1 %in% c("N", "O", "A", "S", "I", "W", "X", "Y"), "Macro-haplogroup N (xR)", macrohap1))),
         haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`)))))))))))))))))),
         Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  dplyr::select(name, `Language family`, haplo, haplogroup1, haplogroup2, haplogroup3, macrohap0, macrohap1, Language_color, Haplogroup1_color) %>% setDT()

lf_rank <- lf2[, .N, by = .(`Language family`)]

lf_hap <- lf2[, .N, by = .(`Language family`, haplo)]
lf_hap <- lf_hap %>%
  group_by(`Language family`) %>% arrange(haplo, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

lf_hap3 <- lf2[, .N, by = .(`Language family`, haplogroup3)]
lf_hap3 <- lf_hap3 %>%
  group_by(`Language family`) %>% arrange(haplogroup3, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

lf_macro0 <- lf2[, .N, by = .(`Language family`, macrohap0)]
lf_macro0 <- lf_macro0 %>%
  group_by(`Language family`) %>% arrange(macrohap0, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1)) %>% ungroup()

lf_macro1 <- lf2[, .N, by = .(`Language family`, macrohap1)]
lf_macro1 <- lf_macro1 %>%
  group_by(`Language family`) %>% arrange(macrohap1, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1)) %>% ungroup()

lf_hap1 <- lf2[, .N, by = .(`Language family`, haplogroup1)]
lf_hap1 <- lf_hap1 %>%
  group_by(`Language family`) %>% arrange(haplogroup1, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1)) %>% ungroup()

lf_hap1$Haplocolors <- dat[match(lf_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]

Languagecolors <- unique(dat[match(lf_hap1$`Language family`, dat$`Language family`), "Language_color"])
rev_Languagecolors <- rev(Languagecolors)

g2 <- lf_hap1 %>%
  ggplot(aes(x=`Language family`, y=percent, fill=haplogroup1)) +      
  # Add the stacked bar
  geom_bar(position = "stack", stat="identity", alpha=1, data = lf_hap1 %>% filter(`Language family` == "Austroasiatic")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = lf_hap1 %>% filter(`Language family` == "Austroasiatic, Austronesian")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = lf_hap1 %>% filter(`Language family` == "Austroasiatic, Tai-Kaidai, Hmong-Mien")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = lf_hap1 %>% filter(`Language family` == "Austronesian")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = lf_hap1 %>% filter(`Language family` == "Austronesian, Sino-Tibetan")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = lf_hap1 %>% filter(`Language family` == "Austronesian, Trans–New Guinea")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = lf_hap1 %>% filter(`Language family` == "Hmong-Mien")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = lf_hap1 %>% filter(`Language family` == "Mayan")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = lf_hap1 %>% filter(`Language family` == "Sino-Tibetan")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = lf_hap1 %>% filter(`Language family` == "Tai-Kadai")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = lf_hap1 %>% filter(`Language family` == "Trans–New Guinea")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = lf_hap1 %>% filter(`Language family` == "Unknown")) +
  ggtitle("Language family") +
  guides(fill=guide_legend("Haplocolors", nrow=2, byrow=TRUE)) +
  # scale_fill_manual(values = Haplocolors) +
  scale_x_discrete(name = "Language family", limits = rev(unique(lf_hap1$`Language family`))) +
  scale_y_continuous(name = "Percent") +
  theme_bw() +
  theme(axis.text.y = element_text(colour = rev_Languagecolors, size=12),
        axis.title.y = element_text(colour = "black", size=12, face = "bold"),
        axis.title.x = element_text(colour = "black", size=10, face = "bold"),
        plot.title = element_text(hjust = 0.5, vjust = 1, face = "bold"),
        legend.position = "none", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm")) +
  coord_flip() +
  geom_label(aes(label = haplogroup1), 
             size = 4,
             label.size = NA,
             position = position_stack(vjust = .5),
             show.legend = FALSE)
g2

ggsave(filename = file.path("figures", "language_haplo1_new.png"), width = 15, height = 10)

# Ethnicity

ethnic <- read_excel("CompleteFull.xlsx")
ethnic <- as.data.frame(ethnic)

library(janitor)
ethnic <- ethnic %>% filter(!Ethnicity %in% c("rCRS", "RSRS")) %>%
  mutate(macrohap0="Macro-haplogroup L",
         macrohap0=ifelse(haplogroup1 %in% c("M", "C", "Z", "D", "E", "G", "Q"), "Macro-haplogroup M",
                          ifelse(haplogroup1 %in% c("R", "B", "F", "H", "V", "J", "T", "P", "U", "K", "N", "O", "A", "S", "I", "W", "X", "Y"), "Macro-haplogroup N", macrohap0)),
         macrohap1="Macro-haplogroup L",
         macrohap1=ifelse(haplogroup1 %in% c("M", "C", "Z", "D", "E", "G", "Q"), "Macro-haplogroup M",
                          ifelse(haplogroup1 %in% c("R", "B", "F", "H", "V", "J", "T", "P", "U", "K"), "Macro-haplogroup R",
                                 ifelse(haplogroup1 %in% c("N", "O", "A", "S", "I", "W", "X", "Y"), "Macro-haplogroup N (xR)", macrohap1))),
         haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`)))))))))))))))))),
         Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  dplyr::select(name, Ethnicity, haplo, haplogroup1, haplogroup2, haplogroup3, macrohap0, macrohap1, Ethnicity_color, Haplogroup1_color) %>% setDT()

ethnics1 <- c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun", "Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai", "Kinh, Tay, Thai, Muong, Hmong", "Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi", "Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan", "Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae", "Dao", "Hmong", "IuMien", "PaThen", "Mamanwa", "Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa", "Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai", "Papuan", "English", "Lun", "Unknown")
# dat2 <- !ethnics1 %in% unique(ethnic_hap1$Ethnicity)

ethnic <- ethnic %>%
  mutate(Ethnicity=factor(Ethnicity, levels = c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun", "Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai", "Kinh, Tay, Thai, Muong, Hmong", "Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi", "Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan", "Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae", "Dao", "Hmong", "IuMien", "PaThen", "Mamanwa", "Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa", "Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai", "Papuan", "English", "Lun", "Unknown")))

ethnic_rank <- ethnic[, .N, by = .(Ethnicity)]

ethnic_hap <- ethnic[, .N, by = .(Ethnicity, haplo)]
ethnic_hap <- ethnic_hap %>%
  group_by(Ethnicity) %>% arrange(haplo, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

ethnic_hap3 <- ethnic[, .N, by = .(Ethnicity, haplogroup3)]
ethnic_hap3 <- ethnic_hap3 %>%
  group_by(Ethnicity) %>% arrange(haplogroup3, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

ethnic_macro0 <- ethnic[, .N, by = .(Ethnicity, macrohap0)]
ethnic_macro0 <- ethnic_macro0 %>%
  group_by(Ethnicity) %>% arrange(macrohap0, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1)) %>% ungroup()

ethnic_macro1 <- ethnic[, .N, by = .(Ethnicity, macrohap1)]
ethnic_macro1 <- ethnic_macro1 %>%
  group_by(Ethnicity) %>% arrange(macrohap1, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1)) %>% ungroup()

ethnic_hap1 <- ethnic[, .N, by = .(Ethnicity, haplogroup1)]
ethnic_hap1 <- ethnic_hap1 %>%
  group_by(Ethnicity) %>% arrange(haplogroup1, .by_group = TRUE) %>% 
  mutate(percent=round((N*100)/sum(N),1)) %>% ungroup()

ethnic_hap1$Haplocolors <- dat[match(ethnic_hap1$haplogroup1, dat$haplogroup1), "Haplogroup1_color"]
Ethnicitycolors <- dat[match(ethnics1, dat$Ethnicity), "Ethnicity_color"]
rev_Ethinicitycolors <- rev(Ethnicitycolors)

g3 <- ethnic_hap1 %>%
  ggplot(aes(x=Ethnicity, y=percent, fill=haplogroup1)) +      
  # Add the stacked bar
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Batek")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Blang")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Bru (Brao)")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Deang")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "H’tin")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Jehai")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Kensiu")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Khamu")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Khmer")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Khuen")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Kinh")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Kinh, Muong, Khmer")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Kintaq")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Kreung")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Lawa")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Mang")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Maniq")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Mel Khaonh")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Mlabri")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Mon")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Nyahkur")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Orang Asli")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Paluang")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Phnong")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Semelai")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Soa")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Stieng")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Suay")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Tompoun")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Jahai, Semang")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Khmer Loeu")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Kinh, Cham, Ede, Giarai")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Kinh, Tay, Thai, Muong, Hmong")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Abaknon")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Aeta (Agta)")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Ambonese")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Bali Aga, Balinese")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Banjar")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Banjar, Dayak, Javanese")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Batak")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Batak, Acehnese")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Batak, Minangkabau, Acehnese, Lampung")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Besemah")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Bidayuh")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Bruneian Malay")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Bugis")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Bugkalot (or Ilongot)")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Bumiputera")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Cebuano - Filipino")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Cham")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Cuyunin (or Cuyonon)")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Dayak")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Ede")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Filipino (or Tagalog)")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Giarai")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Ibaloi")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Ifugao")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Indonesian")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Ivatan")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Jarai")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Javanese")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Kadazan-Dusun")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Kankanaey (or Igorot)")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Makassarese")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Malay")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Malay, Achehnese")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Manabo")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Maranao")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Minahasa")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Minangkabau")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Moken")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Sasak")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Seletar")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Semende")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Southern Thai_AN")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Sumatrans")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Sumbanese")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Sundanese")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Surigaonon")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Tagbanua")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Temuan")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Tengger")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "The Kalanguya (or Ikalahan)")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Toraja")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "UrakLawoi")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Taiwan")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Alorese, Alor Malay, Alor-Pantar")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Tetum, Mambai, Makasae")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Dao")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Hmong")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "IuMien")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "PaThen")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Mamanwa")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Achang")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Aini")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Arakanese (or Rakhine)")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Bamar (or Burman)")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Chin")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Chinese")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Dawei")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Han")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "HaNhi")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Hui")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Jingpo")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Karen")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Lahu")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Lisu")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "LoLo")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Naga")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "PhuLa")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "SiLa")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Ancient Thai")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Black Tai")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Central Thai")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "CoLao")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Dai")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Isan (or Lao)")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Kalueng")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Khon Mueang")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "LaChi")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Lao")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Nung")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Nyaw")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Phuan")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Phutai")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Seak")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Shan")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Southern Thai_TK")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Tai Lue")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Tai Yuan")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Tay")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Tay Nung")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Thai")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Papuan")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "English")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Lun")) +
  geom_bar(position = "stack", stat="identity", alpha=1, data = ethnic_hap1 %>% filter(Ethnicity == "Unknown")) +
  ggtitle("Ethnicity") +
  guides(fill=guide_legend("Haplocolors", nrow=2, byrow=TRUE)) +
  # scale_fill_manual(values = Haplocolors) +
  scale_x_discrete(name = "Ethnicity", limits = rev(unique(ethnic_hap1$Ethnicity))) +
  scale_y_continuous(name = "Percent") +
  theme_bw() +
  theme(axis.text.y = element_text(colour = rev_Ethinicitycolors, size=9),
        axis.title.y = element_text(colour = "black", size=12, face = "bold"),
        axis.title.x = element_text(colour = "black", size=12, face = "bold"),
        plot.title = element_text(hjust = 0.5, vjust = 1, face = "bold"),
        legend.position = "none", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm")) +
  coord_flip() +
  geom_label(aes(label = haplogroup1), 
             size = 2,
             label.size = NA,
             position = position_stack(vjust = .5),
             show.legend = FALSE)
g3

# ggsave(filename = file.path("figures", "ethnic_haplo1_new.png"), width = 10, height = 20)
# 
# ggarrange(ggarrange(g1, g2, nrow = 2, labels = c("A", "B"), heights = c(0.05, 0.05, 10)), # Second row with box and dot plots
#           g3,
#           ncol = 2, 
#           labels = "C"                                        # Labels of the scatter plot
# ) + bgcolor("white")

library(cowplot)   # get_legend() & plot_grid() functions
library(patchwork) # blank plot: plot_spacer()

plot_grid(plot_grid(g1, NULL, g2, 
                    nrow = 3, 
                    labels = c("A", "", "B"), 
                    rel_heights = c(1, 0.1, 1.2)), 
          g3, labels = c("", "C"), ncol = 2, 
          align = "h", 
          axis = "r", 
          rel_widths = c(1,1)) + 
  bgcolor("white") +
  theme(plot.background = element_rect(fill = "white", colour = NA))

ggsave("figures/SEA_Country_Language_Ethnic_Haplo.png", width = 15, height = 16)

# g3 <- ethnic_hap1 %>%
#   ggplot(aes(x=Ethnicity, y=percent, fill=haplogroup1)) +      
#   # Add the stacked bar
#   geom_bar(position = "stack", stat="identity", alpha=0.5) +
#   ggtitle("Language family") +
#   guides(fill=guide_legend("Haplocolors", nrow=5, byrow=TRUE)) +
#   # scale_fill_manual(values = Haplocolors) +
#   scale_x_discrete(name = "Ethnicity", limits = rev(unique(ethnic_hap1$Ethnicity))) +
#   scale_y_continuous(name = "Percent") +
#   theme_bw() +
#   theme(axis.text.y = element_text(colour = rev_Ethnicitycolors, size=12),
#         axis.title.y = element_text(colour = "black", size=12, face = "bold"),
#         axis.title.x = element_text(colour = "black", size=10, face = "bold"),
#         plot.title = element_text(hjust = 0.5, vjust = 1, face = "bold"),
#         legend.position = "none", 
#         legend.title = element_blank(), 
#         legend.text = element_text(size = 10),
#         legend.key.size = unit(0.5, "cm")) +
#   coord_polar() +
#   geom_label(aes(label = haplogroup1), 
#              size = 4,
#              label.size = NA,
#              position = position_stack(vjust = .5),
#              show.legend = FALSE)
# g3
# 
# ggsave(filename = file.path("figures", "ethnic_haplo1_new.png"), width = 20, height = 15)
# 
# options(ignore.negative.edge=TRUE)

###################################################

# Diversity

# Country

# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
dat <- as.data.frame(dat)
names <- dat$names

country <- dat %>%
  dplyr::select(name, Country, `Language family`, Ethnicity, haplo, haplogroup1, haplogroup2, haplogroup3) %>% setDT()
country_rank <- country[, .N, by = .(Country)] %>% arrange(desc(N))

country_hap <- country[, .N, by = .(Country, haplo)]
country_hap <- country_hap %>%
  group_by(Country) %>% arrange(haplo, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

country_hap3 <- country[, .N, by = .(Country, haplogroup3)]
country_hap3 <- country_hap3 %>%
  group_by(Country) %>% arrange(haplogroup3, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

library(janitor)

library(pegas)
library(ape)

dat_c <- NULL
for (i in country_rank$Country) {
  cat(i, "\n")
  df_i <- country %>% dplyr::filter(Country==i)
  n_i <- nrow(df_i)
  nbin_i <- nbin[labels(nbin) %in% df_i$name]
  h_i <- pegas::haplotype(nbin_i)
  n_hi <- length(as.list(h_i))
  fas_i <- file2[labels(nbin) %in% df_i$name]
  writeXStringSet(fas_i, paste0("data/country/", i, "_Aligned.fasta"))
  dnbin_i <- dist.dna(nbin_i, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
  x_i <- as.matrix.DNAbin(nbin_i)  #converting DNAbin to matrix
  dist.gene_i <- dist.gene(x_i, method = "pairwise", variance = TRUE, pairwise.deletion = FALSE)
  mpd_i <- mean(dist.gene_i)
  hap.div_i <- hap.div(nbin_i, variance = TRUE)
  nuc.div_i <- nuc.div(nbin_i, variance = TRUE, pairwise.deletion = FALSE) # hap.div = 1 all haplotypes are unique
  dati <- data.frame(df_i$Country, n_i, n_hi, hap.div_i[1], hap.div_i[2], nuc.div_i[1], nuc.div_i[2], mpd_i) %>% slice(1)
  ## combine
  dat_c <- rbindlist(l = list(dat_c, dati)) %>% unique() %>% setDT()
}
# Rename
setnames(x = dat_c,
         old = c("df_i.Country", "n_i", "n_hi", "hap.div_i.1.", "hap.div_i.2.", "nuc.div_i.1.", "nuc.div_i.2.", "mpd_i"),
         new = c("Country", "Sample size", "Number of haplotypes", "Haplotype diversity (H)", "H variance", "Nucleotide diveristy (pi)", "pi SE", "MPD"))

library(writexl)
write_xlsx(dat_c, "SEA_country_new.xlsx")

# Language family

lf <- read_excel("CompleteFull.xlsx")
lf <- as.data.frame(lf)

library(janitor)
lf2 <- lf %>%
  mutate(`Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`))))))))))))))))))) %>%
  dplyr::select(name, `Language family`, haplo, haplogroup1, haplogroup2, haplogroup3) %>% setDT()
lf_rank <- lf2[, .N, by = .(`Language family`)]

lf_hap <- lf2[, .N, by = .(`Language family`, haplo)]
lf_hap <- lf_hap %>%
  group_by(`Language family`) %>% arrange(haplo, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

lf_hap3 <- lf2[, .N, by = .(`Language family`, haplogroup3)]
lf_hap3 <- lf_hap3 %>%
  group_by(`Language family`) %>% arrange(haplogroup3, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

library(pegas)
library(ape)

dat_lf <- NULL
for (i in lf_rank$`Language family`) {
  cat(i, "\n")
  df_i <- lf2 %>% dplyr::filter(`Language family`==i)
  n_i <- nrow(df_i)
  nbin_i <- nbin[labels(nbin) %in% df_i$name]
  h_i <- pegas::haplotype(nbin_i)
  n_hi <- length(as.list(h_i))
  fas_i <- file2[labels(nbin) %in% df_i$name]
  writeXStringSet(fas_i, paste0("data/language/", i, ".fasta"))
  dnbin_i <- dist.dna(nbin_i, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
  x_i <- as.matrix.DNAbin(nbin_i)  #converting DNAbin to matrix
  dist.gene_i <- dist.gene(x_i, method = "pairwise", variance = TRUE, pairwise.deletion = FALSE)
  mpd_i <- mean(dist.gene_i)
  hap.div_i <- hap.div(nbin_i, variance = TRUE)
  nuc.div_i <- nuc.div(nbin_i, variance = TRUE, pairwise.deletion = FALSE) # hap.div = 1 all haplotypes are unique
  dati <- data.frame(df_i$`Language family`, n_i, n_hi, hap.div_i[1], hap.div_i[2], nuc.div_i[1], nuc.div_i[2], mpd_i) %>% slice(1)
  ## combine
  dat_lf <- rbindlist(l = list(dat_lf, dati)) %>% unique() %>% setDT()
}
# Rename
setnames(x = dat_lf,
         old = c("df_i..Language.family.", "n_i", "n_hi", "hap.div_i.1.", "hap.div_i.2.", "nuc.div_i.1.", "nuc.div_i.2.", "mpd_i"),
         new = c("Language", "Sample size", "Number of haplotypes", "Haplotype diversity (H)", "H variance", "Nucleotide diveristy (pi)", "pi SE", "MPD"))

library(writexl)
write_xlsx(dat_lf, "SEA_language_new.xlsx")

# Ethnicity

## Diversity

# ethnic <- read_excel("IsolateExplanation.xlsx")
ethnic <- read_excel("CompleteFull.xlsx")

library(janitor)
ethnic2 <- ethnic %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity))))))) %>%
  dplyr::select(name, Country, `Language family`, Ethnicity, haplo, haplogroup1, haplogroup2, haplogroup3) %>% setDT()
ethnic_rank <- ethnic2[, .N, by = .(Ethnicity)] %>% arrange(desc(N))

ethnic_hap <- ethnic2[, .N, by = .(Ethnicity, haplo)]
ethnic_hap <- ethnic_hap %>%
  group_by(Ethnicity) %>% arrange(haplo, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

ethnic_hap3 <- ethnic2[, .N, by = .(Ethnicity, haplogroup3)]
ethnic_hap3 <- ethnic_hap3 %>%
  group_by(Ethnicity) %>% arrange(haplogroup3, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

library(pegas)
library(ape)

dat_e <- NULL
for (i in ethnic_rank$Ethnicity) {
  cat(i, "\n")
  df_i <- ethnic2 %>% dplyr::filter(Ethnicity==i)
  n_i <- nrow(df_i)
  nbin_i <- nbin[labels(nbin) %in% df_i$name]
  h_i <- pegas::haplotype(nbin_i)
  n_hi <- length(as.list(h_i))
  fas_i <- file2[labels(nbin) %in% df_i$name]
  writeXStringSet(fas_i, paste0("data/ethnic/", i, ".fasta"))
  dnbin_i <- dist.dna(nbin_i, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
  x_i <- as.matrix.DNAbin(nbin_i)  #converting DNAbin to matrix
  dist.gene_i <- dist.gene(x_i, method = "pairwise", variance = TRUE, pairwise.deletion = FALSE)
  mpd_i <- mean(dist.gene_i)
  hap.div_i <- hap.div(nbin_i, variance = TRUE)
  nuc.div_i <- nuc.div(nbin_i, variance = TRUE, pairwise.deletion = FALSE) # hap.div = 1 all haplotypes are unique
  dati <- data.frame(df_i$Ethnicity, df_i$`Language family`, df_i$Country, n_i, n_hi, hap.div_i[1], hap.div_i[2], nuc.div_i[1], nuc.div_i[2], mpd_i) %>% slice(1)
  ## combine
  dat_e <- rbindlist(l = list(dat_e, dati)) %>% unique() %>% setDT()
}
# Rename
setnames(x = dat_e,
         old = c("df_i.Ethnicity", "df_i..Language.family.", "df_i.Country", "n_i", "n_hi", "hap.div_i.1.", "hap.div_i.2.", "nuc.div_i.1.", "nuc.div_i.2.", "mpd_i"),
         new = c("Ethnic", "Language", "Country", "Sample size", "Number of haplotypes", "Haplotype diversity (H)", "H variance", "Nucleotide diveristy (pi)", "pi SE", "MPD"))

library(writexl)
write_xlsx(dat_e, "SEA_ethnicity_new.xlsx")

## Plot diversity difference from mean

e <- read_excel("SEA_ethnicity_new.xlsx")
e <- as.data.frame(e)

### New variable for the difference between each value and the mean

e <- e %>%
  mutate(hap_dif = (`Haplotype diversity (H)` - mean(`Haplotype diversity (H)`))*100 / mean(`Haplotype diversity (H)`),
         nu_dif = (`Nucleotide diveristy (pi)` - mean(`Nucleotide diveristy (pi)`))*100 / mean(`Nucleotide diveristy (pi)`),
         `Ethnic` = factor(`Ethnic`, levels = c("Blang", "Bru (Brao)", "H’tin", "Jehai", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun", "Khmer Loeu", "Kinh, Cham, Ede, Giarai", "Kinh, Tay, Thai, Muong, Hmong", "Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Surigaonon", "Temuan", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi", "Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae", "Dao", "Hmong", "IuMien", "PaThen", "Mamanwa", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Han", "HaNhi", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa", "Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai", "Papuan", "Unknown")),
         Language_color=NA,
         Language_color=ifelse(`Language`=="RSRS", "black",
                               ifelse(`Language`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language`=="Austronesian", "#9900ff",
                                                           ifelse(`Language`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language`=="rCRS", "orange",
                                                                                ifelse(`Language`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language`=="Mayan", "#660000",
                                                                                              ifelse(`Language`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnic %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnic %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnic=="RSRS", "black",
                                              ifelse(Ethnic %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnic %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnic %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnic %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnic %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnic %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnic %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnic %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnic %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnic %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnic %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnic)))))))))))))),
  ) %>% droplevels()

e <- e %>% 
  mutate(Ethnic=factor(Ethnic, levels = c("Blang", "Bru (Brao)", "H’tin", "Jehai", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun", "Khmer Loeu", "Kinh, Cham, Ede, Giarai", "Kinh, Tay, Thai, Muong, Hmong", "Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Surigaonon", "Temuan", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi", "Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae", "Dao", "Hmong", "IuMien", "PaThen", "Mamanwa", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Han", "HaNhi", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa", "Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai", "Papuan", "Unknown")))

ethnics <- c("Blang", "Bru (Brao)", "H’tin", "Jehai", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun", "Khmer Loeu", "Kinh, Cham, Ede, Giarai", "Kinh, Tay, Thai, Muong, Hmong", "Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Surigaonon", "Temuan", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi", "Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae", "Dao", "Hmong", "IuMien", "PaThen", "Mamanwa", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Han", "HaNhi", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa", "Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai", "Papuan", "Unknown")
Ethniccolors <- e[match(ethnics, e$Ethnic), "Ethnicity_color"]
rev_Ethniccolors <- rev(Ethniccolors)

Languagecolors <- e$Language_color

# Plot heatmap

ggplot(data = fst.df, aes(x = Site1, y = Site2, fill = Fst)) +
  geom_tile(colour = "black")+
  # geom_text(aes(label = Fst), color="black", size = 3)+
  scale_fill_gradient2(low = "blue", mid = "yellow", high = "red", midpoint = mid, name = fst.label, limits = c(0, max(fst.df$Fst)), breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)) +
  scale_x_discrete(expand = c(0,0), labels = wrap_format(50))+
  scale_y_discrete(expand = c(0,0), position = "right")+
  theme(axis.text = element_text(colour = "black", size = 20, face = "bold"),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "top",
        legend.title = element_text(size = 30, face = "bold"),
        legend.text = element_text(size = 20),
        legend.key.width = unit(4, "cm"),
        legend.spacing.x = unit(2, "cm"),
        axis.text.x=element_text(color=Ethniccolors1, angle = 90, size=20, vjust=0, hjust=1),
        axis.text.y=element_text(color=Ethniccolors2, size=20)
  )

library(ggallin)
library(scales)

g1 <- ggplot(data = e, aes(x = Ethnic, y = hap_dif, group = Language)) +
  geom_point(aes(shape=Language, color=Language), size=10, stroke=1) +
  geom_hline(yintercept=0, linetype="solid", color = "grey", linewidth=6) +
  coord_flip() +
  scale_x_discrete(name = "Ethnicity", limits = rev(levels(e$Ethnic))) +
  scale_y_continuous(name = "Haplotype diversity % difference from mean", trans = pseudolog10_trans) +
  scale_shape_manual(values=c(1:12))+
  scale_color_manual(values=c("#fa0f0c", "#996666", "#cccc33", "#9900ff", "#163566", "#66ccff", "#0099ff", "#660000", "#336699", "#339900", "#66ccff", "lightgrey"))+
  theme(axis.text = element_text(colour = "black", size = 30),
        plot.background = element_rect(fill = "white"), 
        panel.background = element_rect(fill = "white"),
        panel.grid.minor = element_line(colour = "lightgrey"),
        panel.grid.major = element_line(colour = "lightgrey"),
        legend.position="right",
        legend.title = element_text(size = 36, face = "bold"),
        legend.text = element_text(size = 30),
        legend.key.height = unit(2, "cm"),
        legend.spacing.y = unit(1, "cm"),
        axis.text.y = element_text(colour = rev_Ethniccolors, size=30),
        axis.title.y = element_text(colour = "black", size=40, face = "bold"),
        axis.title.x = element_text(colour = "black", size=36, face = "bold"))

ggsave("figures/H_difference.png", width = 30, height = 45)

g2 <- ggplot(data = e, aes(x = Ethnic, y = nu_dif, group = Language)) +
  geom_point(aes(shape=Language, color=Language), size=10, stroke=1) +
  geom_hline(yintercept=0, linetype="solid", color = "grey", linewidth=6) +
  coord_flip() +
  scale_x_discrete(name = "Ethnicity", limits = rev(levels(e$Ethnic))) +
  scale_y_continuous(name = "Nucleotide diversity % difference from mean", trans = pseudolog10_trans, breaks = c(-100, -50, 0, 50)) +
  scale_shape_manual(values=c(1:12))+
  scale_color_manual(values=c("#fa0f0c", "#996666", "#cccc33", "#9900ff", "#163566", "#66ccff", "#0099ff", "#660000", "#336699", "#339900", "#66ccff", "lightgrey"))+
  theme(axis.text = element_text(colour = "black", size = 30),
        plot.background = element_rect(fill = "white"), 
        panel.background = element_rect(fill = "white"),
        panel.grid.minor = element_line(colour = "lightgrey"),
        panel.grid.major = element_line(colour = "lightgrey"),
        legend.position="right",
        legend.title = element_text(size = 36, face = "bold"),
        legend.text = element_text(size = 30),
        legend.key.height = unit(2, "cm"),
        legend.spacing.y = unit(1, "cm"),
        axis.text.y = element_text(colour = rev_Ethniccolors, size=30),
        axis.title.y = element_text(colour = "black", size=40, face = "bold"),
        axis.title.x = element_text(colour = "black", size=36, face = "bold"))

ggsave("figures/Nu_difference.png", width = 30, height = 45)

library(ggpubr)
library(gridExtra)
library(grid)

g12 <- gridExtra::grid.arrange(g1, g1, ncol=2)

ggarrange(g1, g2, labels = c("A", "B"), hjust=-1.7, vjust=1.5, common.legend = T, legend = "top", font.label = list(size = 48, color = "black"))

ggsave("figures/H_Nu_difference.png", width = 45, height = 47)

## Fst shared haplotype

library("hierfstat")
library("adegenet")

### Load the meta file that contains population structure 
# dat <- read_excel("IsolateExplanation.xlsx")
dat <- read_excel("CompleteFull.xlsx")
# dat$name <- gsub("\\+", "", dat$name)
# dat$name <- gsub("\\'", "", dat$name)
# dat$name <- gsub("\\(", "", dat$name)
# dat$name <- gsub("\\)", "", dat$name)
# dat$name <- gsub("\\_", "", dat$name)
# dat$name <- gsub("\\-", "", dat$name)
# dat$name <- gsub(" ", "", dat$name)
# dat$name <- gsub("\\*", "", dat$name)
# dat$name <- gsub("\\@", "", dat$name)
# dat$name <- gsub("\\!", "", dat$name)
# dat$name <- gsub("\\,", "", dat$name)
# dat$name <- gsub("\\,", "", dat$name)
# dat$name <- trimws(gsub("\\s+", " ", dat$name))
dat <- as.data.frame(dat)

meta <- dat %>%
  mutate(haplogroup2=ifelse(haplogroup2=="A+152"|haplogroup2=="A+152+16362"|haplogroup2=="A+152+16362+200", "A+",
                            ifelse(haplogroup2=="R+16189", "R+", haplogroup2)),
         Country_color=NA,
         Country_color=ifelse(Country=="Brunei", "#ff6633",
                              ifelse(Country=="Cambodia", "#ffff00",
                                     ifelse(Country=="Indonesia", "#9900ff",
                                            ifelse(Country=="Laos", "#0099ff",
                                                   ifelse(Country=="Malaysia", "#990f80",
                                                          ifelse(Country=="Myanmar", "#99ff99",
                                                                 ifelse(Country=="Philippines", "#cc66ff",
                                                                        ifelse(Country=="Singapore", "#ff9999",
                                                                               ifelse(Country=="Thailand", "#339900",
                                                                                      ifelse(Country=="Timor-Leste", "#66ccff",
                                                                                             ifelse(Country=="Vietnam", "#fa0f0c",
                                                                                                    ifelse(Country=="RSRS", "black",
                                                                                                           ifelse(Country=="rCRS", "orange", Country_color))))))))))))),
         `Language family`=ifelse(Ethnicity=="Mon", "Austroasiatic",
                                  ifelse(Ethnicity=="Hmong", "Hmong-Mien",
                                         ifelse(Ethnicity=="Shan", "Tai-Kadai",
                                                ifelse(Ethnicity=="Jehai (or Jahai)", "Austroasiatic",
                                                       ifelse(Ethnicity=="Temuan", "Austronesian",
                                                              ifelse(Ethnicity=="Maranao", "Austronesian",
                                                                     ifelse(Ethnicity=="Semelai", "Austroasiatic",
                                                                            ifelse(Ethnicity=="Bru (Brao)", "Austroasiatic",
                                                                                   ifelse(Ethnicity=="Jarai", "Austronesian",
                                                                                          ifelse(Ethnicity=="Kadazan-Dusun", "Austronesian",
                                                                                                 ifelse(Ethnicity=="Alor", "Austronesian",
                                                                                                        ifelse(Ethnicity=="Arakanese (or Rakhine)", "Sino-Tibetan",
                                                                                                               ifelse(Ethnicity=="Timorese", "Austronesian",
                                                                                                                      ifelse(Ethnicity=="Mang", "Austroasiatic",
                                                                                                                             ifelse(Ethnicity=="Dao", "Hmong-Mien", 
                                                                                                                                    ifelse(Ethnicity=="English", "Unknown",
                                                                                                                                           ifelse(Ethnicity=="Batek", "Austroasiatic",
                                                                                                                                                  ifelse(Ethnicity=="Orang Asli", "Austroasiatic",`Language family`)))))))))))))))))),
         Language_color=NA,
         Language_color=ifelse(`Language family`=="RSRS", "black",
                               ifelse(`Language family`=="Austroasiatic", "#fa0f0c",
                                      ifelse(`Language family`=="Austroasiatic, Austronesian", "#996666",
                                             ifelse(`Language family`=="Austroasiatic, Tai-Kaidai, Hmong-Mien", "#cccc33",
                                                    ifelse(`Language family`=="Austronesian", "#9900ff",
                                                           ifelse(`Language family`=="Austronesian, Sino-Tibetan", "#163566",
                                                                  ifelse(`Language family`=="Austronesian, Trans–New Guinea", "#cc66ff",
                                                                         ifelse(`Language family`=="rCRS", "orange",
                                                                                ifelse(`Language family`=="Hmong-Mien", "#0099ff",
                                                                                       ifelse(`Language family`=="Mayan", "#660000",
                                                                                              ifelse(`Language family`=="Sino-Tibetan", "#336699",
                                                                                                     ifelse(`Language family`=="Tai-Kadai", "#339900",
                                                                                                            ifelse(`Language family`=="Trans–New Guinea", "#66ccff",
                                                                                                                   ifelse(`Language family`=="Unknown", "lightgrey",
                                                                                                                          Language_color)))))))))))))),
         Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))),
         Ethnicity_color=NA,
         Ethnicity_color=ifelse(Ethnicity %in% c("Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi"), "#9900ff",
                                ifelse(Ethnicity %in% c("Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa"), "#336699",
                                       ifelse(Ethnicity=="RSRS", "black",
                                              ifelse(Ethnicity %in% c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun"), "#fa0f0c",
                                                     ifelse(Ethnicity %in% c("Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai"), "#996666",
                                                            ifelse(Ethnicity %in% c("Papuan"), "#66ccff",
                                                                   ifelse(Ethnicity %in% c("Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai"), "#339900",
                                                                          ifelse(Ethnicity %in% c("Dao", "Hmong", "IuMien", "PaThen"), "#0099ff",
                                                                                 ifelse(Ethnicity %in% c("rCRS"), "orange",
                                                                                        ifelse(Ethnicity %in% c("Kinh, Tay, Thai, Muong, Hmong"), "#cccc33",
                                                                                               ifelse(Ethnicity %in% c("Mamanwa"), "#660000",
                                                                                                      ifelse(Ethnicity %in% c("English", "Lun", "Unknown"), "lightgrey",
                                                                                                             ifelse(Ethnicity %in% c("Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan"), "#163566",
                                                                                                                    ifelse(Ethnicity %in% c("Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae"), "#cc66ff", Ethnicity)))))))))))))),
         Haplogroup1_color=NA,
         Haplogroup1_color=ifelse(haplogroup1=="A", "#F8766D",
                                  ifelse(haplogroup1=="B", "#EA8331",
                                         ifelse(haplogroup1=="C", "#D89000",
                                                ifelse(haplogroup1=="D", "#C09B00",
                                                       ifelse(haplogroup1=="E", "#A3A500",
                                                              ifelse(haplogroup1=="F", "#39B600",
                                                                     ifelse(haplogroup1=="G", "#7CAE00",
                                                                            ifelse(haplogroup1=="H", "yellow",
                                                                                   ifelse(haplogroup1=="I", "#00BF7D",
                                                                                          ifelse(haplogroup1=="K", "#00C1A3",
                                                                                                 ifelse(haplogroup1=="L", "black",
                                                                                                        ifelse(haplogroup1=="M", "#00BAE0",
                                                                                                               ifelse(haplogroup1=="N", "#00B0F6",
                                                                                                                      ifelse(haplogroup1=="P", "#35A2FF",
                                                                                                                             ifelse(haplogroup1=="Q", "#9590FF",
                                                                                                                                    ifelse(haplogroup1=="R", "#C77CFF",
                                                                                                                                           ifelse(haplogroup1=="U", "#E76BF3",
                                                                                                                                                  ifelse(haplogroup1=="W", "#FA62DB",
                                                                                                                                                         ifelse(haplogroup1=="Y", "#FF62BC",
                                                                                                                                                                ifelse(haplogroup1=="Z", "#FF6A98",
                                                                                                                                                                       Haplogroup1_color))))))))))))))))))))) %>%
  droplevels()

ethnics1 <- c("Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun", "Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai", "Kinh, Tay, Thai, Muong, Hmong", "Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi", "Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan", "Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae", "Dao", "Hmong", "IuMien", "PaThen", "Mamanwa", "RSRS", "Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa", "Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai", "Papuan", "English", "Lun", "Unknown", "rCRS")
ethnics2 <- c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun", "Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai", "Kinh, Tay, Thai, Muong, Hmong", "Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi", "Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan", "Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae", "Dao", "Hmong", "IuMien", "PaThen", "Mamanwa", "RSRS", "Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa", "Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai", "Papuan", "English", "Lun", "Unknown")

meta <- meta %>% filter(Ethnicity %in% ethnics1 | Ethnicity %in% ethnics2) %>% 
  mutate(Ethnicity=factor(Ethnicity, levels = c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun", "Jahai, Semang", "Khmer Loeu", "Kinh, Cham, Ede, Giarai", "Kinh, Tay, Thai, Muong, Hmong", "Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi", "Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)", "Taiwan", "Alorese, Alor Malay, Alor-Pantar", "Tetum, Mambai, Makasae", "Dao", "Hmong", "IuMien", "PaThen", "Mamanwa", "RSRS", "Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa", "Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai", "Papuan", "English", "Lun", "Unknown", "rCRS")))

### Lets load the fasta file by extract only the SNPs
seq.snp = fasta2DNAbin('Iso_RSRS_RCRS_countriesAlign.fasta', snpOnly=T)
obj = DNAbin2genind(seq.snp)

# rownames(obj$tab) <- gsub("'", "", rownames(obj$tab))
# rownames(obj$tab) <- gsub("_", "", rownames(obj$tab))
# rownames(obj$tab) <- gsub("-", "", rownames(obj$tab))
# rownames(obj$tab) <- gsub(" ", "", rownames(obj$tab))
# rownames(obj$tab) <- gsub(",", "", rownames(obj$tab))
# rownames(obj$tab) <- trimws(gsub("\\s+", " ", rownames(obj$tab)))
rownames(obj$tab)[4933] <- "NC_012920.1"

dat2 <- dat %>% filter(!name %in% rownames(obj$tab))
table(rownames(obj$tab) %in% dat$name)
table(dat$name %in% rownames(obj$tab))


### Add the structure I want to test in the GenInd object
obj$pop = as.factor(meta[match(rownames(obj$tab), meta$name),]$Ethnicity)

### Convert genind object into hierfstat object
obj.hf = genind2hierfstat(obj)

### Various estimation of Fst
fst_nei <- genet.dist(obj.hf, method='Nei87', diploid=F)
# fst_dch <- genet.dist(obj.hf, method='Dch', diploid=F)

### Visualise pairwise FST for Ethnicity.
ethnic3 <- dat %>%
  dplyr::select(name, Country, `Language family`, Ethnicity, haplo, haplogroup1, haplogroup2, haplogroup3) %>% setDT()
ethnic_name <- ethnic3[, .N, by = .(Ethnicity)] %>% arrange(Ethnicity) %>% filter(N>1)

# Desired order of labels
lab_order = ethnic_name$Ethnicity

# Change order of rows and cols
fst.mat = as.matrix(fst_nei)
fst.mat1 = fst.mat
fst.mat2 = fst.mat1

# Create a data.frame
ind = which(upper.tri(fst.mat2), arr.ind = TRUE)
fst.df = data.frame(Site1 = dimnames(fst.mat2)[[2]][ind[,2]],
                    Site2 = dimnames(fst.mat2)[[1]][ind[,1]],
                    Fst = fst.mat2[ ind ])

fst.df <- fst.df %>% mutate_all(~ifelse(is.nan(.), NA, .))

# Keep the order of the levels in the data.frame for plotting 
fst.df$Site1 = factor(fst.df$Site1, levels = unique(fst.df$Site1))
fst.df$Site2 = factor(fst.df$Site2, levels = unique(fst.df$Site2))

# Convert minus values to zero
fst.df$Fst[fst.df$Fst < 0] = 0

# Print data.frame summary
fst.df %>% str
# 'data.frame':	9730 obs. of  3 variables:
#   $ Site1: Factor w/ 139 levels "Blang","Bru (Brao)",..: 1 2 2 3 3 3 4 4 4 4 ...
# $ Site2: Factor w/ 139 levels "Batek","Blang",..: 1 1 2 1 2 3 1 2 3 4 ...
# $ Fst  : num  0.0703 0.0825 0.0665 NA 0 ...

# Fst italic label
fst.label = expression(italic("F")[ST])

# Extract middle Fst value for gradient argument
mid = max(fst.df$Fst, na.rm = TRUE) / 2

Ethniccolors1 <- meta[match(ethnics1, meta$Ethnicity), "Ethnicity_color"]
Ethniccolors2 <- meta[match(ethnics2, meta$Ethnicity), "Ethnicity_color"]

# Plot heatmap

ggplot(data = fst.df, aes(x = Site1, y = Site2, fill = Fst)) +
  geom_tile(colour = "black")+
  # geom_text(aes(label = Fst), color="black", size = 3)+
  scale_fill_gradient2(low = "blue", mid = "yellow", high = "red", midpoint = mid, name = fst.label, limits = c(0, max(fst.df$Fst)), breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)) +
  scale_x_discrete(expand = c(0,0), labels = wrap_format(50))+
  scale_y_discrete(expand = c(0,0), position = "right")+
  theme(axis.text = element_text(colour = "black", size = 20, face = "bold"),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "top",
        legend.title = element_text(size = 30, face = "bold"),
        legend.text = element_text(size = 20),
        legend.key.width = unit(4, "cm"),
        legend.spacing.x = unit(2, "cm"),
        axis.text.x=element_text(color=Ethniccolors1, angle = 90, size=20, vjust=0, hjust=1),
        axis.text.y=element_text(color=Ethniccolors2, size=20)
  )

ggsave("figures/Fst_Ethnicity_new.png", width = 45, height = 45)

library(xlsx)
# write.xlsx(fst.mat, "Fst_new.xlsx")

### Single ethnicity

ethnics1_short <- c("Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun", "Khmer Loeu", "Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi", "Dao", "Hmong", "IuMien", "PaThen", "Mamanwa", "RSRS", "Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa", "Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai", "Papuan", "English", "Lun", "Unknown", "rCRS")
ethnics2_short <- c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun", "Khmer Loeu", "Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi", "Dao", "Hmong", "IuMien", "PaThen", "Mamanwa", "RSRS", "Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa", "Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai", "Papuan", "English", "Lun", "Unknown")

meta_short <- meta %>% filter(Ethnicity %in% ethnics1_short | Ethnicity %in% ethnics2_short) %>% 
  mutate(Ethnicity=factor(Ethnicity, levels = c("Batek", "Blang", "Bru (Brao)", "Deang", "H’tin", "Jehai", "Kensiu", "Khamu", "Khmer", "Khuen", "Kinh", "Kinh, Muong, Khmer", "Kintaq", "Kreung", "Lawa", "Mang", "Maniq", "Mel Khaonh", "Mlabri", "Mon", "Nyahkur", "Orang Asli", "Paluang", "Phnong", "Semelai", "Soa", "Stieng", "Suay", "Tompoun", "Khmer Loeu", "Abaknon", "Aeta (Agta)", "Ambonese", "Bali Aga, Balinese", "Banjar", "Banjar, Dayak, Javanese", "Batak", "Batak, Acehnese", "Batak, Minangkabau, Acehnese, Lampung", "Besemah", "Bidayuh", "Bruneian Malay", "Bugis", "Bugkalot (or Ilongot)", "Bumiputera", "Cebuano - Filipino", "Cham", "Cuyunin (or Cuyonon)", "Dayak", "Ede", "Filipino (or Tagalog)", "Giarai", "Ibaloi", "Ifugao", "Igorot", "Indonesian", "Ivatan", "Jarai", "Javanese", "Kadazan-Dusun", "Kankanaey (or Igorot)", "Makassarese", "Malay", "Malay, Achehnese", "Manabo", "Maranao", "Minahasa", "Minangkabau", "Moken", "Sasak", "Seletar", "Semende", "Southern Thai_AN", "Sumatrans", "Sumbanese", "Sundanese", "Surigaonon", "Tagbanua", "Temuan", "Tengger", "The Kalanguya (or Ikalahan)", "Toraja", "UrakLawoi", "Dao", "Hmong", "IuMien", "PaThen", "Mamanwa", "RSRS", "Achang", "Aini", "Arakanese (or Rakhine)", "Bamar (or Burman)", "Chin", "Chinese", "Dawei", "Han", "HaNhi", "Hui", "Jingpo", "Karen", "Lahu", "Lisu", "LoLo", "Naga", "PhuLa", "SiLa", "Ancient Thai", "Black Tai", "Central Thai", "CoLao", "Dai", "Isan (or Lao)", "Kalueng", "Khon Mueang", "LaChi", "Lao", "Nung", "Nyaw", "Phuan", "Phutai", "Seak", "Shan", "Southern Thai_TK", "Tai Lue", "Tai Yuan", "Tay", "Tay Nung", "Thai", "Papuan", "English", "Lun", "Unknown", "rCRS")))

obj_short <- obj[rownames(obj$tab) %in% meta_short$name] 


### Add the structure I want to test in the GenInd object
obj_short$pop = as.factor(meta_short[match(rownames(obj_short$tab), meta_short$name),]$Ethnicity)

### Convert genind object into hierfstat object
obj.hf_short = genind2hierfstat(obj_short)

# obj.hf_short$names <- rownames(obj.hf_short)
# 
# obj.hf_short <- obj.hf_short %>% mutate(names=factor(names, levels=meta_short$name))
# 
# library(tidyverse)
# obj.hf_short <- obj.hf_short %>% remove_rownames %>% column_to_rownames(var="names")

### Various estimation of Fst
fst_nei_short <- genet.dist(obj.hf_short, method='Nei87', diploid=F)
# fst_dch_short <- genet.dist(obj.hf_short, method='Dch', diploid=F)

### Visualise pairwise FST for Ethnicity.
ethnic3_short <- meta_short %>%
  dplyr::select(name, Country, `Language family`, Ethnicity, haplo, haplogroup1, haplogroup2, haplogroup3) %>% setDT()

ethnic_name_short <- ethnic3_short[, .N, by = .(Ethnicity)] %>% filter(N>1)

# Desired order of labels
lab_order_short = ethnic_name_short$Ethnicity

# Change order of rows and cols
fst.mat_short = as.matrix(fst_nei_short)
fst.mat1_short = fst.mat_short
fst.mat2_short = fst.mat1_short

# Create a data.frame
ind_short = which(upper.tri(fst.mat2_short), arr.ind = TRUE)
fst.df_short = data.frame(Site1 = dimnames(fst.mat2_short)[[2]][ind_short[,2]],
                          Site2 = dimnames(fst.mat2_short)[[1]][ind_short[,1]],
                          Fst = fst.mat2_short[ ind_short ])

fst.df_short <- fst.df_short %>% mutate_all(~ifelse(is.nan(.), NA, .))

# Keep the order of the levels in the data.frame for plotting 
fst.df_short$Site1 = factor(fst.df_short$Site1, levels = unique(fst.df_short$Site1))
fst.df_short$Site2 = factor(fst.df_short$Site2, levels = unique(fst.df_short$Site2))

# rows1 = lapply(ethnics1_short, FUN = function(x) which(fst.df_short$Site1 == x))
# result1 = fst.df_short[unlist(rows1), ]
# result1 <- unique(result1)
# 
# rows2 = lapply(ethnics2_short, FUN = function(x) which(fst.df_short$Site2 == x))
# result2 = fst.df_short[unlist(rows2), ]
# result2 <- unique(result2)
# 
# fst.df_short <- fst.df_short %>% mutate(Site1=factor(Site1, levels=unique(result1$Site1)), Site2=factor(Site2, levels=unique(result2$Site2)))

# Convert minus values to zero
fst.df_short$Fst[fst.df_short$Fst < 0] = 0

# Print data.frame summary
# fst.df_short %>% str
# 'data.frame':	8778 obs. of  3 variables:
#   $ Site1: Factor w/ 132 levels "Blang","Bru (Brao)",..: 1 2 2 3 3 3 4 4 4 4 ...
# $ Site2: Factor w/ 132 levels "Batek","Blang",..: 1 1 2 1 2 3 1 2 3 4 ...
# $ Fst  : num  0.0703 0.0825 0.0665 NA 0 ...

# Fst italic label
fst.label_short = expression(italic("F")[ST])

# Extract middle Fst value for gradient argument
mid_short = max(fst.df_short$Fst, na.rm = TRUE) / 2

Ethniccolors1_short <- meta_short[match(ethnics1_short, meta_short$Ethnicity), "Ethnicity_color"]
Ethniccolors2_short <- meta_short[match(ethnics2_short, meta_short$Ethnicity), "Ethnicity_color"]

# Plot heatmap
ggplot(data = fst.df_short, aes(Site1, y = Site2, fill = Fst)) +
  geom_tile(colour = "black") +
  # geom_text(aes(label = Fst), color="black", size = 3)+
  scale_fill_gradient2(low = "blue", mid = "yellow", high = "red", midpoint = mid, name = fst.label_short, limits = c(0, max(fst.df_short$Fst)), breaks = c(0, 0.2, 0.4, 0.6, 0.8, 1)) +
  scale_x_discrete(expand = c(0,0), labels = wrap_format(50))+
  scale_y_discrete(expand = c(0,0), position = "right")+
  theme(axis.text = element_text(colour = "black", size = 20, face = "bold"),
        axis.title = element_blank(),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "top",
        legend.title = element_text(size = 30, face = "bold"),
        legend.text = element_text(size = 20),
        legend.key.width = unit(4, "cm"),
        legend.spacing.x = unit(2, "cm"),
        axis.text.x=element_text(color=Ethniccolors1_short, angle = 90, size=22, vjust=0, hjust=1),
        axis.text.y=element_text(color=Ethniccolors2_short, size=22)
  )

ggsave("figures/Fst_Ethnicity_short_new.png", width = 45, height = 45)

library(xlsx)
# write.xlsx(fst.mat_short, "Fst_short.xlsx")

## PCA
### Perform a PCA (principle components analysis) on the fst.df_short data set.

### Replace missing data with the mean allele frequencies
x = tab(obj_short, NA.method = "zero")

### Perform PCA
pca1 = dudi.pca(x, scannf = FALSE, scale = FALSE, nf = 3)

# Analyse how much percent of genetic variance is explained by each axis
percent = pca1$eig/sum(pca1$eig)*100
barplot(percent, ylab = "Genetic variance explained by eigenvectors (%)", ylim = c(0,12),
        names.arg = round(percent, 1))

### Visualise PCA results.

### Create a data.frame containing individual coordinates
ind_coords = as.data.frame(pca1$li)

### Rename columns of dataframe
colnames(ind_coords) = c("Axis1","Axis2","Axis3")

### Add a column containing individuals
ind_coords$Ind = indNames(obj_short)

### Add a column with the site IDs
ind_coords$Site = as.factor(meta_short[match(rownames(obj_short$tab), meta_short$name),]$Ethnicity)

ind_coords$Site = factor(ind_coords$Site, levels = unique(ind_coords$Site))

### Calculate centroid (average) position for each population
centroid = aggregate(cbind(Axis1, Axis2, Axis3) ~ Site, data = ind_coords, FUN = mean)
centroid$Site = factor(centroid$Site, levels = unique(centroid$Site))

### Add centroid coordinates to ind_coords dataframe
ind_coords = left_join(ind_coords, centroid, by = "Site", suffix = c("",".cen"))

# Keep the order of the levels in the data.frame for plotting 
ind_coords$Site = factor(ind_coords$Site, levels = unique(ind_coords$Site))

### Define colour palette
library(RColorBrewer)
library(ggthemes)
library(scales)
# cols = brewer.pal(nPop(obj_short), "Set1")
# colourCount =length(unique(obj_short$pop))
# cols =colorRampPalette(solarized_pal()(8))(colourCount)

cols <- meta_short[match(centroid$Site, meta_short$Ethnicity), "Ethnicity_color"]

# Custom x and y labels
xlab = paste("Axis 1 (", format(round(percent[1], 1), nsmall=1)," %)", sep="")
ylab = paste("Axis 2 (", format(round(percent[2], 1), nsmall=1)," %)", sep="")

# Custom theme for ggplot2
ggtheme = theme(axis.text.y = element_text(colour="black", size=18),
                axis.text.x = element_text(colour="black", size=18),
                axis.title = element_text(colour="black", size=20),
                panel.border = element_rect(colour="black", fill=NA, size=1),
                panel.background = element_blank(),
                plot.title = element_text(hjust=0.5, size=20) 
)

library(grid)
grid.newpage();grid.draw(roundrectGrob(gp = gpar(lwd = NA)))

# Scatter plot axis 1 vs. 2
ggplot(data = ind_coords, aes(x = Axis1, y = Axis2)) +
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  # spider segments
  # geom_segment(aes(xend = Axis1.cen, yend = Axis2.cen, colour = Site), show.legend = FALSE) +
  # points
  geom_point(aes(fill = Site), shape = 21, size = 4, show.legend = FALSE) +
  # centroids
  geom_label(data = centroid, aes(label = Site, colour = Site), position=position_jitter(width=-1.5,height=1.5), size = 6, show.legend = FALSE) +
  # colouring
  scale_fill_manual(values = cols)+
  scale_colour_manual(values = cols)+
  # custom labels
  labs(x = xlab, y = ylab)+
  ggtitle("Ethnicity PCA")+
  # custom theme
  ggtheme

### Export plot
ggsave("figures/Ethinicity_PCA3_short_new.png", width = 24, height = 16, dpi = 600)

## MDS - Ethnic Fst

df <- read_excel("Fst_new_noNA.xlsx")

df <- df %>% na.omit() %>% rename(Ethnic=`...1`) %>% setDF()

df <- df %>% filter(`Sample size`>2 & Ethnic %in% meta_short$Ethnicity)

df$Language = as.factor(meta_short[match(df$Ethnic, meta_short$Ethnicity),]$`Language family`)

Ethniccolors_mds <- meta_short[match(df$Ethnic, meta_short$Ethnicity), "Ethnicity_color"]
Languagecolors_mds <- meta_short[match(df$Language, meta_short$`Language family`), "Language_color"]

# dist_matrix <- dist(dat_e[,-1])
# mds_result <- cmdscale(dist_matrix)
# plot(mds_result, col = dat_e$ethnic, pch = 19, xlab = "MDS1", ylab = "MDS2")

library(MASS)
library(magrittr)
library(dplyr)
library(ggpubr)

# # Cmpute MDS (non-metric)
# library(MASS)
# mds <- df %>% na.omit() %>%
#   dist() %>%
#   isoMDS() %>%
#   .$points %>%
#   as_tibble()
# colnames(mds) <- c("Dim.1", "Dim.2")
# # Plot MDS
# ggscatter(mds, x = "Dim.1", y = "Dim.2",
#           label = df$Ethnic,
#           size = 1,
#           repel = TRUE)

# Compute MDS
mds <- df %>% na.omit() %>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

# Plot MDS
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          size = 1,
          repel = TRUE)

# K-means clustering (K=10)
clust <- kmeans(mds, 10)$cluster %>%
  as.factor()

Ethniccolors_mds <- meta[match(df$Ethnic, meta$Ethnicity), "Ethnicity_color"]
Language_mds <- meta[match(df$Ethnic, meta$Ethnicity), "Language family"]

mds <- mds %>%
  mutate(groups = clust, Ethnic_color = Ethniccolors_mds, Language = Language_mds)

# Plot and color by groups
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "groups",
          palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE)

# palette = c(Abaknon="#9900ff", Akar="#fa0f0c", `Akar Jambat`="#fa0f0c", Alor="#9900ff", Ambonese="#9900ff", `Arakanese (or Rakhine)`="#336699", `Bamar (or Burman)`="#336699", Banjar="#9900ff", Batak="#9900ff", `Bicolano, Bidayuh`="#9900ff", `Bru (Brao)`="#fa0f0c", `Bruneian Malay`="#9900ff", `Bugkalot (or Ilongot)`="#9900ff", Cham="#9900ff", CoLao="#339900", Dao="#0099ff", Dayak="#9900ff", Ede="#fa0f0c", Filipino="#9900ff", `Filipino (or Tagalog)`="#9900ff", Giarai="#fa0f0c", HaNhi="#336699", Hmong="#0099ff", Ibaloi="#9900ff", Ifugao="#9900ff", Igorot="#9900ff", Indonesian="#9900ff", `Isan (or Lao)`="#339900", IuMien="#0099ff", Ivatan="#9900ff", Jarai="#9900ff", Javanese="#9900ff", `Jehai (or Jahai)`="#fa0f0c", Jingpo="#336699", `Kadazan-Dusun`="#9900ff", Kankanaey="#9900ff", Karen="#336699", Khmer="#fa0f0c", Khuen="#fa0f0c", Kinh="#fa0f0c", Kreung="#fa0f0c", LaChi="#339900", Lahu="#336699", LaHu="#336699", Lao="#339900", `Lao Islan`="#339900", Lisu="#336699", LoLo="#336699", Makasae="#66ccff", Malay="#9900ff", Mam="#660000", Mang="#fa0f0c", Maranao="#9900ff", Melanau="#9900ff", Minahasa="#9900ff", Minangkabau="#9900ff", Moken="#9900ff", Mon="#fa0f0c", Nung="#339900", PaThen="#fa0f0c", Phnong="#fa0f0c", PhuLa="#fa0f0c", Phutai="#339900", `Seletar (or Orang Seletar)`="#9900ff", Semelai="#fa0f0c", Semende="#9900ff", Shan="#339900", SiLa="#9900ff", Stieng="#fa0f0c", Sumbanese="#9900ff", Surigaonon="#9900ff", Tagalog="#9900ff", Tay="#339900", `Tay Nung`="#339900", Temuan="#9900ff", Thai="#339900", `The Kalanguya (or Ikalahan)`="#9900ff", Tompoun="#fa0f0c", Toraja="#9900ff", Unknown="lightgrey", UrakLawoi="#9900ff", Zambal="#9900ff")

ggsave(filename = file.path("figures", "ethnic_K10_MDS_Fst.png"), width = 15, height = 10)

# K-means clustering (K=10) - Language

mds <- df %>% replace_na("Unknown") %>% na.omit() %>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

clust_lang <- kmeans(mds, 10)$cluster %>%
  as.factor()

Ethniccolors_mds <- meta[match(df$Ethnic, meta$Ethnicity), "Ethnicity_color"]
Language_mds <- meta[match(df$Ethnic, meta$Ethnicity), "Language family"]
Languagecolors_mds <- meta[match(Language_mds, meta$`Language family`), "Language_color"]

mds_lang <- mds %>%
  mutate(groups = clust, 
         Ethnic_color = Ethniccolors_mds, 
         Language = Language_mds, 
         Language_colors = Languagecolors_mds)

unique_languages <- unique(mds_lang$Language)
print(unique_languages)

shape_values <- c(Austroasiatic=1, `Austroasiatic, Austronesian`=2, `Austroasiatic, Tai-Kaidai, Hmong-Mien`=3, Austronesian=4, `Austronesian, Sino-Tibetan`=5, `Austronesian, Trans–New Guinea`=6, `Hmong-Mien`=7, Mayan=8, `Sino-Tibetan`=9, `Tai-Kadai`=10, `Trans–New Guinea`=11, Unknown=12)
color_palette <- c(Austroasiatic="#fa0f0c", `Austroasiatic, Austronesian`="#996666", `Austroasiatic, Tai-Kaidai, Hmong-Mien`="#cccc33", Austronesian="#9900ff", `Austronesian, Sino-Tibetan`="#163566", `Austronesian, Trans–New Guinea`="#cc66ff", `Hmong-Mien`="#0099ff", Mayan="#660000", `Sino-Tibetan`="#336699", `Tai-Kadai`="#339900", `Trans–New Guinea`="#66ccff", Unknown="lightgrey")

missing_shapes <- setdiff(unique_languages, names(shape_values))
missing_colors <- setdiff(unique_languages, names(color_palette))

print(missing_shapes)
print(missing_colors)

if (length(missing_shapes) > 0) {
  shape_values <- c(shape_values, setNames(rep(NA, length(missing_shapes)), missing_shapes))
}
if (length(missing_colors) > 0) {
  color_palette <- c(color_palette, setNames(rep("grey", length(missing_colors)), missing_colors))
}

mds_lang$Shape <- factor(mds_lang$Language, levels = names(shape_values))

library(ggpubr)

ggscatter(mds_lang, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "Language",
          size = 2, 
          ellipse = F,
          ellipse.type = "euclid",
          repel = TRUE) +
  scale_color_manual(values = color_palette) +
  scale_shape_manual(values = shape_values)

# Plot and color by groups
ggscatter(mds_lang, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "Language",
          # palette = "jco",
          size = 2, 
          ellipse = F,
          ellipse.type = "convex",
          repel = TRUE,
          palette = c(Austroasiatic="#fa0f0c", `Austroasiatic, Austronesian`="#996666", `Austroasiatic, Tai-Kaidai, Hmong-Mien`="#cccc33", Austronesian="#9900ff", `Austronesian, Sino-Tibetan`="#163566", `Austronesian, Trans–New Guinea`="#cc66ff", `Hmong-Mien`="#0099ff", Mayan="#660000", `Sino-Tibetan`="#336699", `Tai-Kadai`="#339900", `Trans–New Guinea`="#66ccff", Unknown="lightgrey"),
          shape = "Shape")

ggsave(filename = file.path("figures", "ethnic_K10_language_MDS_Fst_with_ellipse (euclid).png"), width = 15, height = 10)

library(ggplot2)
library(ggrepel)

unique_languages <- unique(mds_lang$Language)
print(unique_languages)

shape_values <- c(Austroasiatic=1, `Austroasiatic, Austronesian`=2, `Austroasiatic, Tai-Kaidai, Hmong-Mien`=3, Austronesian=4, `Austronesian, Sino-Tibetan`=5, `Austronesian, Trans–New Guinea`=6, `Hmong-Mien`=7, Mayan=8, `Sino-Tibetan`=9, `Tai-Kadai`=10, `Trans–New Guinea`=11, Unknown=12)
color_palette <- c(Austroasiatic="#fa0f0c", `Austroasiatic, Austronesian`="#996666", `Austroasiatic, Tai-Kaidai, Hmong-Mien`="#cccc33", Austronesian="#9900ff", `Austronesian, Sino-Tibetan`="#163566", `Austronesian, Trans–New Guinea`="#cc66ff", `Hmong-Mien`="#0099ff", Mayan="#660000", `Sino-Tibetan`="#336699", `Tai-Kadai`="#339900", `Trans–New Guinea`="#66ccff", Unknown="lightgrey")

missing_shapes <- setdiff(unique_languages, names(shape_values))
missing_colors <- setdiff(unique_languages, names(color_palette))

print(missing_shapes)
print(missing_colors)

if (length(missing_shapes) > 0) {
  shape_values <- c(shape_values, setNames(rep(NA, length(missing_shapes)), missing_shapes))
}
if (length(missing_colors) > 0) {
  color_palette <- c(color_palette, setNames(rep("grey", length(missing_colors)), missing_colors))
}

ggplot(mds_lang, aes(x = Dim.1, y = Dim.2, color = Language, shape = Language, label = df$Ethnic)) +
  geom_point(size = 2) +
  geom_text_repel(max.overlaps = 100) +  # Increase max.overlaps to handle more labels
  scale_color_manual(values = color_palette) +
  scale_shape_manual(values = shape_values) +
  theme_bw() +
  labs(x = "Dimension 1",
       y = "Dimension 2",
       color = "Language",
       shape = "Language") +
  theme(legend.position = "top")

ggsave(filename = file.path("figures", "ethnic_K10_language_MDS_Fst_with_shape.png"), width = 15, height = 10)

## MDS - Ethnic Haplo

df <- read_excel("table3b_Ethnicity.xlsx") %>% setDF()

df <- df %>% dplyr::select(-2) %>% t() %>% as.data.frame()

colnames(df) <- df[1,]

df <- df[-1, ] 

df <- data.frame(Ethnic = row.names(df), df)

row.names(df) <- NULL

df <- df %>% mutate(Ethnic=ifelse(Ethnic=="Yao", "Dao", 
                                  ifelse(Ethnic=="Bru", "Bru (Brao)", 
                                         ifelse(Ethnic=="Aeta" | Ethnic=="Agta", "Aeta (Agta)",
                                                ifelse(Ethnic=="Filipino" | Ethnic=="Tagalog", "Filipino (or Tagalog)",
                                                       ifelse(Ethnic=="Arakanese" | Ethnic=="Rakhine", "Arakanese (or Rakhine)",
                                                              ifelse(Ethnic=="Kankanaey" | Ethnic=="Igorot", "Kankanaey (or Igorot)",
                                                                     Ethnic)))))))

df <- df %>% mutate(across(2:606, ~ as.numeric(.x)))

Ethniccolors_mds <- meta_short[match(df$Ethnic, meta_short$Ethnicity), "Ethnicity_color"]
Languagecolors_mds <- meta_short[match(df$Language, meta_short$`Language family`), "Language_color"]

# dist_matrix <- dist(dat_e[,-1])
# mds_result <- cmdscale(dist_matrix)
# plot(mds_result, col = dat_e$ethnic, pch = 19, xlab = "MDS1", ylab = "MDS2")

library(MASS)
library(magrittr)
library(dplyr)
library(ggpubr)

# # Cmpute MDS (non-metric)
# library(MASS)
# mds <- df %>% na.omit() %>%
#   dist() %>%
#   isoMDS() %>%
#   .$points %>%
#   as_tibble()
# colnames(mds) <- c("Dim.1", "Dim.2")
# # Plot MDS
# ggscatter(mds, x = "Dim.1", y = "Dim.2",
#           label = df$Ethnic,
#           size = 1,
#           repel = TRUE)

# Compute MDS
mds <- df %>% na.omit() %>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

# Plot MDS
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          size = 1,
          repel = TRUE)

# K-means clustering (K=10)
clust <- kmeans(mds, 10)$cluster %>%
  as.factor()

Ethniccolors_mds <- meta[match(df$Ethnic, meta$Ethnicity), "Ethnicity_color"]
Language_mds <- meta[match(df$Ethnic, meta$Ethnicity), "Language family"]

mds <- mds %>%
  mutate(groups = clust, Ethnic_color = Ethniccolors_mds, Language = Language_mds)

# Plot and color by groups
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "groups",
          palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE)

# palette = c(Abaknon="#9900ff", Akar="#fa0f0c", `Akar Jambat`="#fa0f0c", Alor="#9900ff", Ambonese="#9900ff", `Arakanese (or Rakhine)`="#336699", `Bamar (or Burman)`="#336699", Banjar="#9900ff", Batak="#9900ff", `Bicolano, Bidayuh`="#9900ff", `Bru (Brao)`="#fa0f0c", `Bruneian Malay`="#9900ff", `Bugkalot (or Ilongot)`="#9900ff", Cham="#9900ff", CoLao="#339900", Dao="#0099ff", Dayak="#9900ff", Ede="#fa0f0c", Filipino="#9900ff", `Filipino (or Tagalog)`="#9900ff", Giarai="#fa0f0c", HaNhi="#336699", Hmong="#0099ff", Ibaloi="#9900ff", Ifugao="#9900ff", Igorot="#9900ff", Indonesian="#9900ff", `Isan (or Lao)`="#339900", IuMien="#0099ff", Ivatan="#9900ff", Jarai="#9900ff", Javanese="#9900ff", `Jehai (or Jahai)`="#fa0f0c", Jingpo="#336699", `Kadazan-Dusun`="#9900ff", Kankanaey="#9900ff", Karen="#336699", Khmer="#fa0f0c", Khuen="#fa0f0c", Kinh="#fa0f0c", Kreung="#fa0f0c", LaChi="#339900", Lahu="#336699", LaHu="#336699", Lao="#339900", `Lao Islan`="#339900", Lisu="#336699", LoLo="#336699", Makasae="#66ccff", Malay="#9900ff", Mam="#660000", Mang="#fa0f0c", Maranao="#9900ff", Melanau="#9900ff", Minahasa="#9900ff", Minangkabau="#9900ff", Moken="#9900ff", Mon="#fa0f0c", Nung="#339900", PaThen="#fa0f0c", Phnong="#fa0f0c", PhuLa="#fa0f0c", Phutai="#339900", `Seletar (or Orang Seletar)`="#9900ff", Semelai="#fa0f0c", Semende="#9900ff", Shan="#339900", SiLa="#9900ff", Stieng="#fa0f0c", Sumbanese="#9900ff", Surigaonon="#9900ff", Tagalog="#9900ff", Tay="#339900", `Tay Nung`="#339900", Temuan="#9900ff", Thai="#339900", `The Kalanguya (or Ikalahan)`="#9900ff", Tompoun="#fa0f0c", Toraja="#9900ff", Unknown="lightgrey", UrakLawoi="#9900ff", Zambal="#9900ff")

ggsave(filename = file.path("figures", "ethnic_K10_MDS_Haplo.png"), width = 15, height = 10)

# K-means clustering (K=10) - Language

mds <- df %>% na.omit() %>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

clust_lang <- kmeans(mds, 10)$cluster %>%
  as.factor()

Ethniccolors_mds <- meta[match(df$Ethnic, meta$Ethnicity), "Ethnicity_color"]
Language_mds <- meta[match(df$Ethnic, meta$Ethnicity), "Language family"]
Languagecolors_mds <- meta[match(Language_mds, meta$`Language family`), "Language_color"]

mds_lang <- mds %>%
  mutate(groups = clust, 
         Ethnic_color = Ethniccolors_mds, 
         Language = Language_mds, 
         Language_colors = Languagecolors_mds)

unique_languages <- unique(mds_lang$Language)
print(unique_languages)

shape_values <- c(Austroasiatic=1, `Austroasiatic, Austronesian`=2, `Austroasiatic, Tai-Kaidai, Hmong-Mien`=3, Austronesian=4, `Austronesian, Sino-Tibetan`=5, `Austronesian, Trans–New Guinea`=6, `Hmong-Mien`=7, Mayan=8, `Sino-Tibetan`=9, `Tai-Kadai`=10, `Trans–New Guinea`=11, Unknown=12)
color_palette <- c(Austroasiatic="#fa0f0c", `Austroasiatic, Austronesian`="#996666", `Austroasiatic, Tai-Kaidai, Hmong-Mien`="#cccc33", Austronesian="#9900ff", `Austronesian, Sino-Tibetan`="#163566", `Austronesian, Trans–New Guinea`="#cc66ff", `Hmong-Mien`="#0099ff", Mayan="#660000", `Sino-Tibetan`="#336699", `Tai-Kadai`="#339900", `Trans–New Guinea`="#66ccff", Unknown="lightgrey")

missing_shapes <- setdiff(unique_languages, names(shape_values))
missing_colors <- setdiff(unique_languages, names(color_palette))

print(missing_shapes)
print(missing_colors)

if (length(missing_shapes) > 0) {
  shape_values <- c(shape_values, setNames(rep(NA, length(missing_shapes)), missing_shapes))
}
if (length(missing_colors) > 0) {
  color_palette <- c(color_palette, setNames(rep("grey", length(missing_colors)), missing_colors))
}

mds_lang$Shape <- factor(mds_lang$Language, levels = names(shape_values))

library(ggpubr)

ggscatter(mds_lang, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "Language",
          size = 2, 
          ellipse = T,
          ellipse.type = "norm",
          repel = TRUE) +
  scale_color_manual(values = color_palette) +
  scale_shape_manual(values = shape_values)

# Plot and color by groups
ggscatter(mds_lang, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "Language",
          # palette = "jco",
          size = 2, 
          ellipse = T,
          ellipse.type = "norm",
          repel = TRUE,
          palette = c(Austroasiatic="#fa0f0c", `Austroasiatic, Austronesian`="#996666", `Austroasiatic, Tai-Kaidai, Hmong-Mien`="#cccc33", Austronesian="#9900ff", `Austronesian, Sino-Tibetan`="#163566", `Austronesian, Trans–New Guinea`="#cc66ff", `Hmong-Mien`="#0099ff", Mayan="#660000", `Sino-Tibetan`="#336699", `Tai-Kadai`="#339900", `Trans–New Guinea`="#66ccff", Unknown="lightgrey"),
          shape = "Shape")

ggsave(filename = file.path("figures", "ethnic_K10_language_MDS_Haplo_with_ellipse.png"), width = 15, height = 10)

library(ggplot2)
library(ggrepel)

unique_languages <- unique(mds_lang$Language)
print(unique_languages)

shape_values <- c(Austroasiatic=1, `Austroasiatic, Austronesian`=2, `Austroasiatic, Tai-Kaidai, Hmong-Mien`=3, Austronesian=4, `Austronesian, Sino-Tibetan`=5, `Austronesian, Trans–New Guinea`=6, `Hmong-Mien`=7, Mayan=8, `Sino-Tibetan`=9, `Tai-Kadai`=10, `Trans–New Guinea`=11, Unknown=12)
color_palette <- c(Austroasiatic="#fa0f0c", `Austroasiatic, Austronesian`="#996666", `Austroasiatic, Tai-Kaidai, Hmong-Mien`="#cccc33", Austronesian="#9900ff", `Austronesian, Sino-Tibetan`="#163566", `Austronesian, Trans–New Guinea`="#cc66ff", `Hmong-Mien`="#0099ff", Mayan="#660000", `Sino-Tibetan`="#336699", `Tai-Kadai`="#339900", `Trans–New Guinea`="#66ccff", Unknown="lightgrey")

missing_shapes <- setdiff(unique_languages, names(shape_values))
missing_colors <- setdiff(unique_languages, names(color_palette))

print(missing_shapes)
print(missing_colors)

if (length(missing_shapes) > 0) {
  shape_values <- c(shape_values, setNames(rep(NA, length(missing_shapes)), missing_shapes))
}
if (length(missing_colors) > 0) {
  color_palette <- c(color_palette, setNames(rep("grey", length(missing_colors)), missing_colors))
}

ggplot(mds_lang, aes(x = Dim.1, y = Dim.2, color = Language, shape = Language, label = df$Ethnic)) +
  geom_point(size = 2) +
  geom_text_repel(max.overlaps = 100) +  # Increase max.overlaps to handle more labels
  scale_color_manual(values = color_palette) +
  scale_shape_manual(values = shape_values) +
  theme_bw() +
  labs(x = "Dimension 1",
       y = "Dimension 2",
       color = "Language",
       shape = "Language") +
  theme(legend.position = "top")

ggsave(filename = file.path("figures", "ethnic_K10_language_MDS_Haplo_with_shape.png"), width = 15, height = 10)


## Correspondence Analysis - Full

library("FactoMineR")
library("factoextra")

library("gplots")

df <- read_excel("table3b_Ethnicity.xlsx") %>% setDF()

df <- df %>% dplyr::select(-c(2, 110)) %>% t() %>% as.data.frame()

colnames(df) <- df[1,]

df <- df[-1, ]

df <- df %>% mutate(across(1:605, ~ as.numeric(.x)))

res.ca <- CA(df, graph = FALSE)
print(res.ca)
chisq <- chisq.test(df)
chisq

fviz_screeplot(res.ca, addlabels = TRUE, ylim = c(0, 50))

fviz_screeplot(res.ca) +
  geom_hline(yintercept=33.33, linetype=2, color="red")

fviz_ca_biplot(res.ca, repel = TRUE)

row <- get_ca_row(res.ca)
row

# Coordinates
head(row$coord)
# Cos2: quality on the factore map
head(row$cos2)
# Contributions to the principal components
head(row$contrib)

fviz_ca_row(res.ca, repel = TRUE)

fviz_ca_row(res.ca, col.row="steelblue", shape.row = 15)

head(row$cos2, 4)

# Color by cos2 values: quality on the factor map
fviz_ca_row(res.ca, col.row = "cos2",
            gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
            repel = TRUE)

# Change the transparency by cos2 values
fviz_ca_row(res.ca, alpha.row="cos2")

library("corrplot")
corrplot(row$cos2, is.corr=FALSE)

# Cos2 of rows on Dim.1 and Dim.2
fviz_cos2(res.ca, choice = "row", axes = 1:2)

head(row$contrib)

library("corrplot")
corrplot(row$contrib, is.corr=FALSE) 

# Contributions of rows to dimension 1
fviz_contrib(res.ca, choice = "row", axes = 1, top = 10)
# Contributions of rows to dimension 2
fviz_contrib(res.ca, choice = "row", axes = 2, top = 10)

# Total contribution to dimension 1 and 2
fviz_contrib(res.ca, choice = "row", axes = 1:2, top = 10)

fviz_ca_row(res.ca, col.row = "contrib",
            gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
            repel = TRUE)

# Change the transparency by contrib values
fviz_ca_row(res.ca, alpha.row="contrib",
            repel = TRUE)

col <- get_ca_col(res.ca)
col

# Coordinates of column points
head(col$coord)
# Quality of representation
head(col$cos2)
# Contributions
head(col$contrib)

fviz_ca_col(res.ca)

fviz_ca_col(res.ca, col.col = "cos2", 
            gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
            repel = TRUE)


fviz_cos2(res.ca, choice = "col", axes = 1:2)

fviz_contrib(res.ca, choice = "col", axes = 1:2)

fviz_ca_biplot(res.ca, repel = TRUE)

fviz_ca_biplot(res.ca, 
               map ="rowprincipal", arrow = c(TRUE, TRUE),
               repel = TRUE)

fviz_ca_biplot(res.ca, map ="colgreen", arrow = c(TRUE, FALSE),
               repel = TRUE)

# Dimension description
res.desc <- dimdesc(res.ca, axes = c(1,2))

# Description of dimension 1 by row points
head(res.desc[[1]]$row, 4)

# Description of dimension 1 by column points
head(res.desc[[1]]$col, 4)

# Description of dimension 2 by row points
res.desc[[2]]$row
# Description of dimension 1 by column points
res.desc[[2]]$col


fviz_ca_biplot(res.ca, col.col = "lightgrey", col.row = "cos2", title = "",
               map ="rowprincipal", arrow = c(TRUE, TRUE),
               repel = TRUE)

ca <- res.ca$row$cos2 %>% as.data.frame()

ca$Ethnic <- rownames(ca)
ca$Ethnicitycolors <- meta[match(row.names(ca), meta$Ethnicity), "Ethnicity_color"]
ca$Language <- meta[match(row.names(ca), meta$Ethnicity), "Language family"]
ca$Languagecolors <- meta[match(row.names(ca), meta$Ethnicity), "Language_color"]

color_palette <- c(Thai="#339900", `Banjar, Dayak, Javanese`=	"#9900ff", Hui="#336699", Dayak="#9900ff",`Filipino (or Tagalog)`= "#9900ff", Soa="#fa0f0c", `Batak, Acehnese`="#9900ff", `Jahai, Semang`="#996666", `Tai Lue`="#339900", Semende="#9900ff", Seletar="#9900ff", Abaknon="#9900ff", Tay="#339900", Bidayuh="#9900ff", Batak="#9900ff", Kalueng="#339900", Tompoun="#fa0f0c", `Kadazan-Dusun`="#9900ff", Lun="lightgrey", Tengger="#9900ff", Manabo="#9900ff", Lisu="#336699", Dai="#339900", Sumbanese="#9900ff", `Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)`="#163566", `Tay Nung`="#339900", Suay="#fa0f0c", Toraja="#9900ff", Ivatan="#9900ff", `Tetum, Mambai, Makasae`="#cc66ff", Moken="#9900ff", Javanese="#9900ff", Paluang="#fa0f0c", Besemah="#9900ff", Chinese="#336699", `Bali Aga, Balinese`="#9900ff", IuMien="#0099ff", `Arakanese (or Rakhine)`="#336699", `The Kalanguya (or Ikalahan)`="#9900ff", `Southern Thai_TK`="#339900", Khamu="#fa0f0c", Banjar="#9900ff", Bugis="#9900ff", Aini="#336699", Kinh="#fa0f0c", Han="#336699", Maniq="#fa0f0c", Sumatrans="#9900ff", Semelai="#fa0f0c", `Southern Thai_AN`="#9900ff", `Bugkalot (or Ilongot)`="#9900ff", `Cebuano - Filipino`="#9900ff", Taiwan="#163566", Karen="#336699", Kintaq="#fa0f0c", Mang="#fa0f0c", Khmer="#fa0f0c", Ede="#9900ff", Nyahkur="#fa0f0c", `Cuyunin (or Cuyonon)`="#9900ff", `Malay, Achehnese`="#9900ff", Sasak="#9900ff", Bumiputera="#9900ff", `Batak, Minangkabau, Acehnese, Lampung`="#9900ff", `Khon Mueang`="#339900", Blang="#fa0f0c", Batek="#fa0f0c", Lawa="#fa0f0c", Papuan="#66ccff", LaChi="#339900", Lahu="#336699", `Bamar (or Burman)`="#336699", `Alorese, Alor Malay, Alor-Pantar`="#cc66ff", Jingpo="#336699", Minahasa="#9900ff", `Kinh, Cham, Ede, Giarai`="#996666", `Khmer Loeu`="#996666", HaNhi="#336699", `Kankanaey (or Igorot)`="#9900ff", `Aeta (Agta)`=	"#9900ff", LoLo="#336699", Malay="#9900ff", Mlabri="#fa0f0c", Giarai="#9900ff", Surigaonon="#9900ff", PaThen="#0099ff", Kreung="#fa0f0c", Phnong="#fa0f0c", Jehai="#fa0f0c", Seak="#339900", Minangkabau="#9900ff", `Bruneian Malay`="#9900ff", `Bru (Brao)`="#fa0f0c", Deang="#fa0f0c", Khuen="#fa0f0c", English="lightgrey", `Kinh, Muong, Khmer`="#fa0f0c", Ambonese="#9900ff", `Mel Khaonh`="#fa0f0c", Naga="#336699", `UrakLawoi`="#9900ff", Temuan="#9900ff", Mon="#fa0f0c", Mamanwa="#660000", Ifugao="#9900ff", Jarai="#9900ff", Nung="#339900", Ibaloi="#9900ff", Dawei="#336699", CoLao="#339900", Unknown="lightgrey", `Isan (or Lao)`="#339900", Lao="#339900", Cham="#9900ff", Hmong="#0099ff", SiLa="#336699", `Ancient Thai`="#339900", `H’tin`="#fa0f0c", Chin="#336699", Dao="#0099ff", Stieng="#fa0f0c", Nyaw="#339900", Phuan="#339900", `Tai Yuan`=	"#339900", Phutai="#339900", Maranao="#9900ff", PhuLa="#336699", Tagbanua="#9900ff", Makassarese="#9900ff", Indonesian="#9900ff", Shan="#339900", `Orang Asli`="#fa0f0c", Sundanese="#9900ff", Kensiu="#fa0f0c", `Black Tai`="#339900", `Central Thai`="#339900", Achang="#336699", `Kinh, Tay, Thai, Muong, Hmong`="#cccc33")
lcolor_palette <- c(`Tai-Kadai`="#339900", Austronesian="#9900ff", `Sino-Tibetan`="#336699", Austroasiatic="#fa0f0c", `Austroasiatic, Austronesian`="#996666", Unknown="lightgrey", `Austronesian, Sino-Tibetan`="#163566", `Austronesian, Trans–New Guinea`="#cc66ff", `Hmong-Mien`="#0099ff", `Trans–New Guinea`="#66ccff", Mayan="#660000", `Austroasiatic, Tai-Kaidai, Hmong-Mien`="#cccc33")

ca$Combined <- interaction(ca$Ethnic, ca$Language, sep = " - ")

# Verify unique combinations
unique_combined <- unique(ca$Combined)
combined_colors <- setNames(rainbow(length(unique_combined)), unique_combined)

# Map colors to the Ethnic and Language columns
ca$color <- color_palette[match(ca$Ethnic, names(color_palette))]
ca$lcolor <- lcolor_palette[match(ca$Language, names(lcolor_palette))]

# Ensure all rows have a corresponding color
ca$color[is.na(ca$color)] <- "lightgrey"  # Default color for any missing entries
ca$lcolor[is.na(ca$lcolor)] <- "lightgrey"  # Default color for any missing entries

fviz_ca_biplot(res.ca, 
               col.var = ca$Language,
               col.col = "lightgrey",                     # Column color
               col.row = ca$Language,                   # Custom row colors based on the color column
               title = "",                                # Title of the plot
               map = "rowprincipal",                      # Principal row coordinates
               arrow = c(TRUE, TRUE),                     # Show arrows
               repel = TRUE) +                            # Repel labels
  scale_color_manual(values = lcolor_palette, name="Language") +            # Custom color palette for rows
  scale_fill_manual(values = lcolor_palette, name="Language") +              # Custom fill palette for rows
  theme_bw() +
  theme(legend.position = "top",
        legend.text = element_text(colour="black", size=10),
        legend.title = element_text(colour="black", size=12),
        axis.text.y = element_text(colour="black", size=10),
        axis.text.x = element_text(colour="black", size=10),
        axis.title = element_text(colour="black", size=12))

ggsave(filename = file.path("figures", "ethnic_language_CA_Haplo_no_shape.png"), width = 16, height = 11)

# theme(axis.text.y = element_text(colour="black", size=18),
#       axis.text.x = element_text(colour="black", size=18),
#       axis.title = element_text(colour="black", size=20),
#       panel.border = element_rect(colour="black", fill=NA, size=1),
#       panel.background = element_blank(),
#       plot.title = element_text(hjust=0.5, size=20)

# Scree plot
scree.plot <- fviz_eig(res.ca)
# Biplot of row and column variables
biplot.ca <- fviz_ca_biplot(res.ca)

library(ggpubr)
ggexport(plotlist = list(scree.plot, biplot.ca), 
         filename = "CA.pdf")

# Export into a CSV file
write.infile(res.ca, "ca.csv", sep = ";")

## Correspondence Analysis - Short

library("FactoMineR")
library("factoextra")

library("gplots")

df <- read_excel("table3b_Ethnicity.xlsx") %>% setDF()

df <- df %>% dplyr::select(-c(2, 10, 22, 48, 50, 57, 110, 135, 136)) %>% t() %>% as.data.frame()

colnames(df) <- df[1,]

df <- df[-1, ]

df <- df %>% mutate(across(1:605, ~ as.numeric(.x)))

res.ca <- CA(df, graph = FALSE)
print(res.ca)
chisq <- chisq.test(df)
chisq

fviz_screeplot(res.ca, addlabels = TRUE, ylim = c(0, 50))

fviz_screeplot(res.ca) +
  geom_hline(yintercept=33.33, linetype=2, color="red")

fviz_ca_biplot(res.ca, repel = TRUE)

row <- get_ca_row(res.ca)
row

# Coordinates
head(row$coord)
# Cos2: quality on the factore map
head(row$cos2)
# Contributions to the principal components
head(row$contrib)

fviz_ca_row(res.ca, repel = TRUE)

fviz_ca_row(res.ca, col.row="steelblue", shape.row = 15)

head(row$cos2, 4)

# Color by cos2 values: quality on the factor map
fviz_ca_row(res.ca, col.row = "cos2",
            gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
            repel = TRUE)

# Change the transparency by cos2 values
fviz_ca_row(res.ca, alpha.row="cos2")

library("corrplot")
corrplot(row$cos2, is.corr=FALSE)

# Cos2 of rows on Dim.1 and Dim.2
fviz_cos2(res.ca, choice = "row", axes = 1:2)

head(row$contrib)

library("corrplot")
corrplot(row$contrib, is.corr=FALSE) 

# Contributions of rows to dimension 1
fviz_contrib(res.ca, choice = "row", axes = 1, top = 10)
# Contributions of rows to dimension 2
fviz_contrib(res.ca, choice = "row", axes = 2, top = 10)

# Total contribution to dimension 1 and 2
fviz_contrib(res.ca, choice = "row", axes = 1:2, top = 10)

fviz_ca_row(res.ca, col.row = "contrib",
            gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), 
            repel = TRUE)

# Change the transparency by contrib values
fviz_ca_row(res.ca, alpha.row="contrib",
            repel = TRUE)

col <- get_ca_col(res.ca)
col

# Coordinates of column points
head(col$coord)
# Quality of representation
head(col$cos2)
# Contributions
head(col$contrib)

fviz_ca_col(res.ca)

fviz_ca_col(res.ca, col.col = "cos2", 
            gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
            repel = TRUE)


fviz_cos2(res.ca, choice = "col", axes = 1:2)

fviz_contrib(res.ca, choice = "col", axes = 1:2)

fviz_ca_biplot(res.ca, repel = TRUE)

fviz_ca_biplot(res.ca, 
               map ="rowprincipal", arrow = c(TRUE, TRUE),
               repel = TRUE)

fviz_ca_biplot(res.ca, map ="colgreen", arrow = c(TRUE, FALSE),
               repel = TRUE)

# Dimension description
res.desc <- dimdesc(res.ca, axes = c(1,2))

# Description of dimension 1 by row points
head(res.desc[[1]]$row, 4)

# Description of dimension 1 by column points
head(res.desc[[1]]$col, 4)

# Description of dimension 2 by row points
res.desc[[2]]$row
# Description of dimension 1 by column points
res.desc[[2]]$col


fviz_ca_biplot(res.ca, col.col = "lightgrey", col.row = "cos2", title = "",
               map ="rowprincipal", arrow = c(TRUE, TRUE),
               repel = TRUE)

ca <- res.ca$row$cos2 %>% as.data.frame()

ca$Ethnic <- rownames(ca)
ca$Ethnicitycolors <- meta[match(row.names(ca), meta$Ethnicity), "Ethnicity_color"]
ca$Language <- meta[match(row.names(ca), meta$Ethnicity), "Language family"]
ca$Languagecolors <- meta[match(row.names(ca), meta$Ethnicity), "Language_color"]

color_palette <- c(Thai="#339900", `Banjar, Dayak, Javanese`=	"#9900ff", Hui="#336699", Dayak="#9900ff",`Filipino (or Tagalog)`= "#9900ff", Soa="#fa0f0c", `Batak, Acehnese`="#9900ff", `Tai Lue`="#339900", Semende="#9900ff", Seletar="#9900ff", Abaknon="#9900ff", Tay="#339900", Bidayuh="#9900ff", Batak="#9900ff", Kalueng="#339900", Tompoun="#fa0f0c", `Kadazan-Dusun`="#9900ff", Lun="lightgrey", Manabo="#9900ff", Lisu="#336699", Dai="#339900", Sumbanese="#9900ff", `Non-Malaysian (Chinese, Bajau, Kadazan-Dusun)`="#163566", `Tay Nung`="#339900", Suay="#fa0f0c", Toraja="#9900ff", Ivatan="#9900ff", `Tetum, Mambai, Makasae`="#cc66ff", Moken="#9900ff", Javanese="#9900ff", Paluang="#fa0f0c", Besemah="#9900ff", Chinese="#336699", `Bali Aga, Balinese`="#9900ff", IuMien="#0099ff", `Arakanese (or Rakhine)`="#336699", `The Kalanguya (or Ikalahan)`="#9900ff", `Southern Thai_TK`="#339900", Khamu="#fa0f0c", Banjar="#9900ff", Bugis="#9900ff", Aini="#336699", Kinh="#fa0f0c", Maniq="#fa0f0c", Semelai="#fa0f0c", `Southern Thai_AN`="#9900ff", `Bugkalot (or Ilongot)`="#9900ff", `Cebuano - Filipino`="#9900ff", Taiwan="#163566", Karen="#336699", Mang="#fa0f0c", Khmer="#fa0f0c", Ede="#9900ff", Nyahkur="#fa0f0c", `Cuyunin (or Cuyonon)`="#9900ff", `Malay, Achehnese`="#9900ff", Sasak="#9900ff", Bumiputera="#9900ff", `Batak, Minangkabau, Acehnese, Lampung`="#9900ff", `Khon Mueang`="#339900", Blang="#fa0f0c", Batek="#fa0f0c", Lawa="#fa0f0c", Papuan="#66ccff", LaChi="#339900", Lahu="#336699", `Bamar (or Burman)`="#336699", `Alorese, Alor Malay, Alor-Pantar`="#cc66ff", Jingpo="#336699", Minahasa="#9900ff", `Kinh, Cham, Ede, Giarai`="#996666", `Khmer Loeu`="#996666", HaNhi="#336699", `Kankanaey (or Igorot)`="#9900ff", `Aeta (Agta)`=	"#9900ff", LoLo="#336699", Malay="#9900ff", Mlabri="#fa0f0c", Giarai="#9900ff", Surigaonon="#9900ff", PaThen="#0099ff", Kreung="#fa0f0c", Phnong="#fa0f0c", Jehai="#fa0f0c", Seak="#339900", Minangkabau="#9900ff", `Bruneian Malay`="#9900ff", `Bru (Brao)`="#fa0f0c", Deang="#fa0f0c", Khuen="#fa0f0c", English="lightgrey", `Kinh, Muong, Khmer`="#fa0f0c", Ambonese="#9900ff", `Mel Khaonh`="#fa0f0c", Naga="#336699", `UrakLawoi`="#9900ff", Temuan="#9900ff", Mon="#fa0f0c", Mamanwa="#660000", Ifugao="#9900ff", Jarai="#9900ff", Nung="#339900", Ibaloi="#9900ff", Dawei="#336699", CoLao="#339900", Unknown="lightgrey", `Isan (or Lao)`="#339900", Lao="#339900", Cham="#9900ff", Hmong="#0099ff", SiLa="#336699", `Ancient Thai`="#339900", `H’tin`="#fa0f0c", Chin="#336699", Dao="#0099ff", Stieng="#fa0f0c", Nyaw="#339900", Phuan="#339900", `Tai Yuan`=	"#339900", Phutai="#339900", Maranao="#9900ff", PhuLa="#336699", Tagbanua="#9900ff", Makassarese="#9900ff", Indonesian="#9900ff", Shan="#339900", Kensiu="#fa0f0c", `Black Tai`="#339900", `Central Thai`="#339900", Achang="#336699", `Kinh, Tay, Thai, Muong, Hmong`="#cccc33")
lcolor_palette <- c(`Tai-Kadai`="#339900", Austronesian="#9900ff", `Sino-Tibetan`="#336699", Austroasiatic="#fa0f0c", `Austroasiatic, Austronesian`="#996666", Unknown="lightgrey", `Austronesian, Sino-Tibetan`="#163566", `Austronesian, Trans–New Guinea`="#cc66ff", `Hmong-Mien`="#0099ff", `Trans–New Guinea`="#66ccff", Mayan="#660000", `Austroasiatic, Tai-Kaidai, Hmong-Mien`="#cccc33")

ca$Combined <- interaction(ca$Ethnic, ca$Language, sep = " - ")

# Verify unique combinations
unique_combined <- unique(ca$Combined)
combined_colors <- setNames(rainbow(length(unique_combined)), unique_combined)

# Map colors to the Ethnic and Language columns
ca$color <- color_palette[match(ca$Ethnic, names(color_palette))]
ca$lcolor <- lcolor_palette[match(ca$Language, names(lcolor_palette))]

# Ensure all rows have a corresponding color
ca$color[is.na(ca$color)] <- "lightgrey"  # Default color for any missing entries
ca$lcolor[is.na(ca$lcolor)] <- "lightgrey"  # Default color for any missing entries

fviz_ca_biplot(res.ca, 
               col.var = ca$Language,
               col.row = ca$Language,                   # Custom row colors based on the color column
               col.col = "lightgrey",                     # Column color
               title = "",                                # Title of the plot
               map = "rowprincipal",                      # Principal row coordinates
               arrow = c(TRUE, TRUE),                     # Show arrows
               repel = TRUE) +                            # Repel labels
  scale_color_manual(values = lcolor_palette, name="Language") +            # Custom color palette for rows
  scale_fill_manual(values = lcolor_palette, name="Language") +              # Custom fill palette for rows
  theme_bw() +
  theme(legend.position = "top",
        legend.text = element_text(colour="black", size=10),
        legend.title = element_text(colour="black", size=12),
        axis.text.y = element_text(colour="black", size=10),
        axis.text.x = element_text(colour="black", size=10),
        axis.title = element_text(colour="black", size=12))

ggsave(filename = file.path("figures", "ethnic_language_CA_Haplo_no_shape_short_new.png"), width = 16, height = 11)

# theme(axis.text.y = element_text(colour="black", size=18),
#       axis.text.x = element_text(colour="black", size=18),
#       axis.title = element_text(colour="black", size=20),
#       panel.border = element_rect(colour="black", fill=NA, size=1),
#       panel.background = element_blank(),
#       plot.title = element_text(hjust=0.5, size=20)

# Scree plot
scree.plot <- fviz_eig(res.ca)
# Biplot of row and column variables
biplot.ca <- fviz_ca_biplot(res.ca)

library(ggpubr)
ggexport(plotlist = list(scree.plot, biplot.ca), 
         filename = "CA.pdf")

# Export into a CSV file
write.infile(res.ca, "ca.csv", sep = ";")

## MDS

dat_e <- read_excel("SEA_ethnicity_new.xlsx")

# df <- dat_e %>% na.omit() %>% dplyr::select(1,4,6,8)
df <- dat_e %>%
  na.omit() %>% dplyr::select(1,2,3,4,6,8,10) %>% setDF()

df <- df %>% filter(`Sample size`>2 & Ethnic %in% meta_short$Ethnicity)

df$Language = as.factor(meta_short[match(df$Ethnic, meta_short$Ethnicity),]$`Language family`)

Ethniccolors_mds <- meta_short[match(df$Ethnic, meta_short$Ethnicity), "Ethnicity_color"]
Languagecolors_mds <- meta_short[match(df$Language, meta_short$`Language family`), "Language_color"]

# dist_matrix <- dist(dat_e[,-1])
# mds_result <- cmdscale(dist_matrix)
# plot(mds_result, col = dat_e$ethnic, pch = 19, xlab = "MDS1", ylab = "MDS2")

library(MASS)
library(magrittr)
library(dplyr)
library(ggpubr)

# # Cmpute MDS (non-metric)
# library(MASS)
# mds <- df %>% na.omit() %>% dplyr::select(-c(1,2,3,4)) %>%
#   dist() %>%          
#   isoMDS() %>%
#   .$points %>%
#   as_tibble()
# colnames(mds) <- c("Dim.1", "Dim.2")
# # Plot MDS
# ggscatter(mds, x = "Dim.1", y = "Dim.2", 
#           label = df$Ethnic,
#           size = 1,
#           repel = TRUE)

# Compute MDS
mds <- df %>% na.omit() %>% dplyr::select(-c(1,2,3,4)) %>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

# Plot MDS
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          size = 1,
          repel = TRUE)

# K-means clustering (K=10)
clust <- kmeans(mds, 10)$cluster %>%
  as.factor()
mds <- mds %>%
  mutate(groups = clust, Ethnic = df$Ethnic, Ethnic_color = Ethniccolors_mds, Language = df$Language)
# Plot and color by groups
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "groups",
          palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE)

# palette = c(Abaknon="#9900ff", Akar="#fa0f0c", `Akar Jambat`="#fa0f0c", Alor="#9900ff", Ambonese="#9900ff", `Arakanese (or Rakhine)`="#336699", `Bamar (or Burman)`="#336699", Banjar="#9900ff", Batak="#9900ff", `Bicolano, Bidayuh`="#9900ff", `Bru (Brao)`="#fa0f0c", `Bruneian Malay`="#9900ff", `Bugkalot (or Ilongot)`="#9900ff", Cham="#9900ff", CoLao="#339900", Dao="#0099ff", Dayak="#9900ff", Ede="#fa0f0c", Filipino="#9900ff", `Filipino (or Tagalog)`="#9900ff", Giarai="#fa0f0c", HaNhi="#336699", Hmong="#0099ff", Ibaloi="#9900ff", Ifugao="#9900ff", Igorot="#9900ff", Indonesian="#9900ff", `Isan (or Lao)`="#339900", IuMien="#0099ff", Ivatan="#9900ff", Jarai="#9900ff", Javanese="#9900ff", `Jehai (or Jahai)`="#fa0f0c", Jingpo="#336699", `Kadazan-Dusun`="#9900ff", Kankanaey="#9900ff", Karen="#336699", Khmer="#fa0f0c", Khuen="#fa0f0c", Kinh="#fa0f0c", Kreung="#fa0f0c", LaChi="#339900", Lahu="#336699", LaHu="#336699", Lao="#339900", `Lao Islan`="#339900", Lisu="#336699", LoLo="#336699", Makasae="#66ccff", Malay="#9900ff", Mam="#660000", Mang="#fa0f0c", Maranao="#9900ff", Melanau="#9900ff", Minahasa="#9900ff", Minangkabau="#9900ff", Moken="#9900ff", Mon="#fa0f0c", Nung="#339900", PaThen="#fa0f0c", Phnong="#fa0f0c", PhuLa="#fa0f0c", Phutai="#339900", `Seletar (or Orang Seletar)`="#9900ff", Semelai="#fa0f0c", Semende="#9900ff", Shan="#339900", SiLa="#9900ff", Stieng="#fa0f0c", Sumbanese="#9900ff", Surigaonon="#9900ff", Tagalog="#9900ff", Tay="#339900", `Tay Nung`="#339900", Temuan="#9900ff", Thai="#339900", `The Kalanguya (or Ikalahan)`="#9900ff", Tompoun="#fa0f0c", Toraja="#9900ff", Unknown="lightgrey", UrakLawoi="#9900ff", Zambal="#9900ff")

ggsave(filename = file.path("figures", "ethnic_K10_new.png"), width = 15, height = 10)

# K-means clustering (K=10) - Language
mds <- df %>% na.omit() %>% dplyr::select(-c(1,2,3,4)) %>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

clust_lang <- kmeans(mds, 10)$cluster %>%
  as.factor()
mds_lang <- mds %>%
  mutate(groups = clust, Language = df$Language, Language_color = Languagecolors_mds, Ethnic = df$Ethnic, Ethnic_color = Ethniccolors_mds)
# Plot and color by groups
ggscatter(mds_lang, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "Language",
          # palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE,
          palette = c(Austroasiatic="#fa0f0c", `Austroasiatic, Austronesian`="#996666", Austronesian="#9900ff", `Hmong-Mien`="#0099ff", Mayan="#660000", `Sino-Tibetan`="#336699", `Tai-Kadai`="#339900", `Trans–New Guinea`="#66ccff", Unknown="lightgrey"))

ggsave(filename = file.path("figures", "ethnic_K10_language_new_new.png"), width = 15, height = 10)

# K-means clustering (K=6)
clust <- kmeans(mds, 6)$cluster %>%
  as.factor()
mds <- mds %>%
  mutate(groups = clust)
# Plot and color by groups
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "groups",
          palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE)
ggsave(filename = file.path("figures", "ethnic_K6_new.png"), width = 15, height = 10)

# K-means clustering (K=6) - Language
mds <- df %>% na.omit() %>% dplyr::select(-c(1,2,3,4)) %>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

clust_lang <- kmeans(mds, 6)$cluster %>%
  as.factor()
mds_lang <- mds %>%
  mutate(groups = clust, Language = df$Language, Language_color = Languagecolors_mds, Ethnic = df$Ethnic, Ethnic_color = Ethniccolors_mds)
# Plot and color by groups
ggscatter(mds_lang, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "Language",
          # palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE,
          palette = c(Austroasiatic="#fa0f0c", `Austroasiatic, Austronesian`="#996666", Austronesian="#9900ff", `Hmong-Mien`="#0099ff", Mayan="#660000", `Sino-Tibetan`="#336699", `Tai-Kadai`="#339900", `Trans–New Guinea`="#66ccff", Unknown="lightgrey"))

ggsave(filename = file.path("figures", "ethnic_K6_language_new_new.png"), width = 15, height = 10)

library(cluster)    # clustering algorithms
library(factoextra) # clustering algorithms & visualization
set.seed(123)
df2 <- tibble::column_to_rownames(df, var = "Ethnic") %>% dplyr::select(-c("Language", "Country", "Sample size")) %>% as.data.frame()
distance <- get_dist(df2)

fviz_dist(distance, gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))
k2 <- kmeans(df2, centers = 2, nstart = 25)
fviz_cluster(k2, data = df2)

df2 %>%
  as_tibble() %>%
  mutate(cluster = k2$cluster,
         ethnic = df$Ethnic) %>%
  ggplot(aes(`Haplotype diversity (H)`, `Nucleotide diveristy (pi)`, color = factor(cluster), label = ethnic)) +
  geom_text()

k3 <- kmeans(df2, centers = 3, nstart = 25)
k4 <- kmeans(df2, centers = 4, nstart = 25)
k5 <- kmeans(df2, centers = 5, nstart = 25)
k6 <- kmeans(df2, centers = 6, nstart = 25)
k7 <- kmeans(df2, centers = 7, nstart = 25)
k8 <- kmeans(df2, centers = 8, nstart = 25)
k9 <- kmeans(df2, centers = 9, nstart = 25)
k10 <- kmeans(df2, centers = 10, nstart = 25)

# plots to compare
p1 <- fviz_cluster(k2, geom = "point", data = df2) + ggtitle("k = 2")
p2 <- fviz_cluster(k3, geom = "point",  data = df2) + ggtitle("k = 3")
p3 <- fviz_cluster(k4, geom = "point",  data = df2) + ggtitle("k = 4")
p4 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 5")
p5 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 6")
p6 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 7")
p7 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 8")
p8 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 9")
p9 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 10")

library(gridExtra)
png(filename = file.path("figures", "ethnic_K2-5_new.png"), width = 1200, height = 800)
grid.arrange(p1, p2, p3, p4, nrow = 2)
dev.off()

png(filename = file.path("figures", "ethnic_K6-10_new.png"), width = 1200, height = 800)
grid.arrange(p5, p6, p7, p8, p9, nrow = 2)
dev.off()

fviz_cluster(k5, data = df2)
ggsave(filename = file.path("figures", "ethnic_K5_new.png"), width = 15, height = 10)

df2 %>%
  as_tibble() %>%
  mutate(cluster = k5$cluster,
         ethnic = df$Ethnic) %>%
  ggplot(aes(`Haplotype diversity (H)`, `Nucleotide diveristy (pi)`, color = factor(cluster), label = ethnic)) +
  geom_text()

fviz_nbclust(df2, kmeans, method = "wss")
fviz_nbclust(df2, kmeans, method = "silhouette")

# Compute k-means clustering with k = 5
set.seed(123)
final <- kmeans(df2, 5, nstart = 25)
print(final)

fviz_cluster(final, data = df2)
ggsave(filename = file.path("figures", "ethnic_K5_final_new.png"), width = 15, height = 10)

# Ethnicity - FULL

dat_e <- read_excel("SEA_ethnicity_new.xlsx")

# ethnic <- read_excel("IsolateExplanation.xlsx")
# 
# library(janitor)
# ethnic2 <- ethnic %>%
#   mutate(Ethnicity=ifelse(Ethnicity=="Lao, Akha, Hmong, Khmu, Yao/Mien, Phuan", "Lao, Akha, Hmong, Khmu, Yao, Mien, Phuan", Ethnicity)) %>%
#   dplyr::select(name, Country, `Language family`, Ethnicity, haplo, haplogroup1, haplogroup2, haplogroup3) %>% setDT()
# ethnic_rank <- ethnic2[, .N, by = .(Ethnicity)] %>% arrange(desc(N))
# 
# ethnic_hap <- ethnic2[, .N, by = .(Ethnicity, haplo)]
# ethnic_hap <- ethnic_hap %>%
#   group_by(Ethnicity) %>% arrange(haplo, .by_group = TRUE) %>% 
#   mutate(percent=(N*100)/sum(N)) %>% ungroup()
# 
# ethnic_hap3 <- ethnic2[, .N, by = .(Ethnicity, haplogroup3)]
# ethnic_hap3 <- ethnic_hap3 %>%
#   group_by(Ethnicity) %>% arrange(haplogroup3, .by_group = TRUE) %>% 
#   mutate(percent=(N*100)/sum(N)) %>% ungroup()
# 
# library(pegas)
# library(ape)
# 
# dat_e <- NULL
# for (i in ethnic_rank$Ethnicity) {
#   cat(i, "\n")
#   df_i <- ethnic2 %>% dplyr::filter(Ethnicity==i)
#   n_i <- nrow(df_i)
#   nbin_i <- nbin[labels(nbin) %in% df_i$name]
#   h_i <- pegas::haplotype(nbin_i)
#   n_hi <- length(as.list(h_i))
#   # fas_i <- file[labels(nbin) %in% df_i$name]
#   # writeXStringSet(fas_i, paste0("data/ethnic/", i, ".fasta"))
#   # dnbin_i <- dist.dna(nbin_i, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
#   x_i <- as.matrix.DNAbin(nbin_i)  #converting DNAbin to matrix
#   dist.gene_i <- dist.gene(x_i, method = "pairwise", variance = TRUE, pairwise.deletion = FALSE)
#   mpd_i <- mean(dist.gene_i)
#   hap.div_i <- hap.div(nbin_i, variance = TRUE)
#   nuc.div_i <- nuc.div(nbin_i, variance = TRUE, pairwise.deletion = FALSE) # hap.div = 1 all haplotypes are unique
#   dati <- data.frame(df_i$Ethnicity, df_i$`Language family`, df_i$Country, n_i, n_hi, hap.div_i[1], hap.div_i[2], nuc.div_i[1], nuc.div_i[2], mpd_i) %>% slice(1)
#   ## combine
#   dat_e <- rbindlist(l = list(dat_e, dati)) %>% unique() %>% setDT()
# }
# ## Rename
# setnames(x = dat_e,
#          old = c("df_i.Ethnicity", "df_i..Language.family.", "df_i.Country", "n_i", "n_hi", "hap.div_i.1.", "hap.div_i.2.", "nuc.div_i.1.", "nuc.div_i.2.", "mpd_i"),
#          new = c("Ethnic", "Language", "Country", "Sample size", "Number of haplotypes", "Haplotype diversity (H)", "H variance", "Nucleotide diveristy (pi)", "pi SE", "MPD"))

# df <- dat_e %>% na.omit() %>% dplyr::select(1,4,6,8)
df <- dat_e %>%
  na.omit() %>% dplyr::select(1,2,3,4,6,8,10) %>% setDF()

df$Language = as.factor(meta[match(df$Ethnic, meta$Ethnicity),]$`Language family`)

Ethniccolors_mds <- meta[match(df$Ethnic, meta$Ethnicity), "Ethnicity_color"]
Languagecolors_mds <- meta[match(df$Language, meta$`Language family`), "Language_color"]

# dist_matrix <- dist(dat_e[,-1])
# mds_result <- cmdscale(dist_matrix)
# plot(mds_result, col = dat_e$ethnic, pch = 19, xlab = "MDS1", ylab = "MDS2")

# Compute MDS
mds <- df %>% na.omit() %>% dplyr::select(-c(1,2,3,4)) %>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

# Plot MDS
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          size = 1,
          repel = TRUE)

# K-means clustering (K=10)
clust <- kmeans(mds, 10)$cluster %>%
  as.factor()
mds <- mds %>%
  mutate(groups = clust)
# Plot and color by groups
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "groups",
          palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE)
ggsave(filename = file.path("figures", "ethnic_K10_full_new.png"), width = 15, height = 10)

# K-means clustering (K=10) - Language
mds <- df %>% na.omit() %>% dplyr::select(-c(1,2,3,4)) %>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

clust_lang <- kmeans(mds, 10)$cluster %>%
  as.factor()
mds_lang <- mds %>%
  mutate(groups = clust, Language = df$Language, Language_color = Languagecolors_mds, Ethnic = df$Ethnic, Ethnic_color = Ethniccolors_mds)
# Plot and color by groups
ggscatter(mds_lang, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "Language",
          # palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE,
          palette = c(Austroasiatic="#fa0f0c", `Austroasiatic, Austronesian`="#996666", Austronesian="#9900ff", `Hmong-Mien`="#0099ff", Mayan="#660000", `Sino-Tibetan`="#336699", `Tai-Kadai`="#339900", `Trans–New Guinea`="#66ccff", Unknown="lightgrey"))

ggsave(filename = file.path("figures", "ethnic_K10_language_full_new.png"), width = 15, height = 10)

# K-means clustering (K=6)
clust <- kmeans(mds, 6)$cluster %>%
  as.factor()
mds <- mds %>%
  mutate(groups = clust)
# Plot and color by groups
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "groups",
          palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE)
ggsave(filename = file.path("figures", "ethnic_K6_full_new.png"), width = 15, height = 10)

# K-means clustering (K=6) - Language
mds <- df %>% na.omit() %>% dplyr::select(-c(1,2,3,4)) %>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

clust_lang <- kmeans(mds, 6)$cluster %>%
  as.factor()
mds_lang <- mds %>%
  mutate(groups = clust, Language = df$Language, Language_color = Languagecolors_mds, Ethnic = df$Ethnic, Ethnic_color = Ethniccolors_mds)
# Plot and color by groups
ggscatter(mds_lang, x = "Dim.1", y = "Dim.2", 
          label = df$Ethnic,
          color = "Language",
          # palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE,
          palette = c(Austroasiatic="#fa0f0c", `Austroasiatic, Austronesian`="#996666", Austronesian="#9900ff", `Hmong-Mien`="#0099ff", Mayan="#660000", `Sino-Tibetan`="#336699", `Tai-Kadai`="#339900", `Trans–New Guinea`="#66ccff", Unknown="lightgrey"))

ggsave(filename = file.path("figures", "ethnic_K6_language_full_new.png"), width = 15, height = 10)

library(cluster)    # clustering algorithms
library(factoextra) # clustering algorithms & visualization
set.seed(123)
df2 <- tibble::column_to_rownames(df, var = "Ethnic") %>% dplyr::select(-c("Language", "Country", "Sample size")) %>% as.data.frame()
distance <- get_dist(df2)

fviz_dist(distance, gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))
k2 <- kmeans(df2, centers = 2, nstart = 25)
fviz_cluster(k2, data = df2)

df2 %>%
  as_tibble() %>%
  mutate(cluster = k2$cluster,
         ethnic = df$Ethnic) %>%
  ggplot(aes(`Haplotype diversity (H)`, `Nucleotide diveristy (pi)`, color = factor(cluster), label = ethnic)) +
  geom_text()

k3 <- kmeans(df2, centers = 3, nstart = 25)
k4 <- kmeans(df2, centers = 4, nstart = 25)
k5 <- kmeans(df2, centers = 5, nstart = 25)
k6 <- kmeans(df2, centers = 6, nstart = 25)
k7 <- kmeans(df2, centers = 7, nstart = 25)
k8 <- kmeans(df2, centers = 8, nstart = 25)
k9 <- kmeans(df2, centers = 9, nstart = 25)
k10 <- kmeans(df2, centers = 10, nstart = 25)

# plots to compare
p1 <- fviz_cluster(k2, geom = "point", data = df2) + ggtitle("k = 2")
p2 <- fviz_cluster(k3, geom = "point",  data = df2) + ggtitle("k = 3")
p3 <- fviz_cluster(k4, geom = "point",  data = df2) + ggtitle("k = 4")
p4 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 5")
p5 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 6")
p6 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 7")
p7 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 8")
p8 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 9")
p9 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 10")

library(gridExtra)
png(filename = file.path("figures", "ethnic_K2-5_full_new.png"), width = 1200, height = 800)
grid.arrange(p1, p2, p3, p4, nrow = 2)
dev.off()

png(filename = file.path("figures", "ethnic_K6-10_full_new.png"), width = 1200, height = 800)
grid.arrange(p5, p6, p7, p8, p9, nrow = 2)
dev.off()

fviz_cluster(k5, data = df2)
ggsave(filename = file.path("figures", "ethnic_K5_full_new.png"), width = 15, height = 10)

df2 %>%
  as_tibble() %>%
  mutate(cluster = k5$cluster,
         ethnic = df$Ethnic) %>%
  ggplot(aes(`Haplotype diversity (H)`, `Nucleotide diveristy (pi)`, color = factor(cluster), label = ethnic)) +
  geom_text()

fviz_nbclust(df2, kmeans, method = "wss")
fviz_nbclust(df2, kmeans, method = "silhouette")

# Compute k-means clustering with k = 5
set.seed(123)
final <- kmeans(df2, 5, nstart = 25)
print(final)

fviz_cluster(final, data = df2)
ggsave(filename = file.path("figures", "ethnic_K5_final_full_new.png"), width = 15, height = 10)

## Cham

Cham <- VN %>% filter(ethnic=="Cham")
nbin_Cham <- nbin[labels(nbin) %in% Cham$name]
class(nbin_Cham)
dnbin_Cham <- dist.dna(nbin_Cham, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
hap.div(nbin_Cham, variance = TRUE)
nuc.div(nbin_Cham, variance = TRUE, pairwise.deletion = FALSE)
x_Cham <- as.matrix.DNAbin(nbin_Cham)  #converting DNAbin to matrix

disgene_Cham <- dist.gene(x_Cham, method = "pairwise", pairwise.deletion = FALSE, variance = TRUE)

h_Cham <- pegas::haplotype(nbin_Cham)
d_Cham <- dist.dna(h_Cham, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
nt_Cham <- rmst(d_Cham, quiet = TRUE)#constructs the haplotype network
sz_Cham <- summary(h_Cham)
nt.labs_Cham <- attr(nt_Cham, "labels")
sz_Cham <- sz_VN[nt.labs_Cham]

name_Cham <- Cham$name
R <- haploFreq(x_Cham, fac = name_Cham, haplo = h_Cham)
R <- R[nt.labs_Cham, ]
samp<-R %>% t()
phylo_Cham <- ape::as.phylo(nt_Cham)
dis <- cophenetic(phylo_Cham)

dis<-dis[,phylo_Cham$tip.label]
samp<-samp[,phylo_Cham$tip.label]

comdist(samp, dis, abundance.weighted=TRUE)
pd(samp, phylo_Cham, include.root = TRUE)
mpd(samp, dis)
mpdn(samp, dis, abundance.weighted = TRUE, time.output = FALSE)

tree_Cham<-nj(dnbin_Cham)
ggt_Cham<-ggtree::ggtree(tree_Cham, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(size=3)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 4)
ggt_Cham

### MDS based on haplogroup proportion (frequency)

library(reshape2)
ehap <- ethnic_hap3 %>%
  dplyr::rename(ethnic=Ethnicity) %>%
  group_by(haplogroup3) %>%
  mutate(ID=order(ethnic)) %>%
  ungroup() %>%
  dplyr::rename(key=haplogroup3, value=N) %>%
  dplyr::select(-percent) %>%
  arrange(key) %>% filter(!ethnic %in% c("Unknown", "Khmer, Cham, Chinese-Cambodian, Vietnamese", "Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung", "Lao, Akha, Hmong, Khmu, Dao, Mien, Phuan", "Lao, Tai Dam, Tai Deng, Tai Yuan, Katang, Phuan", "Banjar, Bantenese, Banyumasan", "Batak, Minangkabau, Acehnese, Lampung", "Banjar, Dayak, Javanese"))

dt_e <- spread(ehap, key = key, value = value) %>% replace(is.na(.), 0)
DT <- dt_e %>% dplyr::select(-c(ethnic, ID))
m<-as.matrix(DT)
ethnic <- dt_e$ethnic
ID <- dt_e$ID
dt <- aggregate(m, data.frame(ethnic),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
ethnic_hap_all <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100))

library(MASS)
library(magrittr)
library(dplyr)
library(ggpubr)

dist_matrix <- dist(ethnic_hap_all[,-c("ethnic")])
mds_result <- cmdscale(dist_matrix)

# Compute MDS
mds <- ethnic_hap_all %>% dplyr::select(-1) %>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")
# Plot MDS
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = ethnic_hap_all$ethnic,
          size = 1,
          repel = TRUE)

# Compute MDS
df <- ethnic_hap_all
mds <- df %>% na.omit() %>% dplyr::select(-1) %>%
  dist() %>%          
  cmdscale() %>%
  as_tibble()
colnames(mds) <- c("Dim.1", "Dim.2")

# Plot MDS
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$ethnic,
          size = 1,
          repel = TRUE)

# K-means clustering (K=10)
clust <- kmeans(mds, 10)$cluster %>%
  as.factor()
mds <- mds %>%
  mutate(groups = clust)
# Plot and color by groups
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$ethnic,
          color = "groups",
          palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE)
ggsave(filename = file.path("figures", "ethnic_K10_pro.png"), width = 15, height = 10)

# K-means clustering (K=6)
clust <- kmeans(mds, 6)$cluster %>%
  as.factor()
mds <- mds %>%
  mutate(groups = clust)
# Plot and color by groups
ggscatter(mds, x = "Dim.1", y = "Dim.2", 
          label = df$ethnic,
          color = "groups",
          palette = "jco",
          size = 1, 
          ellipse = TRUE,
          ellipse.type = "convex",
          repel = TRUE)
ggsave(filename = file.path("figures", "ethnic_K6_pro.png"), width = 15, height = 10)

library(cluster)    # clustering algorithms
library(factoextra) # clustering algorithms & visualization
set.seed(123)
df2 <- tibble::column_to_rownames(df, var = "ethnic") %>% as.data.frame()
distance <- get_dist(df2)

fviz_dist(distance, gradient = list(low = "#00AFBB", mid = "white", high = "#FC4E07"))
k2 <- kmeans(df2, centers = 2, nstart = 25)
fviz_cluster(k2, data = df2)

k3 <- kmeans(df2, centers = 3, nstart = 25)
k4 <- kmeans(df2, centers = 4, nstart = 25)
k5 <- kmeans(df2, centers = 5, nstart = 25)
k6 <- kmeans(df2, centers = 6, nstart = 25)
k7 <- kmeans(df2, centers = 7, nstart = 25)
k8 <- kmeans(df2, centers = 8, nstart = 25)
k9 <- kmeans(df2, centers = 9, nstart = 25)
k10 <- kmeans(df2, centers = 10, nstart = 25)

# plots to compare
p1 <- fviz_cluster(k2, geom = "point", data = df2) + ggtitle("k = 2")
p2 <- fviz_cluster(k3, geom = "point",  data = df2) + ggtitle("k = 3")
p3 <- fviz_cluster(k4, geom = "point",  data = df2) + ggtitle("k = 4")
p4 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 5")
p5 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 6")
p6 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 7")
p7 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 8")
p8 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 9")
p9 <- fviz_cluster(k5, geom = "point",  data = df2) + ggtitle("k = 10")

library(gridExtra)
png(filename = file.path("figures", "ethnic_K2-5_pro.png"), width = 1200, height = 800)
grid.arrange(p1, p2, p3, p4, nrow = 2)
dev.off()

png(filename = file.path("figures", "ethnic_K6-10_pro.png"), width = 1200, height = 800)
grid.arrange(p5, p6, p7, p8, p9, nrow = 2)
dev.off()

fviz_cluster(k5, data = df2)
ggsave(filename = file.path("figures", "ethnic_K5_pro.png"), width = 15, height = 10)

fviz_nbclust(df2, kmeans, method = "wss")
fviz_nbclust(df2, kmeans, method = "silhouette")

library(viridis)
g1 <- ggplot(country_hap) +      
  # Add the stacked bar
  geom_bar(aes(x=as.factor(country), y=percent, fill=factor(haplo)), position = "stack", stat="identity", alpha=0.5) +
  guides(fill=guide_legend(nrow=50, byrow=TRUE)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_x_discrete(name = "Country") +
  scale_y_continuous(name = "Percent") +
  theme(legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 6),
        legend.key.size = unit(0.2, "cm")) +
  coord_flip()
g1
ggsave(filename = file.path("figures", "country_haplo.png"), width = 15, height = 10)

g2 <- ggplot(country_hap1) +      
  # Add the stacked bar
  geom_bar(aes(x=as.factor(country), y=percent, fill=factor(haplogroup1)), position = "stack", stat="identity", alpha=0.5) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_x_discrete(name = "Country") +
  scale_y_continuous(name = "Percent") +
  theme(legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm")) +
  coord_flip()
g2
ggsave(filename = file.path("figures", "country_haplo1.png"), width = 15, height = 10)

g3 <- ggplot(country_hap3) +      
  # Add the stacked bar
  geom_bar(aes(x=as.factor(country), y=percent, fill=factor(haplogroup3)), position = "stack", stat="identity", alpha=0.5) +
  guides(fill=guide_legend(nrow=8, byrow=TRUE)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_x_discrete(name = "Country") +
  scale_y_continuous(name = "Percent") +
  theme(axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm")) +
  coord_flip()
g3
ggsave(filename = file.path("figures", "country_haplo3.png"), width = 15, height = 10)

g4 <- ggplot(ethnic_hap) +      
  # Add the stacked bar
  geom_bar(aes(x=as.factor(variable), y=value, fill=factor(haplo)), position = "stack", stat="identity", alpha=0.5) +
  guides(fill=guide_legend(nrow=5, byrow=TRUE)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_x_discrete(name = "Ethinicity") +
  scale_y_continuous(name = "Percent") +
  theme(legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 8),
        legend.key.size = unit(0.3, "cm")) +
  coord_polar()
g4
ggsave(filename = file.path("figures", "ethnic_haplo.png"), width = 20, height = 15)

options(ignore.negative.edge=TRUE)

# Vietnam

VN <- dat %>% filter(country=="Vietnam") %>%
  mutate(ethnic = ifelse(str_detect(ethnic, "Cham") == TRUE, "Cham",
                         ifelse(str_detect(ethnic, "CoLao") == TRUE, "CoLao",
                                ifelse(str_detect(ethnic, "Dao") == TRUE, "Dao",
                                       ifelse(str_detect(ethnic, "DHX") == TRUE, "Unspecified",
                                              ifelse(str_detect(ethnic, "DKK") == TRUE, "Unspecified",
                                                     ifelse(str_detect(ethnic, "DKX") == TRUE, "Unspecified",
                                                            ifelse(str_detect(ethnic, "DOX") == TRUE, "Unspecified",
                                                                   ifelse(str_detect(ethnic, "Ede") == TRUE, "Ede",
                                                                          ifelse(str_detect(ethnic, "Giarai") == TRUE, "Giarai",
                                                                                 ifelse(str_detect(ethnic, "HaNhi") == TRUE, "HaNhi",
                                                                                        ifelse(str_detect(ethnic, "HMong") == TRUE, "HMong",
                                                                                               ifelse(str_detect(ethnic, "Hui") == TRUE, "Unspecified",
                                                                                                      ifelse(str_detect(ethnic, "KDH") == TRUE, "Unspecified",
                                                                                                             ifelse(str_detect(ethnic, "Kinh") == TRUE, "Kinh",
                                                                                                                    ifelse(str_detect(ethnic, "LaChi") == TRUE, "LaChi",
                                                                                                                           ifelse(str_detect(ethnic, "LaHu") == TRUE, "LaHu",
                                                                                                                                  ifelse(str_detect(ethnic, "LoLo") == TRUE, "LoLo",
                                                                                                                                         ifelse(str_detect(ethnic, "Mang") == TRUE, "Mang",
                                                                                                                                                ifelse(str_detect(ethnic, "Nung") == TRUE, "Nung",
                                                                                                                                                       ifelse(str_detect(ethnic, "PaThen") == TRUE, "PaThen",
                                                                                                                                                              ifelse(str_detect(ethnic, "PhuLa") == TRUE, "PhuLa",
                                                                                                                                                                     ifelse(str_detect(ethnic, "SiLa") == TRUE, "SiLa",
                                                                                                                                                                            ifelse(str_detect(ethnic, "Tay") == TRUE, "Tay",
                                                                                                                                                                                   ifelse(str_detect(ethnic, "Thai") == TRUE, "Thai",
                                                                                                                                                                                          ifelse(str_detect(ethnic, "V206") == TRUE, "Viet",
                                                                                                                                                                                                 ifelse(str_detect(ethnic, "VIET") == TRUE, "Viet",
                                                                                                                                                                                                        ifelse(str_detect(ethnic, "VN") == TRUE, "Viet",
                                                                                                                                                                                                               ifelse(str_detect(ethnic, "Yao") == TRUE, "Yao",
                                                                                                                                                                                                                      ethnic)))))))))))))))))))))))))))))

nbin_VN <- nbin[labels(nbin) %in% VN$name]
class(nbin_VN)
dnbin_VN <- dist.dna(nbin_VN, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
library(pegas)
hap.div(nbin_VN, variance = TRUE)
nuc.div(nbin_VN, variance = TRUE, pairwise.deletion = FALSE)
library(picante)
x_VN <- as.matrix.DNAbin(nbin_VN)  #converting DNAbin to matrix

library(haplotypes)
h_VN <- pegas::haplotype(nbin_VN)
d_VN <- dist.dna(h_VN, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
nt_VN <- rmst(d_VN, quiet = TRUE)#constructs the haplotype network
sz_VN <- summary(h_VN)
nt.labs_VN <- attr(nt_VN, "labels")
sz_VN <- sz_VN[nt.labs_VN]

library(ape)
x_VN <- as.matrix.DNAbin(nbin_VN)
name_VN <- VN$name
R <- haploFreq(x_VN, fac = name_VN, haplo = h_VN)
R <- R[nt.labs_VN, ]
samp<-R %>% t()
library(ggmuller)
phylo_VN <- as.phylo(nt_VN)
dis <- cophenetic(phylo_VN)

dis<-dis[,phylo_VN$tip.label]
samp<-samp[,phylo_VN$tip.label]

library(picante) 
library(iCAMP)
pd(samp, phylo_VN, include.root = TRUE)
mpd(samp, dis, abundance.weighted=TRUE)
mpdn(R, cophenetic(phylo_VN), abundance.weighted = TRUE, time.output = FALSE)

tree_VN<-nj(dnbin_VN)
library(ggtree)
ggt_VN<-ggtree::ggtree(tree_VN, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 4)
ggt_VN

## Cham

Cham <- VN %>% filter(ethnic=="Cham")
nbin_Cham <- nbin[labels(nbin) %in% Cham$name]
class(nbin_Cham)
dnbin_Cham <- dist.dna(nbin_Cham, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
hap.div(nbin_Cham, variance = TRUE)
nuc.div(nbin_Cham, variance = TRUE, pairwise.deletion = FALSE)
x_Cham <- as.matrix.DNAbin(nbin_Cham)  #converting DNAbin to matrix

h_Cham <- pegas::haplotype(nbin_Cham)
d_Cham <- dist.dna(h_Cham, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
nt_Cham <- rmst(d_Cham, quiet = TRUE)#constructs the haplotype network
sz_Cham <- summary(h_Cham)
nt.labs_Cham <- attr(nt_Cham, "labels")
sz_Cham <- sz_VN[nt.labs_Cham]

name_Cham <- Cham$name
R <- haploFreq(x_Cham, fac = name_Cham, haplo = h_Cham)
R <- R[nt.labs_Cham, ]
samp<-R %>% t()
phylo_Cham <- ape::as.phylo(nt_Cham)
dis <- cophenetic(phylo_Cham)

dis<-dis[,phylo_Cham$tip.label]
samp<-samp[,phylo_Cham$tip.label]

comdist(samp, dis, abundance.weighted=TRUE)
pd(samp, phylo_Cham, include.root = TRUE)
mpd(samp, dis)
mpdn(samp, dis, abundance.weighted = TRUE, time.output = FALSE)

tree_Cham<-nj(dnbin_Cham)
ggt_Cham<-ggtree::ggtree(tree_Cham, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(size=3)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 4)
ggt_Cham

# Plotting Phylogenetic Distribution in Southeast Asia

library(sf)
library(readr)
library(proj4)
library(magick)
library(ggmap)
library(ggimage)
library(usethis)
library(scatterpie)
library(scales)
library(cowplot)

# library(sf)  # "plot"
# library(sp)  # "plot"
# # devtools::install_github("choisy/gadmSEA")
# # devtools::install_github("choisy/mcutils")
# library(mcutils)
# library(gadmSEA)
# library(magrittr)
# 
# ## defining colors:
# rgb2 <- function(...) rgb(..., max = 255)
# blue   <- rgb2(200, 237, 255)
# grey   <- rgb2(225, 225, 225)
# yellow <- rgb2(253, 252, 235)
# ## the map:
# plot(vietnam, xlab = "longitude (decimal degree)", border = NA,
#             ylab = "latitude (decimal degree)", bg = blue)
# mcutils::datasets("gadmSEA") %>%
# as.data.frame(stringsAsFactors = FALSE) %>%
# setNames("country") %>%
# mutate(col = ifelse(country == "vietnam", yellow, grey)) %$%
# invisible(purrr::map2(country, col, ~ plot(get(.x), col = .y, add = TRUE)))
# axis(1); axis(2); box(bty = "o")
# 
# # Plotting some countries in southeast Asia:
# library(sp)  # for "plot"
# library(gadmSEA) # for the countries
# library(magrittr) # for " %$% " and " %>% "
# 
# rgb2 <- function(...) rgb(..., max = 255)
# blue   <- rgb2(200, 237, 255)
# grey   <- rgb2(225, 225, 225)
# yellow <- rgb2(253, 252, 235)
# 
# ## the map:
# plot(vietnam, xlab = "longitude (decimal degree)", border = NA,
#               ylab = "latitude (decimal degree)", bg = blue,
#              xlim = c(68, 146), ylim = c(-11, 54))
# ctr <- c("vietnam", "philippines", "cambodia", "japan", "china", "thailand",
#        "singapore", "indonesia", "malaysia", "taiwan", "bangladesh", "laos",
#       "india", "nepal")
# mcutils::datasets("gadmSEA") %>%
# as.data.frame(stringsAsFactors = FALSE) %>%
# setNames("country") %>%
# dplyr::mutate(col = ifelse(country %in% ctr, yellow, grey)) %$%
# invisible(purrr::map2(country, col, ~ plot(get(.x), col = .y, add = TRUE)))
# axis(1); axis(2); box(bty = "o")
# 
# points(109.215971, 13.715266, col = "red", pch = 19)
# points(109.215971, 13.715266, col = "red", cex = 2)
# points(109.215971, 13.715266, col = "red", cex = 3)
# points(109.215971, 13.715266, col = "red", cex = 4)

# bangladesh_BGD0_sf <- readRDS("data/gadm36_BGD_0_sf.rds")
# bangladesh_BGD1_sf <- readRDS("data/gadm36_BGD_1_sf.rds")
# brunei_BRN0_sf <- readRDS("data/gadm36_BRN_0_sf.rds")
# brunei_BRN1_sf <- readRDS("data/gadm36_BRN_1_sf.rds")
# china_CHN0_sf <- readRDS("data/gadm36_CHN_0_sf.rds")
# china_CHN1_sf <- readRDS("data/gadm36_CHN_1_sf.rds")
# indonesia_IDN0_sf <- readRDS("data/gadm36_IDN_0_sf.rds")
# indonesia_IDN1_sf <- readRDS("data/gadm36_IDN_1_sf.rds")
# india_IND0_sf <- readRDS("data/gadm36_IND_0_sf.rds")
# india_IND1_sf <- readRDS("data/gadm36_IND_1_sf.rds")
# cambodia_KHM0_sf <- readRDS("data/gadm36_KHM_0_sf.rds")
# cambodia_KHM1_sf <- readRDS("data/gadm36_KHM_1_sf.rds")
# laos_LAO0_sf <- readRDS("data/gadm36_LAO_0_sf.rds")
# laos_LAO1_sf <- readRDS("data/gadm36_LAO_1_sf.rds")
# myanmar_MMR0_sf <- readRDS("data/gadm36_MMR_0_sf.rds")
# myanmar_MMR1_sf <- readRDS("data/gadm36_MMR_1_sf.rds")
# malaysia_MYS0_sf <- readRDS("data/gadm36_MYS_0_sf.rds")
# malaysia_MYS1_sf <- readRDS("data/gadm36_MYS_1_sf.rds")
# philippines_PHL0_sf <- readRDS("data/gadm36_PHL_0_sf.rds")
# philippines_PHL1_sf <- readRDS("data/gadm36_PHL_1_sf.rds")
# singapore_SGP0_sf <- readRDS("data/gadm36_SGP_0_sf.rds")
# singapore_SGP1_sf <- readRDS("data/gadm36_SGP_1_sf.rds")
# thailand_THA0_sf <- readRDS("data/gadm36_THA_0_sf.rds")
# thailand_THA1_sf <- readRDS("data/gadm36_THA_1_sf.rds")
# taiwan_TWN0_sf <- readRDS("data/gadm36_TWN_0_sf.rds")
# taiwan_TWN1_sf <- readRDS("data/gadm36_TWN_1_sf.rds")
# easttimor_TLS0_sf <- readRDS("data/gadm36_TLS_0_sf.rds")
# easttimor_TLS1_sf <- readRDS("data/gadm36_TLS_1_sf.rds")
# vietnam_VNM0_sf <- readRDS("data/gadm36_VNM_0_sf.rds")
# vietnam_VNM1_sf <- readRDS("data/gadm36_VNM_1_sf.rds")
# paracelislands_XPI0_sf <- readRDS("data/gadm36_XPI_0_sf.rds")
# spratlyislands_XSP0_sf <- readRDS("data/gadm36_XSP_0_sf.rds")

# SEA0_sf <- rbind(brunei_BRN0_sf, indonesia_IDN0_sf, cambodia_KHM0_sf, laos_LAO0_sf, myanmar_MMR0_sf, malaysia_MYS0_sf, philippines_PHL0_sf, singapore_SGP0_sf,
#                  thailand_THA0_sf, easttimor_TLS0_sf, vietnam_VNM0_sf, paracelislands_XPI0_sf, spratlyislands_XSP0_sf)
# 
# save(SEA0_sf, file = "data/SEA0_sf.RData")
# 
# SEA0p_sf <- rbind(bangladesh_BGD0_sf, brunei_BRN0_sf, china_CHN0_sf, indonesia_IDN0_sf, india_IND0_sf, cambodia_KHM0_sf, laos_LAO0_sf, myanmar_MMR0_sf, malaysia_MYS0_sf, philippines_PHL0_sf, singapore_SGP0_sf,
#                  thailand_THA0_sf, taiwan_TWN0_sf, easttimor_TLS0_sf, vietnam_VNM0_sf, paracelislands_XPI0_sf, spratlyislands_XSP0_sf)
# 
# save(SEA0p_sf, file = "data/SEA0p_sf.RData")

## Ancient mtDNA plus

load("data/SEA0p_sf.RData")
SEA0p_sf <- SEA0p_sf %>% dplyr::rename(country=NAME_0)

library(readxl)
ancient <- read_excel("all-ancient-dna-2-07-73-full.xlsx")
ancient_SEA <- ancient %>% filter(Country %in% c("Bangladesh", "Brunei", "Cambodia", "China", "Indonesia", "India", "Laos", "Malaysia", "Myanmar", "Philippines", "Singapore", "Thailand", "Taiwan", "Timor-Leste", "Vietnam"))
dat_ancient_SEA <- ancient_SEA %>%
  rename(haplo="mtDNA-haplogroup",
         haploY="Y-Haplotree-Public",
         country="Country") %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200", "A+152+16362+16189", "C4+152", "C4+152+16093", "D*", "E (95.07%)", "G1 (94.06%)", "M4″67", "n/a", "n/a (<2x)", "n/a (exome capture)", "R+16189", "R+16189C (76.45%)", "R+16189C (80.01%)", "R+16189C (81.67%)", "R2+13500", "U4'9", "W1+119")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1 = ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200", "A+152+16362+16189"), "A+", haplo1),
         haplo1 = ifelse(haplo %in% c("C4+152", "C4+152+16093"), "C4+", haplo1),
         haplo1 = ifelse(haplo %in% c("D*"), "D", haplo1),
         haplo1 = ifelse(haplo %in% c("E (95.07%)"), "E", haplo1),
         haplo1 = ifelse(haplo %in% c("G1 (94.06%)"), "G1", haplo1),
         haplo1 = ifelse(haplo %in% c("M4″67"), "M4", haplo1),
         haplo1 = ifelse(haplo %in% c("n/a", "n/a (<2x)", "n/a (exome capture)"), "Unspecified", haplo1),
         haplo1 = ifelse(haplo %in% c("R+16189", "R+16189C (76.45%)", "R+16189C (80.01%)", "R+16189C (81.67%)"), "R+", haplo1),
         haplo1 = ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1 = ifelse(haplo %in% c("U4'9"), "U4", haplo1),
         haplo1 = ifelse(haplo %in% c("W1+119"), "W1", haplo1),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), haplo, haplo1),
         haplo2 = substr(haplo, 1, 1),
         haplo3 = str_extract(haplo, "^([A-Z])\\d+"),
         haplo3 = ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200", "A+152+16362+16189"), "A+", haplo3),
         haplo3 = ifelse(haplo %in% c("C4+152", "C4+152+16093"), "C4+", haplo3),
         haplo3 = ifelse(haplo %in% c("D*"), "D", haplo3),
         haplo3 = ifelse(haplo %in% c("E (95.07%)"), "E", haplo3),
         haplo3 = ifelse(haplo %in% c("G1 (94.06%)"), "G1", haplo3),
         haplo3 = ifelse(haplo %in% c("M4″67"), "M4", haplo3),
         haplo3 = ifelse(haplo %in% c("n/a", "n/a (<2x)", "n/a (exome capture)"), "Unspecified", haplo3),
         haplo3 = ifelse(haplo %in% c("R+16189", "R+16189C (76.45%)", "R+16189C (80.01%)", "R+16189C (81.67%)"), "R+", haplo3),
         haplo3 = ifelse(haplo %in% c("R2+13500"), "R2+", haplo3),
         haplo3 = ifelse(haplo %in% c("U4'9"), "U4", haplo3),
         haplo3 = ifelse(haplo %in% c("W1+119"), "W1", haplo3),
         haplo3 = ifelse((is.na(haplo3) | haplo3==".."), haplo, haplo3)
  ) %>% setDT() %>% filter(haplo1!="Unspecified")

# library(writexl)
# write_xlsx(dat_ancient_SEA, "dat_ancient_SEA.xlsx")
dat_ancient_SEA <- read_excel("dat_ancient_SEA_extra.xlsx") %>%
  mutate(Time=paste(Time1, "(", Time1_LB, "-", Time1_UB, ")", "BP", sep = "")) %>% setDT() %>% filter(haplo1!="Unspecified")

hap_ancient_SEA <- dat_ancient_SEA[, .N, by = .(haplo1, country)] %>% arrange(desc(N))
hap_ancient_SEA1 <- dat_ancient_SEA[, .N, by = .(haplo1)] %>% arrange(desc(N))

### Haplo

country_ancient_SEA <- dat_ancient_SEA[, .N, by = .(country, haplo1)]
country_ancient_SEA <- country_ancient_SEA %>%
  group_by(country) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

library(viridis)
g5 <- ggplot(country_ancient_SEA) +      
  # Add the stacked bar
  geom_bar(aes(x=as.factor(country), y=percent, fill=factor(haplo1)), position = "stack", stat="identity", alpha=0.5) +
  guides(fill=guide_legend(nrow=12, byrow=TRUE)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_x_discrete(name = "Country") +
  scale_y_continuous(name = "Percent") +
  theme(axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm")) +
  coord_flip()
g5
ggsave(filename = file.path("figures", "country_ancient_haplo_plus_new.png"), width = 15, height = 10)

country_ancient_SEA1 <- dat_ancient_SEA[, .N, by = .(country, haplo2)]
country_ancient_SEA1 <- country_ancient_SEA1 %>%
  group_by(country) %>% arrange(haplo2, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

g1 <- ggplot(country_ancient_SEA1) +      
  # Add the stacked bar
  geom_bar(aes(x=as.factor(country), y=percent, fill=factor(haplo2)), position = "stack", stat="identity", alpha=0.5) +
  guides(fill=guide_legend(nrow=1, byrow=TRUE)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_x_discrete(name = "Country") +
  scale_y_continuous(name = "Percent") +
  theme(axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm")) +
  coord_flip()
g1
ggsave(filename = file.path("figures", "country_ancient_haplo_plus_new1.png"), width = 15, height = 10)

an_SEA <- dat_ancient_SEA %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1),
         count=1,
         haploY=ifelse((is.na(haploY) | haploY==".."), "Unspecified", haploY),
         countY=1) %>%
  group_by(country, haplo) %>%  mutate(sum=sum(count), max=max(sum)) %>%
  group_by(country) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo_max=haplo[order==1]) %>% ungroup %>%
  group_by(country, haplo1) %>% mutate(sum1=sum(count), max1=max(sum1)) %>%
  group_by(country) %>% arrange(desc(max1)) %>% 
  mutate(order1=order(max1, decreasing = T), haplo1_max=haplo1[order1==1]) %>% ungroup() %>%
  group_by(country, haploY) %>% mutate(sumY=sum(countY), maxY=max(sumY)) %>%
  group_by(country) %>% arrange(desc(maxY)) %>% 
  mutate(orderY=order(maxY, decreasing = T), haploY_max=haploY[orderY==1]) %>% ungroup() %>%
  select(c(`Object-ID`, Latitude, Longitude, Sex, haplo, haplo1, haploY, haplo_max, haplo1_max, haploY_max, Age, Location, Label, Date, country)) %>% 
  filter(haplo1!="Unspecified")

an_SEA_sf <- merge(an_SEA, SEA0p_sf, by=c("country"))
an_SEA_plot <- an_SEA_sf %>% st_as_sf(crs = 4326)

countries <- SEA0p_sf
countries_coords <- st_coordinates(st_centroid(SEA0p_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = countries$country)

res <- country_ancient_SEA %>%
  dplyr::rename(ID=country) %>%
  group_by(haplo1) %>%
  mutate(Country=order(ID)) %>%
  ungroup() %>%
  dplyr::rename(key=haplo1, value=N) %>%
  select(-percent) %>%
  arrange(key)

res <- res %>% left_join(countries_coords)

dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)
DT <- dt_res %>% select(-c(ID, X, Y, Country))
m<-as.matrix(DT)
ID <- dt_res$ID
Country <- dt_res$Country
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(Country=order(ID)) %>% left_join(countries_coords) %>% rename(x=X, y=Y)
dt_x <- dt %>% select(-c(Country, ID))

an_SEA_plot_max <- an_SEA_plot %>% group_by(country) %>% slice(1)
an_SEA_max <- an_SEA_plot_max %>% st_drop_geometry() %>% select(country, haplo1_max) %>% rename(Country=country, `Dominant Haplogroup`=haplo1_max) %>% setDT()

library("ggpmisc")

ggplot() + 
  # geom_sf(data=SEA0p_sf, aes(fill="white"), alpha=0.1) +
  geom_sf(data=an_SEA_plot_max, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_point(aes(x = Longitude, y = Latitude,  colour = haplo1), data = an_SEA_plot, position=position_jitter(width=1,height=1), size = 6) +
  geom_label(aes(x = Longitude, y = Latitude,  colour = haplo1, label = Date), data = an_SEA_plot, size = 2.5, hjust=-0.1, vjust=0.5, position=position_jitter(width=1,height=1), label.size = 0.5) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:217], color=NA, alpha=0.8) +
  annotate(geom = "table", x = 80, y = -10, label = list(an_SEA_max), size = 6.5) +
  scale_fill_discrete(name="") +
  scale_color_discrete(name="") +
  guides(fill=guide_legend(nrow=10, byrow=TRUE)) +
  theme_bw() +
  theme(text = element_text(size=28), 
        axis.text.x = element_text(size=15), 
        axis.text.y = element_text(size=15), 
        legend.text=element_text(size=20), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Ancient Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia (+)")
ggsave(filename = file.path("figures", "Ancient_SEA_plus_date.png"), width = 49, height = 33)

ggplot() + 
  # geom_sf(data=SEA0p_sf, aes(fill="white"), alpha=0.1) + 
  geom_sf(data=an_SEA_plot_max, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_point(aes(x = Longitude, y = Latitude,  colour = haplo1), data = an_SEA_plot, position=position_jitter(width=1,height=1), size = 6) +
  geom_label(aes(x = Longitude, y = Latitude,  colour = haplo1, label = Time), data = an_SEA_plot, size = 2.5, hjust=-0.1, vjust=0.5, position=position_jitter(width=1,height=1), label.size = 0.5) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:217], color=NA, alpha=0.8) +
  annotate(geom = "table", x = 80, y = -10, label = list(an_SEA_max), size = 6.5) +
  scale_fill_discrete(name="") +
  scale_color_discrete(name="") +
  guides(fill=guide_legend(nrow=10, byrow=TRUE)) +
  theme_bw() +
  theme(text = element_text(size=28), 
        axis.text.x = element_text(size=15), 
        axis.text.y = element_text(size=15), 
        legend.text=element_text(size=20), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Ancient Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia (+)")
ggsave(filename = file.path("figures", "Ancient_SEA_plus_time.png"), width = 49, height = 33)

ggplot() + 
  # geom_sf(data=SEA0p_sf, aes(fill="white"), alpha=0.1) + 
  geom_sf(data=an_SEA_plot_max, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_point(aes(x = Longitude, y = Latitude,  colour = haplo1), data = an_SEA_plot, position=position_jitter(width=-0.5,height=0.5), size = 6) +
  geom_label(aes(x = Longitude, y = Latitude,  colour = haplo1, label = haplo1), data = an_SEA_plot, size = 8, hjust=-0.1, vjust=0.5, position=position_jitter(width=-1.5,height=1.5), label.size = 0.5) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:217], color=NA, alpha=0.8) +
  annotate(geom = "table", x = 70, y = -10, label = list(an_SEA_max), size = 10) +
  scale_fill_discrete(name="") +
  scale_color_discrete(name="") +
  guides(fill=guide_legend(nrow=12, byrow=TRUE)) +
  theme_bw() +
  theme(text = element_text(size=35), 
        axis.text.x = element_text(size=30), 
        axis.text.y = element_text(size=30), 
        legend.text=element_text(size=30), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Ancient Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia (+)")
ggsave(filename = file.path("figures", "Ancient_SEA_plus_label_new_new.png"), width = 49, height = 33)

writexl::write_xlsx(dt, "Haplo_ancient_country_SEA.xlsx")
writexl::write_xlsx(dt_res, "Haplo_ancient_country_location_SEA.xlsx")

### Location
ggplot() + 
  # geom_sf(data=SEA0p_sf, aes(fill="white"), alpha=0.1) + 
  geom_sf(data=an_SEA_plot_max, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_point(aes(x = Longitude, y = Latitude,  colour = haplo1), data = an_SEA_plot, position=position_jitter(width=-0.5,height=0.5), size = 6) +
  geom_label(aes(x = Longitude, y = Latitude,  colour = haplo1, label = Location), data = an_SEA_plot, size = 8, hjust=-0.1, vjust=0.5, position=position_jitter(width=-1.5,height=1.5), label.size = 0.5) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:217], color=NA, alpha=0.8) +
  annotate(geom = "table", x = 80, y = -10, label = list(an_SEA_max), size = 6.5) +
  scale_fill_discrete(name="") +
  scale_color_discrete(name="") +
  guides(fill=guide_legend(nrow=10, byrow=TRUE)) +
  theme_bw() +
  theme(text = element_text(size=35), 
        axis.text.x = element_text(size=30), 
        axis.text.y = element_text(size=30), 
        legend.text=element_text(size=30), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Ancient Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia (+)")
ggsave(filename = file.path("figures", "Ancient_SEA_plus_location.png"), width = 49, height = 33)

## Ancient DNA

load("data/SEA0_sf.RData")
SEA0_sf <- SEA0_sf %>% rename(Country=NAME_0)

library(readxl)
ancient <- read_excel("all-ancient-dna-2-07-73-full.xlsx")
ancient_SEA <- ancient %>% filter(Country %in% c("Brunei", "Cambodia", "Indonesia", "Laos", "Malaysia", "Myanmar", "Philippines", "Singapore", "Thailand", "Timor-Leste", "Vietnam"))
dat_ancient_SEA <- ancient_SEA %>%
  rename(haplo="mtDNA-haplogroup",
         country="Country") %>%
  mutate(haplo1=str_extract(haplo, "^([A-Z])\\d\\w"),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo2 = substr(haplo, 1, 1),
         haplo3 = str_extract(haplo, "^([A-Z])\\d+"),
         haplo3 = ifelse(is.na(haplo3), haplo, haplo3)
  ) %>% setDT()

hap_ancient_SEA <- dat_ancient_SEA[, .N, by = .(haplo1, country)] %>% arrange(desc(N))
hap_ancient_SEA1 <- dat_ancient_SEA[, .N, by = .(haplo1)] %>% arrange(desc(N))

### Haplo

country_ancient_SEA <- dat_ancient_SEA[, .N, by = .(country, haplo)]
country_ancient_SEA <- country_ancient_SEA %>%
  group_by(country) %>% arrange(haplo, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

library(viridis)
g5 <- ggplot(country_ancient_SEA) +      
  # Add the stacked bar
  geom_bar(aes(x=as.factor(country), y=percent, fill=factor(haplo)), position = "stack", stat="identity", alpha=0.5) +
  guides(fill=guide_legend(nrow=3, byrow=TRUE)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_x_discrete(name = "Country") +
  scale_y_continuous(name = "Percent") +
  theme(axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm")) +
  coord_flip()
g5
ggsave(filename = file.path("figures", "country_ancient_haplo.png"), width = 15, height = 10)

an_SEA <- dat_ancient_SEA %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1),
         count=1) %>%
  group_by(country, haplo) %>%  mutate(sum=sum(count), max=max(sum)) %>%
  group_by(country) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo_max=haplo[order==1]) %>% ungroup %>%
  group_by(country, haplo1) %>% mutate(sum1=sum(count), max1=max(sum1)) %>%
  group_by(country) %>% arrange(desc(max1)) %>% 
  mutate(order1=order(max1, decreasing = T), haplo1_max=haplo1[order1==1]) %>%
  ungroup() %>%
  select(c(`Object-ID`, Latitude, Longitude, Sex, haplo, haplo1, haplo_max, haplo1_max, Age, Location, Label, Date, country))

an_SEA_sf <- merge(an_SEA, SEA0_sf, by=c("country"))
an_SEA_plot <- an_SEA_sf %>% st_as_sf(crs = 4326)

countries <- SEA0_sf
countries_coords <- st_coordinates(st_centroid(SEA0_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = countries$country)

res <- country_ancient_SEA %>%
  mutate(haplo1=str_extract(haplo, "^([A-Z])\\d\\w"),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  rename(ID=country) %>%
  group_by(haplo1) %>%
  mutate(Country=order(ID)) %>%
  ungroup() %>%
  rename(key=haplo1, value=N) %>%
  select(-percent, -haplo) %>%
  arrange(key)

res <- res %>% left_join(countries_coords)

dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)
DT <- dt_res %>% select(-c(ID, X, Y, Country))
m<-as.matrix(DT)
ID <- dt_res$ID
Country <- dt_res$Country
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(Country=order(ID)) %>% left_join(countries_coords) %>% rename(x=X, y=Y)
dt_x <- dt %>% select(-c(Country, ID))

ggplot() + geom_sf() + geom_sf(data=an_SEA_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_point(aes(x = Longitude, y = Latitude,  colour = haplo1), data = an_SEA_plot, size = 8) +
  geom_label(aes(x = Longitude, y = Latitude,  colour = haplo1, label = Location), data = an_SEA_plot, size = 7.5, hjust=-0.1, vjust=1, label.size = 1) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:33], color=NA, alpha=0.8) +
  scale_fill_discrete(name="") +
  scale_color_discrete(name="") +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  theme_bw() +
  theme(text = element_text(size=36), 
        axis.text.x = element_text(size=30), 
        axis.text.y = element_text(size=30), 
        legend.text=element_text(size=30), 
        legend.key.size = unit(2, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Ancient Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia")
ggsave(filename = file.path("figures", "Ancient_SEA.png"), width = 49, height = 33)

### Haplo 1

country_ancient_SEA1 <- dat_ancient_SEA[, .N, by = .(country, haplo1)]
country_ancient_SEA1 <- country_ancient_SEA1 %>%
  group_by(country) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup() %>%
  mutate(haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1))

g6 <- ggplot(country_ancient_SEA1) +      
  # Add the stacked bar
  geom_bar(aes(x=as.factor(country), y=percent, fill=factor(haplo1)), position = "stack", stat="identity", alpha=0.5) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_x_discrete(name = "Country") +
  scale_y_continuous(name = "Percent") +
  theme(axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm")) +
  coord_flip()
g6
ggsave(filename = file.path("figures", "country_ancient_haplo1.png"), width = 15, height = 10)

dat_f <- dat %>% mutate(count=1) %>% setDF()

an_SEA1 <- dat_ancient_SEA %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1),
         count=1) %>%
  group_by(country, haplo) %>%  mutate(sum=sum(count), max=max(sum)) %>%
  group_by(country) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo_max=haplo[order==1]) %>% ungroup %>%
  group_by(country, haplo1) %>% mutate(sum1=sum(count), max1=max(sum1)) %>%
  group_by(country) %>% arrange(desc(max1)) %>% 
  mutate(order1=order(max1, decreasing = T), haplo1_max=haplo1[order1==1]) %>%
  ungroup() %>%
  select(c(`Object-ID`, Latitude, Longitude, Sex, haplo, haplo1, haplo_max, haplo1_max, Age, Location, Label, Date, country))

an_SEA1_sf <- merge(an_SEA1, SEA0_sf, by=c("country"))
an_SEA1_plot <- an_SEA1_sf %>% st_as_sf(crs = 4326)

countries <- SEA0_sf
countries_coords <- st_coordinates(st_centroid(SEA0_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = countries$country)

res <- country_ancient_SEA1 %>%
  rename(ID=country) %>%
  group_by(haplo1) %>%
  mutate(Country=order(ID)) %>%
  ungroup() %>%
  rename(key=haplo1, value=N) %>%
  select(-percent) %>%
  arrange(key)

res <- res %>% left_join(countries_coords)

dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)
DT <- dt_res %>% select(-c(ID, X, Y, Country))
m<-as.matrix(DT)
ID <- dt_res$ID
Country <- dt_res$Country
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(Country=order(ID)) %>% left_join(countries_coords) %>% rename(x=X, y=Y)
dt_x <- dt %>% select(-c(Country, ID))

ggplot() + geom_sf() + geom_sf(data=an_SEA1_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_point(aes(x = Longitude, y = Latitude,  colour = haplo1), data = an_SEA1_plot, size = 8) +
  geom_label(aes(x = Longitude, y = Latitude,  colour = haplo1, label = Location), data = an_SEA1_plot, size = 7.5, hjust=-0.1, vjust=1, label.size = 1) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:33], color=NA, alpha=0.8) +
  scale_fill_discrete(name="") +
  scale_color_discrete(name="") +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  theme_bw() +
  theme(text = element_text(size=36), 
        axis.text.x = element_text(size=30), 
        axis.text.y = element_text(size=30), 
        legend.text=element_text(size=30), 
        legend.key.size = unit(2, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Ancient Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia")
ggsave(filename = file.path("figures", "Ancient_SEA1.png"), width = 49, height = 33)

### Haplo 3

country_ancient_SEA3 <- dat_ancient_SEA[, .N, by = .(country, haplo3)]
country_ancient_SEA3 <- country_ancient_SEA3 %>%
  group_by(country) %>% arrange(haplo3, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup() %>%
  mutate(haplo3=ifelse((is.na(haplo3) | haplo3==".."), "Unspecified", haplo3))

g7 <- ggplot(country_ancient_SEA3) +      
  # Add the stacked bar
  geom_bar(aes(x=as.factor(country), y=percent, fill=factor(haplo3)), position = "stack", stat="identity", alpha=0.5) +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_x_discrete(name = "Country") +
  scale_y_continuous(name = "Percent") +
  theme(axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(1, "cm")) +
  coord_flip()
g7
ggsave(filename = file.path("figures", "country_ancient_haplo3.png"), width = 15, height = 10)

dat_f <- dat %>% mutate(count=1) %>% setDF()

an_SEA3 <- dat_ancient_SEA %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo3=ifelse((is.na(haplo3) | haplo3==".."), "Unspecified", haplo3),
         count=1) %>%
  group_by(country, haplo) %>%  mutate(sum=sum(count), max=max(sum)) %>%
  group_by(country) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo_max=haplo[order==1]) %>% ungroup %>%
  group_by(country, haplo1) %>% mutate(sum1=sum(count), max1=max(sum1)) %>%
  group_by(country) %>% arrange(desc(max1)) %>%
  group_by(country, haplo3) %>% mutate(sum3=sum(count), max3=max(sum3)) %>%
  group_by(country) %>% arrange(desc(max3)) %>%
  mutate(order3=order(max3, decreasing = T), haplo3_max=haplo3[order3==1]) %>%
  ungroup() %>%
  select(c(`Object-ID`, Latitude, Longitude, Sex, haplo, haplo3, haplo_max, haplo3_max, Age, Location, Label, Date, country))

an_SEA3_sf <- merge(an_SEA3, SEA0_sf, by=c("country"))
an_SEA3_plot <- an_SEA3_sf %>% st_as_sf(crs = 4326)

countries <- SEA0_sf
countries_coords <- st_coordinates(st_centroid(SEA0_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = countries$country)

res <- country_ancient_SEA3 %>%
  rename(ID=country) %>%
  group_by(haplo3) %>%
  mutate(Country=order(ID)) %>%
  ungroup() %>%
  rename(key=haplo3, value=N) %>%
  select(-percent) %>%
  arrange(key)

res <- res %>% left_join(countries_coords)

dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)
DT <- dt_res %>% select(-c(ID, X, Y, Country))
m<-as.matrix(DT)
ID <- dt_res$ID
Country <- dt_res$Country
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(Country=order(ID)) %>% left_join(countries_coords) %>% rename(x=X, y=Y)
dt_x <- dt %>% select(-c(Country, ID))

ggplot() + geom_sf() + geom_sf(data=an_SEA3_plot, aes(fill=haplo3_max), lwd=0, alpha=0.6) +
  geom_point(aes(x = Longitude, y = Latitude,  colour = haplo3), data = an_SEA3_plot, size = 8) +
  geom_label(aes(x = Longitude, y = Latitude,  colour = haplo3, label = Location), data = an_SEA3_plot, size = 7.5, hjust=-0.1, vjust=1, label.size = 1) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:28], color=NA, alpha=0.8) +
  scale_fill_discrete(name="") +
  scale_color_discrete(name="") +
  guides(fill=guide_legend(nrow=2, byrow=TRUE)) +
  theme_bw() +
  theme(text = element_text(size=36), 
        axis.text.x = element_text(size=30), 
        axis.text.y = element_text(size=30), 
        legend.text=element_text(size=30), 
        legend.key.size = unit(2, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Ancient Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia")
ggsave(filename = file.path("figures", "Ancient_SEA3.png"), width = 49, height = 33)

## Ancient Y-DNA plus

load("data/SEA0p_sf.RData")
SEA0p_sf <- SEA0p_sf %>% rename(country=NAME_0)

library(readxl)
ancient <- read_excel("all-ancient-dna-2-07-73-full.xlsx")
ancient_SEA <- ancient %>% filter(Country %in% c("Bangladesh", "Brunei", "Cambodia", "China", "Indonesia", "India", "Laos", "Malaysia", "Myanmar", "Philippines", "Singapore", "Thailand", "Taiwan", "Timor-Leste", "Vietnam"))
dat_ancientY_SEA <- ancient_SEA %>%
  rename(haplo="mtDNA-haplogroup",
         haploY="Y-Haplotree-Public",
         country="Country") %>%
  mutate(haploY1=ifelse(!is.na(`Y-New`), `Y-New`, `Y-Simple`),
         haploY1=ifelse(`Y-New` %in% c("CT low coverage", "D1(xD1a1a1a1b,xD1a1b1a,xD1a2) low coverage", "F low coverage", "F or J2a1a low coverage", "FTDNA: Forms a new branch D-Y65054 under D-PH344 with a Big Y tester from Kazakhstan", "ISOGG2015?", "ISOGG2015??", "ISOGG2016??", "ISOGG2018?", "J2b:FGC3945.1/FGC3945.2/FGC3945/Z526.1/Z526.2/Z526, J2b2a:AM01367/Z605", "K low coverage", "K2 low coverage", "M9, M526, M1221, L405, P295, F115", "NO1 low coverage", "O low coverage", "O1 low coverage", "O1a low coverage", "O1b1a1a1a(xO1b1a1a1a1a1)", "O2a1 low coverage", "O2a2b2a low coverage"), `Y-Simple`, haploY1),
         haploY2=ifelse(haploY1 %in% c("C", "C2", "CT", "D", "F", "K", "N", "N-L735", "NO", "O", "O2", "P*", "Q", "Q1", "R2"), haploY1, `Y-Simple`),
         haploY2=ifelse(!haploY1 %in% c("C", "C2", "CT", "D", "F", "K", "N", "N-L735", "NO", "O", "O2", "P*", "Q", "Q1", "R2"), str_extract(haploY1, "^([A-Z]+)\\d\\w"), haploY2),
         haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200", "A+152+16362+16189", "C4+152", "C4+152+16093", "D*", "E (95.07%)", "G1 (94.06%)", "M4″67", "n/a", "n/a (<2x)", "n/a (exome capture)", "R+16189", "R+16189C (76.45%)", "R+16189C (80.01%)", "R+16189C (81.67%)", "R2+13500", "U4'9", "W1+119")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haploY=ifelse((is.na(haploY) | haplo==".."), "Unspecified", haploY),
         haplo1 = ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200", "A+152+16362+16189"), "A+", haplo1),
         haplo1 = ifelse(haplo %in% c("C4+152", "C4+152+16093"), "C4+", haplo1),
         haplo1 = ifelse(haplo %in% c("D*"), "D", haplo1),
         haplo1 = ifelse(haplo %in% c("E (95.07%)"), "E", haplo1),
         haplo1 = ifelse(haplo %in% c("G1 (94.06%)"), "G1", haplo1),
         haplo1 = ifelse(haplo %in% c("M4″67"), "M4", haplo1),
         haplo1 = ifelse(haplo %in% c("n/a", "n/a (<2x)", "n/a (exome capture)"), "Unspecified", haplo1),
         haplo1 = ifelse(haplo %in% c("R+16189", "R+16189C (76.45%)", "R+16189C (80.01%)", "R+16189C (81.67%)"), "R+", haplo1),
         haplo1 = ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1 = ifelse(haplo %in% c("U4'9"), "U4", haplo1),
         haplo1 = ifelse(haplo %in% c("W1+119"), "W1", haplo1),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), haplo, haplo1),
         haplo2 = substr(haplo, 1, 1),
         haplo3 = str_extract(haplo, "^([A-Z])\\d+"),
         haplo3 = ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200", "A+152+16362+16189"), "A+", haplo3),
         haplo3 = ifelse(haplo %in% c("C4+152", "C4+152+16093"), "C4+", haplo3),
         haplo3 = ifelse(haplo %in% c("D*"), "D", haplo3),
         haplo3 = ifelse(haplo %in% c("E (95.07%)"), "E", haplo3),
         haplo3 = ifelse(haplo %in% c("G1 (94.06%)"), "G1", haplo3),
         haplo3 = ifelse(haplo %in% c("M4″67"), "M4", haplo3),
         haplo3 = ifelse(haplo %in% c("n/a", "n/a (<2x)", "n/a (exome capture)"), "Unspecified", haplo3),
         haplo3 = ifelse(haplo %in% c("R+16189", "R+16189C (76.45%)", "R+16189C (80.01%)", "R+16189C (81.67%)"), "R+", haplo3),
         haplo3 = ifelse(haplo %in% c("R2+13500"), "R2+", haplo3),
         haplo3 = ifelse(haplo %in% c("U4'9"), "U4", haplo3),
         haplo3 = ifelse(haplo %in% c("W1+119"), "W1", haplo3),
         haplo3 = ifelse((is.na(haplo3) | haplo3==".."), haplo, haplo3)
  ) %>% setDT() %>% filter(!is.na(haploY) & haploY!="Unspecified")

# library(writexl)
# write_xlsx(dat_ancient_SEA, "dat_ancient_SEA.xlsx")
# dat_ancient_SEA <- read_excel("dat_ancient_SEA_extra.xlsx") %>%
#   mutate(Time=paste(Time1, "(", Time1_LB, "-", Time1_UB, ")", "BP", sep = "")) %>% setDT() %>% filter(haplo1!="Unspecified")

hapY_ancient_SEA <- dat_ancientY_SEA[, .N, by = .(haploY, country)] %>% arrange(desc(N))
hapY_ancient_SEA1 <- dat_ancientY_SEA[, .N, by = .(haploY)] %>% arrange(desc(N))

### Haplo

country_ancientY_SEA <- dat_ancientY_SEA[, .N, by = .(country, haploY)]
country_ancientY_SEA <- country_ancientY_SEA %>%
  group_by(country) %>% arrange(haploY, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

library(viridis)
g5Y <- ggplot(country_ancientY_SEA) +      
  # Add the stacked bar
  geom_bar(aes(x=as.factor(country), y=percent, fill=factor(haploY)), position = "stack", stat="identity", alpha=0.5) +
  guides(fill=guide_legend(nrow=5, byrow=TRUE)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_x_discrete(name = "Country") +
  scale_y_continuous(name = "Percent") +
  theme(axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 10),
        legend.key.size = unit(0.5, "cm")) +
  coord_flip()
g5Y
ggsave(filename = file.path("figures", "country_ancient_haploY_plus.png"), width = 15, height = 10)

anY_SEA <- dat_ancientY_SEA %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1),
         count=1,
         haploY=ifelse((is.na(haploY) | haploY==".."), "Unspecified", haploY),
         countY=1) %>%
  group_by(country, haplo) %>%  mutate(sum=sum(count), max=max(sum)) %>%
  group_by(country) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo_max=haplo[order==1]) %>% ungroup %>%
  group_by(country, haplo1) %>% mutate(sum1=sum(count), max1=max(sum1)) %>%
  group_by(country) %>% arrange(desc(max1)) %>% 
  mutate(order1=order(max1, decreasing = T), haplo1_max=haplo1[order1==1]) %>% ungroup() %>%
  group_by(country, haploY) %>% mutate(sumY=sum(countY), maxY=max(sumY)) %>%
  group_by(country) %>% arrange(desc(maxY)) %>% 
  mutate(orderY=order(maxY, decreasing = T), haploY_max=haploY[orderY==1]) %>% ungroup() %>%
  select(c(`Object-ID`, Latitude, Longitude, Sex, haplo, haplo1, haploY, haplo_max, haplo1_max, haploY_max, Age, Location, Label, Date, country)) %>% 
  filter(!is.na(haploY) & haploY!="Unspecified")

anY_SEA_sf <- merge(anY_SEA, SEA0p_sf, by=c("country"))
anY_SEA_plot <- anY_SEA_sf %>% st_as_sf(crs = 4326)

countries <- SEA0p_sf
countries_coords <- st_coordinates(st_centroid(SEA0p_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = countries$country)

res <- country_ancientY_SEA %>%
  rename(ID=country) %>%
  group_by(haploY) %>%
  mutate(Country=order(ID)) %>%
  ungroup() %>%
  rename(key=haploY, value=N) %>%
  select(-percent) %>%
  arrange(key)

res <- res %>% left_join(countries_coords)

dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)
DT <- dt_res %>% select(-c(ID, X, Y, Country))
m<-as.matrix(DT)
ID <- dt_res$ID
Country <- dt_res$Country
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(Country=order(ID)) %>% left_join(countries_coords) %>% rename(x=X, y=Y)
dt_x <- dt %>% select(-c(Country, ID))

anY_SEA_plot_max <- anY_SEA_plot %>% group_by(country) %>% slice(1)
anY_SEA_max <- anY_SEA_plot_max %>% st_drop_geometry() %>% select(country, haploY_max) %>% rename(Country=country, `Max Y-Haplogroup`=haploY_max) %>% setDT()

library("ggpmisc")

ggplot() + 
  # geom_sf(data=SEA0p_sf, aes(fill="white"), alpha=0.1) +
  geom_sf(data=anY_SEA_plot_max, aes(fill=haploY_max), lwd=0, alpha=0.6) +
  geom_point(aes(x = Longitude, y = Latitude,  colour = haploY), data = anY_SEA_plot, position=position_jitter(width=1,height=1), size = 6) +
  geom_label(aes(x = Longitude, y = Latitude,  colour = haploY, label = Date), data = anY_SEA_plot, size = 2.5, hjust=-0.1, vjust=0.5, position=position_jitter(width=1,height=1), label.size = 0.5) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:90], color=NA, alpha=0.8) +
  annotate(geom = "table", x = 80, y = -10, label = list(anY_SEA_max), size = 6.5) +
  scale_fill_discrete(name="") +
  scale_color_discrete(name="") +
  guides(fill=guide_legend(nrow=8, byrow=TRUE)) +
  theme_bw() +
  theme(text = element_text(size=28), 
        axis.text.x = element_text(size=15), 
        axis.text.y = element_text(size=15), 
        legend.text=element_text(size=20), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Ancient Human Y-DNA (Y-DNA) Haplogroups in Southeast Asia (+)")
ggsave(filename = file.path("figures", "AncientY_SEA_plus_date.png"), width = 49, height = 33)

ggplot() + 
  # geom_sf(data=SEA0p_sf, aes(fill="white"), alpha=0.1) + 
  geom_sf(data=anY_SEA_plot_max, aes(fill=haploY_max), lwd=0, alpha=0.6) +
  geom_point(aes(x = Longitude, y = Latitude,  colour = haploY), data = anY_SEA_plot, position=position_jitter(width=-0.5,height=0.5), size = 6) +
  geom_label(aes(x = Longitude, y = Latitude,  colour = haploY, label = haploY), data = anY_SEA_plot, size = 8, hjust=-0.1, vjust=0.5, position=position_jitter(width=-1.5,height=1.5), label.size = 0.5) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:90], color=NA, alpha=0.8) +
  annotate(geom = "table", x = 80, y = -10, label = list(anY_SEA_max), size = 6.5) +
  scale_fill_discrete(name="") +
  scale_color_discrete(name="") +
  guides(fill=guide_legend(nrow=8, byrow=TRUE)) +
  theme_bw() +
  theme(text = element_text(size=40), 
        axis.text.x = element_text(size=30), 
        axis.text.y = element_text(size=30), 
        legend.text=element_text(size=30), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Ancient Human Y-DNA (Y-DNA) Haplogroups in Southeast Asia (+)")
ggsave(filename = file.path("figures", "AncientY_SEA_plus_label.png"), width = 49, height = 33)

## O1b - Ancient Y-DNA plus

load("data/SEA0p_sf.RData")
SEA0p_sf <- SEA0p_sf %>% rename(country=NAME_0)

library(readxl)
ancient <- read_excel("all-ancient-dna-2-07-73-full.xlsx")
ancient_SEA <- ancient %>% filter(Country %in% c("Bangladesh", "Brunei", "Cambodia", "China", "Indonesia", "India", "Laos", "Malaysia", "Myanmar", "Philippines", "Singapore", "Thailand", "Taiwan", "Timor-Leste", "Vietnam"))
O_ancientY_SEA <- ancient_SEA %>%
  rename(haplo="mtDNA-haplogroup",
         haploY="Y-Haplotree-Public",
         country="Country") %>%
  mutate(haploY1=ifelse(!is.na(`Y-New`), `Y-New`, `Y-Simple`),
         haploY1=ifelse(`Y-New` %in% c("CT low coverage", "D1(xD1a1a1a1b,xD1a1b1a,xD1a2) low coverage", "F low coverage", "F or J2a1a low coverage", "FTDNA: Forms a new branch D-Y65054 under D-PH344 with a Big Y tester from Kazakhstan", "ISOGG2015?", "ISOGG2015??", "ISOGG2016??", "ISOGG2018?", "J2b:FGC3945.1/FGC3945.2/FGC3945/Z526.1/Z526.2/Z526, J2b2a:AM01367/Z605", "K low coverage", "K2 low coverage", "M9, M526, M1221, L405, P295, F115", "NO1 low coverage", "O low coverage", "O1 low coverage", "O1a low coverage", "O1b1a1a1a(xO1b1a1a1a1a1)", "O2a1 low coverage", "O2a2b2a low coverage"), `Y-Simple`, haploY1),
         haploY2=ifelse(haploY1 %in% c("C", "C2", "CT", "D", "F", "K", "N", "N-L735", "NO", "O", "O2", "P*", "Q", "Q1", "R2"), haploY1, `Y-Simple`),
         haploY2=ifelse(!haploY1 %in% c("C", "C2", "CT", "D", "F", "K", "N", "N-L735", "NO", "O", "O2", "P*", "Q", "Q1", "R2"), str_extract(haploY1, "^([A-Z]+)\\d\\w"), haploY2),
         haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200", "A+152+16362+16189", "C4+152", "C4+152+16093", "D*", "E (95.07%)", "G1 (94.06%)", "M4″67", "n/a", "n/a (<2x)", "n/a (exome capture)", "R+16189", "R+16189C (76.45%)", "R+16189C (80.01%)", "R+16189C (81.67%)", "R2+13500", "U4'9", "W1+119")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haploY=ifelse((is.na(haploY) | haplo==".."), "Unspecified", haploY),
         haplo1 = ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200", "A+152+16362+16189"), "A+", haplo1),
         haplo1 = ifelse(haplo %in% c("C4+152", "C4+152+16093"), "C4+", haplo1),
         haplo1 = ifelse(haplo %in% c("D*"), "D", haplo1),
         haplo1 = ifelse(haplo %in% c("E (95.07%)"), "E", haplo1),
         haplo1 = ifelse(haplo %in% c("G1 (94.06%)"), "G1", haplo1),
         haplo1 = ifelse(haplo %in% c("M4″67"), "M4", haplo1),
         haplo1 = ifelse(haplo %in% c("n/a", "n/a (<2x)", "n/a (exome capture)"), "Unspecified", haplo1),
         haplo1 = ifelse(haplo %in% c("R+16189", "R+16189C (76.45%)", "R+16189C (80.01%)", "R+16189C (81.67%)"), "R+", haplo1),
         haplo1 = ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1 = ifelse(haplo %in% c("U4'9"), "U4", haplo1),
         haplo1 = ifelse(haplo %in% c("W1+119"), "W1", haplo1),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), haplo, haplo1),
         haplo2 = substr(haplo, 1, 1),
         haplo3 = str_extract(haplo, "^([A-Z])\\d+"),
         haplo3 = ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200", "A+152+16362+16189"), "A+", haplo3),
         haplo3 = ifelse(haplo %in% c("C4+152", "C4+152+16093"), "C4+", haplo3),
         haplo3 = ifelse(haplo %in% c("D*"), "D", haplo3),
         haplo3 = ifelse(haplo %in% c("E (95.07%)"), "E", haplo3),
         haplo3 = ifelse(haplo %in% c("G1 (94.06%)"), "G1", haplo3),
         haplo3 = ifelse(haplo %in% c("M4″67"), "M4", haplo3),
         haplo3 = ifelse(haplo %in% c("n/a", "n/a (<2x)", "n/a (exome capture)"), "Unspecified", haplo3),
         haplo3 = ifelse(haplo %in% c("R+16189", "R+16189C (76.45%)", "R+16189C (80.01%)", "R+16189C (81.67%)"), "R+", haplo3),
         haplo3 = ifelse(haplo %in% c("R2+13500"), "R2+", haplo3),
         haplo3 = ifelse(haplo %in% c("U4'9"), "U4", haplo3),
         haplo3 = ifelse(haplo %in% c("W1+119"), "W1", haplo3),
         haplo3 = ifelse((is.na(haplo3) | haplo3==".."), haplo, haplo3)
  ) %>% setDT() %>% filter(haploY2 %in% c("NO", "O", "O1a", "O1b", "O2", "O2a", "O3a"))

country_O_SEA <- O_ancientY_SEA[, .N, by = .(country, haploY1)]
country_O_SEA <- country_O_SEA %>%
  group_by(country) %>% arrange(haploY1, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

O_SEA <- O_ancientY_SEA %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1),
         count=1,
         haploY1=ifelse((is.na(haploY1) | haploY1==".."), "Unspecified", haploY1),
         countY1=1) %>%
  group_by(country, haplo) %>%  mutate(sum=sum(count), max=max(sum)) %>%
  group_by(country) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo_max=haplo[order==1]) %>% ungroup %>%
  group_by(country, haplo1) %>% mutate(sum1=sum(count), max1=max(sum1)) %>%
  group_by(country) %>% arrange(desc(max1)) %>% 
  mutate(order1=order(max1, decreasing = T), haplo1_max=haplo1[order1==1]) %>% ungroup() %>%
  group_by(country, haploY1) %>% mutate(sumY1=sum(countY1), maxY1=max(sumY1)) %>%
  group_by(country) %>% arrange(desc(maxY1)) %>% 
  mutate(orderY1=order(maxY1, decreasing = T), haploY1_max=haploY1[orderY1==1]) %>% ungroup() %>%
  select(c(`Object-ID`, Latitude, Longitude, Sex, haplo, haplo1, haploY1, haplo_max, haplo1_max, haploY1_max, Age, Location, Label, Date, country)) %>% 
  filter(!is.na(haploY1) & haploY1!="Unspecified")

O_SEA_sf <- merge(O_SEA, SEA0p_sf, by=c("country"))
O_SEA_plot <- O_SEA_sf %>% st_as_sf(crs = 4326)

countries <- SEA0p_sf
countries_coords <- st_coordinates(st_centroid(SEA0p_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = countries$country)

res <- country_O_SEA %>%
  rename(ID=country) %>%
  group_by(haploY1) %>%
  mutate(Country=order(ID)) %>%
  ungroup() %>%
  rename(key=haploY1, value=N) %>%
  select(-percent) %>%
  arrange(key)

res <- res %>% left_join(countries_coords)

dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)
DT <- dt_res %>% select(-c(ID, X, Y, Country))
m<-as.matrix(DT)
ID <- dt_res$ID
Country <- dt_res$Country
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(Country=order(ID)) %>% left_join(countries_coords) %>% rename(x=X, y=Y)
dt_x <- dt %>% select(-c(Country, ID))

O_SEA_plot_max <- O_SEA_plot %>% group_by(country) %>% slice(1)
O_SEA_max <- O_SEA_plot_max %>% st_drop_geometry() %>% select(country, haploY1_max) %>% rename(Country=country, `Dominant Y-Haplogroup`=haploY1_max) %>% setDT()

library("ggpmisc")

ggplot() + 
  # geom_sf(data=SEA0p_sf, aes(fill="white"), alpha=0.1) + 
  geom_sf(data=O_SEA_plot_max, aes(fill=haploY1_max), lwd=0, alpha=0.6) +
  geom_point(aes(x = Longitude, y = Latitude,  colour = haploY1), data = O_SEA_plot, position=position_jitter(width=-0.5,height=0.5), size = 6) +
  geom_label(aes(x = Longitude, y = Latitude,  colour = haploY1, label = haploY1), data = O_SEA_plot, size = 8, hjust=-0.1, vjust=0.5, position=position_jitter(width=-1.5,height=1.5), label.size = 0.5) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:28], color=NA, alpha=0.8) +
  annotate(geom = "table", x = 80, y = -10, label = list(O_SEA_max), size = 6.5) +
  scale_fill_discrete(name="") +
  scale_color_discrete(name="") +
  guides(fill=guide_legend(nrow=4, byrow=TRUE)) +
  theme_bw() +
  theme(text = element_text(size=40), 
        axis.text.x = element_text(size=30), 
        axis.text.y = element_text(size=30), 
        legend.text=element_text(size=30), 
        legend.key.size = unit(2, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Ancient Human Y-DNA Haplogroup O in Southeast Asia (+)")
ggsave(filename = file.path("figures", "AncientY_SEA_plus_haplo_O.png"), width = 49, height = 33)

### Make pie

# make_pie <- function(dt, title = NA, legend.position = 0){
#   if(is.na(title)){
#     title <- unique(dt$ID)
#   }
#   ggplot() +
#     geom_bar(data = dt,
#              aes(x = "", y = value, fill = key),
#              stat = "identity", width = 1) +
#     coord_polar("y") +
#     theme_void() +
#     theme(legend.position = legend.position) +
#     ggtitle(title)
# }
# 
# con1 <- make_pie(dplyr::filter(res, Country == 1))
# con2 <- make_pie(dplyr::filter(res, Country == 2))
# con3 <- make_pie(dplyr::filter(res, Country == 3))
# con4 <- make_pie(dplyr::filter(res, Country == 4))
# con5 <- make_pie(dplyr::filter(res, Country == 5))
# con6 <- make_pie(dplyr::filter(res, Country == 6))
# con7 <- make_pie(dplyr::filter(res, Country == 7))
# con8 <- make_pie(dplyr::filter(res, Country == 8))
# 
# (gg_countries <- ggplot(data = countries) +
#     geom_sf() +
#     scale_x_continuous(expand = c(0, 0)) +
#     scale_y_continuous(expand = c(0, 0 )) +
#     theme(legend.position = 0,
#           plot.margin = unit(c(0,0,0,0), "cm"))
# )
# 
# leg <- get_legend(make_pie(res, "", legend.position = "left"))
# 
# draw_plot_loc <- function(plot, dt){
#   draw_plot(plot, x = dt$X[1], y = dt$Y[1],
#             height = 0.2)
# }
# 
# (all <-
# ggdraw(gg_countries) +
#     draw_plot_loc(con1, dplyr::filter(res, Country == 1)) +
#     draw_plot_loc(con2, dplyr::filter(res, Country == 2)) +
#     draw_plot_loc(con3, dplyr::filter(res, Country == 3)) +
#     draw_plot_loc(con4, dplyr::filter(res, Country == 4)) +
#     draw_plot_loc(con5, dplyr::filter(res, Country == 5)) +
#     draw_plot_loc(con6, dplyr::filter(res, Country == 6)) +
#     draw_plot_loc(con7, dplyr::filter(res, Country == 7)) +
#     draw_plot_loc(con8, dplyr::filter(res, Country == 8)) +
#     draw_plot_loc(con9, dplyr::filter(res, Country == 9))
#   )
# 
# cowplot::plot_grid(all, leg, rel_widths = c(1, 0.1))

## Present DNA

load("data/SEA0_sf.RData")

# ggplot() + geom_sf(data=SEA0p_sf, aes(fill="white"), alpha=0.001) +
#   geom_sf_text(data=SEA0p_sf, mapping=aes(label = NAME_1), stat = "sf_coordinates", position = "identity", check_overlap = T)

SEA0_sf <- SEA0_sf %>% dplyr::rename(Country=NAME_0)

dat <- read_excel("CompleteFull.xlsx")
dat_f <- dat %>% mutate(count=1) %>% setDF()

pre_SEA <- dat %>% 
  mutate(haplo1=ifelse(!(haplogroup3 %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), haplo, haplo1),
         haplo1=ifelse(haplo1=="A+152", "A+",
                       ifelse(haplo1=="B4+16261", "B4+",
                              ifelse(haplo1=="F1+16189", "F1+",
                                     ifelse(haplo1=="HV12b1", "HV12",
                                            ifelse(haplo1=="M1'20'51", "M1'",
                                                   ifelse(haplo1=="M4''67", "M4'",
                                                          ifelse(haplo1=="P1+152", "P1+",
                                                                 ifelse(haplo1=="P2*1" | haplo1=="P2*1a" | haplo1=="P2*2", "P2*",
                                                                        ifelse(haplo1=="Q1+@16223", "Q1+",
                                                                               ifelse(haplo1=="R+16189", "R+",
                                                                                      ifelse(haplo1=="R2+13500", "R2+",
                                                                                             ifelse(haplo1=="R6+16129*", "R6+", haplo1)))))))))))),
         haplo2 = substr(haplo, 1, 1),
         haplo3 = str_extract(haplo, "^([A-Z])\\d+"),
         haplo3 = ifelse(is.na(haplo3), haplo, haplo3),
         count=1) %>%
  group_by(Country, haplo) %>%  mutate(sum=sum(count), max=max(sum)) %>%
  group_by(Country) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo_max=haplo[order==1]) %>% ungroup %>%
  group_by(Country, haplo1) %>% mutate(sum1=sum(count), max1=max(sum1)) %>%
  group_by(Country) %>% arrange(desc(max1)) %>% 
  mutate(order1=order(max1, decreasing = T), haplo1_max=haplo1[order1==1]) %>%
  ungroup() %>% setDT()

pre_SEA_sf <- merge(pre_SEA, SEA0_sf, by=c("Country"))
pre_SEA_plot <- pre_SEA_sf %>% st_as_sf(crs = 4326)

country_present_SEA <- pre_SEA[, .N, by = .(Country, haplo1)]
country_present_SEA <- country_present_SEA %>%
  group_by(Country) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

countries <- SEA0_sf
countries_coords <- st_coordinates(st_centroid(SEA0_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = countries$Country)

res_pre <- country_present_SEA %>%
  rename(ID=Country) %>%
  group_by(haplo1) %>%
  mutate(Country=order(ID)) %>%
  ungroup() %>%
  rename(key=haplo1, value=N) %>%
  select(-percent) %>%
  arrange(key)

res_pre <- res_pre %>% left_join(countries_coords)

dt_res <- spread(res_pre, key = key, value = value) %>% replace(is.na(.), 0)
DT <- dt_res %>% select(-c(ID, X, Y, Country))
m<-as.matrix(DT)
ID <- dt_res$ID
Country <- dt_res$Country
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(Country=order(ID)) %>% left_join(countries_coords) %>% rename(x=X, y=Y)
dt_x <- dt %>% select(-c(Country, ID))
dt_x <- dt_x[complete.cases(dt_x), ]

pre_SEA_plot_max <- pre_SEA_plot %>% group_by(Country) %>% slice(1)
pre_SEA_max <- pre_SEA_plot_max %>% st_drop_geometry() %>% select(Country, haplo1_max) %>% rename(`Dominant Haplogroup`=haplo1_max) %>% setDT()

library(ggpmisc)
library(scatterpie)

ggplot() + geom_sf() + geom_sf(data=pre_SEA_plot_max, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:217], color=NA, alpha=1) +
  annotate(geom = "table", x = 135, y = 25, label = list(pre_SEA_max), size = 10) +
  guides(fill=guide_legend(nrow=10, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(text = element_text(size=36), 
        axis.text.x = element_text(size=30), 
        axis.text.y = element_text(size=30), 
        legend.text=element_text(size=30), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Present Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia")
ggsave(filename = file.path("figures", "Present_SEA_new_new.png"), width = 49, height = 33)

ggplot() + geom_sf() + geom_sf(data=pre_SEA_plot_max, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:217], color=NA, alpha=1) +
  annotate(geom = "table", x = 140, y = 28, label = list(pre_SEA_max), size = 12) +
  guides(fill=guide_legend(nrow=10, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(text = element_text(size=36), 
        axis.text.x = element_text(size=30), 
        axis.text.y = element_text(size=30), 
        legend.text=element_text(size=30), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom")
ggsave(filename = file.path("figures", "Present_SEA_new_new_new.png"), width = 34, height = 32)

writexl::write_xlsx(dt, "Haplo_present_country_SEA.xlsx")
writexl::write_xlsx(dt_res, "Haplo_present_country_location_SEA.xlsx")

### Haplo 3

pre_SEA3 <- dat %>% 
  mutate(haplo1=ifelse(!(haplogroup3 %in% c("A+152", "A+152+16362", "A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), haplo, haplo1),
         haplo2 = substr(haplo, 1, 1),
         haplo3 = str_extract(haplo, "^([A-Z])\\d+"),
         haplo3 = ifelse(haplogroup3 %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo3),
         haplo3 = ifelse(haplogroup3 %in% c("R+16189"), "R+", haplo3),
         haplo3 = ifelse(is.na(haplo3), haplogroup3, haplo3),
         count=1) %>%
  group_by(country, haplo) %>%  mutate(sum=sum(count), max=max(sum)) %>%
  group_by(country) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo_max=haplo[order==1]) %>% ungroup %>%
  group_by(country, haplo3) %>% mutate(sum3=sum(count), max3=max(sum3)) %>%
  group_by(country) %>% arrange(desc(max3)) %>% 
  mutate(order3=order(max3, decreasing = T), haplo3_max=haplo3[order3==1]) %>%
  ungroup() %>% setDT()

pre_SEA3_sf <- merge(pre_SEA3, SEA0_sf, by=c("country"))
pre_SEA3_plot <- pre_SEA3_sf %>% st_as_sf(crs = 4326)

country_present_SEA3 <- pre_SEA3[, .N, by = .(country, haplo3)]
country_present_SEA3 <- country_present_SEA3 %>%
  group_by(country) %>% arrange(haplo3, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

res_pre <- country_present_SEA3 %>%
  rename(ID=country) %>%
  group_by(haplo3) %>%
  mutate(Country=order(ID)) %>%
  ungroup() %>%
  rename(key=haplo3, value=N) %>%
  select(-percent) %>%
  arrange(key)

res_pre <- res_pre %>% left_join(countries_coords)

dt_res <- spread(res_pre, key = key, value = value) %>% replace(is.na(.), 0)
DT <- dt_res %>% select(-c(ID, X, Y, Country))
m<-as.matrix(DT)
ID <- dt_res$ID
Country <- dt_res$Country
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(Country=order(ID)) %>% left_join(countries_coords) %>% rename(x=X, y=Y)
dt_x <- dt %>% select(-c(Country, ID))

pre_SEA3_plot_max <- pre_SEA3_plot %>% group_by(country) %>% slice(1)

ggplot() + geom_sf() + geom_sf(data=pre_SEA3_plot_max, aes(fill=haplo3_max), lwd=0, alpha=0.6) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:139], color=NA, alpha=0.8) +
  guides(fill=guide_legend(nrow=8, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(text = element_text(size=36), 
        axis.text.x = element_text(size=30), 
        axis.text.y = element_text(size=30), 
        legend.text=element_text(size=30), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Present Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia")
ggsave(filename = file.path("figures", "Present_SEA3.png"), width = 49, height = 33)

### Haplo 3 (2)

pre_SEA3 <- dat %>% 
  mutate(country=Country,
         haplo1=ifelse(!(haplogroup3 %in% c("A+152", "A+152+16362", "A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), haplo, haplo1),
         haplo2 = substr(haplo, 1, 1),
         haplo3 = str_extract(haplo, "^([A-Z])\\d+"),
         haplo3 = ifelse(haplogroup3 %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo3),
         haplo3 = ifelse(haplogroup3 %in% c("R+16189"), "R+", haplo3),
         haplo3 = ifelse(is.na(haplo3), haplogroup3, haplo3),
         count=1) %>%
  group_by(country, haplo) %>%  mutate(sum=sum(count), max=max(sum)) %>%
  group_by(country) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo_max=haplo[order==1]) %>% ungroup %>%
  group_by(country, haplo3) %>% mutate(sum3=sum(count), max3=max(sum3)) %>%
  group_by(country) %>% arrange(desc(max3)) %>% 
  mutate(order3=order(max3, decreasing = T), haplo3_max=haplo3[order3==1]) %>%
  ungroup() %>% setDT()

load("data/SEA0_sf.RData")
SEA0_sf <- SEA0_sf %>% rename(country=NAME_0)

pre_SEA3_sf <- merge(pre_SEA3, SEA0_sf, by=c("country"))
pre_SEA3_plot <- pre_SEA3_sf %>% st_as_sf(crs = 4326)

country_present_SEA3 <- pre_SEA3[, .N, by = .(country, haplo3)]
country_present_SEA3 <- country_present_SEA3 %>%
  group_by(country) %>% arrange(haplo3, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

countries <- SEA0_sf
countries_coords <- st_coordinates(st_centroid(SEA0_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = countries$country)

res_pre <- country_present_SEA3 %>%
  rename(ID=country) %>%
  group_by(haplo3) %>%
  mutate(Country=order(ID)) %>%
  ungroup() %>%
  rename(key=haplo3, value=N) %>%
  select(-percent) %>%
  arrange(key)

res_pre <- res_pre %>% left_join(countries_coords)

dt_res <- spread(res_pre, key = key, value = value) %>% replace(is.na(.), 0)
DT <- dt_res %>% select(-c(ID, X, Y, Country))
m<-as.matrix(DT)
ID <- dt_res$ID
Country <- dt_res$Country
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(Country=order(ID)) %>% left_join(countries_coords) %>% rename(x=X, y=Y)
dt_x <- dt %>% select(-c(Country, ID))

pre_SEA3_plot_max <- pre_SEA3_plot %>% group_by(country) %>% slice(1)

ggplot() + geom_sf() + geom_sf(data=pre_SEA3_plot_max, aes(fill=haplo3_max), lwd=0, alpha=0.6) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:139], color=NA, alpha=0.8) +
  # annotate(geom = "table", x = 135, y = 20, label = list(pre_SEA3_plot_max), size = 6.5) +
  guides(fill=guide_legend(nrow=8, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(text = element_text(size=36), 
        axis.text.x = element_text(size=30), 
        axis.text.y = element_text(size=30), 
        legend.text=element_text(size=30), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Present Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia")
ggsave(filename = file.path("figures", "Present_SEA3 (2).png"), width = 49, height = 33)

## Present DNA plus

load("data/SEA0p_sf.RData")

# ggplot() + geom_sf(data=SEA0p_sf, aes(fill="white"), alpha=0.001) +
#   geom_sf_text(data=SEA0p_sf, mapping=aes(label = NAME_1), stat = "sf_coordinates", position = "identity", check_overlap = T)

SEA0_sf <- SEA0p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% 
  dplyr::filter(country %in% c("Brunei", "Cambodia", "Indonesia", "Laos", "Malaysia", "Myanmar", "Philippines", "Singapore", "Taiwan", "Thailand", "Timor-Leste", "Vietnam") | (country=="China" & location %in% c("Yunnan", "Guangxi", "Guangdong", "Hainan", "Fujian", "Guizhou", "Hunan", "Jiangxi"))) %>%
  mutate(country=ifelse(country=="China", "Myanmar", country))
SEA1_sf$location <- stri_trans_general(SEA1_sf$location, "Latin-ASCII")
SEA1_sf$location <- trimws(gsub("\\s+", " ", SEA1_sf$location))
SEA1_sf <- SEA1_sf %>% dplyr::select(country, location, type, geometry)

SEA0_sf <- SEA0_sf %>% rename(country=NAME_0)

dat <- read_excel("CompleteFull.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))

dat_f <- dat %>% mutate(count=1) %>% setDF()

SEA <- dat_f %>%  mutate(Location=ifelse(Location=="Yunnan, China", "Yunnan", Location))

pre_SEA <- SEA %>% 
  mutate(haplo1=ifelse(!(haplogroup3 %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), haplo, haplo1),
         haplo1=ifelse(haplo1=="A+152", "A+",
                       ifelse(haplo1=="B4+16261", "B4+",
                              ifelse(haplo1=="F1+16189", "F1+",
                                     ifelse(haplo1=="HV12b1", "HV12",
                                            ifelse(haplo1=="M1'20'51", "M1'",
                                                   ifelse(haplo1=="M4''67", "M4'",
                                                          ifelse(haplo1=="P1+152", "P1+",
                                                                 ifelse(haplo1=="P2*1" | haplo1=="P2*1a" | haplo1=="P2*2", "P2*",
                                                                        ifelse(haplo1=="Q1+@16223", "Q1+",
                                                                               ifelse(haplo1=="R+16189", "R+",
                                                                                      ifelse(haplo1=="R2+13500", "R2+",
                                                                                             ifelse(haplo1=="R6+16129*", "R6+", haplo1)))))))))))),
         haplo2 = substr(haplo, 1, 1),
         haplo3 = str_extract(haplo, "^([A-Z])\\d+"),
         haplo3 = ifelse(is.na(haplo3), haplo, haplo3),
         count=1) %>%
  group_by(Country, haplo) %>%  mutate(sum=sum(count), max=max(sum)) %>%
  group_by(Country) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo_max=haplo[order==1]) %>% ungroup %>%
  group_by(Country, haplo1) %>% mutate(sum1=sum(count), max1=max(sum1)) %>%
  group_by(Country) %>% arrange(desc(max1)) %>% 
  mutate(order1=order(max1, decreasing = T), haplo1_max=haplo1[order1==1]) %>%
  ungroup() %>% setDT()

pre_SEA_sf <- merge(pre_SEA, SEA0_sf, by=c("Country"))
pre_SEA_plot <- pre_SEA_sf %>% st_as_sf(crs = 4326)

country_present_SEA <- pre_SEA[, .N, by = .(Country, haplo1)]
country_present_SEA <- country_present_SEA %>%
  group_by(Country) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

countries <- SEA0_sf
countries_coords <- st_coordinates(st_centroid(SEA0_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = countries$Country)

res_pre <- country_present_SEA %>%
  rename(ID=Country) %>%
  group_by(haplo1) %>%
  mutate(Country=order(ID)) %>%
  ungroup() %>%
  rename(key=haplo1, value=N) %>%
  select(-percent) %>%
  arrange(key)

res_pre <- res_pre %>% left_join(countries_coords)

dt_res <- spread(res_pre, key = key, value = value) %>% replace(is.na(.), 0)
DT <- dt_res %>% select(-c(ID, X, Y, Country))
m<-as.matrix(DT)
ID <- dt_res$ID
Country <- dt_res$Country
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(Country=order(ID)) %>% left_join(countries_coords) %>% rename(x=X, y=Y)
dt_x <- dt %>% select(-c(Country, ID))
dt_x <- dt_x[complete.cases(dt_x), ]

pre_SEA_plot_max <- pre_SEA_plot %>% group_by(Country) %>% slice(1)
pre_SEA_max <- pre_SEA_plot_max %>% st_drop_geometry() %>% select(Country, haplo1_max) %>% rename(`Dominant Haplogroup`=haplo1_max) %>% setDT()

library(ggpmisc)
library(scatterpie)

ggplot() + geom_sf() + geom_sf(data=pre_SEA_plot_max, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:217], color=NA, alpha=1) +
  annotate(geom = "table", x = 135, y = 25, label = list(pre_SEA_max), size = 10) +
  guides(fill=guide_legend(nrow=10, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(text = element_text(size=36), 
        axis.text.x = element_text(size=30), 
        axis.text.y = element_text(size=30), 
        legend.text=element_text(size=30), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Geographic distribution of Present Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia")
ggsave(filename = file.path("figures", "Present_SEA_new_new.png"), width = 49, height = 33)

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")

# ggplot() + geom_sf(data=SEA1p_sf, aes(fill="white"), alpha=0.001) +
#   geom_sf_text(data=SEA1p_sf, mapping=aes(label = NAME_1), stat = "sf_coordinates", position = "identity", check_overlap = T)

SEA1_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% 
  dplyr::filter(country %in% c("Brunei", "Cambodia", "Indonesia", "Laos", "Malaysia", "Myanmar", "Philippines", "Singapore", "Taiwan", "Thailand", "Timor-Leste", "Vietnam") | (country=="China" & location %in% c("Yunnan", "Guangxi", "Guangdong", "Hainan", "Fujian", "Guizhou", "Hunan", "Jiangxi"))) %>%
  mutate(country=ifelse(country=="China", "Myanmar", country))
SEA1_sf$location <- stri_trans_general(SEA1_sf$location, "Latin-ASCII")
SEA1_sf$location <- trimws(gsub("\\s+", " ", SEA1_sf$location))
SEA1_sf <- SEA1_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
SEA <- read_excel("CompleteFull.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))

SEA <- SEA %>%  mutate(Location=ifelse(Location=="Yunnan, China", "Yunnan", Location))

pre_SEA <- SEA %>% 
  mutate(haplo1=ifelse(!(haplogroup3 %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), haplo, haplo1),
         haplo1=ifelse(haplo1=="A+152", "A+",
                       ifelse(haplo1=="B4+16261", "B4+",
                              ifelse(haplo1=="F1+16189", "F1+",
                                     ifelse(haplo1=="HV12b1", "HV12",
                                            ifelse(haplo1=="M1'20'51", "M1'",
                                                   ifelse(haplo1=="M4''67", "M4'",
                                                          ifelse(haplo1=="P1+152", "P1+",
                                                                 ifelse(haplo1=="P2*1" | haplo1=="P2*1a" | haplo1=="P2*2", "P2*",
                                                                        ifelse(haplo1=="Q1+@16223", "Q1+",
                                                                               ifelse(haplo1=="R+16189", "R+",
                                                                                      ifelse(haplo1=="R2+13500", "R2+",
                                                                                             ifelse(haplo1=="R6+16129*", "R6+", haplo1)))))))))))),
         haplo2 = substr(haplo, 1, 1),
         haplo3 = str_extract(haplo, "^([A-Z])\\d+"),
         haplo3 = ifelse(is.na(haplo3), haplo, haplo3),
         count=1) %>%
  group_by(Country, haplo) %>%  mutate(sum=sum(count), max=max(sum)) %>%
  group_by(Country) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo_max=haplo[order==1]) %>% ungroup %>%
  group_by(Country, haplo1) %>% mutate(sum1=sum(count), max1=max(sum1)) %>%
  group_by(Country) %>% arrange(desc(max1)) %>% 
  mutate(order1=order(max1, decreasing = T), haplo1_max=haplo1[order1==1]) %>%
  ungroup() %>% setDT()

dat_country_SEA <- country_SEA %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

country_SEA_sf <- merge(pre_SEA, SEA1_sf, by=c("location"))
country_SEA_plot <- country_SEA_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
SEA1_sf <- st_as_sf(SEA1_sf)

# Check for empty geometries
SEA1_sf <- SEA1_sf[!st_is_empty(SEA1_sf), ]

locations <- SEA1_sf
locations_coords <- st_coordinates(st_centroid(SEA1_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_country_SEA$location %in% locations$location)

dat2 <- dat_country_SEA %>% filter(!location %in% locations$location)

country_SEA <- pre_SEA[, .N, by = .(Country, haplo1)]
country_SEA <- country_SEA %>%
  group_by(Country) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N*100)/sum(N)) %>% ungroup()

res <- country_SEA %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(country, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

country_SEA_plot_max <- country_SEA_plot %>% group_by(Country) %>% slice(1)
country_SEA_max <- country_SEA_plot_max %>% st_drop_geometry() %>% select(Country, haplo1_max) %>% rename(`Dominant Haplogroup`=haplo1_max) %>% setDT()

library(ggpmisc)
library(scatterpie)

ggplot() + geom_sf(data=SEA1_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_SEA_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  # geom_sf_text(data=country_SEA_plot, mapping=aes(label = location), stat = "sf_coordinates", position = "identity", check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.3), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow=13, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom")

ggsave(filename = file.path("figures", "Haplo_country_SEA_new_plus.png"), width = 24, height = 26)

writexl::write_xlsx(dt, "Haplo_present_country_SEA_plus.xlsx")
writexl::write_xlsx(dt_res, "Haplo_present_country_SEA_plus.xlsx")

## Ethnicity

# SEA1_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1_sf, file = "data/SEA1_sf.RData")

# SEA1p_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, china_CHN1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, taiwan_TWN1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1p_sf, file = "data/SEA1p_sf.RData")

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")

# ggplot() + geom_sf(data=SEA1p_sf, aes(fill="white"), alpha=0.001) +
#   geom_sf_text(data=SEA1p_sf, mapping=aes(label = NAME_1), stat = "sf_coordinates", position = "identity", check_overlap = T)

SEA1_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% 
  dplyr::filter(country %in% c("Brunei", "Cambodia", "Indonesia", "Laos", "Malaysia", "Myanmar", "Philippines", "Singapore", "Taiwan", "Thailand", "Timor-Leste", "Vietnam") | (country=="China" & location %in% c("Yunnan", "Guangxi", "Guangdong", "Hainan", "Fujian", "Guizhou", "Hunan", "Jiangxi"))) %>%
  mutate(country=ifelse(country=="China", "Myanmar", country))
SEA1_sf$location <- stri_trans_general(SEA1_sf$location, "Latin-ASCII")
SEA1_sf$location <- trimws(gsub("\\s+", " ", SEA1_sf$location))
SEA1_sf <- SEA1_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))

SEA <- SEA %>%  mutate(Location=ifelse(Location=="Yunnan, China", "Yunnan", Location))

ethnic_SEA <- SEA[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_SEA <- ethnic_SEA %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_SEA <- gather(ethnic_SEA, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_SEA <- ethnic_SEA %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_SEA <- dat_ethnic_SEA[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_SEA1 <- dat_ethnic_SEA[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_SEA <- dat_ethnic_SEA %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

g8 <- ggplot(pre_ethnic_SEA) +      
  # Add the stacked bar
  geom_bar(aes(x=as.factor(ethnicity), y=percent, fill=factor(haplo1)), position = "stack", stat="identity", alpha=0.5) +
  guides(fill=guide_legend(nrow=10, byrow=TRUE)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_x_discrete(name = "Ethnicity") +
  scale_y_continuous(name = "Percent") +
  theme(axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 8),
        legend.key.size = unit(0.3, "cm")) +
  coord_flip()
g8
ggsave(filename = file.path("figures", "pre_ethnicity_haplo_new.png"), width = 20, height = 15)

g9 <- ggplot(pre_ethnic_SEA) +      
  # Add the stacked bar
  geom_bar(aes(x=as.factor(ethnicity), y=percent, fill=factor(haplo1)), position = "stack", stat="identity", alpha=0.5) +
  guides(fill=guide_legend(nrow=10, byrow=TRUE)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_x_discrete(name = "Ethinicity") +
  scale_y_continuous(name = "Percent") +
  theme(legend.position = "bottom", 
        legend.title = element_blank(), 
        legend.text = element_text(size = 8),
        legend.key.size = unit(0.3, "cm")) +
  coord_polar()
g9
ggsave(filename = file.path("figures", "pre_ethnicity_haplo_polar_new.png"), width = 20, height = 15)

# library(writexl)
# write_xlsx(dat_ethnic_SEA, "dat_ethnic_SEA.xlsx")
# write_xlsx(locations, "locations.xlsx")

ethnicity_SEA <- dat_ethnic_SEA %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_SEA_sf <- merge(ethnicity_SEA, SEA1_sf, by=c("location"))
ethnicity_SEA_plot <- ethnicity_SEA_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
SEA1_sf <- st_as_sf(SEA1_sf)

# Check for empty geometries
SEA1_sf <- SEA1_sf[!st_is_empty(SEA1_sf), ]

locations <- SEA1_sf
locations_coords <- st_coordinates(st_centroid(SEA1_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_SEA$location %in% locations$location)

dat2 <- dat_ethnic_SEA %>% filter(!location %in% locations$location)

res <- ethnicity_SEA %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

# ggplot() + geom_sf(data=SEA1_sf, aes(fill="white"), alpha=0.1) + 
#   geom_sf(data=ethnicity_SEA_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
#   geom_sf_text(data=ethnicity_SEA_plot, mapping=aes(label = ethnicity), stat = "sf_coordinates", position = "identity", check_overlap = T) +
#   geom_scatterpie(aes(x=x, y=y, r=0.6), data=dt_x, cols = colnames(dt_x)[1:218], color=NA, alpha=0.8) +
#   guides(fill=guide_legend(nrow=10, byrow=TRUE)) +
#   scale_fill_discrete(name="") +
#   theme_bw() +
#   theme(text = element_text(size=36), 
#         axis.text.x = element_text(size=30), 
#         axis.text.y = element_text(size=30), 
#         legend.text=element_text(size=25), 
#         legend.key.size = unit(1, "cm"),
#         legend.position = "bottom") +
#   ggtitle("Geographic distribution of Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia by Ethnicity")
# ggsave(filename = file.path("figures", "Ethnicity_SEA_edit2_new.png"), width = 49, height = 33)

ggplot() + geom_sf(data=SEA1_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_SEA_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  # geom_sf_text(data=ethnicity_SEA_plot, mapping=aes(label = location), stat = "sf_coordinates", position = "identity", check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.3), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow=13, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom")

ggsave(filename = file.path("figures", "Haplo_location_SEA_new_plus.png"), width = 24, height = 26)

# writexl::write_xlsx(dt, "Haplo_location_SEA.xlsx")
# writexl::write_xlsx(dt_res, "Haplo_ethnic_location_SEA.xlsx")

## Brunei

# SEA1_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1_sf, file = "data/SEA1_sf.RData")

# SEA1p_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, china_CHN1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, taiwan_TWN1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1p_sf, file = "data/SEA1p_sf.RData")

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")
BRU_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% dplyr::filter(country=="Brunei")
BRU_sf$location <- stri_trans_general(BRU_sf$location, "Latin-ASCII")
BRU_sf$location <- trimws(gsub("\\s+", " ", BRU_sf$location))
BRU_sf <- BRU_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))
BRU <- SEA %>% filter(Country=="Brunei")

ethnic_BRU <- BRU[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_BRU <- ethnic_BRU %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_BRU <- gather(ethnic_BRU, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_BRU <- ethnic_BRU %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_BRU <- dat_ethnic_BRU[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_BRU1 <- dat_ethnic_BRU[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_BRU <- dat_ethnic_BRU %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

ethnicity_BRU <- dat_ethnic_BRU %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_BRU_sf <- merge(ethnicity_BRU, BRU_sf, by=c("location"))
ethnicity_BRU_plot <- ethnicity_BRU_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
BRU_sf <- st_as_sf(BRU_sf)

# Check for empty geometries
BRU_sf <- BRU_sf[!st_is_empty(BRU_sf), ]

locations <- BRU_sf
locations_coords <- st_coordinates(st_centroid(BRU_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_BRU$location %in% locations$location)

dat2 <- dat_ethnic_BRU %>% filter(!location %in% locations$location)

res <- ethnicity_BRU %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

g_bru <- ggplot() + geom_sf(data=BRU_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_BRU_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_BRU_plot, mapping=aes(label = location), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.1), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow = 1, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Brunei")

g_bru

ggsave(filename = file.path("figures", "Haplo_location_Brunei_new.png"), width = 20, height = 18)

ethnicity_BRU_plot_max <- ethnicity_BRU_plot %>% group_by(ethnicity) %>% slice(1)
ethnicity_BRU_max <- ethnicity_BRU_plot_max %>% st_drop_geometry() %>% select(ethnicity, haplo1_max) %>% rename(Ethnicity=ethnicity, `Dominant Haplogroup`=haplo1_max) %>% setDT()

e_bru <- ggplot() + geom_sf(data=BRU_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_BRU_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_BRU_plot, mapping=aes(label = ethnicity), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.1), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  annotate(geom = "table", x = 114, y = 4.8, label = list(ethnicity_BRU_max), size = 8) +
  guides(fill=guide_legend(nrow = 1, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Brunei")

e_bru

ggsave(filename = file.path("figures", "Haplo_ethnic_Brunei_new.png"), width = 20, height = 17)

## Cambodia

# SEA1_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1_sf, file = "data/SEA1_sf.RData")

# SEA1p_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, china_CHN1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, taiwan_TWN1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1p_sf, file = "data/SEA1p_sf.RData")

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")
CAM_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% dplyr::filter(country=="Cambodia")
CAM_sf$location <- stri_trans_general(CAM_sf$location, "Latin-ASCII")
CAM_sf$location <- trimws(gsub("\\s+", " ", CAM_sf$location))
CAM_sf <- CAM_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))
CAM <- SEA %>% filter(Country=="Cambodia")

ethnic_CAM <- CAM[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_CAM <- ethnic_CAM %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_CAM <- gather(ethnic_CAM, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_CAM <- ethnic_CAM %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_CAM <- dat_ethnic_CAM[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_CAM1 <- dat_ethnic_CAM[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_CAM <- dat_ethnic_CAM %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

ethnicity_CAM <- dat_ethnic_CAM %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_CAM_sf <- merge(ethnicity_CAM, CAM_sf, by=c("location"))
ethnicity_CAM_plot <- ethnicity_CAM_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
CAM_sf <- st_as_sf(CAM_sf)

# Check for empty geometries
CAM_sf <- CAM_sf[!st_is_empty(CAM_sf), ]

locations <- CAM_sf
locations_coords <- st_coordinates(st_centroid(CAM_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_CAM$location %in% locations$location)

dat2 <- dat_ethnic_CAM %>% filter(!location %in% locations$location)

res <- ethnicity_CAM %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

g_cam <- ggplot() + geom_sf(data=CAM_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_CAM_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_CAM_plot, mapping=aes(label = location), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.2), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow = 4, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Cambodia")

g_cam

ggsave(filename = file.path("figures", "Haplo_location_Cambodia_new.png"), width = 24, height = 25)

ethnicity_CAM_plot_max <- ethnicity_CAM_plot %>% group_by(ethnicity) %>% slice(1)
ethnicity_CAM_max <- ethnicity_CAM_plot_max %>% st_drop_geometry() %>% select(ethnicity, haplo1_max) %>% rename(Ethnicity=ethnicity, `Dominant Haplogroup`=haplo1_max) %>% setDT()

e_cam <- ggplot() + geom_sf(data=CAM_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_CAM_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_CAM_plot, mapping=aes(label = ethnicity), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.2), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  annotate(geom = "table", x = 108, y = 10, label = list(ethnicity_CAM_max), size = 8) +
  guides(fill=guide_legend(nrow = 4, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Cambodia")

e_cam

ggsave(filename = file.path("figures", "Haplo_ethnic_Cambodia_new.png"), width = 24, height = 25)

## Indonesia

# SEA1_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1_sf, file = "data/SEA1_sf.RData")

# SEA1p_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, china_CHN1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, taiwan_TWN1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1p_sf, file = "data/SEA1p_sf.RData")

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")
IND_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% dplyr::filter(country=="Indonesia")
IND_sf$location <- stri_trans_general(IND_sf$location, "Latin-ASCII")
IND_sf$location <- trimws(gsub("\\s+", " ", IND_sf$location))
IND_sf <- IND_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))
IND <- SEA %>% filter(Country=="Indonesia")

ethnic_IND <- IND[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_IND <- ethnic_IND %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_IND <- gather(ethnic_IND, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_IND <- ethnic_IND %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_IND <- dat_ethnic_IND[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_IND1 <- dat_ethnic_IND[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_IND <- dat_ethnic_IND %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

ethnicity_IND <- dat_ethnic_IND %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_IND_sf <- merge(ethnicity_IND, IND_sf, by=c("location"))
ethnicity_IND_plot <- ethnicity_IND_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
IND_sf <- st_as_sf(IND_sf)

# Check for empty geometries
IND_sf <- IND_sf[!st_is_empty(IND_sf), ]

locations <- IND_sf
locations_coords <- st_coordinates(st_centroid(IND_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_IND$location %in% locations$location)

dat2 <- dat_ethnic_IND %>% filter(!location %in% locations$location)

res <- ethnicity_IND %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

g_ind <- ggplot() + geom_sf(data=IND_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_IND_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_IND_plot, mapping=aes(label = location), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow = 4, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Indonesia")

g_ind

ggsave(filename = file.path("figures", "Haplo_location_Indonesia_new.png"), width = 30, height = 16)

ethnicity_IND_plot_max <- ethnicity_IND_plot %>% group_by(ethnicity) %>% slice(1)
ethnicity_IND_max <- ethnicity_IND_plot_max %>% st_drop_geometry() %>% select(ethnicity, haplo1_max) %>% rename(Ethnicity=ethnicity, `Dominant Haplogroup`=haplo1_max) %>% setDT()

e_ind <- ggplot() + geom_sf(data=IND_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_IND_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_IND_plot, mapping=aes(label = ethnicity), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=1), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  annotate(geom = "table", x = 88, y = -20, label = list(ethnicity_IND_max), size = 6) +
  guides(fill=guide_legend(nrow = 4, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Indonesia")

e_ind

ggsave(filename = file.path("figures", "Haplo_ethnic_Indonesia_new.png"), width = 30, height = 18)

## Laos

# SEA1_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1_sf, file = "data/SEA1_sf.RData")

# SEA1p_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, china_CHN1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, taiwan_TWN1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1p_sf, file = "data/SEA1p_sf.RData")

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")
LAO_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% dplyr::filter(country=="Laos")
LAO_sf$location <- stri_trans_general(LAO_sf$location, "Latin-ASCII")
LAO_sf$location <- trimws(gsub("\\s+", " ", LAO_sf$location))
LAO_sf <- LAO_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))
LAO <- SEA %>% filter(Country=="Laos")

ethnic_LAO <- LAO[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_LAO <- ethnic_LAO %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_LAO <- gather(ethnic_LAO, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_LAO <- ethnic_LAO %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_LAO <- dat_ethnic_LAO[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_LAO1 <- dat_ethnic_LAO[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_LAO <- dat_ethnic_LAO %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

ethnicity_LAO <- dat_ethnic_LAO %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_LAO_sf <- merge(ethnicity_LAO, LAO_sf, by=c("location"))
ethnicity_LAO_plot <- ethnicity_LAO_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
LAO_sf <- st_as_sf(LAO_sf)

# Check for empty geometries
LAO_sf <- LAO_sf[!st_is_empty(LAO_sf), ]

locations <- LAO_sf
locations_coords <- st_coordinates(st_centroid(LAO_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_LAO$location %in% locations$location)

dat2 <- dat_ethnic_LAO %>% filter(!location %in% locations$location)

res <- ethnicity_LAO %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

g_lao <- ggplot() + geom_sf(data=LAO_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_LAO_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_LAO_plot, mapping=aes(label = location), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.4), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow = 2, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Laos")

g_lao

ggsave(filename = file.path("figures", "Haplo_location_Laos_new.png"), width = 22, height = 26)

ethnicity_LAO_plot_max <- ethnicity_LAO_plot %>% group_by(ethnicity) %>% slice(1)
ethnicity_LAO_max <- ethnicity_LAO_plot_max %>% st_drop_geometry() %>% select(ethnicity, haplo1_max) %>% rename(Ethnicity=ethnicity, `Dominant Haplogroup`=haplo1_max) %>% setDT()

e_lao <- ggplot() + geom_sf(data=LAO_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_LAO_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_LAO_plot, mapping=aes(label = ethnicity), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.4), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  annotate(geom = "table", x = 101, y = 16, label = list(ethnicity_LAO_max), size = 9) +
  guides(fill=guide_legend(nrow = 2, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Laos")

e_lao

ggsave(filename = file.path("figures", "Haplo_ethnic_Laos_new.png"), width = 22, height = 26)

## Malaysia

# SEA1_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1_sf, file = "data/SEA1_sf.RData")

# SEA1p_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, china_CHN1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, taiwan_TWN1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1p_sf, file = "data/SEA1p_sf.RData")

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")
MAL_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% dplyr::filter(country=="Malaysia")
MAL_sf$location <- stri_trans_general(MAL_sf$location, "Latin-ASCII")
MAL_sf$location <- trimws(gsub("\\s+", " ", MAL_sf$location))
MAL_sf <- MAL_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))
MAL <- SEA %>% filter(Country=="Malaysia")

ethnic_MAL <- MAL[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_MAL <- ethnic_MAL %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_MAL <- gather(ethnic_MAL, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_MAL <- ethnic_MAL %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_MAL <- dat_ethnic_MAL[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_MAL1 <- dat_ethnic_MAL[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_MAL <- dat_ethnic_MAL %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

ethnicity_MAL <- dat_ethnic_MAL %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_MAL_sf <- merge(ethnicity_MAL, MAL_sf, by=c("location"))
ethnicity_MAL_plot <- ethnicity_MAL_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
MAL_sf <- st_as_sf(MAL_sf)

# Check for empty geometries
MAL_sf <- MAL_sf[!st_is_empty(MAL_sf), ]

locations <- MAL_sf
locations_coords <- st_coordinates(st_centroid(MAL_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_MAL$location %in% locations$location)

dat2 <- dat_ethnic_MAL %>% filter(!location %in% locations$location)

res <- ethnicity_MAL %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

g_mal <- ggplot() + geom_sf(data=MAL_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_MAL_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_MAL_plot, mapping=aes(label = location), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.4), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow = 2, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Malaysia")

g_mal

ggsave(filename = file.path("figures", "Haplo_location_Malaysia_new.png"), width = 30, height = 13)

ethnicity_MAL_plot_max <- ethnicity_MAL_plot %>% group_by(ethnicity) %>% slice(1)
ethnicity_MAL_max <- ethnicity_MAL_plot_max %>% st_drop_geometry() %>% select(ethnicity, haplo1_max) %>% rename(Ethnicity=ethnicity, `Dominant Haplogroup`=haplo1_max) %>% setDT()

e_mal <- ggplot() + geom_sf(data=MAL_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_MAL_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_MAL_plot, mapping=aes(label = ethnicity), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.4), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  annotate(geom = "table", x = 111, y = 7.3, label = list(ethnicity_MAL_max), size = 6.5) +
  guides(fill=guide_legend(nrow = 2, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Malaysia")

e_mal

ggsave(filename = file.path("figures", "Haplo_ethnic_Malaysia_new.png"), width = 30, height = 13)

## Myanmar

# SEA1_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1_sf, file = "data/SEA1_sf.RData")

# SEA1p_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, china_CHN1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, taiwan_TWN1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1p_sf, file = "data/SEA1p_sf.RData")

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")
MYA_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% dplyr::filter(country=="Myanmar" | (country=="China" & location=="Yunnan")) %>%
  mutate(country=ifelse(country=="China", "Myanmar", country))
MYA_sf$location <- stri_trans_general(MYA_sf$location, "Latin-ASCII")
MYA_sf$location <- trimws(gsub("\\s+", " ", MYA_sf$location))
MYA_sf <- MYA_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))
MYA <- SEA %>% filter(Country=="Myanmar") %>%
  mutate(Location=ifelse(Location=="Yunnan, China", "Yunnan", Location))

ethnic_MYA <- MYA[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_MYA <- ethnic_MYA %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_MYA <- gather(ethnic_MYA, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_MYA <- ethnic_MYA %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_MYA <- dat_ethnic_MYA[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_MYA1 <- dat_ethnic_MYA[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_MYA <- dat_ethnic_MYA %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

ethnicity_MYA <- dat_ethnic_MYA %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_MYA_sf <- merge(ethnicity_MYA, MYA_sf, by=c("location"))
ethnicity_MYA_plot <- ethnicity_MYA_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
MYA_sf <- st_as_sf(MYA_sf)

# Check for empty geometries
MYA_sf <- MYA_sf[!st_is_empty(MYA_sf), ]

locations <- MYA_sf
locations_coords <- st_coordinates(st_centroid(MYA_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_MYA$location %in% locations$location)

dat2 <- dat_ethnic_MYA %>% filter(!location %in% locations$location)

res <- ethnicity_MYA %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

g_mya <- ggplot() + geom_sf(data=MYA_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_MYA_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_MYA_plot, mapping=aes(label = location), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.8), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow = 6, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Myanmar")

g_mya

ggsave(filename = file.path("figures", "Haplo_location_Myanmar_new.png"), width = 18, height = 30)

ethnicity_MYA_plot_max <- ethnicity_MYA_plot %>% group_by(ethnicity) %>% slice(1)
ethnicity_MYA_max <- ethnicity_MYA_plot_max %>% st_drop_geometry() %>% select(ethnicity, haplo1_max) %>% rename(Ethnicity=ethnicity, `Dominant Haplogroup`=haplo1_max) %>% setDT()

e_mya <- ggplot() + geom_sf(data=MYA_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_MYA_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_MYA_plot, mapping=aes(label = ethnicity), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.8), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  annotate(geom = "table", x = 106, y = 20, label = list(ethnicity_MYA_max), size = 7) +
  guides(fill=guide_legend(nrow = 6, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Myanmar")

e_mya

ggsave(filename = file.path("figures", "Haplo_ethnic_Myanmar_new.png"), width = 18, height = 30)


## Philippines

# SEA1_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1_sf, file = "data/SEA1_sf.RData")

# SEA1p_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, china_CHN1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, taiwan_TWN1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1p_sf, file = "data/SEA1p_sf.RData")

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")
PHI_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% dplyr::filter(country=="Philippines")
PHI_sf$location <- stri_trans_general(PHI_sf$location, "Latin-ASCII")
PHI_sf$location <- trimws(gsub("\\s+", " ", PHI_sf$location))
PHI_sf <- PHI_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))
PHI <- SEA %>% filter(Country=="Philippines")

ethnic_PHI <- PHI[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_PHI <- ethnic_PHI %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_PHI <- gather(ethnic_PHI, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_PHI <- ethnic_PHI %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_PHI <- dat_ethnic_PHI[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_PHI1 <- dat_ethnic_PHI[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_PHI <- dat_ethnic_PHI %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

ethnicity_PHI <- dat_ethnic_PHI %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_PHI_sf <- merge(ethnicity_PHI, PHI_sf, by=c("location"))
ethnicity_PHI_plot <- ethnicity_PHI_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
PHI_sf <- st_as_sf(PHI_sf)

# Check for empty geometries
PHI_sf <- PHI_sf[!st_is_empty(PHI_sf), ]

locations <- PHI_sf
locations_coords <- st_coordinates(st_centroid(PHI_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_PHI$location %in% locations$location)

dat2 <- dat_ethnic_PHI %>% filter(!location %in% locations$location)

res <- ethnicity_PHI %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

g_phi <- ggplot() + geom_sf(data=PHI_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_PHI_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_PHI_plot, mapping=aes(label = location), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.4), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow = 4, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Philippines")

g_phi

ggsave(filename = file.path("figures", "Haplo_location_Philippines_new.png"), width = 18, height = 28)

ethnicity_PHI_plot_max <- ethnicity_PHI_plot %>% group_by(ethnicity) %>% slice(1)
ethnicity_PHI_max <- ethnicity_PHI_plot_max %>% st_drop_geometry() %>% select(ethnicity, haplo1_max) %>% rename(Ethnicity=ethnicity, `Dominant Haplogroup`=haplo1_max) %>% setDT()

e_phi <- ggplot() + geom_sf(data=PHI_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_PHI_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_PHI_plot, mapping=aes(label = ethnicity), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.4), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  annotate(geom = "table", x = 130, y = 20, label = list(ethnicity_PHI_max), size = 6.5) +
  guides(fill=guide_legend(nrow = 4, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Philippines")

e_phi

ggsave(filename = file.path("figures", "Haplo_ethnic_Philippines_new.png"), width = 18, height = 28)

## Thailand

# SEA1_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1_sf, file = "data/SEA1_sf.RData")

# SEA1p_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, china_CHN1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, taiwan_TWN1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1p_sf, file = "data/SEA1p_sf.RData")

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")
THA_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% dplyr::filter(country=="Thailand")
THA_sf$location <- stri_trans_general(THA_sf$location, "Latin-ASCII")
THA_sf$location <- trimws(gsub("\\s+", " ", THA_sf$location))
THA_sf <- THA_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))
THA <- SEA %>% filter(Country=="Thailand")

ethnic_THA <- THA[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_THA <- ethnic_THA %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_THA <- gather(ethnic_THA, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_THA <- ethnic_THA %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_THA <- dat_ethnic_THA[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_THA1 <- dat_ethnic_THA[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_THA <- dat_ethnic_THA %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

ethnicity_THA <- dat_ethnic_THA %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_THA_sf <- merge(ethnicity_THA, THA_sf, by=c("location"))
ethnicity_THA_plot <- ethnicity_THA_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
THA_sf <- st_as_sf(THA_sf)

# Check for empty geometries
THA_sf <- THA_sf[!st_is_empty(THA_sf), ]

locations <- THA_sf
locations_coords <- st_coordinates(st_centroid(THA_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_THA$location %in% locations$location)

dat2 <- dat_ethnic_THA %>% filter(!location %in% locations$location)

res <- ethnicity_THA %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

g_tha <- ggplot() + geom_sf(data=THA_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_THA_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_THA_plot, mapping=aes(label = location), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.4), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow = 15, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=20), 
        axis.text.y = element_text(size=20), 
        legend.text=element_text(size=20), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Thailand")

g_tha

ggsave(filename = file.path("figures", "Haplo_location_Thailand_new.png"), width = 16, height = 34)

ethnicity_THA_plot_max <- ethnicity_THA_plot %>% group_by(ethnicity) %>% slice(1)
ethnicity_THA_max <- ethnicity_THA_plot_max %>% st_drop_geometry() %>% select(ethnicity, haplo1_max) %>% rename(Ethnicity=ethnicity, `Dominant Haplogroup`=haplo1_max) %>% setDT()

e_tha <- ggplot() + geom_sf(data=THA_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_THA_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_THA_plot, mapping=aes(label = ethnicity), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.4), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  annotate(geom = "table", x = 106.5, y = 7, label = list(ethnicity_THA_max), size = 6) +
  guides(fill=guide_legend(nrow = 15, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=20), 
        axis.text.y = element_text(size=20), 
        legend.text=element_text(size=20), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Thailand")

e_tha

ggsave(filename = file.path("figures", "Haplo_ethnic_Thailand_new.png"), width = 18, height = 34)

## Taiwan

# SEA1_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1_sf, file = "data/SEA1_sf.RData")

# SEA1p_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, china_CHN1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, taiwan_TWN1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1p_sf, file = "data/SEA1p_sf.RData")

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")
TAI_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% dplyr::filter(country=="Taiwan")
TAI_sf$location <- stri_trans_general(TAI_sf$location, "Latin-ASCII")
TAI_sf$location <- trimws(gsub("\\s+", " ", TAI_sf$location))
TAI_sf <- TAI_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))
TAI <- SEA %>% filter(Country=="Thailand")

ethnic_TAI <- TAI[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_TAI <- ethnic_TAI %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_TAI <- gather(ethnic_TAI, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_TAI <- ethnic_TAI %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_TAI <- dat_ethnic_TAI[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_TAI1 <- dat_ethnic_TAI[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_TAI <- dat_ethnic_TAI %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

ethnicity_TAI <- dat_ethnic_TAI %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_TAI_sf <- merge(ethnicity_TAI, TAI_sf, by=c("location"))
ethnicity_TAI_plot <- ethnicity_TAI_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
TAI_sf <- st_as_sf(TAI_sf)

# Check for empty geometries
TAI_sf <- TAI_sf[!st_is_empty(TAI_sf), ]

locations <- TAI_sf
locations_coords <- st_coordinates(st_centroid(TAI_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_TAI$location %in% locations$location)

dat2 <- dat_ethnic_TAI %>% filter(!location %in% locations$location)

res <- ethnicity_TAI %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

g_tai <- ggplot() + geom_sf(data=TAI_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_TAI_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_TAI_plot, mapping=aes(label = location), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.4), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow = 1, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Taiwan")

g_tai

ggsave(filename = file.path("figures", "Haplo_location_Taiwan_new.png"), width = 18, height = 20)

ethnicity_TAI_plot_max <- ethnicity_TAI_plot %>% group_by(ethnicity) %>% slice(1)
ethnicity_TAI_max <- ethnicity_TAI_plot_max %>% st_drop_geometry() %>% select(ethnicity, haplo1_max) %>% rename(Ethnicity=ethnicity, `Dominant Haplogroup`=haplo1_max) %>% setDT()

e_tai <- ggplot() + geom_sf(data=TAI_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_TAI_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_TAI_plot, mapping=aes(label = ethnicity), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.4), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  annotate(geom = "table", x = 118, y = 22, label = list(ethnicity_TAI_max), size = 8) +
  guides(fill=guide_legend(nrow = 1, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Taiwan")

e_tai

ggsave(filename = file.path("figures", "Haplo_ethnic_Taiwan_new.png"), width = 18, height = 20)

## Timor-Leste

# SEA1_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1_sf, file = "data/SEA1_sf.RData")

# SEA1p_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, china_CHN1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, taiwan_TWN1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1p_sf, file = "data/SEA1p_sf.RData")

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")
TIM_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% dplyr::filter(country=="Timor-Leste")
TIM_sf$location <- stri_trans_general(TIM_sf$location, "Latin-ASCII")
TIM_sf$location <- trimws(gsub("\\s+", " ", TIM_sf$location))
TIM_sf <- TIM_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))
TIM <- SEA %>% filter(Country=="Timor-Leste")

ethnic_TIM <- TIM[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_TIM <- ethnic_TIM %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_TIM <- gather(ethnic_TIM, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_TIM <- ethnic_TIM %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_TIM <- dat_ethnic_TIM[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_TIM1 <- dat_ethnic_TIM[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_TIM <- dat_ethnic_TIM %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

ethnicity_TIM <- dat_ethnic_TIM %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_TIM_sf <- merge(ethnicity_TIM, TIM_sf, by=c("location"))
ethnicity_TIM_plot <- ethnicity_TIM_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
TIM_sf <- st_as_sf(TIM_sf)

# Check for empty geometries
TIM_sf <- TIM_sf[!st_is_empty(TIM_sf), ]

locations <- TIM_sf
locations_coords <- st_coordinates(st_centroid(TIM_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_TIM$location %in% locations$location)

dat2 <- dat_ethnic_TIM %>% filter(!location %in% locations$location)

res <- ethnicity_TIM %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

g_tim <- ggplot() + geom_sf(data=TIM_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_TIM_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_TIM_plot, mapping=aes(label = location), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.1), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow = 1, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Timor-Leste")

g_tim

ggsave(filename = file.path("figures", "Haplo_location_Timor-Leste_new.png"), width = 30, height = 15)

ethnicity_TIM_plot_max <- ethnicity_TIM_plot %>% group_by(ethnicity) %>% slice(1)
ethnicity_TIM_max <- ethnicity_TIM_plot_max %>% st_drop_geometry() %>% select(ethnicity, haplo1_max) %>% rename(Ethnicity=ethnicity, `Dominant Haplogroup`=haplo1_max) %>% setDT()

e_tim <- ggplot() + geom_sf(data=TIM_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_TIM_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_TIM_plot, mapping=aes(label = ethnicity), size=10, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.1), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  annotate(geom = "table", x = 124, y = -8.6, label = list(ethnicity_TIM_max), size = 6) +
  guides(fill=guide_legend(nrow = 1, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Timor-Leste")

e_tim

ggsave(filename = file.path("figures", "Haplo_ethnic_Timor-Leste_new.png"), width = 30, height = 15)

## Vietnam

# SEA1_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1_sf, file = "data/SEA1_sf.RData")

# SEA1p_sf <- rbind(brunei_BRN1_sf, indonesia_IDN1_sf, cambodia_KHM1_sf, china_CHN1_sf, laos_LAO1_sf, myanmar_MMR1_sf, malaysia_MYS1_sf, philippines_PHL1_sf, singapore_SGP1_sf,
#                  thailand_THA1_sf, taiwan_TWN1_sf, easttimor_TLS1_sf, vietnam_VNM1_sf)
# 
# save(SEA1p_sf, file = "data/SEA1p_sf.RData")

# load("data/SEA1_sf.RData")
load("data/SEA1p_sf.RData")
VN_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% dplyr::filter(country=="Vietnam")
VN_sf$location <- stri_trans_general(VN_sf$location, "Latin-ASCII")
VN_sf$location <- trimws(gsub("\\s+", " ", VN_sf$location))
VN_sf <- VN_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))
VN <- SEA %>% filter(Country=="Vietnam")

ethnic_VN <- VN[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_VN <- ethnic_VN %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_VN <- gather(ethnic_VN, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_VN <- ethnic_VN %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_VN <- dat_ethnic_VN[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_VN1 <- dat_ethnic_VN[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_VN <- dat_ethnic_VN %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

ethnicity_VN <- dat_ethnic_VN %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_VN_sf <- merge(ethnicity_VN, VN_sf, by=c("location"))
ethnicity_VN_plot <- ethnicity_VN_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
VN_sf <- st_as_sf(VN_sf)

# Check for empty geometries
VN_sf <- VN_sf[!st_is_empty(VN_sf), ]

locations <- VN_sf
locations_coords <- st_coordinates(st_centroid(VN_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_VN$location %in% locations$location)

dat2 <- dat_ethnic_VN %>% filter(!location %in% locations$location)

res <- ethnicity_VN %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

g_vn <- ggplot() + geom_sf(data=VN_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_VN_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_VN_plot, mapping=aes(label = location), size=9, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.5), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow = 9, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=20), 
        axis.text.y = element_text(size=20), 
        legend.text=element_text(size=20), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Vietnam")

g_vn

ggsave(filename = file.path("figures", "Haplo_location_Vietnam_new.png"), width = 14, height = 30)

g_vn2 <- ggplot() + geom_sf(data=VN_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_VN_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_VN_plot, mapping=aes(label = location), stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.4), data=dt_x, cols = colnames(dt_x)[1:218], color=NA, alpha=0.5) +
  guides(fill=guide_legend(nrow = 6, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=20, face = "bold"),
        text = element_text(size=12), 
        axis.text.x = element_text(size=10), 
        axis.text.y = element_text(size=10), 
        legend.text=element_text(size=10), 
        legend.key.size = unit(0.5, "cm"),
        legend.position = "bottom") +
  ggtitle("Vietnam")

g_vn2

ggsave(filename = file.path("figures", "Haplo_location_Vietnam2.png"), width = 10, height = 15)


library(ggpmisc)
library(scatterpie)

ethnicity_VN_plot_max <- ethnicity_VN_plot %>% group_by(ethnicity) %>% slice(1)
ethnicity_VN_max <- ethnicity_VN_plot_max %>% st_drop_geometry() %>% select(ethnicity, haplo1_max) %>% rename(Ethnicity=ethnicity, `Dominant Haplogroup`=haplo1_max) %>% setDT()

e_vn <- ggplot() + geom_sf(data=VN_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_VN_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  geom_sf_text(data=ethnicity_VN_plot, mapping=aes(label = ethnicity), size=8, stat = "sf_coordinates", hjust=0.5, vjust=0.5, check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.5), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  annotate(geom = "table", x = 106, y = 17, label = list(ethnicity_VN_max), size = 5) +
  guides(fill=guide_legend(nrow = 9, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(plot.title = element_text(size=40, face = "bold"),
        text = element_text(size=24), 
        axis.text.x = element_text(size=20), 
        axis.text.y = element_text(size=20), 
        legend.text=element_text(size=20), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom") +
  ggtitle("Vietnam")

e_vn

ggsave(filename = file.path("figures", "Haplo_ethnic_Vietnam_new.png"), width = 14, height = 30)  


################ SUBCLADES #######################

dat1 <- dat %>% mutate(haplogroup4 = str_extract(haplo, "^([A-Z])\\d\\w"),
                       haplogroup4 = ifelse(is.na(haplogroup4), haplogroup3, haplogroup4))
hap_present_SEA <- dat1[, .N, by = .(haplogroup4)] %>% arrange(desc(N))
hap_precountry_SEA <- dat1[, .N, by = .(country, haplogroup4)] %>% arrange(desc(N))

# Haplogroup F1f

hap_F1f <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="F1", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "F1f")
nbin_F1f <- nbin[labels(nbin) %in% hap_F1f$name]
class(nbin_F1f)
dnbin_F1f<-dist.dna(nbin_F1f, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_F1f<-nj(dnbin_F1f)
library(ggtree)
ggt_F1f<-ggtree::ggtree(tree_F1f, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 2)
ggt_F1f

library(treeio)
png("figures/Viet_Indo_F1f.png", width = 1200, height = 1600)
zoom(tree_F1f, grep("Vietnam|Indonesia", tree_F1f$tip.label, value = TRUE))
dev.off()
png("figures/Viet_Thai_F1f.png", width = 1200, height = 1600)
zoom(tree_F1f, grep("Vietnam|Thailand", tree_F1f$tip.label, value = TRUE))
dev.off()

# Haplogroup F1a
hap_F1a <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="F1", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "F1a")
nbin_F1a <- nbin[labels(nbin) %in% hap_F1a$name]
class(nbin_F1a)
dnbin_F1a<-dist.dna(nbin_F1a, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_F1a<-nj(dnbin_F1a)
library(ggtree)
ggt_F1a<-ggtree::ggtree(tree_F1a, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 2)
ggt_F1a

library(treeio)
png("figures/Viet_Indo_F1a.png", width = 1200, height = 1600)
zoom(tree_F1a, grep("Vietnam|Indonesia", tree_F1a$tip.label, value = TRUE))
dev.off()
png("figures/Viet_Thai_F1a.png", width = 1200, height = 1600)
zoom(tree_F1a, grep("Vietnam|Thailand", tree_F1a$tip.label, value = TRUE))
dev.off()

F1a <- file[hap_F1a$name]
writeXStringSet(F1a, "data/F1a.fasta")

# cat(file="data/F1a.fasta", paste(paste0(">",names(nbin_F1a)),
#                                  sapply(nbin_F1a, paste, collapse=""), sep="\n"), sep="\n")

# Haplogroup B5a

hap_B5a <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="B5", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "B5a")

B5a <- file[hap_B5a$name]
writeXStringSet(B5a, "data/B5a.fasta")

# Haplogroup M7b
hap_M7b <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="M7", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "M7b")

M7b <- file[hap_M7b$name]
writeXStringSet(M7b, "data/M7b.fasta")

hap_M7b1a1 <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="M7", str_extract(haplo, "^([A-Z])\\d\\w\\d\\w\\d"), haplogroup3)) %>%
  filter(haplogroup4 == "M7b1a1")

M7b1a1 <- file[hap_M7b1a1$name]
writeXStringSet(M7b1a1, "data/M7b1a1.fasta")

# Haplogroup B4a

hap_B4a <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="B4", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "B4a")

B4a <- file[hap_B4a$name]
writeXStringSet(B4a, "data/B4a.fasta")

# Haplogroup M7c
hap_M7c <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="M7", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "M7c")

M7c <- file[hap_M7c$name]
writeXStringSet(M7c, "data/M7c.fasta")

# Haplogroup B4c

hap_B4c <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="B4", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "B4c")

B4c <- file[hap_B4c$name]
writeXStringSet(B4c, "data/B4c.fasta")

# Haplogroup F1f
hap_F1f <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="F1", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "F1f")

F1f <- file[hap_F1f$name]
writeXStringSet(F1f, "data/F1f.fasta")

# Haplogroup N9a
hap_N9a <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="N9", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "N9a")

N9a <- file[hap_N9a$name]
writeXStringSet(N9a, "data/N9a.fasta")

# Haplogroup R9b
hap_R9b <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="R9", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "R9b")

R9b <- file[hap_R9b$name]
writeXStringSet(R9b, "data/R9b.fasta")

# Haplogroup M74
hap_M74 <- dat %>%filter(haplogroup3 == "M74")

M74 <- file[hap_M74$name]
writeXStringSet(M74, "data/M74.fasta")

# Haplogroup C7a
hap_C7a <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="C7", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "C7a")

C7a <- file[hap_C7a$name]
writeXStringSet(C7a, "data/C7a.fasta")

################ SUBCLADE DISTRIBUTION ##########################

library(readxl)
library(dplyr)
library(sf)
library(spatstat)
library(sp)
# library(maptools)
# library(raster)
library(cartography)
library(SpatialPosition)
library(potential)
# remotes::install_github("riatelab/SpatialPosition")
# remotes::install_github("riatelab/potential")
# library(tanaka)

dat <- read_excel("CompleteFull.xlsx")
dat_f <- dat %>% mutate(count=1) %>% setDF()

load("data/SEA1p_sf.RData")
SEA1_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% 
  dplyr::filter(country %in% c("Brunei", "Cambodia", "Indonesia", "Laos", "Malaysia", "Myanmar", "Philippines", "Singapore", "Taiwan", "Thailand", "Timor-Leste", "Vietnam") | (country=="China" & location %in% c("Yunnan", "Guangxi", "Guangdong", "Hainan", "Fujian", "Guizhou", "Hunan", "Jiangxi"))) %>%
  mutate(country=ifelse(country=="China", "Myanmar", country))
SEA1_sf$location <- stri_trans_general(SEA1_sf$location, "Latin-ASCII")
SEA1_sf$location <- trimws(gsub("\\s+", " ", SEA1_sf$location))
SEA1_sf <- SEA1_sf %>% dplyr::select(country, location, type, geometry)

# Process the data
dat_f2 <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location))

dat_sf <- merge(dat_f2, SEA1_sf, by = c("location"))

# Haplogroup F

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup F1
prop.F <- (sum(dat_f$haplogroup1 == "F" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
F <- dat_f %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup1 == "F", str_extract(haplo, "^([A-Z])"), haplogroup1)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "F" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "F") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
F <- F %>%
  mutate(prop.F = prop.F)

# Ensure columns have the correct data types
F_sf <- merge(F, SEA1_sf, by = c("location"))
F_sf$prop.pop <- as.numeric(F_sf$prop.pop)
F_sf$prop.F <- as.numeric(F_sf$prop.F)

# Convert to sf object
F_plot <- F_sf %>% select(prop.pop, prop.F, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(F_plot$prop.pop)) || any(is.null(F_plot$prop.F))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = F_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(F_plot$prop.F[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup F")

ggsave(filename = file.path("figures", "F-PerPop-location.png"), width = 49, height = 33)

# Contour

F_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup1 == "F", str_extract(haplo, "^([A-Z])"), haplogroup1)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "F" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "F" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.F <- (sum(dat_sf$haplogroup1 == "F" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

F_sf <- F_sf %>% mutate(prop.F = prop.F) %>% filter(haplogroup1=="F")

F_f <- F_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
F_f <- sf::st_transform(F_f, 2154)
F_plot <- F_sf %>% select(prop.pop, prop.F, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
F_sf2 <- F_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
F_sf2 <- sf::st_transform(F_sf2, 2154)
F_sp <- as(F_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
poppot <- stewart(knownpts = F_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 50000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = F_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
happot <- stewart(knownpts = F_sp, 
                   varname = "ind", 
                   typefct = "exponential", 
                   span = 50000, 
                   beta = 2, 
                   resolution = 50000, 
                   mask = F_sp, 
                   returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(F_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = F_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(F_plot$prop.F[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup F") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "F-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

F_plot <- F_sf %>% dplyr::select(prop.pop, prop.F, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
F.ok <- gstat::krige(prop.pop ~ 1, F_plot, SEA1_sf)
# Convert the result back to sf object
FKrige_sf <- st_as_sf(F.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = FKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(F_plot$prop.F[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup F")

ggsave(filename = file.path("figures", "F-Kriging.png"), width = 42, height = 33)

F.ak <- autoKrige(prop.pop ~ 1, F_plot, SEA1_sf)

# auto kriging
F_plot <- F_plot[!duplicated(st_geometry(F_plot)), ]
F_plot_utm <- st_transform(F_plot, crs = 2154)  # Using UTM zone 33N as an example
SEA1_sf_utm <- st_transform(SEA1_sf, crs = 2154)

# Convert to SpatialPointsDataFrame
F_sp <- as(F_plot_utm, "Spatial")
SEA1_sp <- as(SEA1_sf_utm, "Spatial")

# Ensure there are no missing values in prop.pop
F_sp <- F_sp[!is.na(F_sp@data$prop.pop), ]

# Define a custom variogram model
variogram_model <- vgm(psill = 1, model = "Sph", range = 100000, nugget = 0.1)

# Fit the variogram model
kriging_model <- gstat::gstat(formula = prop.pop ~ 1, locations = F_sp, model = variogram_model)

# Perform kriging using the custom model
F.ak <- predict(kriging_model, newdata = SEA1_sp)

# Convert kriging results to sf for plotting
FAKrige_sf <- st_as_sf(F.ak)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = FAKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(F_plot$prop.F[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup F")

ggsave(filename = file.path("figures", "F-AutoKriging.png"), width = 42, height = 33)

# Haplogroup F1

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup F1
prop.F1 <- (sum(dat_f$haplogroup2 == "F1" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
F1 <- dat_f %>% rename(location=Location, ethnicity=Ethnicity)  %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup2 == "F1", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "F1" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "F1") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
F1 <- F1 %>%
  mutate(prop.F1 = prop.F1)

# Ensure columns have the correct data types
F1_sf <- merge(F1, SEA1_sf, by = c("location"))
F1_sf$prop.pop <- as.numeric(F1_sf$prop.pop)
F1_sf$prop.F1 <- as.numeric(F1_sf$prop.F1)

# Convert to sf object
F1_plot <- F1_sf %>% select(prop.pop, prop.F1, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(F1_plot$prop.pop)) || any(is.null(F1_plot$prop.F1))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = F1_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(F1_plot$prop.F1[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup F1")

ggsave(filename = file.path("figures", "F1-PerPop-location.png"), width = 49, height = 33)

# Contour

F1_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup2 == "F1", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "F1" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "F1" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.F1 <- (sum(dat_sf$haplogroup2 == "F1" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

F1_sf <- F1_sf %>% mutate(prop.F1 = prop.F1) %>% filter(haplogroup2=="F1")

F1_f <- F1_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
F1_f <- sf::st_transform(F1_f, 2154)
F1_plot <- F1_sf %>% select(prop.pop, prop.F1, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
F1_sf2 <- F1_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
F1_sf2 <- sf::st_transform(F1_sf2, 2154)
F1_sp <- as(F1_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
poppot <- stewart(knownpts = F1_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 50000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = F1_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
happot <- stewart(knownpts = F1_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 50000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = F1_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(F1_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = F1_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(F1_plot$prop.F1[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup F1") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "F1-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

F1_plot <- F1_sf %>% dplyr::select(prop.pop, prop.F1, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
F1.ok <- gstat::krige(prop.pop ~ 1, F1_plot, SEA1_sf)

# Convert the result back to sf object
F1Krige_sf <- st_as_sf(F1.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = F1Krige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(F1_plot$prop.F1[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup F1")

ggsave(filename = file.path("figures", "F1-Kriging.png"), width = 42, height = 33)

# Haplogroup F1a

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup F1a
prop.F1a <- (sum(dat_f$haplogroup3 == "F1a" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
F1a <- dat_f %>% rename(location=Location, ethnicity=Ethnicity)  %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup3 == "F1a", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "F1a" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "F1a") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
F1a <- F1a %>%
  mutate(prop.F1a = prop.F1a)

# Ensure columns have the correct data types
F1a_sf <- merge(F1a, SEA1_sf, by = c("location"))
F1a_sf$prop.pop <- as.numeric(F1a_sf$prop.pop)
F1a_sf$prop.F1a <- as.numeric(F1a_sf$prop.F1a)

# Convert to sf object
F1a_plot <- F1a_sf %>% dplyr::select(prop.pop, prop.F1a, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(F1a_plot$prop.pop)) || any(is.null(F1a_plot$prop.F1a))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = F1a_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(F1a_plot$prop.F1a[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup F1a")

ggsave(filename = file.path("figures", "F1a-PerPop-location.png"), width = 42, height = 33)

# Contour

F1a_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup3 == "F1a", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "F1a" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "F1a" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.F1a <- (sum(dat_sf$haplogroup3 == "F1a" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

F1a_sf <- F1a_sf %>% mutate(prop.F1a = prop.F1a) %>% filter(haplogroup3=="F1a")

F1a_f <- F1a_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
F1a_f <- sf::st_transform(F1a_f, 2154)
F1a_plot <- F1a_sf %>% select(prop.pop, prop.F1a, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
F1a_sf2 <- F1a_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
F1a_sf2 <- sf::st_transform(F1a_sf2, 2154)
F1a_sp <- as(F1a_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
poppot <- stewart(knownpts = F1a_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 10000, 
                  beta = 3, 
                  resolution = 50000, 
                  mask = F1a_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
happot <- stewart(knownpts = F1a_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 10000, 
                  beta = 3, 
                  resolution = 50000, 
                  mask = F1a_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(F1a_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = F1a_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(F1a_plot$prop.F1a[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup F1a") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "F1a-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

F1a_plot <- F1a_sf %>% dplyr::select(prop.pop, prop.F1a, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
F1a.ok <- gstat::krige(prop.pop ~ 1, F1a_plot, SEA1_sf)

# Convert the result back to sf object
F1aKrige_sf <- st_as_sf(F1a.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = F1aKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(F1a_plot$prop.F1a[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup F1a")

ggsave(filename = file.path("figures", "F1a-Kriging.png"), width = 42, height = 33)

# Haplogroup F1f

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup F1a
prop.F1f <- (sum(dat_f$haplogroup3 == "F1f" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
F1f <- dat_f %>% rename(location=Location, ethnicity=Ethnicity)  %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup3 == "F1f", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "F1f" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "F1f") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
F1f <- F1f %>%
  mutate(prop.F1f = prop.F1f)

# Ensure columns have the correct data types
F1f_sf <- merge(F1f, SEA1_sf, by = c("location"))
F1f_sf$prop.pop <- as.numeric(F1f_sf$prop.pop)
F1f_sf$prop.F1f <- as.numeric(F1f_sf$prop.F1f)

# Convert to sf object
F1f_plot <- F1f_sf %>% dplyr::select(prop.pop, prop.F1f, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(F1f_plot$prop.pop)) || any(is.null(F1f_plot$prop.F1f))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = F1f_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(F1f_plot$prop.F1f[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup F1f")

ggsave(filename = file.path("figures", "F1f-PerPop-location.png"), width = 42, height = 33)

# Contour

F1f_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup3 == "F1f", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "F1f" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "F1f" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.F1f <- (sum(dat_sf$haplogroup3 == "F1f" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

F1f_sf <- F1f_sf %>% mutate(prop.F1f = prop.F1f) %>% filter(haplogroup3=="F1f")

F1f_f <- F1f_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
F1f_f <- sf::st_transform(F1f_f, 2154)
F1f_plot <- F1f_sf %>% select(prop.pop, prop.F1f, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
F1f_sf2 <- F1f_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
F1f_sf2 <- sf::st_transform(F1f_sf2, 2154)
F1f_sp <- as(F1f_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
poppot <- stewart(knownpts = F1f_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 10000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = F1f_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
happot <- stewart(knownpts = F1f_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 10000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = F1f_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(F1f_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = F1f_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(F1f_plot$prop.F1f[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup F1f") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "F1f-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

F1f_plot <- F1f_sf %>% dplyr::select(prop.pop, prop.F1f, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
F1f.ok <- gstat::krige(prop.pop ~ 1, F1f_plot, SEA1_sf)

# Convert the result back to sf object
F1fKrige_sf <- st_as_sf(F1f.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = F1fKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(F1f_plot$prop.F1f[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup F1f")

ggsave(filename = file.path("figures", "F1f-Kriging.png"), width = 42, height = 33)

# Haplogroup M

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup M
prop.M <- (sum(dat_f$haplogroup1 == "M" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
M <- dat_f %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup1 == "M" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup1 == "M") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
M <- M %>%
  mutate(prop.M = prop.M)

# Ensure columns have the correct data types
M_sf <- merge(M, SEA1_sf, by = c("location"))
M_sf$prop.pop <- as.numeric(M_sf$prop.pop)
M_sf$prop.M <- as.numeric(M_sf$prop.M)

# Convert to sf object
M_plot <- M_sf %>% select(prop.pop, prop.M, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(M_plot$prop.pop)) || any(is.null(M_plot$prop.M))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = M_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(M_plot$prop.M[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup M")

ggsave(filename = file.path("figures", "M-PerPop-location.png"), width = 49, height = 33)

# Contour

M_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup1 == "M", str_extract(haplo, "^([A-Z])"), haplogroup1)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "M" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "M" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.M <- (sum(dat_sf$haplogroup1 == "M" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

M_sf <- M_sf %>% mutate(prop.M = prop.M) %>% filter(haplogroup1=="M")

M_f <- M_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
M_f <- sf::st_transform(M_f, 2154)
M_plot <- M_sf %>% select(prop.pop, prop.M, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
M_sf2 <- M_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
M_sf2 <- sf::st_transform(M_sf2, 2154)
M_sp <- as(M_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (75km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = M_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 75000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = M_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (75km span)
# function = exponential, beta = 2, span = 75 km
happot <- stewart(knownpts = M_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 75000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = M_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(M_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = M_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(M_plot$prop.M[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup M") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "M-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

M_plot <- M_sf %>% dplyr::select(prop.pop, prop.M, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
M.ok <- gstat::krige(prop.pop ~ 1, M_plot, SEA1_sf)

# Convert the result back to sf object
MKrige_sf <- st_as_sf(M.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = MKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(M_plot$prop.M[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup M")

ggsave(filename = file.path("figures", "M-Kriging.png"), width = 42, height = 33)

# Haplogroup M7

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup M7
prop.M7 <- (sum(dat_f$haplogroup2 == "M7" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
M7 <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup2 == "M7", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "M7" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "M7") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
M7 <- M7 %>%
  mutate(prop.M7 = prop.M7)

# Ensure columns have the correct data types
M7_sf <- merge(M7, SEA1_sf, by = c("location"))
M7_sf$prop.pop <- as.numeric(M7_sf$prop.pop)
M7_sf$prop.M7 <- as.numeric(M7_sf$prop.M7)

# Convert to sf object
M7_plot <- M7_sf %>% select(prop.pop, prop.M7, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(M7_plot$prop.pop)) || any(is.null(M7_plot$prop.M7))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = M7_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(M7_plot$prop.M7[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup M7")

ggsave(filename = file.path("figures", "M7-PerPop-location.png"), width = 49, height = 33)

# Contour

M7_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup2 == "M7", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "M7" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "M7" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.M7 <- (sum(dat_sf$haplogroup2 == "M7" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

M7_sf <- M7_sf %>% mutate(prop.M7 = prop.M7) %>% filter(haplogroup2=="M7")

M7_f <- M7_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
M7_f <- sf::st_transform(M7_f, 2154)
M7_plot <- M7_sf %>% select(prop.pop, prop.M7, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
M7_sf2 <- M7_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
M7_sf2 <- sf::st_transform(M7_sf2, 2154)
M7_sp <- as(M7_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
poppot <- stewart(knownpts = M7_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 75000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = M7_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
happot <- stewart(knownpts = M7_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 75000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = M7_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(M7_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = M7_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(M7_plot$prop.M7[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup M7") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "M7-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

M7_plot <- M7_sf %>% dplyr::select(prop.pop, prop.M7, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
M7.ok <- gstat::krige(prop.pop ~ 1, M7_plot, SEA1_sf)

# Convert the result back to sf object
M7Krige_sf <- st_as_sf(M7.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = M7Krige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(M7_plot$prop.M7[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup M7")

ggsave(filename = file.path("figures", "M7-Kriging.png"), width = 42, height = 33)

# Haplogroup M7b

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup M7b
prop.M7b <- (sum(dat_f$haplogroup3 == "M7b" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
M7b <- dat_f %>% rename(location=Location, ethnicity=Ethnicity)  %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup3 == "M7b", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "M7b" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "M7b") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
M7b <- M7b %>%
  mutate(prop.M7b = prop.M7b)

# Ensure columns have the correct data types
M7b_sf <- merge(M7b, SEA1_sf, by = c("location"))
M7b_sf$prop.pop <- as.numeric(M7b_sf$prop.pop)
M7b_sf$prop.M7b <- as.numeric(M7b_sf$prop.M7b)

# Convert to sf object
M7b_plot <- M7b_sf %>% dplyr::select(prop.pop, prop.M7b, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(M7b_plot$prop.pop)) || any(is.null(M7b_plot$prop.M7b))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = M7b_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(M7b_plot$prop.M7b[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup M7b")

ggsave(filename = file.path("figures", "M7b-PerPop-location.png"), width = 42, height = 33)

# Contour

M7b_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup3 == "M7b", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "M7b" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "M7b" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.M7b <- (sum(dat_sf$haplogroup3 == "M7b" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

M7b_sf <- M7b_sf %>% mutate(prop.M7b = prop.M7b) %>% filter(haplogroup3=="M7b")

M7b_f <- M7b_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
M7b_f <- sf::st_transform(M7b_f, 2154)
M7b_plot <- M7b_sf %>% select(prop.pop, prop.M7b, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
M7b_sf2 <- M7b_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
M7b_sf2 <- sf::st_transform(M7b_sf2, 2154)
M7b_sp <- as(M7b_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
poppot <- stewart(knownpts = M7b_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 75000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = M7b_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
happot <- stewart(knownpts = M7b_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 75000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = M7b_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(M7b_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = M7b_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(M7b_plot$prop.M7b[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup M7b") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "M7b-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

M7b_plot <- M7b_sf %>% dplyr::select(prop.pop, prop.M7b, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
M7b.ok <- gstat::krige(prop.pop ~ 1, M7b_plot, SEA1_sf)

# Convert the result back to sf object
M7bKrige_sf <- st_as_sf(M7b.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = M7bKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(M7b_plot$prop.M7b[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup M7b")

ggsave(filename = file.path("figures", "M7b-Kriging.png"), width = 42, height = 33)

# Haplogroup M7c

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup M7b
prop.M7c <- (sum(dat_f$haplogroup3 == "M7c" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
M7c <- dat_f %>% rename(location=Location, ethnicity=Ethnicity)  %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup3 == "M7c", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "M7c" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "M7c") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
M7c <- M7c %>%
  mutate(prop.M7c = prop.M7c)

# Ensure columns have the correct data types
M7c_sf <- merge(M7c, SEA1_sf, by = c("location"))
M7c_sf$prop.pop <- as.numeric(M7c_sf$prop.pop)
M7c_sf$prop.M7c <- as.numeric(M7c_sf$prop.M7c)

# Convert to sf object
M7c_plot <- M7c_sf %>% dplyr::select(prop.pop, prop.M7c, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(M7c_plot$prop.pop)) || any(is.null(M7c_plot$prop.M7c))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = M7c_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(M7c_plot$prop.M7c[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup M7c")

ggsave(filename = file.path("figures", "M7c-PerPop-location.png"), width = 42, height = 33)

# Contour

M7c_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup3 == "M7c", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "M7c" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "M7c" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.M7c <- (sum(dat_sf$haplogroup3 == "M7c" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

M7c_sf <- M7c_sf %>% mutate(prop.M7c = prop.M7c) %>% filter(haplogroup3=="M7c")

M7c_f <- M7c_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
M7c_f <- sf::st_transform(M7c_f, 2154)
M7c_plot <- M7c_sf %>% select(prop.pop, prop.M7c, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
M7c_sf2 <- M7c_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
M7c_sf2 <- sf::st_transform(M7c_sf2, 2154)
M7c_sp <- as(M7c_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
poppot <- stewart(knownpts = M7c_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 10000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = M7c_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 50 km
happot <- stewart(knownpts = M7c_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 10000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = M7c_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(M7c_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = M7c_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(M7c_plot$prop.M7c[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup M7c") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "M7c-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

M7c_plot <- M7c_sf %>% dplyr::select(prop.pop, prop.M7c, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
M7c.ok <- gstat::krige(prop.pop ~ 1, M7c_plot, SEA1_sf)

# Convert the result back to sf object
M7cKrige_sf <- st_as_sf(M7c.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = M7cKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(M7c_plot$prop.M7c[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup M7c")

ggsave(filename = file.path("figures", "M7c-Kriging.png"), width = 42, height = 33)

# Haplogroup B

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup M
prop.B <- (sum(dat_f$haplogroup1 == "B" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
B <- dat_f %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup1 == "B" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup1 == "B") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
B <- B %>%
  mutate(prop.B = prop.B)

# Ensure columns have the correct data types
B_sf <- merge(B, SEA1_sf, by = c("location"))
B_sf$prop.pop <- as.numeric(B_sf$prop.pop)
B_sf$prop.B <- as.numeric(B_sf$prop.B)

# Convert to sf object
B_plot <- B_sf %>% select(prop.pop, prop.B, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(B_plot$prop.pop)) || any(is.null(B_plot$prop.B))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B_plot$prop.B[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B")

ggsave(filename = file.path("figures", "B-PerPop-location.png"), width = 49, height = 33)

# Contour

B_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup1 == "B", str_extract(haplo, "^([A-Z])"), haplogroup1)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "B" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.B <- (sum(dat_sf$haplogroup1 == "B" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

B_sf <- B_sf %>% mutate(prop.B = prop.B) %>% filter(haplogroup1=="B")

B_f <- B_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B_f <- sf::st_transform(B_f, 2154)
B_plot <- B_sf %>% select(prop.pop, prop.B, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
B_sf2 <- B_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B_sf2 <- sf::st_transform(B_sf2, 2154)
B_sp <- as(B_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (75km span)
# function = exponential, beta = 2, span = 75 km
poppot <- stewart(knownpts = B_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 75000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (75km span)
# function = exponential, beta = 2, span = 75 km
happot <- stewart(knownpts = B_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 75000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(B_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = B_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(B_plot$prop.B[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup B") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "B-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

B_plot <- B_sf %>% dplyr::select(prop.pop, prop.B, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
B.ok <- gstat::krige(prop.pop ~ 1, B_plot, SEA1_sf)

# Convert the result back to sf object
BKrige_sf <- st_as_sf(B.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = BKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B_plot$prop.B[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B")

ggsave(filename = file.path("figures", "B-Kriging.png"), width = 42, height = 33)

# Haplogroup B4

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup B4
prop.B4 <- (sum(dat_f$haplogroup2 == "B4" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
B4 <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup2 == "B4", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B4" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "B4") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
B4 <- B4 %>%
  mutate(prop.B4 = prop.B4)

# Ensure columns have the correct data types
B4_sf <- merge(B4, SEA1_sf, by = c("location"))
B4_sf$prop.pop <- as.numeric(B4_sf$prop.pop)
B4_sf$prop.B4 <- as.numeric(B4_sf$prop.B4)

# Convert to sf object
B4_plot <- B4_sf %>% select(prop.pop, prop.B4, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(B4_plot$prop.pop)) || any(is.null(B4_plot$prop.B4))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B4_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B4_plot$prop.B4[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B4")

ggsave(filename = file.path("figures", "B4-PerPop-location.png"), width = 49, height = 33)

# Contour

B4_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup2 == "B4", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B4" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "B4" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.B4 <- (sum(dat_sf$haplogroup2 == "B4" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

B4_sf <- B4_sf %>% mutate(prop.B4 = prop.B4) %>% filter(haplogroup2=="B4")

B4_f <- B4_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B4_f <- sf::st_transform(B4_f, 2154)
B4_plot <- B4_sf %>% select(prop.pop, prop.B4, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
B4_sf2 <- B4_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B4_sf2 <- sf::st_transform(B4_sf2, 2154)
B4_sp <- as(B4_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 25 km
poppot <- stewart(knownpts = B4_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B4_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 25 km
happot <- stewart(knownpts = B4_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 20000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B4_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(B4_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = B4_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(B4_plot$prop.B4[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup B4") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "B4-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

B4_plot <- B4_sf %>% dplyr::select(prop.pop, prop.B4, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
B4.ok <- gstat::krige(prop.pop ~ 1, B4_plot, SEA1_sf)

# Convert the result back to sf object
B4Krige_sf <- st_as_sf(B4.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B4Krige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B4_plot$prop.B4[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B4")

ggsave(filename = file.path("figures", "B4-Kriging.png"), width = 42, height = 33)

# Haplogroup B4a

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup B4a
prop.B4a <- (sum(dat_f$haplogroup3 == "B4a" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
B4a <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup3 == "B4a", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B4a" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "B4a") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
B4a <- B4a %>%
  mutate(prop.B4a = prop.B4a)

# Ensure columns have the correct data types
B4a_sf <- merge(B4a, SEA1_sf, by = c("location"))
B4a_sf$prop.pop <- as.numeric(B4a_sf$prop.pop)
B4a_sf$prop.B4a <- as.numeric(B4a_sf$prop.B4a)

# Convert to sf object
B4a_plot <- B4a_sf %>% select(prop.pop, prop.B4a, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(B4a_plot$prop.pop)) || any(is.null(B4a_plot$prop.B4a))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B4a_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B4a_plot$prop.B4a[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B4a")

ggsave(filename = file.path("figures", "B4a-PerPop-location.png"), width = 42, height = 33)

# Contour

B4a_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup3 == "B4a", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B4a" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "B4a" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.B4a <- (sum(dat_sf$haplogroup3 == "B4a" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

B4a_sf <- B4a_sf %>% mutate(prop.B4a = prop.B4a) %>% filter(haplogroup3=="B4a")

B4a_f <- B4a_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B4a_f <- sf::st_transform(B4a_f, 2154)
B4a_plot <- B4a_sf %>% select(prop.pop, prop.B4a, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
B4a_sf2 <- B4a_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B4a_sf2 <- sf::st_transform(B4a_sf2, 2154)
B4a_sp <- as(B4a_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
poppot <- stewart(knownpts = B4a_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 25000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B4a_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
happot <- stewart(knownpts = B4a_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 25000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B4a_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(B4a_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = B4a_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(B4a_plot$prop.B4a[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup B4a") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "B4a-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

B4a_plot <- B4a_sf %>% dplyr::select(prop.pop, prop.B4a, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
B4a.ok <- gstat::krige(prop.pop ~ 1, B4a_plot, SEA1_sf)

# Convert the result back to sf object
B4aKrige_sf <- st_as_sf(B4a.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B4aKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B4a_plot$prop.B4a[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B4a")

ggsave(filename = file.path("figures", "B4a-Kriging.png"), width = 42, height = 33)

# Haplogroup B4b

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup B4b
prop.B4b <- (sum(dat_f$haplogroup3 == "B4b" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
B4b <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup3 == "B4b", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B4b" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "B4b") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
B4b <- B4b %>%
  mutate(prop.B4b = prop.B4b)

# Ensure columns have the correct data types
B4b_sf <- merge(B4b, SEA1_sf, by = c("location"))
B4b_sf$prop.pop <- as.numeric(B4b_sf$prop.pop)
B4b_sf$prop.B4b <- as.numeric(B4b_sf$prop.B4b)

# Convert to sf object
B4b_plot <- B4b_sf %>% select(prop.pop, prop.B4b, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(B4b_plot$prop.pop)) || any(is.null(B4b_plot$prop.B4b))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B4b_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B4b_plot$prop.B4b[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B4b")

ggsave(filename = file.path("figures", "B4b-PerPop-location.png"), width = 42, height = 33)

# Contour

B4b_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup3 == "B4b", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B4b" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "B4b" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.B4b <- (sum(dat_sf$haplogroup3 == "B4b" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

B4b_sf <- B4b_sf %>% mutate(prop.B4b = prop.B4b) %>% filter(haplogroup3=="B4b")

B4b_f <- B4b_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B4b_f <- sf::st_transform(B4b_f, 2154)
B4b_plot <- B4b_sf %>% select(prop.pop, prop.B4b, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
B4b_sf2 <- B4b_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B4b_sf2 <- sf::st_transform(B4b_sf2, 2154)
B4b_sp <- as(B4b_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
poppot <- stewart(knownpts = B4b_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B4b_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
happot <- stewart(knownpts = B4b_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B4b_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(B4b_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = B4b_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(B4b_plot$prop.B4b[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup B4b") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "B4b-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

B4b_plot <- B4b_sf %>% dplyr::select(prop.pop, prop.B4b, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
B4b.ok <- gstat::krige(prop.pop ~ 1, B4b_plot, SEA1_sf)

# Convert the result back to sf object
B4bKrige_sf <- st_as_sf(B4b.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B4bKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B4b_plot$prop.B4b[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B4b")

ggsave(filename = file.path("figures", "B4b-Kriging.png"), width = 42, height = 33)

# Haplogroup B4c

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup B4b
prop.B4c <- (sum(dat_f$haplogroup3 == "B4c" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
B4c <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup3 == "B4c", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B4c" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "B4c") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
B4c <- B4c %>%
  mutate(prop.B4c = prop.B4c)

# Ensure columns have the correct data types
B4c_sf <- merge(B4c, SEA1_sf, by = c("location"))
B4c_sf$prop.pop <- as.numeric(B4c_sf$prop.pop)
B4c_sf$prop.B4c <- as.numeric(B4c_sf$prop.B4c)

# Convert to sf object
B4c_plot <- B4c_sf %>% select(prop.pop, prop.B4c, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(B4c_plot$prop.pop)) || any(is.null(B4c_plot$prop.B4c))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B4c_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B4c_plot$prop.B4c[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B4c")

ggsave(filename = file.path("figures", "B4c-PerPop-location.png"), width = 42, height = 33)

# Contour

B4c_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup3 == "B4c", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B4c" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "B4c" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.B4c <- (sum(dat_sf$haplogroup3 == "B4c" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

B4c_sf <- B4c_sf %>% mutate(prop.B4c = prop.B4c) %>% filter(haplogroup3=="B4c")

B4c_f <- B4c_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B4c_f <- sf::st_transform(B4c_f, 2154)
B4c_plot <- B4c_sf %>% select(prop.pop, prop.B4c, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
B4c_sf2 <- B4c_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B4c_sf2 <- sf::st_transform(B4c_sf2, 2154)
B4c_sp <- as(B4c_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
poppot <- stewart(knownpts = B4c_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 10000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B4c_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
happot <- stewart(knownpts = B4c_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 10000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B4c_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(B4c_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = B4c_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(B4c_plot$prop.B4c[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup B4c") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "B4c-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

B4c_plot <- B4c_sf %>% dplyr::select(prop.pop, prop.B4c, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
B4c.ok <- gstat::krige(prop.pop ~ 1, B4c_plot, SEA1_sf)

# Convert the result back to sf object
B4cKrige_sf <- st_as_sf(B4c.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B4cKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B4c_plot$prop.B4c[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B4c")

ggsave(filename = file.path("figures", "B4c-Kriging.png"), width = 42, height = 33)


# Haplogroup B5

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup B5
prop.B5 <- (sum(dat_f$haplogroup2 == "B5" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
B5 <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup2 == "B5", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B5" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "B5") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
B5 <- B5 %>%
  mutate(prop.B5 = prop.B5)

# Ensure columns have the correct data types
B5_sf <- merge(B5, SEA1_sf, by = c("location"))
B5_sf$prop.pop <- as.numeric(B5_sf$prop.pop)
B5_sf$prop.M5 <- as.numeric(B5_sf$prop.B5)

# Convert to sf object
B5_plot <- B5_sf %>% select(prop.pop, prop.B5, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(B5_plot$prop.pop)) || any(is.null(B5_plot$prop.B5))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B5_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B5_plot$prop.B5[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B5")

ggsave(filename = file.path("figures", "B5-PerPop-location.png"), width = 49, height = 33)

# Contour

B5_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup2 == "B5", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B5" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "B5" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.B5 <- (sum(dat_sf$haplogroup2 == "B5" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

B5_sf <- B5_sf %>% mutate(prop.B5 = prop.B5) %>% filter(haplogroup2=="B5")

B5_f <- B5_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B5_f <- sf::st_transform(B5_f, 2154)
B5_plot <- B5_sf %>% select(prop.pop, prop.B5, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
B5_sf2 <- B5_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B5_sf2 <- sf::st_transform(B5_sf2, 2154)
B5_sp <- as(B5_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
poppot <- stewart(knownpts = B5_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B5_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
happot <- stewart(knownpts = B5_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B5_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(B5_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = B5_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(B5_plot$prop.B5[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup B5") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "B5-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

B5_plot <- B5_sf %>% dplyr::select(prop.pop, prop.B5, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
B5.ok <- gstat::krige(prop.pop ~ 1, B5_plot, SEA1_sf)

# Convert the result back to sf object
B5Krige_sf <- st_as_sf(B5.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B5Krige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B5_plot$prop.B5[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B5")

ggsave(filename = file.path("figures", "B5-Kriging.png"), width = 42, height = 33)

# Haplogroup B5a

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup B4a
prop.B5a <- (sum(dat_f$haplogroup3 == "B5a" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
B5a <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup3 == "B5a", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B5a" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "B5a") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
B5a <- B5a %>%
  mutate(prop.B5a = prop.B5a)

# Ensure columns have the correct data types
B5a_sf <- merge(B5a, SEA1_sf, by = c("location"))
B5a_sf$prop.pop <- as.numeric(B5a_sf$prop.pop)
B5a_sf$prop.B4a <- as.numeric(B5a_sf$prop.B5a)

# Convert to sf object
B5a_plot <- B5a_sf %>% select(prop.pop, prop.B5a, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(B5a_plot$prop.pop)) || any(is.null(B5a_plot$prop.B5a))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B5a_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B5a_plot$prop.B5a[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B5a")

ggsave(filename = file.path("figures", "B5a-PerPop-location.png"), width = 42, height = 33)

# Contour

B5a_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup3 == "B5a", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "B5a" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "B5a" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.B5a <- (sum(dat_sf$haplogroup3 == "B5a" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

B5a_sf <- B5a_sf %>% mutate(prop.B5a = prop.B5a) %>% filter(haplogroup3=="B5a")

B5a_f <- B5a_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B5a_f <- sf::st_transform(B5a_f, 2154)
B5a_plot <- B5a_sf %>% select(prop.pop, prop.B5a, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
B5a_sf2 <- B5a_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
B5a_sf2 <- sf::st_transform(B5a_sf2, 2154)
B5a_sp <- as(B5a_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
poppot <- stewart(knownpts = B5a_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 25000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B5a_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
happot <- stewart(knownpts = B5a_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 25000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = B5a_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(B5a_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = B5a_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(B5a_plot$prop.B5a[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup B5a") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "B5a-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

B5a_plot <- B5a_sf %>% dplyr::select(prop.pop, prop.B5a, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
B5a.ok <- gstat::krige(prop.pop ~ 1, B5a_plot, SEA1_sf)

# Convert the result back to sf object
B5aKrige_sf <- st_as_sf(B5a.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = B5aKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(B5a_plot$prop.B5a[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup B5a")

ggsave(filename = file.path("figures", "B5a-Kriging.png"), width = 42, height = 33)

# Haplogroup R9

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup R9
prop.R9 <- (sum(dat_f$haplogroup2 == "R9" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
R9 <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup2 == "R9", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "R9" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "R9") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
R9 <- R9 %>%
  mutate(prop.R9 = prop.R9)

# Ensure columns have the correct data types
R9_sf <- merge(R9, SEA1_sf, by = c("location"))
R9_sf$prop.pop <- as.numeric(R9_sf$prop.pop)
R9_sf$prop.R9 <- as.numeric(R9_sf$prop.R9)

# Convert to sf object
R9_plot <- R9_sf %>% select(prop.pop, prop.R9, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(R9_plot$prop.pop)) || any(is.null(R9_plot$prop.R9))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = R9_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(R9_plot$prop.R9[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup R9")

ggsave(filename = file.path("figures", "R9-PerPop-location.png"), width = 49, height = 33)

# Contour

R9_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup2 == "R9", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "R9" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "R9" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.R9 <- (sum(dat_sf$haplogroup2 == "R9" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

R9_sf <- R9_sf %>% mutate(prop.R9 = prop.R9) %>% filter(haplogroup2=="R9")

R9_f <- R9_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
R9_f <- sf::st_transform(R9_f, 2154)
R9_plot <- R9_sf %>% select(prop.pop, prop.R9, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
R9_sf2 <- R9_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
R9_sf2 <- sf::st_transform(R9_sf2, 2154)
R9_sp <- as(R9_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
poppot <- stewart(knownpts = R9_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = R9_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
happot <- stewart(knownpts = R9_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = R9_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(R9_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = R9_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(R9_plot$prop.R9[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup R9") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "R9-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

R9_plot <- R9_sf %>% dplyr::select(prop.pop, prop.R9, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
R9.ok <- gstat::krige(prop.pop ~ 1, R9_plot, SEA1_sf)

# Convert the result back to sf object
R9Krige_sf <- st_as_sf(R9.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = R9Krige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(R9_plot$prop.R9[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup R9")

ggsave(filename = file.path("figures", "R9-Kriging.png"), width = 42, height = 33)


# Haplogroup R9b

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup R9b
prop.R9b <- (sum(dat_f$haplogroup3 == "R9b" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
R9b <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup3 == "R9b", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "R9b" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "R9b") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
R9b <- R9b %>%
  mutate(prop.R9b = prop.R9b)

# Ensure columns have the correct data types
R9b_sf <- merge(R9b, SEA1_sf, by = c("location"))
R9b_sf$prop.pop <- as.numeric(R9b_sf$prop.pop)
R9b_sf$prop.R9b <- as.numeric(R9b_sf$prop.R9b)

# Convert to sf object
R9b_plot <- R9b_sf %>% select(prop.pop, prop.R9b, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(R9b_plot$prop.pop)) || any(is.null(R9b_plot$prop.R9b))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = R9b_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(R9b_plot$prop.R9b[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup R9b")

ggsave(filename = file.path("figures", "R9b-PerPop-location.png"), width = 42, height = 33)

# Contour

R9b_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup3 == "R9b", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "R9b" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "R9b" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.R9b <- (sum(dat_sf$haplogroup3 == "R9b" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

R9b_sf <- R9b_sf %>% mutate(prop.R9b = prop.R9b) %>% filter(haplogroup3=="R9b")

R9b_f <- R9b_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
R9b_f <- sf::st_transform(R9b_f, 2154)
R9b_plot <- R9b_sf %>% select(prop.pop, prop.R9b, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
R9b_sf2 <- R9b_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
R9b_sf2 <- sf::st_transform(R9b_sf2, 2154)
R9b_sp <- as(R9b_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
poppot <- stewart(knownpts = R9b_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = R9b_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
happot <- stewart(knownpts = R9b_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = R9b_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(R9b_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = R9b_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(R9b_plot$prop.R9b[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup R9b") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "R9b-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

R9b_plot <- R9b_sf %>% dplyr::select(prop.pop, prop.R9b, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
R9b.ok <- gstat::krige(prop.pop ~ 1, R9b_plot, SEA1_sf)

# Convert the result back to sf object
R9bKrige_sf <- st_as_sf(R9b.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = R9bKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(R9b_plot$prop.R9b[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup R9b")

ggsave(filename = file.path("figures", "R9b-Kriging.png"), width = 42, height = 33)

# Haplogroup N9

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup N9
prop.N9 <- (sum(dat_f$haplogroup2 == "N9" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
N9 <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup2 == "N9", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "N9" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "N9") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
N9 <- N9 %>%
  mutate(prop.N9 = prop.N9)

# Ensure columns have the correct data types
N9_sf <- merge(N9, SEA1_sf, by = c("location"))
N9_sf$prop.pop <- as.numeric(N9_sf$prop.pop)
N9_sf$prop.N9 <- as.numeric(N9_sf$prop.N9)

# Convert to sf object
N9_plot <- N9_sf %>% select(prop.pop, prop.N9, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(N9_plot$prop.pop)) || any(is.null(N9_plot$prop.N9))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = N9_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(N9_plot$prop.N9[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup N9")

ggsave(filename = file.path("figures", "N9-PerPop-location.png"), width = 42, height = 33)

# Contour

N9_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup2 == "N9", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "N9" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "N9" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.N9 <- (sum(dat_sf$haplogroup2 == "N9" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

N9_sf <- N9_sf %>% mutate(prop.N9 = prop.N9) %>% filter(haplogroup2=="N9")

N9_f <- N9_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
N9_f <- sf::st_transform(N9_f, 2154)
N9_plot <- N9_sf %>% select(prop.pop, prop.N9, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
N9_sf2 <- N9_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
N9_sf2 <- sf::st_transform(N9_sf2, 2154)
N9_sp <- as(N9_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
poppot <- stewart(knownpts = N9_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = N9_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
happot <- stewart(knownpts = N9_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = N9_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(N9_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = N9_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(N9_plot$prop.N9[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup N9") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "N9-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

N9_plot <- N9_sf %>% dplyr::select(prop.pop, prop.N9, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
N9.ok <- gstat::krige(prop.pop ~ 1, N9_plot, SEA1_sf)

# Convert the result back to sf object
N9Krige_sf <- st_as_sf(N9.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = N9Krige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(N9_plot$prop.N9[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup N9")

ggsave(filename = file.path("figures", "N9-Kriging.png"), width = 42, height = 33)

# Haplogroup N9a

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup N9a
prop.N9a <- (sum(dat_f$haplogroup3 == "N9a" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
N9a <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup3 == "N9a", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "N9a" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "N9a") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
N9a <- N9a %>%
  mutate(prop.N9a = prop.N9a)

# Ensure columns have the correct data types
N9a_sf <- merge(N9a, SEA1_sf, by = c("location"))
N9a_sf$prop.pop <- as.numeric(N9a_sf$prop.pop)
N9a_sf$prop.N9a <- as.numeric(N9a_sf$prop.N9a)

# Convert to sf object
N9a_plot <- N9a_sf %>% select(prop.pop, prop.N9a, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(N9a_plot$prop.pop)) || any(is.null(N9a_plot$prop.N9a))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = N9a_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(N9a_plot$prop.N9a[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup N9a")

ggsave(filename = file.path("figures", "N9a-PerPop-location.png"), width = 42, height = 33)

# Contour

N9a_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup3 == "N9a", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "N9a" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "N9a" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.N9a <- (sum(dat_sf$haplogroup3 == "N9a" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

N9a_sf <- N9a_sf %>% mutate(prop.N9a = prop.N9a) %>% filter(haplogroup3=="N9a")

N9a_f <- N9a_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
N9a_f <- sf::st_transform(N9a_f, 2154)
N9a_plot <- N9a_sf %>% select(prop.pop, prop.N9a, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
N9a_sf2 <- N9a_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
N9a_sf2 <- sf::st_transform(N9a_sf2, 2154)
N9a_sp <- as(N9a_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
poppot <- stewart(knownpts = N9a_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = N9a_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
happot <- stewart(knownpts = N9a_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = N9a_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(N9a_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = N9a_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(N9a_plot$prop.N9a[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup N9a") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "N9a-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

N9a_plot <- N9a_sf %>% dplyr::select(prop.pop, prop.N9a, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
N9a.ok <- gstat::krige(prop.pop ~ 1, N9a_plot, SEA1_sf)

# Convert the result back to sf object
N9aKrige_sf <- st_as_sf(N9a.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = N9aKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(N9a_plot$prop.N9a[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup N9a")

ggsave(filename = file.path("figures", "N9a-Kriging.png"), width = 42, height = 33)

# Haplogroup C7

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup N9
prop.C7 <- (sum(dat_f$haplogroup2 == "C7" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
C7 <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup2 == "C7", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "C7" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "C7") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
C7 <- C7 %>%
  mutate(prop.C7 = prop.C7)

# Ensure columns have the correct data types
C7_sf <- merge(C7, SEA1_sf, by = c("location"))
C7_sf$prop.pop <- as.numeric(C7_sf$prop.pop)
C7_sf$prop.C7 <- as.numeric(C7_sf$prop.C7)

# Convert to sf object
C7_plot <- C7_sf %>% select(prop.pop, prop.C7, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(C7_plot$prop.pop)) || any(is.null(C7_plot$prop.C7))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = C7_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(C7_plot$prop.C7[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup C7")

ggsave(filename = file.path("figures", "C7-PerPop-location.png"), width = 42, height = 33)

# Contour

C7_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup2 == "C7", str_extract(haplo, "^([A-Z])\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "C7" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "C7" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.C7 <- (sum(dat_sf$haplogroup2 == "C7" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

C7_sf <- C7_sf %>% mutate(prop.C7 = prop.C7) %>% filter(haplogroup2=="C7")

C7_f <- C7_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
C7_f <- sf::st_transform(C7_f, 2154)
C7_plot <- C7_sf %>% select(prop.pop, prop.C7, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
C7_sf2 <- C7_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
C7_sf2 <- sf::st_transform(C7_sf2, 2154)
C7_sp <- as(C7_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
poppot <- stewart(knownpts = C7_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = C7_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
happot <- stewart(knownpts = C7_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = C7_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(C7_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = C7_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(C7_plot$prop.C7[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup C7") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "C7-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

C7_plot <- C7_sf %>% dplyr::select(prop.pop, prop.C7, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
C7.ok <- gstat::krige(prop.pop ~ 1, C7_plot, SEA1_sf)

# Convert the result back to sf object
C7Krige_sf <- st_as_sf(C7.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = C7Krige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(C7_plot$prop.C7[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup C7")

ggsave(filename = file.path("figures", "C7-Kriging.png"), width = 42, height = 33)

# Haplogroup C7a

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup C7a
prop.C7a <- (sum(dat_f$haplogroup3 == "C7a" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
C7a <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup3 == "C7a", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "C7a" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "C7a") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
C7a <- C7a %>%
  mutate(prop.C7a = prop.C7a)

# Ensure columns have the correct data types
C7a_sf <- merge(C7a, SEA1_sf, by = c("location"))
C7a_sf$prop.pop <- as.numeric(C7a_sf$prop.pop)
C7a_sf$prop.C7a <- as.numeric(C7a_sf$prop.C7a)

# Convert to sf object
C7a_plot <- C7a_sf %>% select(prop.pop, prop.C7a, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(C7a_plot$prop.pop)) || any(is.null(C7a_plot$prop.C7a))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = C7a_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(C7a_plot$prop.C7a[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup C7a")

ggsave(filename = file.path("figures", "C7a-PerPop-location.png"), width = 42, height = 33)

# Contour

C7a_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup3 == "C7a", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "C7a" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "C7a" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.C7a <- (sum(dat_sf$haplogroup3 == "C7a" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

C7a_sf <- C7a_sf %>% mutate(prop.C7a = prop.C7a) %>% filter(haplogroup3=="C7a")

C7a_f <- C7a_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
C7a_f <- sf::st_transform(C7a_f, 2154)
C7a_plot <- C7a_sf %>% select(prop.pop, prop.C7a, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
C7a_sf2 <- C7a_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
C7a_sf2 <- sf::st_transform(C7a_sf2, 2154)
C7a_sp <- as(C7a_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
poppot <- stewart(knownpts = C7a_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = C7a_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
happot <- stewart(knownpts = C7a_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = C7a_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(C7a_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = C7a_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(C7a_plot$prop.C7a[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup C7a") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "C7a-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

C7a_plot <- C7a_sf %>% dplyr::select(prop.pop, prop.C7a, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
C7a.ok <- gstat::krige(prop.pop ~ 1, C7a_plot, SEA1_sf)

# Convert the result back to sf object
C7aKrige_sf <- st_as_sf(C7a.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = C7aKrige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(C7a_plot$prop.C7a[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup C7a")

ggsave(filename = file.path("figures", "C7a-Kriging.png"), width = 42, height = 33)

# Haplogroup M74

library(sf)
library(ggplot2)
library(data.table)
library(dplyr)

# Calculate the overall proportion of haplogroup M74
prop.M74 <- (sum(dat_f$haplogroup2 == "M74" & !is.na(dat_f$count), na.rm = TRUE) / sum(dat_f$count, na.rm = TRUE)) * 100

# Process the data
M74 <- dat_f  %>% rename(location=Location, ethnicity=Ethnicity) %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location)) %>%
  mutate(haplogroup4 = ifelse(haplogroup2 == "M74", str_extract(haplo, "^([A-Z])\\d\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "M74" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100) %>%
  ungroup() %>%
  filter(haplogroup4 == "M74") %>%
  group_by(location) %>%
  slice(1) %>% setDT()

# Add the overall proportion to the data
M74 <- M74 %>%
  mutate(prop.M74 = prop.M74)

# Ensure columns have the correct data types
M74_sf <- merge(M74, SEA1_sf, by = c("location"))
M74_sf$prop.pop <- as.numeric(M74_sf$prop.pop)
M74_sf$prop.M74 <- as.numeric(M74_sf$prop.M74)

# Convert to sf object
M74_plot <- M74_sf %>% select(prop.pop, prop.M74, geometry) %>% st_as_sf(crs = 4326)

# Check for NULL values
if (any(is.null(M74_plot$prop.pop)) || any(is.null(M74_plot$prop.M74))) {
  stop("There are NULL values in the data.")
}

# Plotting
ggplot() +
  geom_sf() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = M74_plot, aes(fill = prop.pop), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(M74_plot$prop.M74[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup M74")

ggsave(filename = file.path("figures", "M74-PerPop-location.png"), width = 42, height = 33)

# Contour

M74_sf <- dat_sf %>% mutate(haplogroup4 = ifelse(haplogroup2 == "M74", str_extract(haplo, "^([A-Z])\\d\\d"), haplogroup2)) %>%
  group_by(location) %>%
  mutate(prop.pop = (sum(haplogroup4 == "M74" & !is.na(count), na.rm = TRUE) / sum(count, na.rm = TRUE)) * 100,
         ind=sum(haplogroup4 == "M74" & !is.na(count), na.rm = TRUE),
         pop=sum(count, na.rm = TRUE)) %>%
  ungroup()

prop.M74 <- (sum(dat_sf$haplogroup2 == "M74" & !is.na(dat_sf$count), na.rm = TRUE) / sum(dat_sf$count, na.rm = TRUE)) * 100

M74_sf <- M74_sf %>% mutate(prop.M74 = prop.M74) %>% filter(haplogroup2=="M74")

M74_f <- M74_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
M74_f <- sf::st_transform(M74_f, 2154)
M74_plot <- M74_sf %>% select(prop.pop, prop.M74, geometry) %>% st_as_sf(crs = 4326)
# Convert to Spatial class
M74_sf2 <- M74_sf %>% select(location, ind, pop, prop.pop, geometry) %>% st_as_sf(crs = 4326)
M74_sf2 <- sf::st_transform(M74_sf2, 2154)
M74_sp <- as(M74_sf2, Class = "Spatial")

# Compute the potentials of population on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
poppot <- stewart(knownpts = M74_sp, 
                  varname = "pop", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = M74_sp, 
                  returnclass = "sf")

# Compute the potentials of haplogroup on a regular grid (50km span)
# function = exponential, beta = 2, span = 15 km
happot <- stewart(knownpts = M74_sp, 
                  varname = "ind", 
                  typefct = "exponential", 
                  span = 15000, 
                  beta = 2, 
                  resolution = 50000, 
                  mask = M74_sp, 
                  returnclass = "sf")


# Create the ratio variable
# Handle NaN
"/" <- function(x,y) ifelse(y==0,0,base:::"/"(x,y))
poppot$OUTPUT2 <- happot$OUTPUT * 100 / poppot$OUTPUT

# Discretize the variable
bv <- quantile(M74_sf$prop.pop, seq(from = 0, to = 1, length.out = 9))

# Create an isopleth layer
pot <- isopoly(x = poppot, var = "OUTPUT2",
               breaks = bv, 
               mask = M74_sp, 
               returnclass = "sf")

ggplot() + geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) + 
  geom_sf(data=pot, aes(fill=min), lwd=0) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(M74_plot$prop.M74[1],1), "% population", sep = "")) +
  ggtitle("Haplogroup M74") +
  coord_sf(crs = 4326)
ggsave(filename = file.path("figures", "M74-Contour.png"), width = 42, height = 33)

# Kriging

# library(dplyr)
# library(sf)
# library(ggplot2)
# library(viridis)
# library(automap)
# library(gstat)
# library(terra)
# library("gstat")   # geostatistics
# library("mapview") # map plot
# library("sf")      # spatial vector data
# library("stars")   # spatial-temporal data
# library("terra")   # raster data handling 
# library("ggplot2") # plotting
# mapviewOptions(fgb = FALSE)

M74_plot <- M74_sf %>% dplyr::select(prop.pop, prop.M74, geometry) %>% st_as_sf(crs = 4326)

# ordinary kriging
M74.ok <- gstat::krige(prop.pop ~ 1, M74_plot, SEA1_sf)

# Convert the result back to sf object
M74Krige_sf <- st_as_sf(M74.ok)

ggplot() +
  geom_sf(data = SEA1_sf, fill = "white", alpha = 0.001) +
  geom_sf(data = M74Krige_sf, aes(fill = var1.pred), lwd = 0) +
  annotate(geom = "text", x = 130, y = 23, color = "red", size = 18, label = paste0(round(M74_plot$prop.M74[1], 1), "% population")) +
  scale_fill_viridis("Percent (%)", direction = -1, option = "viridis") +
  theme_bw() +
  theme(
    text = element_text(size = 45),
    axis.text.x = element_text(size = 30),
    axis.text.y = element_text(size = 30),
    legend.text = element_text(size = 30),
    legend.key.size = unit(2, "cm")
  ) +
  ggtitle("Haplogroup M74")

ggsave(filename = file.path("figures", "M74-Kriging.png"), width = 42, height = 33)


##########################################################################################

SEA1_sf <- SEA1p_sf %>% dplyr::rename(country=NAME_0, location=NAME_1, type=ENGTYPE_1) %>% 
  dplyr::filter(country %in% c("Brunei", "Cambodia", "Indonesia", "Laos", "Malaysia", "Myanmar", "Philippines", "Singapore", "Taiwan", "Thailand", "Timor-Leste", "Vietnam") | (country=="China" & location %in% c("Yunnan", "Guangxi", "Guangdong", "Hainan", "Fujian", "Guizhou", "Hunan", "Jiangxi"))) %>%
  mutate(country=ifelse(country=="China", "Myanmar", country))
SEA1_sf$location <- stri_trans_general(SEA1_sf$location, "Latin-ASCII")
SEA1_sf$location <- trimws(gsub("\\s+", " ", SEA1_sf$location))
SEA1_sf <- SEA1_sf %>% dplyr::select(country, location, type, geometry)

library(readxl)
# SEA <- read_excel("Changed_SEA_haplogroups.xlsx")
SEA <- read_excel("Changed_SEA_haplogroups_new.xlsx") %>%
  mutate(Ethnicity=ifelse(Ethnicity=="Yao", "Dao", 
                          ifelse(Ethnicity=="Bru", "Bru (Brao)", 
                                 ifelse(Ethnicity=="Aeta" | Ethnicity=="Agta", "Aeta (Agta)",
                                        ifelse(Ethnicity=="Filipino" | Ethnicity=="Tagalog", "Filipino (or Tagalog)",
                                               ifelse(Ethnicity=="Arakanese" | Ethnicity=="Rakhine", "Arakanese (or Rakhine)",
                                                      ifelse(Ethnicity=="Kankanaey" | Ethnicity=="Igorot", "Kankanaey (or Igorot)",
                                                             Ethnicity)))))))

SEA <- SEA %>%  mutate(Location=ifelse(Location=="Yunnan, China", "Yunnan", Location))

ethnic_SEA <- SEA[,-c(1,3,4,7,8)] %>% dplyr::rename(country=Country, ethnicity=Ethnicity, location=Location, sum=`Sample size`)
ethnic_SEA <- ethnic_SEA %>% 
  mutate(across(where(is.character), ~na_if(., "-"))) %>%
  mutate_at(c(4:609), as.numeric) %>%
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% dplyr::select(-sum) %>% setDT()

ethnic_SEA <- gather(ethnic_SEA, haplo, N, -country, -ethnicity, -location, factor_key=TRUE) %>% setDT()

dat_ethnic_SEA <- ethnic_SEA %>%
  mutate(haplo1=ifelse(!(haplo %in% c("A+152", "A+152+16362", " A+152+16362+200", "R+16189")), str_extract(haplo, "^([A-Z])\\d\\w"), haplo),
         haplo1=ifelse(is.na(haplo1), haplo, haplo1),
         haplo1=case_when(haplo1 %in% c("135", "156", "159", "167", "172", "175", "182", "187", "197", "246", "261", "263", "264", "266", "272", "299", "316", "318", "349", "372", "377", "422", "430", "436", "481", "487", "494", "499", "562", "566", "595", "604", "168", "30", "32", "50", "51", "53", "530", "62", "73", "78", "90", "563") ~ haplo, 
                          TRUE ~ haplo1),
         haplo1=ifelse(haplo %in% c("A+152", "A+152+16362", "A+152+16362+200"), "A+", haplo1),
         haplo1=ifelse(haplo %in% c("B4+16261"), "B4+", haplo1),
         haplo1=ifelse(haplo %in% c("F1+16189"), "F1+", haplo1),
         haplo1=ifelse(haplo %in% c("HV12b1"), "HV12", haplo1),
         haplo1=ifelse(haplo %in% c("M1'20'51"), "M1'", haplo1),
         haplo1=ifelse(haplo %in% c("M4''67"), "M4'", haplo1),
         haplo1=ifelse(haplo %in% c("P1+152"), "P1+", haplo1),
         haplo1=ifelse(haplo %in% c("P2*1", "P2*1a", "P2*2"), "P2*", haplo1),
         haplo1=ifelse(haplo %in% c("Q1+@16223"), "Q1+", haplo1),
         haplo1=ifelse(haplo %in% c("R+16189"), "R+", haplo1),
         haplo1=ifelse(haplo %in% c("R2+13500"), "R2+", haplo1),
         haplo1=ifelse(haplo %in% c("R6+16129*"), "R6+", haplo1),
         location=case_when(location=="Akar" ~ "Bengkulu",
                            location=="Akar Jambat" ~ "Bengkulu",
                            location=="Alor Island" ~ "Nusa Tenggara Timur",
                            location=="Andaman Sea coast" ~ "Krabi",
                            location=="Bangkok" ~ "Bangkok Metropolis",
                            location=="Borneo" ~ "Kalimantan Timur",
                            location=="Capul's island in Northern Samar" ~ "Northern Samar",
                            location=="Columbio" ~ "Sultan Kudarat",
                            location=="Dulag" ~ "Leyte",
                            location=="East Malaysia on the island of Borneo" ~ "Sarawak",
                            location=="Ibabao, Cordova, Cebu City" ~ "Cebu",
                            location=="Jangkar" ~ "Jawa Timur",
                            location=="Jemaring" ~ "Sumatera Selatan",
                            location=="Kachin State" ~ "Kachin",
                            location=="Kayin State" ~ "Kachin",
                            location=="Kota Kinabalu" ~ "Sabah",
                            location=="Lipa" ~ "Batangas",
                            location=="Luzon, Visayas, Mindanao" ~ "Quezon",
                            location=="Mataran (or Mataram)" ~ "Nusa Tenggara Barat",
                            location=="Merpayang Pauna" ~ "Sumatera Selatan",
                            location=="Mindanao" ~ "Davao del Sur",
                            location=="Mon, Kayin State" ~ "Kachin",
                            location=="North Thailand, Central Thailand (Kanchanaburi and Ratchaburi)" ~ "Ratchaburi",
                            location=="Northern Mindanao" ~ "Bukidnon",
                            location=="Nothern Luzon" ~ "Cagayan",
                            location=="Pelagaran" ~ "Sumatera Selatan",
                            location=="Pelagaran Jambat" ~ "Sumatera Selatan",
                            location=="Palembang" ~ "Sumatera Selatan",
                            location=="Pang Mapha" ~ "Mae Hong Son",
                            location=="Papua New Guinea" ~ "Papua",
                            location=="Peninsular Malaysia" ~ "Pahang",
                            location=="Philippines" ~ "Metropolitan Manila",
                            location=="President Quirino" ~ "Sultan Kudarat",
                            location=="Ratanakiri" ~ "Rotanokiri",
                            location=="Salak" ~ "Sumatera Utara",
                            location=="Semende" ~ "Sumatera Selatan",
                            location=="Singapore" ~ "Central",
                            location=="Southern Mindanao" ~ "Davao del Sur",
                            location=="Southern Thailand" & (ethnicity =="Maniq" | ethnicity == "Southern Thai_AN") ~ "Narathiwat",
                            location=="Southern Thailand" & ethnicity == "Southern Thai_TK" ~ "Surat Thani",
                            location=="Stung Treng" ~ "Stoeng Treng",
                            location=="Tak, Mae Hong Son, and Kanchanaburi" ~ "Mae Hong Son",
                            location=="Thailand" & ethnicity == "Taiwan" ~ "Taiwan",
                            location=="Vietnam" & ethnicity == "Kinh, Cham, Ede, Giarai" ~ "Ninh Thuan",
                            location=="Vietnam" & ethnicity == "Kinh, Muong, Khmer" ~ "Ho Chi Minh",
                            location=="Vietnam" & ethnicity == "Kinh, Tay, Thai, Muong, Hmong" ~ "Hoa Binh",
                            location=="Wallacea" ~ "Sulawesi Tengah",
                            location=="China" ~ "Yunnan",
                            location=="Lancang, China" ~ "Yunnan",
                            location=="Dehong, China" ~ "Yunnan",
                            location=="Yunnan, China" ~ "Yunnan",
                            location=="Brunei (Borneo)" ~ "Brunei and Muara",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Seim Riep (or Siem Reap)" ~ "Siemreab",
                            location=="Prey Veng" ~ "Prey Veng",
                            location=="Banteay Meanchey" ~ "Banteay Meanchey",
                            location=="Kampong Thom" ~ "Kampong Thum",
                            location=="Kampong Cham" ~ "Kampong Cham",
                            location=="Kratie" ~ "Kracheh",
                            location=="Takeo" ~ "Takev",
                            location=="Battanbang" ~ "Batdambang",
                            location=="Kampong Chahnang" ~ "Kampong Chhnang",
                            location=="Pursat" ~ "Pouthisat",
                            location=="Phnom Penh" ~ "Phnom Penh",
                            location=="Kampot" ~ "Kampot",
                            location=="Kandal" ~ "Kandal",
                            location=="Oddar Meanchey" ~ "Otdar Mean Chey",
                            location=="Koh Kong" ~ "Kaoh Kong",
                            location=="Svay Rieng" ~ "Svay Rieng",
                            location=="Alor" ~ "Nusa Tenggara Timur",
                            location=="Ambon" ~ "Maluku",
                            location=="Bali" ~ "Bali",
                            location=="South Kalimantan" ~ "Kalimantan Selatan",
                            location=="Padang" ~ "Sumatera Barat",
                            location=="Sumatra" ~ "Sumatera Barat",
                            location=="Java, Demak" ~ "Jawa Tengah",
                            location=="Sumatra, Kutaradja" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="West New Guinea" ~ "Papua Barat",
                            location=="Manado" ~ "Sulawesi Utara",
                            location=="Sulawesi" ~ "Sulawesi Tengah",
                            location=="Sulawesi, Manado" ~ "Sulawesi Utara",
                            location=="Sumatra, Padang" ~ "Sumatera Barat",
                            location=="Sumatra, Palembang" ~ "Sumatera Selatan",
                            location=="Palangkaraya" ~ "Kalimantan Tengah",
                            location=="South Borneo" ~ "Kalimantan Selatan",
                            location=="Pagaralam" ~ "Sumatera Selatan",
                            location=="Java" ~ "Jawa Tengah",
                            location=="Toraja" ~ "Sulawesi Selatan",
                            location=="Ujung Pandang" ~ "Sulawesi Selatan",
                            location=="Waigapu (Sumba)" ~ "Nusa Tenggara Timur",
                            location=="Sumba" ~ "Nusa Tenggara Timur",
                            location=="Banjarmasin (Borneo)" ~ "Kalimantan Selatan",
                            location=="Palangkaraya (Borneo)" ~ "Kalimantan Tengah",
                            location=="North Laos" ~ "Louangphrabang",
                            location=="Central Laos" ~ "Vientiane",
                            location=="Kedah" ~ "Kedah",
                            location=="Acheh-Kedah Yan" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor" ~ "Johor",
                            location=="Johor Pontian" ~ "Johor",
                            location=="Banjar Perak Kuala Kurau" ~ "Kedah",
                            location=="Perak, Banjar Malay" ~ "Kedah",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Johor Semerah Jawa" ~ "Johor",
                            location=="Johor Muar Jawa" ~ "Johor",
                            location=="Sabah" ~ "Johor",
                            location=="Kelantan" ~ "Kelantan",
                            location=="Kelantan Kota Bahru" ~ "Kelantan",
                            location=="Negeri Sembilan" ~ "Negeri Sembilan",
                            location=="Minangkabau-Negeri Sembilan Lenggeng" ~ "Negeri Sembilan",
                            location=="Kelantan RantauPanjang" ~ "Kelantan",
                            location=="Perak, Rawa Malay" ~ "Perak",
                            location=="Kota Kinabalu (Borneo)" ~ "Sabah",
                            location=="Yangon" ~ "Yangon",
                            location=="Pakokku" ~ "Mon",
                            location=="Bataan" ~ "Bataan",
                            location=="Zambales" ~ "Zambales",
                            location=="Iriga" ~ "Camarines Sur",
                            location=="Batan Archipelago" ~ "Bataan",
                            location=="Cebu" ~ "Cebu",
                            location=="Philippines Bohol" ~ "Bohol",
                            location=="Luzon" ~ "Bulacan",
                            location=="North Thailand" ~ "Chiang Mai",
                            location=="Northeast Thailand" ~ "Samut Prakan",
                            location=="Northern Thailand" ~ "Chiang Mai",
                            location=="Central Thailand" ~ "Bangkok Metropolis",
                            location=="Mergui Archipelago" ~ "Tanintharyi",
                            location=="West Thailand" ~ "Surat Thani",
                            location=="Baucau" ~ "Baucau",
                            location=="Liquica" ~ "Liquica",
                            location=="Cova Lima" ~ "Covalima",
                            location=="Viqueque" ~ "Viqueque",
                            location=="Aileu" ~ "Aileu",
                            location=="Ermera" ~ "Ermera",
                            location=="Dili" ~ "Dili",
                            location=="Manufahi" ~ "Manufahi",
                            ethnicity=="Cham" ~ "Ninh Thuan",
                            ethnicity=="CoLao" ~ "Ha Giang",
                            ethnicity=="Dao" ~ "Ha Giang",
                            ethnicity=="Kinh" ~ "Ha Noi",
                            ethnicity=="Stieng" ~ "Binh Phuoc",
                            ethnicity=="Ede" ~ "Dak Lak",
                            ethnicity=="Giarai" ~ "Gia Lai",
                            ethnicity=="HaNhi" ~ "Lai Chau",
                            ethnicity=="Hmong" ~ "Dien Bien",
                            ethnicity=="Hui" ~ "Ha Giang",
                            ethnicity=="LaChi" ~ "Ha Giang",
                            ethnicity=="LaHu" ~ "Lai Chau",
                            ethnicity=="LoLo" ~ "Ha Giang",
                            ethnicity=="Mang" ~ "Lai Chau",
                            ethnicity=="Nung" ~ "Lang Son",
                            ethnicity=="PaThen" ~ "Ha Giang",
                            ethnicity=="PhuLa" ~ "Lao Cai",
                            ethnicity=="SiLa" ~ "Lai Chau",
                            ethnicity=="Tay" ~ "Lang Son",
                            ethnicity=="Thai" ~ "Son La",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Yao" ~ "Ha Giang",
                            ethnicity=="Kinh, Tay, Dao, Hmong, Muong, Hoa, Khmer, Nung" ~ "Ha Noi",
                            ethnicity=="Tay Nung" ~ "Lao Cai",
                            TRUE ~ location),) %>% setDT()

hap_ethnic_SEA <- dat_ethnic_SEA[, .N, by = .(haplo1, ethnicity, location)] %>% arrange(desc(N))
hap_ethnic_SEA1 <- dat_ethnic_SEA[, .N, by = .(haplo1)] %>% arrange(desc(N))

pre_ethnic_SEA <- dat_ethnic_SEA %>% 
  group_by(ethnicity, haplo1) %>% 
  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(ethnicity, haplo1, N1) %>%
  group_by(ethnicity, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(ethnicity) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup()

ethnicity_SEA <- dat_ethnic_SEA %>% 
  mutate(haplo=ifelse((is.na(haplo) | haplo==".."), "Unspecified", haplo),
         haplo1=ifelse((is.na(haplo1) | haplo1==".."), "Unspecified", haplo1)) %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(N1=sum(N)) %>% ungroup() %>%
  arrange(desc(N1), .by_group = TRUE) %>%
  dplyr::select(country, ethnicity, location, haplo1, N1) %>%
  group_by(country, ethnicity, location, haplo1) %>% dplyr::slice(1) %>% ungroup() %>%
  group_by(country, ethnicity, location) %>% arrange(haplo1, .by_group = TRUE) %>% 
  mutate(percent=(N1*100)/sum(N1)) %>% ungroup() %>%
  group_by(country, ethnicity, location, haplo1) %>%  mutate(sum=sum(N1), max=max(sum)) %>%
  group_by(country, ethnicity, location) %>% arrange(desc(max)) %>% mutate(order=order(max, decreasing = T), haplo1_max=haplo1[order==1]) %>% ungroup %>%
  dplyr::select(-country)

ethnicity_SEA_sf <- merge(ethnicity_SEA, SEA1_sf, by=c("location"))
ethnicity_SEA_plot <- ethnicity_SEA_sf %>% st_as_sf(crs = 4326)

# Convert your dataset to an sf object
SEA1_sf <- st_as_sf(SEA1_sf)

# Check for empty geometries
SEA1_sf <- SEA1_sf[!st_is_empty(SEA1_sf), ]

locations <- SEA1_sf
locations_coords <- st_coordinates(st_centroid(SEA1_sf)) %>%
  data.frame(stringsAsFactors = FALSE) %>%
  mutate(ID = locations$location)

table(dat_ethnic_SEA$location %in% locations$location)

dat2 <- dat_ethnic_SEA %>% filter(!location %in% locations$location)

res <- ethnicity_SEA %>%
  dplyr::rename(ID=location) %>%
  dplyr::rename(key=haplo1, value=N1) %>%
  arrange(key)

res <- res %>% left_join(locations_coords) %>% filter(!is.na(ID))

# dt_res <- spread(res, key = key, value = value) %>% replace(is.na(.), 0)

dt_res <- res %>% 
  group_by(ethnicity, ID) %>% 
  mutate(Var = paste0("Val", row_number())) %>% 
  spread(key, value) %>% replace(is.na(.), 0) %>%
  ungroup()

DT <- dt_res %>% dplyr::select(-c(1:10))
m<-as.matrix(DT)
ID <- dt_res$ID
location <- dt_res$ID
dt <- aggregate(m, data.frame(ID),sum) %>% setDT()
# cbind(id = x[, 1], x[, -1]/rowSums(x[, -1]))
library(janitor)
dt <- dt %>% 
  adorn_percentages() %>% 
  dplyr::mutate_if(is.numeric, funs(. * 100)) %>%
  mutate(location=order(ID)) %>% left_join(locations_coords) %>% dplyr::rename(x=X, y=Y)
dt_x <- dt %>% dplyr::select(-c(location, ID))

# ggplot() + geom_sf(data=SEA1_sf, aes(fill="white"), alpha=0.1) + 
#   geom_sf(data=ethnicity_SEA_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
#   geom_sf_text(data=ethnicity_SEA_plot, mapping=aes(label = ethnicity), stat = "sf_coordinates", position = "identity", check_overlap = T) +
#   geom_scatterpie(aes(x=x, y=y, r=0.6), data=dt_x, cols = colnames(dt_x)[1:218], color=NA, alpha=0.8) +
#   guides(fill=guide_legend(nrow=10, byrow=TRUE)) +
#   scale_fill_discrete(name="") +
#   theme_bw() +
#   theme(text = element_text(size=36), 
#         axis.text.x = element_text(size=30), 
#         axis.text.y = element_text(size=30), 
#         legend.text=element_text(size=25), 
#         legend.key.size = unit(1, "cm"),
#         legend.position = "bottom") +
#   ggtitle("Geographic distribution of Human mitochondrial DNA (mtDNA) Haplogroups in Southeast Asia by Ethnicity")
# ggsave(filename = file.path("figures", "Ethnicity_SEA_edit2_new.png"), width = 49, height = 33)

ggplot() + geom_sf(data=SEA1_sf, aes(fill="white"), alpha=0.001) + 
  geom_sf(data=ethnicity_SEA_plot, aes(fill=haplo1_max), lwd=0, alpha=0.6) +
  # geom_sf_text(data=ethnicity_SEA_plot, mapping=aes(label = location), stat = "sf_coordinates", position = "identity", check_overlap = T) +
  geom_scatterpie(aes(x=x, y=y, r=0.3), data=dt_x, cols = colnames(dt_x)[1:216], color=NA, alpha=0.6) +
  guides(fill=guide_legend(nrow=13, byrow=TRUE)) +
  scale_fill_discrete(name="") +
  theme_bw() +
  theme(text = element_text(size=24), 
        axis.text.x = element_text(size=24), 
        axis.text.y = element_text(size=24), 
        legend.text=element_text(size=24), 
        legend.key.size = unit(1, "cm"),
        legend.position = "bottom")

ggsave(filename = file.path("figures", "Haplo_location_SEA_new_plus.png"), width = 24, height = 26)

# Haplogroup F1a

F1a <- dat_f %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="F1", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         prop.F1a=(sum(subset(., haplogroup4=="F1a")[, "count"])/sum(.$count))*100) %>%
  group_by(country) %>% mutate(prop.pop=(sum(subset(dat_f, haplogroup4=="F1a")[, "count"])/sum(dat_f$count))*100) %>% ungroup() %>%
  filter(haplogroup4 == "F1a") %>% group_by(country) %>% slice(1)

F1a_sf <- merge(F1a, SEA0_sf, by=c("country"))
F1a_plot <- F1a_sf %>% select(prop.pop, prop.F1a, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=F1a_plot, aes(fill=prop.pop), lwd=0) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(F1a_plot$prop.F1a[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Haplogroup F1a")
ggsave(filename = file.path("figures", "F1a-PerPop.png"), width = 49, height = 33)

geom_point(aes(x = Lon, y = Lat,  colour = Facility), data = df, size = 0.5) + 
  theme(legend.position="bottom")

# Haplogroup B5a

B5a <- dat_f %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="B5", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         prop.B5a=(sum(subset(., haplogroup4=="B5a")[, "count"])/sum(.$count))*100) %>%
  group_by(country) %>% mutate(prop.pop=(sum(subset(dat_f, haplogroup4=="B5a")[, "count"])/sum(dat_f$count))*100) %>% ungroup() %>%
  filter(haplogroup4 == "B5a") %>% group_by(country) %>% slice(1)

B5a_sf <- merge(B5a, SEA0_sf, by=c("country"))
B5a_plot <- B5a_sf %>% select(prop.pop, prop.B5a, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=B5a_plot, aes(fill=prop.pop), lwd=0) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(B5a_plot$prop.B5a[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Haplogroup B5a")
ggsave(filename = file.path("figures", "B5a-PerPop.png"), width = 49, height = 33)

# Haplogroup F1f

F1f <- dat_f %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="F1", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         prop.F1f=(sum(subset(., haplogroup4=="F1f")[, "count"])/sum(.$count))*100) %>%
  group_by(country) %>% mutate(prop.pop=(sum(subset(dat_f, haplogroup4=="F1f")[, "count"])/sum(dat_f$count))*100) %>% ungroup() %>%
  filter(haplogroup4 == "F1f") %>% group_by(country) %>% slice(1)

F1f_sf <- merge(F1f, SEA0_sf, by=c("country"))
F1f_plot <- F1f_sf %>% select(prop.pop, prop.F1f, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=F1f_plot, aes(fill=prop.pop), lwd=0) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(F1f_plot$prop.F1f[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Haplogroup F1f")
ggsave(filename = file.path("figures", "F1f-PerPop.png"), width = 49, height = 33)

# Haplogroup F1c

F1c <- dat_f %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="F1", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         prop.F1c=(sum(subset(., haplogroup4=="F1c")[, "count"])/sum(.$count))*100) %>%
  group_by(country) %>% mutate(prop.pop=(sum(subset(dat_f, haplogroup4=="F1c")[, "count"])/sum(dat_f$count))*100) %>% ungroup() %>%
  filter(haplogroup4 == "F1c") %>% group_by(country) %>% slice(1)

F1c_sf <- merge(F1c, SEA0_sf, by=c("country"))
F1c_plot <- F1c_sf %>% select(prop.pop, prop.F1c, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=F1c_plot, aes(fill=prop.pop), lwd=0) +
  annotate(geom="text", x=115, y=23, color="red", size=18, label= paste(round(F1c_plot$prop.F1c[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Haplogroup F1c")
ggsave(filename = file.path("figures", "F1c-PerPop.png"), width = 49, height = 33)

# Haplogroup F1e

F1e <- dat_f %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="F1", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         prop.F1e=(sum(subset(., haplogroup4=="F1e")[, "count"])/sum(.$count))*100) %>%
  group_by(country) %>% mutate(prop.pop=(sum(subset(dat_f, haplogroup4=="F1e")[, "count"])/sum(dat_f$count))*100) %>% ungroup() %>%
  filter(haplogroup4 == "F1e") %>% group_by(country) %>% slice(1)

F1e_sf <- merge(F1e, SEA0_sf, by=c("country"))
F1e_plot <- F1e_sf %>% select(prop.pop, prop.F1e, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=F1e_plot, aes(fill=prop.pop), lwd=0) +
  annotate(geom="text", x=115, y=23, color="red", size=18, label= paste(round(F1e_plot$prop.F1e[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Haplogroup F1e")
ggsave(filename = file.path("figures", "F1e-PerPop.png"), width = 49, height = 33)

# Haplogroup M7b

M7b <- dat_f %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="M7", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         prop.M7b=(sum(subset(., haplogroup4=="M7b")[, "count"])/sum(.$count))*100) %>%
  group_by(country) %>% mutate(prop.pop=(sum(subset(dat_f, haplogroup4=="M7b")[, "count"])/sum(dat_f$count))*100) %>% ungroup() %>%
  filter(haplogroup4 == "M7b") %>% group_by(country) %>% slice(1)

M7b_sf <- merge(M7b, SEA0_sf, by=c("country"))
M7b_plot <- M7b_sf %>% select(prop.pop, prop.M7b, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=M7b_plot, aes(fill=prop.pop), lwd=0) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(M7b_plot$prop.M7b[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Haplogroup M7b")
ggsave(filename = file.path("figures", "M7b-PerPop.png"), width = 49, height = 33)

# Haplogroup M7c

M7c <- dat_f %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="M7", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         prop.M7c=(sum(subset(., haplogroup4=="M7c")[, "count"])/sum(.$count))*100) %>%
  group_by(country) %>% mutate(prop.pop=(sum(subset(dat_f, haplogroup4=="M7c")[, "count"])/sum(dat_f$count))*100) %>% ungroup() %>%
  filter(haplogroup4 == "M7c") %>% group_by(country) %>% slice(1)

M7c_sf <- merge(M7c, SEA0_sf, by=c("country"))
M7c_plot <- M7c_sf %>% select(prop.pop, prop.M7c, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=M7c_plot, aes(fill=prop.pop), lwd=0) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(M7c_plot$prop.M7c[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Haplogroup M7c")
ggsave(filename = file.path("figures", "M7c-PerPop.png"), width = 49, height = 33)

# Haplogroup B4a

B4a <- dat_f %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="B4", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         prop.B4a=(sum(subset(., haplogroup4=="B4a")[, "count"])/sum(.$count))*100) %>%
  group_by(country) %>% mutate(prop.pop=(sum(subset(dat_f, haplogroup4=="B4a")[, "count"])/sum(dat_f$count))*100) %>% ungroup() %>%
  filter(haplogroup4 == "B4a") %>% group_by(country) %>% slice(1)

B4a_sf <- merge(B4a, SEA0_sf, by=c("country"))
B4a_plot <- B4a_sf %>% select(prop.pop, prop.B4a, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=B4a_plot, aes(fill=prop.pop), lwd=0) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(B4a_plot$prop.B4a[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Haplogroup B4a")
ggsave(filename = file.path("figures", "B4a-PerPop.png"), width = 49, height = 33)

# Haplogroup N9a

N9a <- dat_f %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="N9", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         prop.N9a=(sum(subset(., haplogroup4=="N9a")[, "count"])/sum(.$count))*100) %>%
  group_by(country) %>% mutate(prop.pop=(sum(subset(dat_f, haplogroup4=="N9a")[, "count"])/sum(dat_f$count))*100) %>% ungroup() %>%
  filter(haplogroup4 == "N9a") %>% group_by(country) %>% slice(1)

N9a_sf <- merge(N9a, SEA0_sf, by=c("country"))
N9a_plot <- N9a_sf %>% select(prop.pop, prop.N9a, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=N9a_plot, aes(fill=prop.pop), lwd=0) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(N9a_plot$prop.N9a[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Haplogroup N9a")
ggsave(filename = file.path("figures", "N9a-PerPop.png"), width = 49, height = 33)

# Haplogroup R9b

R9b <- dat_f %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="R9", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         prop.R9b=(sum(subset(., haplogroup4=="R9b")[, "count"])/sum(.$count))*100) %>%
  group_by(country) %>% mutate(prop.pop=(sum(subset(dat_f, haplogroup4=="R9b")[, "count"])/sum(dat_f$count))*100) %>% ungroup() %>%
  filter(haplogroup4 == "R9b") %>% group_by(country) %>% slice(1)

R9b_sf <- merge(R9b, SEA0_sf, by=c("country"))
R9b_plot <- R9b_sf %>% select(prop.pop, prop.R9b, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=R9b_plot, aes(fill=prop.pop), lwd=0) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(R9b_plot$prop.R9b[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Haplogroup R9b")
ggsave(filename = file.path("figures", "R9b-PerPop.png"), width = 49, height = 33)

# Haplogroup R9c

R9c <- dat_f %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="R9", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         prop.R9c=(sum(subset(., haplogroup4=="R9c")[, "count"])/sum(.$count))*100) %>%
  group_by(country) %>% mutate(prop.pop=(sum(subset(dat_f, haplogroup4=="R9c")[, "count"])/sum(dat_f$count))*100) %>% ungroup() %>%
  filter(haplogroup4 == "R9c") %>% group_by(country) %>% slice(1)

R9c_sf <- merge(R9c, SEA0_sf, by=c("country"))
R9c_plot <- R9c_sf %>% select(prop.pop, prop.R9c, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=R9c_plot, aes(fill=prop.pop), lwd=0) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(R9c_plot$prop.R9c[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Haplogroup R9c")
ggsave(filename = file.path("figures", "R9c-PerPop.png"), width = 49, height = 33)

# Haplogroup G2b

G2b <- dat_f %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="G2", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3),
         prop.G2b=(sum(subset(., haplogroup4=="G2b")[, "count"])/sum(.$count))*100) %>%
  group_by(country) %>% mutate(prop.pop=(sum(subset(dat_f, haplogroup4=="G2b")[, "count"])/sum(dat_f$count))*100) %>% ungroup() %>%
  filter(haplogroup4 == "G2b") %>% group_by(country) %>% slice(1)

G2b_sf <- merge(G2b, SEA0_sf, by=c("country"))
G2b_plot <- G2b_sf %>% select(prop.pop, prop.G2b, geometry) %>% st_as_sf(crs = 4326)
ggplot() + geom_sf() + geom_sf(data=G2b_plot, aes(fill=prop.pop), lwd=0) +
  annotate(geom="text", x=130, y=23, color="red", size=18, label= paste(round(G2b_plot$prop.G2b[1],1), "% dân số", sep = "")) +
  scale_fill_viridis("Tỉ lệ (%) trên dân số", direction = -1, option = "viridis") +
  theme(text = element_text(size=45), axis.text.x = element_text(size=30), axis.text.y = element_text(size=30), legend.text=element_text(size=30), legend.key.size = unit(2, "cm")) +
  ggtitle("Haplogroup G2b")
ggsave(filename = file.path("figures", "G2b-PerPop.png"), width = 49, height = 33)

# Haplogroup M

hap_M <- dat %>% filter(haplogroup1=="M")
nbin_M <- nbin[labels(nbin) %in% hap_M$name]
class(nbin_M)
dnbin_M<-dist.dna(nbin_M, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_M<-nj(dnbin_M)
library(ggtree)
ggt_M<-ggtree::ggtree(tree_M, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 4)
ggt_M

# Haplogroup M1
hap_M1 <- dat %>% filter(haplogroup2=="M1")
nbin_M1 <- nbin[labels(nbin) %in% hap_M1$name]
class(nbin_M1)
dnbin_M1<-dist.dna(nbin_M1, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_M1<-nj(dnbin_M1)
library(ggtree)
ggt_M1<-ggtree::ggtree(tree_M1, layout = "circular", cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 4)
ggt_M1

library(treeio)

png("figures/Viet_Indo_M1.png", width = 1200, height = 800)
zoom(tree_M1, grep("Vietnam|Indonesia", tree_M1$tip.label, value = TRUE))
dev.off()

zoom(tree_M1, grep("Vietnam|Thailand", tree_M1$tip.label, value = TRUE))

# Haplogroup M2
hap_M2 <- dat %>% filter(haplogroup2=="M2")
nbin_M2 <- nbin[labels(nbin) %in% hap_M2$name]
class(nbin_M2)
dnbin_M2<-dist.dna(nbin_M2, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_M2<-nj(dnbin_M2)
library(ggtree)
ggt_M2<-ggtree::ggtree(tree_M2, layout = "circular", cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 4)
ggt_M2

library(treeio)
png("figures/Viet_Indo_M2.png", width = 1200, height = 800)
zoom(tree_M2, grep("Vietnam|Indonesia", tree_M2$tip.label, value = TRUE))
dev.off()
zoom(tree_M2, grep("Vietnam|Thailand", tree_M2$tip.label, value = TRUE))

# Haplogroup M5
hap_M5 <- dat %>% filter(haplogroup2=="M5")
nbin_M5 <- nbin[labels(nbin) %in% hap_M5$name]
class(nbin_M5)
dnbin_M5<-dist.dna(nbin_M5, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_M5<-nj(dnbin_M5)
library(ggtree)
ggt_M5<-ggtree::ggtree(tree_M5, layout = "circular", cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 4)
ggt_M5

library(treeio)
png("figures/Viet_Indo_M5.png", width = 1200, height = 800)
zoom(tree_M5, grep("Vietnam|Indonesia", tree_M5$tip.label, value = TRUE))
dev.off()
zoom(tree_M5, grep("Vietnam|Thailand", tree_M5$tip.label, value = TRUE))

# Haplogroup M7
hap_M7 <- dat %>% filter(haplogroup2=="M7")
nbin_M7 <- nbin[labels(nbin) %in% hap_M7$name]
class(nbin_M7)
dnbin_M7<-dist.dna(nbin_M7, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_M7<-nj(dnbin_M7)
library(ggtree)
ggt_M7<-ggtree::ggtree(tree_M7, layout = "circular", cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 4)
ggt_M7

library(treeio)
png("figures/Viet_Indo_M7.png", width = 2400, height = 4800, res = 130)
zoom(tree_M7, grep("Vietnam|Indonesia", tree_M7$tip.label, value = TRUE))
dev.off()
zoom(tree_M7, grep("Vietnam|Thailand", tree_M7$tip.label, value = TRUE))

groupInfo <- split(tree_M7$tip.label, gsub("_\\w+", "", tree_M7$tip.label))
tree_M7 <- groupOTU(tree_M7, groupInfo)
p_M7 <- ggtree(tree_M7, aes(color=group)) + geom_tiplab() + xlim(NA, 23)
zoom(tree_M7, grep("Vietnam", tree_M7$tip.label), xmax_adjust=2)

tre_M7<-ladderize(tree_M7)
ggtree(tre_M7, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 4)+
  geom_highlight(node = 20, fill="purple", alpha=0.2)

tre<-ladderize(tree)
ggtree(tre, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 4)+
  geom_highlight(node = 20, fill="purple", alpha=0.2)

# Haplogroup M7b
hap_M7b <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="M7", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "M7b")
nbin_M7b <- nbin[labels(nbin) %in% hap_M7b$name]
class(nbin_M7b)
dnbin_M7b<-dist.dna(nbin_M7b, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_M7b<-nj(dnbin_M7b)
library(ggtree)
ggt_M7b<-ggtree::ggtree(tree_M7b, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 2)
ggt_M7b

M7b <- file[hap_M7b$name]
writeXStringSet(M7b, "data/M7b.fasta")

hap_M7b1a1 <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="M7", str_extract(haplo, "^([A-Z])\\d\\w\\d\\w\\d"), haplogroup3)) %>%
  filter(haplogroup4 == "M7b1a1")

M7b1a1 <- file[hap_M7b1a1$name]
writeXStringSet(M7b1a1, "data/M7b1a1.fasta")

library(treeio)
png("figures/Viet_Indo_M7b.png", width = 1200, height = 1600)
zoom(tree_M7b, grep("Vietnam|Indonesia", tree_M7b$tip.label, value = TRUE))
dev.off()
zoom(tree_M7b, grep("Vietnam|Thailand", tree_M7b$tip.label, value = TRUE))

# Haplogroup N9a
hap_N9a <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="N9", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "N9a")
nbin_N9a <- nbin[labels(nbin) %in% hap_N9a$name]
class(nbin_N9a)
dnbin_N9a<-dist.dna(nbin_N9a, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_N9a<-nj(dnbin_N9a)
library(ggtree)
ggt_N9a<-ggtree::ggtree(tree_N9a, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 2)
ggt_N9a

library(treeio)
png("figures/Viet_Indo_N9a.png", width = 1200, height = 1600)
zoom(tree_N9a, grep("Vietnam|Indonesia", tree_N9a$tip.label, value = TRUE))
dev.off()
zoom(tree_N9a, grep("Vietnam|Thailand", tree_N9a$tip.label, value = TRUE))

# Haplogroup R9b
hap_R9b <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="R9", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "R9b")
nbin_R9b <- nbin[labels(nbin) %in% hap_R9b$name]
class(nbin_R9b)
dnbin_R9b<-dist.dna(nbin_R9b, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_R9b<-nj(dnbin_R9b)
library(ggtree)
ggt_R9b<-ggtree::ggtree(tree_R9b, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 2)
ggt_R9b

library(treeio)
png("figures/Viet_Indo_R9b.png", width = 1200, height = 1600)
zoom(tree_R9b, grep("Vietnam|Indonesia", tree_R9b$tip.label, value = TRUE))
dev.off()
zoom(tree_R9b, grep("Vietnam|Thailand", tree_R9b$tip.label, value = TRUE))

# Haplogroup B4
hap_B4 <- dat %>% filter(haplogroup2=="B4")
nbin_B4 <- nbin[labels(nbin) %in% hap_B4$name]
class(nbin_B4)
dnbin_B4<-dist.dna(nbin_B4, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_B4<-nj(dnbin_B4)
library(ggtree)
ggt_B4<-ggtree::ggtree(tree_B4, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 2)
ggt_B4

library(treeio)
zoom(tree_B4, grep("Vietnam|Indonesia", tree_B4$tip.label, value = TRUE))
zoom(tree_B4, grep("Vietnam|Thailand", tree_B4$tip.label, value = TRUE))

# Haplogroup B4a
hap_B4a <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="B4", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "B4a")
nbin_B4a <- nbin[labels(nbin) %in% hap_B4a$name]
class(nbin_B4a)
dnbin_B4a<-dist.dna(nbin_B4a, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_B4a<-nj(dnbin_B4a)
library(ggtree)
ggt_B4a<-ggtree::ggtree(tree_B4a, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 2)
ggt_B4a

library(treeio)
png("figures/Viet_Indo_B4a.png", width = 1200, height = 1600)
zoom(tree_B4a, grep("Vietnam|Indonesia", tree_B4a$tip.label, value = TRUE))
dev.off()
zoom(tree_B4a, grep("Vietnam|Thailand", tree_B4a$tip.label, value = TRUE))

# Haplogroup B4c
hap_B4c <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="B4", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "B4c")
nbin_B4c <- nbin[labels(nbin) %in% hap_B4c$name]
class(nbin_B4c)
dnbin_B4c<-dist.dna(nbin_B4c, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_B4c<-nj(dnbin_B4c)
library(ggtree)
ggt_B4c<-ggtree::ggtree(tree_B4c, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 2)
ggt_B4c

library(treeio)
png("figures/Viet_Indo_B4c.png", width = 1200, height = 1600)
zoom(tree_B4c, grep("Vietnam|Indonesia", tree_B4a$tip.label, value = TRUE))
dev.off()
zoom(tree_B4c, grep("Vietnam|Thailand", tree_B4c$tip.label, value = TRUE))

# Haplogroup B5
hap_B5 <- dat %>% filter(haplogroup2=="B5")
nbin_B5 <- nbin[labels(nbin) %in% hap_B5$name]
class(nbin_B5)
dnbin_B5<-dist.dna(nbin_B5, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_B5<-nj(dnbin_B5)
library(ggtree)
ggt_B5<-ggtree::ggtree(tree_B5, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 2)
ggt_B5

library(treeio)
zoom(tree_B5, grep("Vietnam|Indonesia", tree_B5$tip.label, value = TRUE))
zoom(tree_B5, grep("Vietnam|Thailand", tree_B5$tip.label, value = TRUE))

# Haplogroup B5a
hap_B5a <- dat %>% 
  mutate(haplogroup4 = ifelse(haplogroup3=="B5", str_extract(haplo, "^([A-Z])\\d\\w"), haplogroup3)) %>%
  filter(haplogroup4 == "B5a")
nbin_B5a <- nbin[labels(nbin) %in% hap_B5a$name]
class(nbin_B5a)
dnbin_B5a<-dist.dna(nbin_B5a, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_B5a<-nj(dnbin_B5a)
library(ggtree)
ggt_B5a<-ggtree::ggtree(tree_B5a, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 2)
ggt_B5a

library(treeio)
png("figures/Viet_Indo_B5a.png", width = 1200, height = 1600)
zoom(tree_B5a, grep("Vietnam|Indonesia", tree_B5a$tip.label, value = TRUE))
dev.off()
zoom(tree_B5a, grep("Vietnam|Thailand", tree_B5a$tip.label, value = TRUE))

# Haplogroup D4
hap_D4 <- dat %>% filter(haplogroup2=="D4")
nbin_D4 <- nbin[labels(nbin) %in% hap_D4$name]
class(nbin_D4)
dnbin_D4<-dist.dna(nbin_D4, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_D4<-nj(dnbin_D4)
library(ggtree)
ggt_D4<-ggtree::ggtree(tree_D4, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 2)
ggt_D4

library(treeio)
zoom(tree_D4, grep("Vietnam|Indonesia", tree_D4$tip.label, value = TRUE))
zoom(tree_D4, grep("Vietnam|Thailand", tree_D4$tip.label, value = TRUE))

# Haplogroup F1
hap_F1 <- dat %>% filter(haplogroup2=="F1")
nbin_F1 <- nbin[labels(nbin) %in% hap_F1$name]
class(nbin_F1)
dnbin_F1<-dist.dna(nbin_F1, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_F1<-nj(dnbin_F1)
library(ggtree)
ggt_F1<-ggtree::ggtree(tree_F1, cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 2)
ggt_F1

library(treeio)
zoom(tree_F1, grep("Vietnam|Indonesia", tree_F1$tip.label, value = TRUE))
zoom(tree_F1, grep("Vietnam|Thailand", tree_F1$tip.label, value = TRUE))

# Haplogroup R9
hap_R9 <- dat %>% filter(haplogroup2=="R9")
nbin_R9 <- nbin[labels(nbin) %in% hap_R9$name]
class(nbin_R9)
dnbin_R9<-dist.dna(nbin_R9, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree_R9<-nj(dnbin_R9)
library(ggtree)
ggt_R9<-ggtree::ggtree(tree_R9, layout = "circular", cex = 0.8, aes(color=branch.length))+
  scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_tiplab(align=TRUE, size=2)+
  geom_treescale(y = - 5, color = "coral4", fontsize = 4)
ggt_R9

library(treeio)
zoom(tree_R9, grep("Vietnam|Indonesia", tree_R9$tip.label, value = TRUE))
zoom(tree_R9, grep("Vietnam|Thailand", tree_R9$tip.label, value = TRUE))

#########   EXTRACTION SEQUENCE AND HAPLOTYPE INFORMATION    ###############

nrow(nm)#confirmation of number of samples

ncol(nm)#confirmation of sequences size

sat2 <- NULL
for (i in 1:nrow(nm)) {
  sat2[i] <- paste(nm[i, ], collapse="")
}

sat2 <- toupper(sat2) #converts all letters to uppercase
sat3 <- unique(sat2) #gives only unique sequences from all sequences
sat3#that is, it gives complete sequences of haplotypes (20x373).
hfreq <- NULL
for (i in 1:length(sat3)) {
  hcount = 0
  s3 <- sat3[i]
  for (j in 1:length(sat2)) {
    s2 <- sat2[j]
    if (s3 == s2) {
      hcount <- (hcount + 1) #counts the number of individuals with the same haplotype sequence. 
      #print(paste(i, "yes", hcount))
    }
    #print(s2)
  }
  hname<-(paste("H",i, sep =""))
  hfreq[i] <- hcount
  #print(paste(hname, hcount, collapse = ""))
}   #haplotype frequency in the all samples

len <- nchar(sat3[1]) #assume all have same length!!!
cnt <- 1
sat4 = list()
for (j in 1:len) {
  same <- TRUE
  first <- substr(sat3[1], j, j)
  for (i in 2:length(sat3)) {
    ch1 <- substr(sat3[i], j, j)
    if (first != ch1) {
      str <- paste(j, first, ch1)
      print(str)
      same <- FALSE
      break
    }
  }
  if (!same) {
    ss <- NULL
    for (i in 1:length(sat3)) {
      ss <- paste(ss, substr(sat3[i], j, j), sep="")
    }
    sat4[cnt] <- ss
    cnt <- cnt + 1
  }
}#it gives the mutation points and the nucleotide substitutions

len <- nchar(sat3[1]) #assume all have same length!!!
cnt <- 1
sat5 = list() 
for (j in 1:len) { #scan all columnns and if all elements are the same do not copy
  same <- TRUE
  first <- substr(sat3[1], j, j)
  scol <- first
  for (i in 2:length(sat3)) {
    ch1 <- substr(sat3[i], j, j)
    scol <- paste(scol, ch1, sep="")
    if (first != ch1) {
      str <- paste(j, first, ch1)
      #print(str)
      same <- FALSE
      #break
    }
  }
  if (!same) {
    scol <- paste("V_", cnt, " ", scol, sep="")
    ss <- NULL
    for (i in 1:length(sat3)) {
      ss <- paste(ss, substr(sat3[i], j, j), sep="")
    } 
    sat5[cnt] <- ss
    cnt <- cnt + 1
  }
}

sat6 <- as.matrix(sat5)
mat6 = matrix(nrow=nrow(sat6), ncol=nchar(sat6[1]))
for (i in 1:nrow(mat6)) {
  s <- as.vector(strsplit(as.character(sat5[i]), ""))
  for (j in 1:ncol(mat6)) {
    mat6[i, j] <- as.character(s[[1]][j])
  }
}
mat7 <- t(mat6) #sequences of haplotypes and variable sites matrix (20x41)
write.table(mat7,file="mat7.txt", quote=FALSE, sep="\t")
hname<-paste("H", 1:nrow(mat7), sep = "")
rownames(mat7)=hname
write.table(mat7,file="mat7.txt", quote=FALSE, sep="\t") 

str4 <- NULL
str4[1] <- paste(mat7[1, ], collapse="")
for (i in 2:nrow(mat7)) {
  tmp <- NULL
  for (j in 1:ncol(mat7)) {
    chr = "."
    if(mat7[i, j] != mat7[1, j]) chr = mat7[i, j]
    tmp <- paste(tmp, chr, sep="")
  }
  str4[i] <- paste(tmp, collapse="")
}
nchar(str4[1]) #confirmation of number of variable sites
mstr4<-as.matrix(str4)
rownames(mstr4)<-hname
colnames(mstr4)<-paste("sequences length","(", ncol(mat7), "base pairs", ")")
pct<-round((as.matrix(hfreq)*100/colSums(as.matrix(hfreq))), 2)
colnames(pct)<-c("pct")
cmstr4<-as.data.frame(cbind(mstr4, hfreq, pct))
cmstr4
write.table(cmstr4,file="cmstr4.txt", quote=FALSE, sep="\t") 

#############  HAPLOTYPES FREQUENCY  ################
library(haplotypes)

kn<-as.dna(nbin)
kh<-haplotypes::haplotype(kn)

ncb <- as.matrix(labels(nbin))
n2 <- NULL
for (i in 1:nrow(ncb)) {
  n2[i] <- strsplit(ncb[i], '_')[[1]][1] #to get the names of the examples where the name and number are separated by an underscore
}
n2

for (i in 1:nrow(ncb)) {
  n2[i] <- strsplit(n2[i], ' ')[[1]][1] #to get the names of the examples where the name and number are separated by a space
}
n2

hf<-grouping(kh, factors=n2)
hf[["hapvec"]] <- NULL
dhf<-as.data.frame(hf$hapmat) #haplotype frequency matrix per populaion
rownames(dhf)<-paste("H", 1:nrow(mat7), sep = "")
dhf
write.table(dhf,file="dhf.txt", quote=FALSE, sep="\t")

############## DISTANCE MATRIX OF HAPLOTYPES  ############################
library(pegas)
dh<-dist.hamming(mat7) #from pegas package
dh
dhm<-as.matrix(dh)
write.table(dhm,file="dhm.txt", quote=FALSE, sep="\t")

############### HEAT MAP ###########################
sat2 <- NULL
for (i in 1:nrow(nm)) {
  sat2[i] <- paste(nm[i, ], collapse="")
}
sat2

sat2 <- toupper(sat2)
sat3 <- unique(sat2)
comat = matrix(nrow=length(sat3), ncol=length(sat3))
for (i in 1:length(sat3)) { 
  si <- sat3[i]
  for (j in 1:length(sat3)) { 
    sj <- sat3[j]
    difcnt = 0
    s1 = as.vector(strsplit(as.character(si), ""))
    s2 = as.vector(strsplit(as.character(sj), ""))
    for (k in 1:length(s1[[1]])) {
      if (s1[[1]][k] != s2[[1]][k]) {
        difcnt = difcnt + 1
      }
      comat[i, j] = difcnt
      #print(paste(i, " ", j, " ", difcnt))
    }
  }
}
comat	#is Hamming distance matrix
colnames(comat)<-paste("H", 1:nrow(comat), sep = "")
rownames(comat)<-paste("H", 1:nrow(comat), sep = "")
heatmap(comat,scale="none",col=heat.colors(100),keep.dendro=TRUE, symm=TRUE) #stats package

dev.new()
heatmap(comat,scale="none",col=heat.colors(100),keep.dendro=TRUE, symm=TRUE)


pdf("heatmap.pdf", width = 7, height = 7)
heatmap(comat,scale="none",col=heat.colors(100),keep.dendro=TRUE, symm=TRUE)
dev.off()

############## HAPLOTYPE NETWORK-INDIVIDUALS ##########################
library(pegas)
h<-pegas::haplotype(nbin, strict = FALSE, trailingGapsAsN = TRUE)#extracts haplotypes from DNAbin object
hname<-paste("H", 1:nrow(h), sep = "")
rownames(h)= paste(hname)
net<-haploNet(h, d = NULL, getProb = TRUE)#constructs the haplotype network
net
ind.hap<-with(
  utils::stack(setNames(attr(h, "index"), rownames(h))),
  table(hap=ind, individuals=rownames(nbin))
)

par(mar=c(0.01,0.01,0.01,15))
plot(net, size=attr(net, "freq"), scale.ratio = 2, cex = 0.6, labels=TRUE, pie = ind.hap, show.mutation=1, font=2, fast=TRUE)
legend(x= 57,y=15, colnames(ind.hap), fill=rainbow(ncol(ind.hap)), cex=0.52, ncol=6, x.intersp=0.2, text.width=11)

dev.new()
plot(net, size=attr(net, "freq"), scale.ratio = 2, cex = 0.6, labels=TRUE, pie = ind.hap, show.mutation=1, font=2, fast=TRUE)
legend(x= 57,y=30, colnames(ind.hap), fill=rainbow(ncol(ind.hap)), cex=0.5, ncol=6, x.intersp=0,003, text.width=9)

pdf("hapind.pdf", width = 11, height = 5)
par(mar=c(0.01,0.01,0.01,15))
plot(net, size=attr(net, "freq"), scale.ratio = 2, cex = 0.6, labels=TRUE, pie = ind.hap, show.mutation=1, font=2, fast=TRUE)
legend(x= 57,y=15, colnames(ind.hap), fill=rainbow(ncol(ind.hap)), cex=0.52, ncol=6, x.intersp=0.2, text.width=11)
dev.off()

# M7b

library(pegas)
h_M7b<-pegas::haplotype(nbin_M7b, strict = FALSE, trailingGapsAsN = TRUE)#extracts haplotypes from DNAbin object
hname_M7b<-paste("H", 1:nrow(h_M7b), sep = "")
rownames(h_M7b)= paste(hname_M7b)
net_M7b<-haploNet(h_M7b, d = NULL, getProb = TRUE)#constructs the haplotype network
net_M7b
ind.hap<-with(
  utils::stack(setNames(attr(h_M7b, "index"), rownames(h_M7b))),
  table(hap=ind, individuals=rownames(nbin_M7b))
)

par(mar=c(0.01,0.01,0.01,15))
plot(net, size=attr(net, "freq"), scale.ratio = 2, cex = 0.6, labels=TRUE, pie = ind.hap, show.mutation=1, font=2, fast=TRUE)
legend(x= 57,y=15, colnames(ind.hap), fill=rainbow(ncol(ind.hap)), cex=0.52, ncol=6, x.intersp=0.2, text.width=11)

dev.new()
plot(net, size=attr(net, "freq"), scale.ratio = 2, cex = 0.6, labels=TRUE, pie = ind.hap, show.mutation=1, font=2, fast=TRUE)
legend(x= 57,y=30, colnames(ind.hap), fill=rainbow(ncol(ind.hap)), cex=0.5, ncol=6, x.intersp=0,003, text.width=9)

pdf("hapind.pdf", width = 11, height = 5)
par(mar=c(0.01,0.01,0.01,15))
plot(net, size=attr(net, "freq"), scale.ratio = 2, cex = 0.6, labels=TRUE, pie = ind.hap, show.mutation=1, font=2, fast=TRUE)
legend(x= 57,y=15, colnames(ind.hap), fill=rainbow(ncol(ind.hap)), cex=0.52, ncol=6, x.intersp=0.2, text.width=11)
dev.off()


#For a better position of the name table, you can optimize x and y coordinates in the "legend()" argument.

############## HAPLOTYPE NETWORK-POPULATIONS ##########################

h<-pegas::haplotype(nbin, strict = FALSE, trailingGapsAsN = TRUE)#extracts haplotypes from DNAbin object
hname<-paste("H", 1:nrow(h), sep = "")
rownames(h)= paste(hname)
net<-haploNet(h, d = NULL, getProb = TRUE) #constructs the haplotype network
net
ind.hap<-with(
  utils::stack(setNames(attr(h, "index"), rownames(h))),
  table(hap=ind, individuals=rownames(nbin)[values])
)

#We followed the name order in the ind.hap object for all coloring of samples in the haplotype network circles.
#You can see the order of sample names using the command "colnames(ind.hap)".
#The color of the samples has been assigned as the "bg" list for use in the plot () command, as below.
#The number of colors is determined by the number of samples in the same population (see "colnames (ind.hap)").
#Using the colors() command, you can choose different colors for your samples according to the populations.

bg<-c(rep("orange", 10), rep("red", 10))

#If you are not going to use a special order for the population names to be listed in the legend command (population names listed in the legend ("hapcol"), 
#you can automatically select and sort the population names using the following command ("sn2"). 
#This order is fully consistent with the order in the ind.hap object.

#un2<-unique(n2)
#sn2<-sort(un2)

#Then you must the use "sn2" list instead of "hapcol" list in the legend argument.

#But, we wanted to order names of the population names according to groups. 
#Therefore, we reordered the population names as "hapcol" list.
#So, you can see color transitions of the populations by the groups. 
#The population names were assigned using "hapcol" list in the legend () command.

hapcol<-c("Kinh", "Sumatra")

#At this point, the colors to be used in the list where the populations will be shown (legend) must match the colors you choose for the samples in the circles.
#Therefore, if you used the "sn2" list, you can directly use the "bg" list for the populations' color symbols. 
#Note, now the number of colors must be changed to "1" for each population.
#For example;
#bgp<-c(rep("dodgerblue4", 1), rep("olivedrab4",1),...)

#Then you must the use "bgp" list instead of "ubg" list in the legend argument (fill).

#But, we used different order for the population names (hapcol list).
#Thus, colors of the population were assigned as "ubg" list and used in the fill argument of the legend () command.
#The colors of the samples assigned in the bg list and the population colors (ubg) belonging samples must match each other.

ubg<-c(rep("orange", 1), rep("red", 1))

par(mar=c(0.001,0.001,0.001,0.001))
plot(net, size=attr(net, "freq"), bg = bg, scale.ratio = 2, cex = 0.7, labels=TRUE, pie = ind.hap, show.mutation=1, font=2, fast=TRUE)
legend(x=-36,y=53, hapcol, fill=ubg, cex=0.8, ncol=1, bty="n", x.intersp = 0.2)

########## USING "sn2" NAME LIST AND "bgp" COLOR LIST  ###############

#par(mar=c(0.001,0.001,0.001,0.001))
#plot(net, size=attr(net, "freq"), bg = bg, scale.ratio = 2, cex = 0.7, labels=TRUE, pie = ind.hap, show.mutation=1, font=2, fast=TRUE)
#legend(x=-36,y=53, sn2, fill=bgp, cex=0.8, ncol=1, bty="n", x.intersp = 0.2)

dev.new()
par(mar=c(0.001,0.001,0.001,0.001))
plot(net, size=attr(net, "freq"), bg = bg, scale.ratio = 2, cex = 0.7, labels=TRUE, pie = ind.hap, show.mutation=1, font=2, fast=TRUE)
legend(x=-36,y=53, hapcol, fill=ubg, cex=0.8, ncol=1, bty="n", x.intersp = 0.2)

pdf("happop.pdf", width = 7, height = 4)
par(mar=c(0.001,0.001,0.001,0.001))
plot(net, size=attr(net, "freq"), bg = bg, scale.ratio = 2, cex = 0.7, labels=TRUE, pie = ind.hap, show.mutation=1, font=2, fast=TRUE)
legend(x=-36,y=53, hapcol, fill=ubg, cex=0.8, ncol=1, bty="n", x.intersp = 0.2)
dev.off()

############## HAPLOTYPE NETWORK-GROUPS ##########################

#To construct a haplotype network according to the groups, we assigned the group names of the samples according to the nbin object. 
#At this stage, we followed the name order in the nbin object using "labels(nbin)".

# nmname<-c(rep("Nature", 3), rep("Nature", 6), rep("Nature", 6), rep("Nature", 4), rep("Firm", 4), 
#           rep("Nature", 11), rep("Greenhouse", 3), rep("Nature", 3), rep("Greenhouse", 2), rep("Greenhouse", 12), 
#           rep("Nature", 6), rep("Firm", 4),  rep("Nature", 7), rep("Greenhouse", 13), rep("Nature", 6), rep("Greenhouse", 15), 
#           rep("Firm", 3), rep("Nature", 6), rep("Nature", 2), rep("Firm", 4))

nmname<-c(rep("Kinh", 1), rep("Sumatra", 2), rep("Kinh", 3), rep("Sumatra", 2), rep("Kinh", 5), rep("Sumatra", 6), rep("Kinh", 1))

ng<-nbin
rownames(ng)<-nmname
hg<-pegas::haplotype(ng, strict = FALSE, labels = hname, trailingGapsAsN = TRUE) #extracts haplotypes from DNAbin object
hg
netg<-haploNet(hg, d = NULL, getProb = TRUE) #constructs the haplotype network
netg
ind.hapg<-with(
  utils::stack(setNames(attr(hg, "index"), rownames(hg))),
  table(hap=ind, individuals=rownames(ng)[values])
)

#Group colors in the legend command which gbg argument below, were assigned according to the order of names in the ind.hapg object.
#To see name order, you can use the below command;
#as.data.frame(ind.hap)
#Color of samples was assigned using "gbg" argument in the plot () command.

gbg<-c(rep("red"), rep("blue"), rep("green"))

par(mar=c(0.001,0.001,0.001, 0.001))
plot(netg, size=attr(netg, "freq"), bg = gbg, scale.ratio = 2, cex = 0.7, labels=TRUE, pie = ind.hapg, show.mutation=1, font=2, fast=TRUE)
legend(x=-35,y=45, colnames(ind.hapg), fill=c("red","blue", "green"), cex=0.8, ncol=1, bty = "n", x.intersp = 0.2)

dev.new()
par(mar=c(0.001,0.001,0.001, 0.001))
plot(netg, size=attr(netg, "freq"), bg = gbg, scale.ratio = 2, cex = 0.7, labels=TRUE, pie = ind.hapg, show.mutation=1, font=2, fast=TRUE)
legend(x=-35,y=45, colnames(ind.hapg), fill=c("red","blue", "green"), cex=0.8, ncol=1, bty = "n", x.intersp = 0.2)


pdf("hapgrp.pdf", width = 8, height = 5) #save as pdf file
par(mar=c(0.001,0.001,0.001, 0.001))
plot(netg, size=attr(netg, "freq"), bg = gbg, scale.ratio = 2, cex = 0.7, labels=TRUE, pie = ind.hapg, show.mutation=1, font=2, fast=TRUE)
legend(x=-35,y=45, colnames(ind.hapg), fill=c("red","blue", "green"), cex=0.8, ncol=1, bty = "n", x.intersp = 0.2)
dev.off()

############# CIRCULAR TREE-NJ-POPULATIONS #######################

library(pegas)
library(ggtree)
library(ggplot2)
library(phytools)
library(stats)

nname<-as.matrix(sort(labels(nbin)))#to construct population names 
krp<-list(Kinh = nname[1:10,],
          Sumatra = nname[11:20,])

nbin
class(nbin)
dnbin<-dist.dna(nbin, model = "K80") #computing distance by ape package with K80 model derived by Kimura (1980)
tree<-nj(dnbin) #neighbor-joining tree estimation of Saitou and Nei (1987).

emos<-ggtree(tree, layout = 'circular', branch.length='branch.length', lwd = 0.5)+xlim(-0.1, NA)
groupOTU(emos, krp, 'Populations') + aes(color=Populations)+theme(legend.position="right")+geom_tiplab(names(nbin), cex = 1.7, offset=0.002)+guides(color = guide_legend(override.aes = list(size = 2.5)))+geom_treescale(x=-0.1, color = "coral4", fontsize = 3, offset = 9)

dev.new()
emos<-ggtree(tree, layout = 'circular', branch.length='branch.length', lwd = 0.5)+xlim(-0.1, NA)
groupOTU(emos, krp, 'Populations') + aes(color=Populations)+theme(legend.position="right")+geom_tiplab(names(nbin), cex = 1.7, offset=0.002)+guides(color = guide_legend(override.aes = list(size = 2.5)))+geom_treescale(x=-0.1, color = "coral4", fontsize = 3, offset = 9)


pdf("njtreepop.pdf", width = 6.5, height = 5)
emos<-ggtree(tree, layout = 'circular', branch.length='branch.length', lwd = 0.5)+xlim(-0.1, NA)
groupOTU(emos, krp, 'Populations') + aes(color=Populations)+theme(legend.position="right")+geom_tiplab(names(nbin), cex = 1.7, offset=0.002)+guides(color = guide_legend(override.aes = list(size = 2.5)))+geom_treescale(x=-0.1, color = "coral4", fontsize = 3, offset = 9)
dev.off()

##################### CIRCULAR TREE-NJ-DISTANCE ##############################

nbin
class(nbin)
dnbin<-dist.dna(nbin, model = "K80")#computing distance by ape package with K80 model derived by Kimura (1980)
tree<-nj(dnbin)#neighbor-joining tree estimation of Saitou and Nei (1987).

njdistree<-ggtree(tree,layout = 'circular', branch.length='branch.length', aes(color=branch.length), lwd = 0.5)+xlim(-0.1, NA)+
  geom_tiplab(names(nbin), size = 1.7, offset=0.002)+scale_color_continuous(high='lightskyblue1',low='coral4')+
  geom_treescale(x=-0.1, color = "coral4", fontsize = 3, offset = 9) 

njdistree

dev.new()
njdistree


pdf("njdistree.pdf", width = 6.5, height = 5)
njdistree
dev.off()

############## HAPLOTYPE TREE ##########################

library(treeio)
D <- dist.hamming(mat7)#pegas package
class(D)
htre<-nj(D)#This function performs the neighbor-joining tree estimation of Saitou and Nei (1987).
bp <- boot.phylo(htre, mat7, B=100, function(x) nj(dist.hamming(x)))
bp2 <- data.frame(node=1:Nnode(htre) + Ntip(htre), bootstrap = bp)
htree <- full_join(htre, bp2, by="node")
boothap<-ggtree(htree, size=1, branch.length='branch.length')+geom_tiplab(size=4)+
  geom_nodepoint(aes(fill=cut(bootstrap, c(0,50,70,85,100))), shape=21, size=4)+
  theme_tree(legend.position=c(0.85, 0.2))+ 
  scale_fill_manual(values=c("black", "red", "pink1", "white"), guide='legend', name='Bootstrap Percentage (BP)',breaks=c('(85,100]', '(70,85]', '(50,70]', '(0,50]'), labels=expression(BP>=85, 70<=BP*"<85",50<=BP*"<70", BP<50))

boothap

dev.new()
boothap


pdf("boothap.pdf", width = 11, height = 5)
boothap
dev.off()

library("admixtools")

genotype_data = "/my/geno/prefix"
fit = qpgraph(genotype_data, example_graph)
fit$score

f2_blocks = f2_from_geno(genotype_data)
fit = qpgraph(f2_blocks, example_graph)

prefix = '/path/to/geno'
my_f2_dir = '/store/f2data/here/'

extract_f2(prefix, my_f2_dir)

admixtools::run_shiny_admixtools()

library(admixr)

snp_data <- eigenstrat(download_data())

result <- d(
  W = c("French", "Sardinian"), X = "Yoruba", Y = "Vindija", Z = "Chimp",
  data = snp_data
)

result

beast_file <- system.file("examples/MCC_FluA_H3.tree", 
                          package="ggtree")
beast_tree <- read.beast(beast_file)
ggtree(beast_tree, mrsd="2013-01-01") + theme_tree2()

samplelist <- read_tsv("analysis/samplelist.txt",
                       col_names = "sample")

read_delim("analysis/full_genome.filtered.numericChr.2.Q",
           col_names = paste0("Q",seq(1:2)),
           delim=" ")

### Coalescent MCMC

# Haplogroup F1
hap_F1 <- dat %>% filter(haplogroup2 == "F1")
nbin_F1 <- nbin[labels(nbin) %in% hap_F1$name]

data(woodmouse)
out <- coalescentMCMC(woodmouse)

#adjust plot margins
par(mar = c(1, 1, 1, 1))
plot(out)
getMCMCtrees()

res <- coalescentMCMC(woodmouse, 1e6, moves = c(1, 3)) # ~ 1 hr
plot(res) # surely hard to read
plot(subset(res, end = 1e3)) # plot only the first 1000 generations
acfplot(res)
acfplot(subset(res, 1e4, 100))

library(ape)
it = read.tree("example_newick.txt")  # autogenerated filename from the website.
getMRCA(it, c("Homo_sapiens", "Drosophila_melanogaster"))  # drosophila is one of only 2 arthropods in this tree, but arthropods all have an arthropod common ancestor
# prints "200", the node index of the MRCA.

library(phytools)
F1a_it = read.newick("F1a_newick.txt")
mrca(F1a_it, full = TRUE)
getMRCA(F1a_it, F1a_it$tip.label)

findMRCA(F1a_it, tips=NULL, type=c("node","height"))
anc<-findMRCA(F1a_it, F1a_it$tip.label)
plotTree(F1a_it,type="fan",fsize=0.7,lwd=1)
nodelabels(node=anc,frame="circle",pch=21,cex=1.5,
           bg="blue")
legend("topleft","most recent common ancestor\nof Puerto Rican TG anoles",
       pch=21,pt.cex=1.5,pt.bg="blue",cex=0.7,bty="n")
par(mar=c(5.1,4.1,4.1,2.1)) ## reset margin to default

library(devtools)
# install_github("jhavsmith/startmrca")
library(startmrca)
help(run.startmrca)
run.startmrca(vcf.file = "examples/FIN_chr2_pos136608646.vcf.gz",
              rec.file      = "examples/decode_recmap_sexaveraged.txt", 
              sample.ids    = "examples/sample_ids.txt", 
              refsample.ids = "examples/sample_ids.txt",
              mut.rate      = 1.6e-8, 
              nsel          = 50,
              nanc          = 20,
              chain.length  = 20,
              nanc.post     = 10,
              pos           = 136608646,
              sel.allele    = 1)


